

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adding a New Model to VeOmni &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Adding a New Model to VeOmni</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/sources/_generated/sources/VeOmni/key_features/model_loader.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="adding-a-new-model-to-veomni">
<h1>Adding a New Model to VeOmni<a class="headerlink" href="#adding-a-new-model-to-veomni" title="Link to this heading">ïƒ</a></h1>
<section id="table-of-contents">
<h2>ğŸ”– Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#adding-a-new-model-to-veomni">Adding a New Model to VeOmni</a></p>
<ul>
<li><p><a class="reference external" href="#%F0%9F%94%96-table-of-contents">ğŸ”– Table of Contents</a></p></li>
<li><p><a class="reference external" href="#%F0%9F%93%9A-overview">ğŸ“š Overview</a></p></li>
<li><p><a class="reference external" href="#%F0%9F%94%8D-model-registry-system">ğŸ” Model Registry System</a></p></li>
<li><p><a class="reference external" href="#%F0%9F%9B%A0%EF%B8%8F-add-your-own-model">ğŸ› ï¸ Add Your Own Model</a></p></li>
</ul>
</li>
</ul>
</section>
<section id="overview">
<h2>ğŸ“š Overview<a class="headerlink" href="#overview" title="Link to this heading">ïƒ</a></h2>
<p>In this tutorial, we will guide you through the process of adding a new model to VeOmni. We use a registry-based system to manage different model implementations.</p>
<p>VeOmni uses a model registry system that allows you to:</p>
<ol class="simple">
<li><p>Support both HuggingFace models and their custom implementations</p></li>
<li><p>Register your custom model implementation</p></li>
<li><p>Automatically load the appropriate model based on the configuration</p></li>
</ol>
</section>
<section id="model-registry-system">
<h2>ğŸ” Model Registry System<a class="headerlink" href="#model-registry-system" title="Link to this heading">ïƒ</a></h2>
<p>To enable users to quickly train models from HuggingFace and flexibly train custom models, VeOmni adopts a model registration system to support model loading and initialization. This design is inspired by <a class="reference external" href="https://github.com/vllm-project/vllm">vLLM</a> and <a class="reference external" href="https://github.com/sgl-project/sglang">SGLang</a>. An overall architecture diagram is shown below.</p>
<div style="text-align: center;">
    <img src="../assets/model_loader.png" alt="model loader" width="75%"/>
</div><p>Users can directly load models from HuggingFace and start the training process by specifying the model name or model path. Additionally, they can implement their own custom models or enhance existing HuggingFace models with advanced features such as sequence parallelism or expert parallelism. Custom modeling can be implemented in one of the supported modeling paths:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">veomni/models/transformers/</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">veomni/models/seed_omni/</span></code></p></li>
</ul>
</section>
<section id="add-your-own-model">
<h2>ğŸ› ï¸ Add Your Own Model<a class="headerlink" href="#add-your-own-model" title="Link to this heading">ïƒ</a></h2>
<section id="create-your-model-implementation">
<h3>1. Create Your Model Implementation<a class="headerlink" href="#create-your-model-implementation" title="Link to this heading">ïƒ</a></h3>
<p>First, create new modeling file for your model implementation. Note that the custom models should inherit from <code class="docutils literal notranslate"><span class="pre">PreTrainedModel</span></code> and implement the necessary methods.</p>
</section>
<section id="register-your-model">
<h3>2. Register Your Model<a class="headerlink" href="#register-your-model" title="Link to this heading">ïƒ</a></h3>
<p>See <a class="reference external" href="support-new-models#in-your-model-file">enable_new_models.md</a> for more details.</p>
</section>
<section id="model-configuration">
<h3>3. Model Configuration<a class="headerlink" href="#model-configuration" title="Link to this heading">ïƒ</a></h3>
<p>Your model should have a corresponding configuration class that inherits from <code class="docutils literal notranslate"><span class="pre">PretrainedConfig</span></code>. The configuration should include:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">YourCustomConfig</span><span class="p">(</span><span class="n">PretrainedConfig</span><span class="p">):</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;your_custom_model&quot;</span>
    <span class="n">architectures</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;YourCustomModel&quot;</span><span class="p">]</span>  <span class="c1"># This should match your model class name</span>
</pre></div>
</div>
<p>You can also use the model configuration from HuggingFace if you are only modifying the modeling component of an existing HuggingFace model.</p>
<p>Here's a complete example of adding a new model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># veomni/models/transformers/your_custom_model.py</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">PretrainedConfig</span>

<span class="k">class</span><span class="w"> </span><span class="nc">YourCustomConfig</span><span class="p">(</span><span class="n">PretrainedConfig</span><span class="p">):</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;your_custom_model&quot;</span>
    <span class="n">architectures</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;YourCustomModel&quot;</span><span class="p">]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">YourCustomModel</span><span class="p">(</span><span class="n">PreTrainedModel</span><span class="p">):</span>
    <span class="n">config_class</span> <span class="o">=</span> <span class="n">YourCustomConfig</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="c1"># Initialize your model components</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="o">...</span>

<span class="c1"># Register your model</span>
<span class="n">ModelClass</span> <span class="o">=</span> <span class="n">YourCustomModel</span>
</pre></div>
</div>
<p>Check existing model implementations in the <code class="docutils literal notranslate"><span class="pre">veomni/models/transformers/</span></code> and <code class="docutils literal notranslate"><span class="pre">veomni/models/seed_omni/</span></code> directory for reference.</p>
</section>
<section id="loading-your-model">
<h3>4. Loading Your Model<a class="headerlink" href="#loading-your-model" title="Link to this heading">ïƒ</a></h3>
<p>The framework will automatically handle model loading based on the configuration. You can load your model using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">veomni.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_foundation_model</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">build_foundation_model</span><span class="p">(</span>
    <span class="n">config_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config_path</span><span class="p">,</span>
    <span class="n">weights_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>VeOmni supports various initialization methods:</p>
<ul class="simple">
<li><p>Empty initialization</p></li>
<li><p>Loading from weights file</p></li>
<li><p>Meta device initialization</p></li>
<li><p>Support for different devices (CUDA, CPU, NPU)</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>