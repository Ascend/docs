

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Embeddingè®­ç»ƒ &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Embeddingè®­ç»ƒ</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/sources/_generated/sources/ms-swift/source/BestPractices/Embedding.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="embedding">
<h1>Embeddingè®­ç»ƒ<a class="headerlink" href="#embedding" title="Link to this heading">ïƒ</a></h1>
<p>SWIFTå·²ç»æ”¯æŒEmbeddingæ¨¡å‹çš„è®­ç»ƒï¼ŒåŒ…æ‹¬çº¯æ–‡æœ¬å’Œå¤šæ¨¡æ€ä¸¤ä¸ªç±»å‹ã€‚ç›®å‰å·²ç»æ”¯æŒçš„æ¨¡å‹æœ‰ï¼š</p>
<ol class="simple">
<li><p>modernbert embeddingæ¨¡å‹</p>
<ul class="simple">
<li><p><a class="reference external" href="https://modelscope.cn/models/iic/gte-modernbert-base">ModelScope</a> <a class="reference external" href="https://huggingface.co/Alibaba-NLP/gte-modernbert-base">Hugging Face</a></p></li>
</ul>
</li>
<li><p>gte embeddingæ¨¡å‹</p>
<ul class="simple">
<li><p>1.5B: <a class="reference external" href="https://www.modelscope.cn/models/iic/gte_Qwen2-1.5B-instruct">ModelScope</a> <a class="reference external" href="https://huggingface.co/Alibaba-NLP/gte-Qwen2-1.5B-instruct">Hugging Face</a></p></li>
<li><p>7B: <a class="reference external" href="https://www.modelscope.cn/models/iic/gte_Qwen2-7B-instruct">ModelScope</a> <a class="reference external" href="https://huggingface.co/Alibaba-NLP/gte-Qwen2-7B-instruct">Hugging Face</a></p></li>
</ul>
</li>
<li><p>gme embeddingæ¨¡å‹</p>
<ul class="simple">
<li><p>2B: <a class="reference external" href="https://www.modelscope.cn/models/iic/gme-Qwen2-VL-2B-Instruct">ModelScope</a> <a class="reference external" href="https://huggingface.co/Alibaba-NLP/gme-Qwen2-VL-2B-Instruct">Hugging Face</a></p></li>
<li><p>7B: <a class="reference external" href="https://www.modelscope.cn/models/iic/gme-Qwen2-VL-7B-Instruct">ModelScope</a> <a class="reference external" href="https://huggingface.co/Alibaba-NLP/gme-Qwen2-VL-7B-Instruct">Hugging Face</a></p></li>
</ul>
</li>
<li><p>qwen3-embeddingæ¨¡å‹</p>
<ul class="simple">
<li><p>0.6B: <a class="reference external" href="https://www.modelscope.cn/models/Qwen/Qwen3-Embedding-0.6B">ModelScope</a> <a class="reference external" href="https://huggingface.co/Qwen/Qwen3-Embedding-0.6B">Hugging Face</a></p></li>
<li><p>4B: <a class="reference external" href="https://www.modelscope.cn/models/Qwen/Qwen3-Embedding-4B">ModelScope</a> <a class="reference external" href="https://huggingface.co/Qwen/Qwen3-Embedding-4B">Hugging Face</a></p></li>
<li><p>8B: <a class="reference external" href="https://www.modelscope.cn/models/Qwen/Qwen3-Embedding-8B">ModelScope</a> <a class="reference external" href="https://huggingface.co/Qwen/Qwen3-Embedding-8B">Hugging Face</a></p></li>
</ul>
</li>
<li><p>qwen3-vl-embeddingæ¨¡å‹</p>
<ul class="simple">
<li><p>2B: <a class="reference external" href="https://www.modelscope.cn/models/Qwen/Qwen3-VL-Embedding-2B">ModelScope</a> <a class="reference external" href="https://huggingface.co/Qwen/Qwen3-VL-Embedding-2B">Hugging Face</a></p></li>
<li><p>8B: <a class="reference external" href="https://www.modelscope.cn/models/Qwen/Qwen3-VL-Embedding-8B">ModelScope</a> <a class="reference external" href="https://huggingface.co/Qwen/Qwen3-VL-Embedding-8B">Hugging Face</a></p></li>
</ul>
</li>
</ol>
<p>å¼€å‘è€…å¯ä»¥è‡ªè¡Œé›†æˆè‡ªå·±çš„æ¨¡å‹ï¼Œæ¨¡å‹forwardè¾“å‡ºå€¼éœ€è¦æ»¡è¶³ï¼š</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{&quot;last_hidden_state&quot;: some-embedding-tensor}
</pre></div>
</div>
<p>è¿”å›å€¼æ˜¯ä¸€ä¸ªjsonï¼Œå…·æœ‰<code class="docutils literal notranslate"><span class="pre">last_hidden_state</span></code> keyï¼Œvalueæ˜¯embedding tensorå³å¯ï¼Œè¾“å…¥éƒ¨åˆ†å¯ä»¥ä½¿ç”¨æˆ‘ä»¬å·²ç»æ”¯æŒçš„templateã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="w">   </span>--task_type<span class="w"> </span>embedding
</pre></div>
</div>
<p>å‚æ•°æ¥å°†ä»»æ„ä¸€ä¸ªå…¶ä»–æ¨¡å‹è½¬æ¢ä¸ºembeddingæ¨¡å‹è¿›è¡Œè®­ç»ƒã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSWIFTç›®å‰æ”¯æŒçš„embeddingæ¨¡å‹å‡ä¸ºç¬¦åˆçº¯æ–‡æœ¬æˆ–å¤šæ¨¡æ€LLMï¼Œç›®å‰å¹¶ä¸æ”¯æŒCLIPç±»å‹çš„æ¨¡å‹è®­ç»ƒã€‚</p>
<p>æ­¤å¤–ï¼ŒSWIFTæ”¯æŒçš„æ‰€æœ‰embeddingæ¨¡å‹åœ¨æ¨¡å‹forwardæœ€åéƒ½å¢åŠ äº†normalizeï¼Œå¦‚è‡ªè¡Œå¢åŠ æ–°æ¨¡å‹è¯·æ³¨æ„å¢åŠ normalizeå±‚ã€‚</p>
<section id="loss">
<h2>loss<a class="headerlink" href="#loss" title="Link to this heading">ïƒ</a></h2>
<p>ç›®å‰SWIFTæ”¯æŒçš„Embeddingæ¨¡å‹å¯ä»¥ä½¿ç”¨çš„lossæœ‰ï¼š</p>
<ul class="simple">
<li><p>cosine_similarity: cosineç›¸ä¼¼åº¦lossï¼Œè®¡ç®—ä¸¤ä¸ªembeddingçš„ç›¸ä¼¼åº¦ï¼Œå¹¶æ ¹æ®labelçš„å€¼æ‹Ÿåˆï¼Œå®é™…ä¸ºMSE loss</p></li>
<li><p>contrastive: å¯è°ƒmarginçš„å¯¹æ¯”å­¦ä¹ lossï¼Œlabelä»…æ”¯æŒ0å’Œ1ä¸¤ä¸ªå€¼</p></li>
<li><p>online_contrastive: è€ƒè™‘hard negativeå’Œhard positiveéƒ¨åˆ†çš„contrastive lossï¼Œlabelä»…æ”¯æŒ0å’Œ1ä¸¤ä¸ªå€¼</p></li>
<li><p>infonce: åœ¨åŒä¸€ä¸ªbatchä¸­ä¸åŒrowä¸¤ä¸¤è®¡ç®—cosineç›¸ä¼¼åº¦ï¼Œå¹¶ä½¿rowå†…éƒ¨ç›¸ä¼¼åº¦æœ€å¤§ï¼Œä¸åŒrowç›¸ä¼¼åº¦æœ€å°ï¼Œä¸éœ€è¦label</p></li>
</ul>
<p>lossçš„æºä»£ç å¯ä»¥åœ¨<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/loss/mapping.py">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚</p>
</section>
<section id="id1">
<h2>æ•°æ®é›†æ ¼å¼<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h2>
<blockquote>
<div><p>æ³¨ï¼š</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;image&gt;</span></code>æ ‡ç­¾å¯ä»¥å‡ºç°åœ¨<code class="docutils literal notranslate"><span class="pre">messages</span></code>/<code class="docutils literal notranslate"><span class="pre">positive_messages</span></code>/<code class="docutils literal notranslate"><span class="pre">negative_messages</span></code>çš„ä»»æ„ä½ç½®ï¼›å®ƒä»¬å„è‡ªæ‹¥æœ‰ç‹¬ç«‹çš„<code class="docutils literal notranslate"><span class="pre">images</span></code>/<code class="docutils literal notranslate"><span class="pre">positive_images</span></code>/<code class="docutils literal notranslate"><span class="pre">negative_images</span></code>å­—æ®µç”¨äºæä¾›å›¾ç‰‡è·¯å¾„æˆ–URLã€‚</p></li>
<li><p>ä¸å†éœ€è¦è·¨å­—æ®µçš„â€œå¯¹åº”é¡ºåºâ€ã€‚å¯¹é½è§„åˆ™ä¸ºï¼š<code class="docutils literal notranslate"><span class="pre">images</span></code>çš„é•¿åº¦ç­‰äº<code class="docutils literal notranslate"><span class="pre">messages</span></code>ä¸­<code class="docutils literal notranslate"><span class="pre">&lt;image&gt;</span></code>æ ‡ç­¾çš„æ•°é‡ï¼›<code class="docutils literal notranslate"><span class="pre">positive_images</span></code>ä¸<code class="docutils literal notranslate"><span class="pre">negative_images</span></code>å‡ä¸ºâ€œlist of listâ€ï¼Œå…¶å¤–å±‚é•¿åº¦åˆ†åˆ«ç­‰äº<code class="docutils literal notranslate"><span class="pre">positive_messages</span></code>ä¸<code class="docutils literal notranslate"><span class="pre">negative_messages</span></code>çš„é•¿åº¦ï¼›å¹¶ä¸”å¤–å±‚æ¯ä¸€é¡¹çš„å†…å±‚åˆ—è¡¨é•¿åº¦ç­‰äºè¯¥æ¡æ¶ˆæ¯åºåˆ—ä¸­<code class="docutils literal notranslate"><span class="pre">&lt;image&gt;</span></code>æ ‡ç­¾çš„æ•°é‡ã€‚</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">messages</span></code>ä»£è¡¨anchoræ ·æœ¬ï¼ˆanchor sampleï¼‰ï¼›<code class="docutils literal notranslate"><span class="pre">positive_messages</span></code>/<code class="docutils literal notranslate"><span class="pre">negative_messages</span></code>ä¸ºâ€œlist of messagesâ€ï¼ˆå› æ­¤å¤šä¸€å±‚<code class="docutils literal notranslate"><span class="pre">[]</span></code>ï¼‰ï¼›ç›¸åº”åœ°ï¼Œ<code class="docutils literal notranslate"><span class="pre">positive_images</span></code>/<code class="docutils literal notranslate"><span class="pre">negative_images</span></code>ä¹Ÿå¤šä¸€å±‚<code class="docutils literal notranslate"><span class="pre">[]</span></code>å¹¶ä¸ä¹‹é€é¡¹å¯¹é½ã€‚</p></li>
<li><p>ä¹Ÿæ”¯æŒ<code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;audio&gt;</span></code>æ ‡ç­¾ï¼›å¯æŒ‰ç›¸åŒè§„åˆ™åˆ†åˆ«é€šè¿‡<code class="docutils literal notranslate"><span class="pre">videos</span></code>/<code class="docutils literal notranslate"><span class="pre">positive_videos</span></code>/<code class="docutils literal notranslate"><span class="pre">negative_videos</span></code>ä¸<code class="docutils literal notranslate"><span class="pre">audios</span></code>/<code class="docutils literal notranslate"><span class="pre">positive_audios</span></code>/<code class="docutils literal notranslate"><span class="pre">negative_audios</span></code>æä¾›å¯¹åº”æ¨¡æ€æ•°æ®ã€‚</p></li>
<li><p>å½“å‰çº¦æŸï¼š<code class="docutils literal notranslate"><span class="pre">positive_messages</span></code>çš„å¤–å±‚é•¿åº¦å¿…é¡»ä¸º1ï¼ˆå³ä»…æä¾›ä¸€ä¸ªpositiveæ ·æœ¬ï¼‰ï¼›å¯¹åº”åœ°ï¼Œ<code class="docutils literal notranslate"><span class="pre">positive_images</span></code>çš„å¤–å±‚é•¿åº¦ä¹Ÿå¿…é¡»ä¸º1ã€‚</p></li>
</ol>
</div></blockquote>
<section id="cosine-similarity-loss">
<h3>cosine_similarity losså¯¹åº”çš„æ ¼å¼<a class="headerlink" href="#cosine-similarity-loss" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-json lines notranslate"><div class="highlight"><pre><span></span># LLM
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;sentence1&quot;}], &quot;positive_messages&quot;: [[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;sentence2&quot;}]], &quot;label&quot;: 0.8}
# MLLM
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;&quot;}], &quot;images&quot;: [&quot;/some/images1.jpg&quot;],&quot;positive_messages&quot;: [[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;sentence&quot;}]], &quot;positive_images&quot;: [[&quot;/some/images2.jpg&quot;]], &quot;label&quot;: 0.7}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;sentence1&quot;}], &quot;positive_messages&quot;: [[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;sentence2&quot;}]], &quot;positive_images&quot;: [[&quot;/some/images.jpg&quot;]], &quot;label&quot;: 0.7}
</pre></div>
</div>
</section>
<section id="contrastive-online-contrastive-loss">
<h3>contrastive/online_contrastive losså¯¹åº”çš„æ ¼å¼<a class="headerlink" href="#contrastive-online-contrastive-loss" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-json lines notranslate"><div class="highlight"><pre><span></span># LLM
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;sentence1&quot;}], &quot;positive_messages&quot;: [[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;sentence2&quot;}]], &quot;label&quot;: 1}
# MLLM
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;&quot;}], &quot;images&quot;: [&quot;/some/images1.jpg&quot;], &quot;positive_messages&quot;: [[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;sentence&quot;}]], &quot;positive_images&quot;: [[&quot;/some/images2.jpg&quot;]], &quot;label&quot;: 1}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;sentence1&quot;}], &quot;positive_messages&quot;: [[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;sentence2&quot;}]], &quot;positive_images&quot;: [[&quot;/some/images.jpg&quot;]], &quot;label&quot;: 0}
</pre></div>
</div>
<p>è¯„æµ‹çš„æŒ‡æ ‡åˆ†åˆ«æ˜¯ä¸¤ä¸ªembeddingçš„æ¬§å¼è·ç¦»ã€ç‚¹ç§¯ç­‰çš„pearsonç³»æ•°ä»¥åŠspearmanç³»æ•°ï¼Œå…±å…«ä¸ªæŒ‡æ ‡ã€‚</p>
</section>
<section id="infonce">
<h3>infonce æ ¼å¼<a class="headerlink" href="#infonce" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-json lines notranslate"><div class="highlight"><pre><span></span># LLM
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;sentence1&quot;}], &quot;positive_messages&quot;: [[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;sentence2&quot;}]]}
# MLLM
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;&quot;}], &quot;images&quot;: [&quot;/some/images.jpg&quot;], &quot;positive_messages&quot;: [[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;sentence&quot;}]]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;sentence1&quot;}], &quot;images&quot;: [&quot;/some/images.jpg&quot;], &quot;positive_messages&quot;: [[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;sentence2&quot;}]], &quot;positive_images&quot;: [[&quot;/some/positive_images.jpg&quot;]], &quot;negative_messages&quot;: [[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;&lt;image&gt;sentence3&quot;}], [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;sentence4&quot;}]], &quot;negative_images&quot;: [[&quot;/some/negative_images1.jpg&quot;, &quot;/some/negative_images2.jpg&quot;], [&quot;/some/negative_images3.jpg&quot;]]}
</pre></div>
</div>
<p>infonce lossæ”¯æŒå‡ ä¸ªç¯å¢ƒå˜é‡ï¼š</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">INFONCE_TEMPERATURE</span></code>ï¼š temperatureå‚æ•°ï¼Œä¸è®¾ç½®çš„è¯é»˜è®¤å€¼æ˜¯0.1</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INFONCE_USE_BATCH</span></code>ï¼š ä½¿ç”¨sampleå†…éƒ¨çš„<code class="docutils literal notranslate"><span class="pre">negative_messages</span></code>ï¼ˆhard negativeæ ·ä¾‹ï¼‰è¿˜æ˜¯ä½¿ç”¨ä¸€ä¸ªbatchå†…å…¶ä»–æ ·æœ¬ä½œä¸ºin-batch negativesï¼›é»˜è®¤ä¸ºTrueï¼Œè¡¨ç¤ºä½¿ç”¨batchå†…éƒ¨çš„æ ·æœ¬ä½œä¸ºè´Ÿä¾‹</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INFONCE_HARD_NEGATIVES</span></code>ï¼š hard negativesçš„æ•°é‡ï¼›å¦‚æœä¸è®¾ç½®ä¼šä½¿ç”¨æ•°æ®ä¸­æä¾›çš„æ‰€æœ‰<code class="docutils literal notranslate"><span class="pre">negative_messages</span></code>ã€‚ç”±äºé•¿åº¦æœªå¿…ä¸€è‡´ï¼Œå› æ­¤ä¼šé‡‡ç”¨forå¾ªç¯è®¡ç®—lossï¼ˆè®¡ç®—ä¼šæ…¢ï¼‰ã€‚è‹¥è®¾ç½®ä¸ºæŸä¸ªæ•°å€¼ï¼Œåˆ™ä¸è¶³ä¼šéšæœºé‡‡æ ·è¡¥é½ï¼Œè¶…é•¿ä¼šé€‰ç”¨å‰<code class="docutils literal notranslate"><span class="pre">INFONCE_HARD_NEGATIVES</span></code>ä¸ª</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INFONCE_MASK_FAKE_NEGATIVE</span></code>ï¼š maskæ‰å‡negativeã€‚é»˜è®¤ä¸ºFalseï¼Œå¼€å¯æ—¶ä¼šåˆ¤æ–­ <code class="docutils literal notranslate"><span class="pre">positive_similarity</span> <span class="pre">+</span> <span class="pre">INFONCE_FAKE_NEG_MARGIN</span></code>ï¼Œæ¯”è¯¥é˜ˆå€¼å¤§çš„æ ·æœ¬ç›¸ä¼¼åº¦ä¼šè¢«è®¾ç½®ä¸º <code class="docutils literal notranslate"><span class="pre">-inf</span></code>ï¼Œä»¥é˜²æ­¢æ­£æ ·æœ¬æ³„éœ²é—®é¢˜</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INFONCE_FAKE_NEG_MARGIN</span></code>ï¼šå‡è´Ÿæ ·æœ¬å±è”½çš„è¾¹é™…ï¼Œé»˜è®¤ <code class="docutils literal notranslate"><span class="pre">0.1</span></code>ã€‚</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INFONCE_INCLUDE_QQ</span></code>ï¼šæ˜¯å¦åœ¨åˆ†æ¯ä¸­åŠ å…¥ qâ€“q åˆ†é‡ï¼ˆquery é—´ç›¸ä¼¼åº¦ï¼‰ä½œä¸ºè´Ÿä¾‹ï¼Œé»˜è®¤ <code class="docutils literal notranslate"><span class="pre">False</span></code>ã€‚</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INFONCE_INCLUDE_DD</span></code>ï¼šæ˜¯å¦åœ¨åˆ†æ¯ä¸­åŠ å…¥ dâ€“d åˆ†é‡ï¼ˆæ­£æ ·æœ¬æ–‡æ¡£ä¸ batch å†…æ‰€æœ‰æ–‡æ¡£çš„ç›¸ä¼¼åº¦ï¼‰ä½œä¸ºè´Ÿä¾‹ï¼Œé»˜è®¤ <code class="docutils literal notranslate"><span class="pre">False</span></code>ã€‚</p></li>
</ol>
<blockquote>
<div><p>ä¹Ÿå¯ä»¥åœ¨æ•°æ®é›†ä¸­å°†hard negativesæ•°é‡è®¾ç½®ä¸ºæ•°é‡ç›¸ç­‰ï¼Œè¿™æ ·å³ä½¿ä¸è®¾ç½®ä¹Ÿä¸ä¼šä½¿ç”¨forå¾ªç¯æ–¹å¼ï¼ŒåŠ å¿«è®¡ç®—é€Ÿåº¦
<code class="docutils literal notranslate"><span class="pre">negative_messages</span></code>ä¹Ÿå¯ä»¥ä¸æä¾›ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¿æŒ<code class="docutils literal notranslate"><span class="pre">INFONCE_USE_BATCH=True</span></code>ï¼Œä¼šä½¿ç”¨ä¸€ä¸ªbatchå†…éƒ¨çš„å…¶ä»–æ ·æœ¬ä½œä¸ºè´Ÿä¾‹</p>
</div></blockquote>
<p>infonce lossçš„è¯„æµ‹ä¼šæœ‰ä¸‹é¢å‡ ä¸ªæŒ‡æ ‡ï¼š</p>
<ul class="simple">
<li><p>mean_neg æ‰€æœ‰hard_negativeçš„å¹³å‡å€¼</p></li>
<li><p>mean_pos æ‰€æœ‰positiveçš„å¹³å‡å€¼</p></li>
<li><p>margin positive-max_hard_negativeçš„å¹³å‡å€¼</p></li>
</ul>
</section>
</section>
<section id="id2">
<h2>è®­ç»ƒ<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h2>
<p>SWIFTæä¾›çš„è„šæ‰‹æ¶è®­ç»ƒè„šæœ¬ï¼š</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/embedding/qwen3">Qwen3-Embedding/Qwen3-VL-Embeddingæ¨¡å‹</a></p></li>
<li><p><a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/embedding/train_gme.sh">GMEæ¨¡å‹</a></p></li>
</ul>
</section>
<section id="id3">
<h2>æ¨ç†<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h2>
<p>SWIFTå·²ç»æ”¯æŒGMEã€GTEã€Qwen3-Embeddingæ¨¡å‹çš„éƒ¨ç½²ï¼Œè¯·æŸ¥çœ‹<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/deploy/embedding/client.py">è¿™é‡Œ</a>ã€‚</p>
<ul class="simple">
<li><p>æ¨ç†è„šæœ¬å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/infer/demo_embedding.py">è¿™é‡Œ</a>ã€‚</p></li>
</ul>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨åŸæ¨¡å‹çš„ä»£ç è¿›è¡Œæ¨ç†ï¼š</p>
<p>https://www.modelscope.cn/models/iic/gte_Qwen2-7B-instruct</p>
<p>https://www.modelscope.cn/models/iic/gme-Qwen2-VL-7B-Instruct</p>
<p>å¦‚æœä½¿ç”¨äº†å…¶ä»–æ¨¡å‹ä»0è®­ç»ƒembeddingï¼ˆä¾‹å¦‚ï¼ŒåŸç‰ˆ<code class="docutils literal notranslate"><span class="pre">qwen2-vl</span></code>æ¨¡å‹+<code class="docutils literal notranslate"><span class="pre">--task_type</span> <span class="pre">embedding</span></code>ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨gmeçš„æ¨ç†ä»£ç ï¼Œä½†è¯·æ³¨æ„ï¼š</p>
<p>https://www.modelscope.cn/models/iic/gme-Qwen2-VL-7B-Instruct/file/view/master/gme_inference.py?status=1#L111</p>
<p>è¿™é‡Œçš„æ¨¡æ¿è¯·ä¿®æ”¹ä¸ºæ¨¡å‹è‡ªèº«çš„templateï¼Œä»¥å…æœ€åçš„embeddingå¯¹ä¸ä¸Šã€‚éœ€è¦é¢å¤–æ³¨æ„çš„æ˜¯ï¼Œgmeæ¨¡å‹çš„templateå’Œ<code class="docutils literal notranslate"><span class="pre">qwen2-vl</span></code>æˆ–<code class="docutils literal notranslate"><span class="pre">qwen2.5-vl</span></code>ç³»åˆ—çš„chatml templateå¹¶ä¸ç›¸åŒï¼Œå…¶æ¨ç†ä»£ç æœ€åçš„ç»“æŸå­—ç¬¦æ˜¯<code class="docutils literal notranslate"><span class="pre">&lt;|endoftext|&gt;</span></code>è€Œé<code class="docutils literal notranslate"><span class="pre">&lt;|im_end|&gt;</span></code>.</p>
</section>
<section id="id4">
<h2>é«˜çº§åŠŸèƒ½<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p>Qwen3-Embedding è‡ªå®šä¹‰ Instructionï¼š</p>
<ul>
<li><p>é»˜è®¤æ—  Instructionï¼Œè¾“å…¥æ¨¡æ¿ä¸ºï¼š<code class="docutils literal notranslate"><span class="pre">{Query}&lt;|endoftext|&gt;</span></code>ã€‚</p></li>
<li><p>é€šè¿‡åœ¨ system message ä¸­æ·»åŠ  Instructionï¼Œå¯å°†è¾“å…¥æ”¹ä¸ºï¼š<code class="docutils literal notranslate"><span class="pre">{Instruction}</span> <span class="pre">{Query}&lt;|endoftext|&gt;</span></code>ã€‚</p></li>
<li><p>ç¤ºä¾‹ï¼š</p></li>
</ul>
</li>
</ul>
<div class="highlight-json lines notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [
  {&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œå¹¶è¾“å‡ºç®€æ´è¦ç‚¹&quot;},
  {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;ä»‹ç»ä¸€ä¸‹Qwen3-Embedding&quot;}
]}
</pre></div>
</div>
<blockquote>
<div><p>è¯´æ˜ï¼šQwen3-Embedding æ¨¡æ¿ä¼šå°† system å†…å®¹å‰ç½®æ‹¼æ¥åˆ°é¦–æ¡ user æ¶ˆæ¯ä¸­ï¼Œå¹¶ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">&lt;|endoftext|&gt;</span></code> ä½œä¸ºç»“æŸæ ‡è®°ã€‚</p>
</div></blockquote>
<section id="id5">
<h3>è½¬æ¢å‰åç¤ºä¾‹<a class="headerlink" href="#id5" title="Link to this heading">ïƒ</a></h3>
<ul>
<li><p>ä¸åŠ  Instructionï¼š</p>
<p>è¾“å…¥æ•°æ®ï¼ˆmessagesï¼‰ï¼š</p>
<div class="highlight-json lines notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [
  {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;åŒ—äº¬æ˜å¤©å¤©æ°”å¦‚ä½•ï¼Ÿ&quot;}
]}
</pre></div>
</div>
<p>æ¨¡æ¿è½¬æ¢åï¼ˆé€å…¥æ¨¡å‹çš„å®é™…æ–‡æœ¬ï¼‰ï¼š</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>åŒ—äº¬æ˜å¤©å¤©æ°”å¦‚ä½•ï¼Ÿ&lt;|endoftext|&gt;
</pre></div>
</div>
</li>
<li><p>åŠ  Instructionï¼š</p>
<p>è¾“å…¥æ•°æ®ï¼ˆmessagesï¼ŒåŒ…å«systemï¼‰ï¼š</p>
<div class="highlight-json lines notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [
  {&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;è¯·ä½¿ç”¨ä¸­æ–‡ã€ç²¾ç‚¼è¾“å‡ºè¦ç‚¹&quot;},
  {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;åŒ—äº¬æ˜å¤©å¤©æ°”å¦‚ä½•ï¼Ÿ&quot;}
]}
</pre></div>
</div>
<p>æ¨¡æ¿è½¬æ¢åï¼ˆé€å…¥æ¨¡å‹çš„å®é™…æ–‡æœ¬ï¼‰ï¼š</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>è¯·ä½¿ç”¨ä¸­æ–‡ã€ç²¾ç‚¼è¾“å‡ºè¦ç‚¹ åŒ—äº¬æ˜å¤©å¤©æ°”å¦‚ä½•ï¼Ÿ&lt;|endoftext|&gt;
</pre></div>
</div>
</li>
<li><p>positive/negative åŒç†ï¼š</p>
<p>è‹¥åœ¨æŸä¸ª positive/negative çš„æ¶ˆæ¯åºåˆ—ä¸­æä¾› systemï¼Œåˆ™ä¼šå°†è¯¥ system å†…å®¹å‰ç½®åˆ°è¯¥åºåˆ—é¦–æ¡ user å†…å®¹ä¹‹å‰ï¼›æœªæä¾› system åˆ™ä¸å‰ç½®ã€‚</p>
<p>è¾“å…¥æ•°æ®ï¼ˆåŒ…å«ä¸€ä¸ª positive å¸¦ systemï¼Œå’Œä¸€ä¸ª negative æ—  systemï¼‰ï¼š</p>
<div class="highlight-json lines notranslate"><div class="highlight"><pre><span></span>{
  &quot;messages&quot;: [
    {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Anchor&quot;}
  ],
  &quot;positive_messages&quot;: [[
    {&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;æŒ‡ä»¤&quot;},
    {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Positive&quot;}
  ]],
  &quot;negative_messages&quot;: [[
    {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Negative&quot;}
  ]]
}
</pre></div>
</div>
<p>æ¨¡æ¿è½¬æ¢åï¼ˆé€å…¥æ¨¡å‹çš„å®é™…æ–‡æœ¬ï¼‰ï¼š</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Anchor&lt;|endoftext|&gt;
æŒ‡ä»¤ Positive&lt;|endoftext|&gt;
Negative&lt;|endoftext|&gt;
</pre></div>
</div>
</li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>