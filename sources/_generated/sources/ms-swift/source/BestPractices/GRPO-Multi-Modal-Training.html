

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¤šæ¨¡æ€GRPOå®Œæ•´å®éªŒæµç¨‹ &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">å¤šæ¨¡æ€GRPOå®Œæ•´å®éªŒæµç¨‹</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/sources/_generated/sources/ms-swift/source/BestPractices/GRPO-Multi-Modal-Training.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="grpo">
<h1>å¤šæ¨¡æ€GRPOå®Œæ•´å®éªŒæµç¨‹<a class="headerlink" href="#grpo" title="Link to this heading">ïƒ</a></h1>
<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨SWIFT GRPOè¿›è¡Œå¤šæ¨¡æ€æ¨¡å‹å’Œä»»åŠ¡çš„è®­ç»ƒã€‚ç›®æ ‡æ˜¯å¯¹å¤šä¸ªå¤šæ¨¡æ€ä»»åŠ¡è¿›è¡Œè®­ç»ƒï¼Œæå‡ä»»åŠ¡ç²¾åº¦ï¼Œä»»åŠ¡å®šä¹‰å’Œè®­ç»ƒå‚æ•°ç­‰å‚è€ƒäº† <a class="reference external" href="https://github.com/Deep-Agent/R1-V.git">R1-V</a> å’Œ <a class="reference external" href="https://github.com/EvolvingLMMs-Lab/open-r1-multimodal.git">open-r1-multimodal</a></p>
<section id="clevrcount">
<h2>ClevrCount ä»»åŠ¡<a class="headerlink" href="#clevrcount" title="Link to this heading">ïƒ</a></h2>
<section id="id1">
<h3>ä»»åŠ¡ä¸æ•°æ®é›†å®šä¹‰<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h3>
<p>æœ¬ä»»åŠ¡ä»clevr_cogen_a_trainæ•°æ®é›†å‡ºå‘ï¼Œæ¨¡å‹çš„ç›®æ ‡æ˜¯è¾“å‡ºå›¾åƒä¸­åŒ…å«çš„ç‰©ä½“æ•°é‡ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å®šä¹‰æ•°æ®é›†å¦‚ä¸‹ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ClevrPreprocessor</span><span class="p">(</span><span class="n">ResponsePreprocessor</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2"> Output the thinking process in &lt;think&gt; &lt;/think&gt; and</span>
<span class="s2"> final answer (number) in &lt;answer&gt; &lt;/answer&gt; tags.&quot;&quot;&quot;</span>
        <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>


<span class="n">register_dataset</span><span class="p">(</span>
    <span class="n">DatasetMeta</span><span class="p">(</span>
        <span class="n">ms_dataset_id</span><span class="o">=</span><span class="s1">&#39;AI-ModelScope/clevr_cogen_a_train&#39;</span><span class="p">,</span>
        <span class="n">subsets</span><span class="o">=</span><span class="p">[</span>
            <span class="n">SubsetDataset</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="n">preprocess_func</span><span class="o">=</span><span class="n">ClevrPreprocessor</span><span class="p">(),</span>
        <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;qa&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p>è¿™é‡Œé‡æ–°å®šä¹‰dataset preprocessorçš„ç›®çš„æ˜¯ä¿®æ”¹queryã€‚æ•°æ®é›†ç¤ºä¾‹æ ·æœ¬å¦‚ä¸‹ï¼ŒåŒ…å«messages,imageså’Œsolutionå­—æ®µï¼Œsolutionä¼šé€å…¥åç»­çš„å¥–åŠ±å‡½æ•°ä¸­ï¼Œè€Œmessageså’Œimagesåˆ™ä¼šä½œä¸ºæ¨¡å‹è¾“å…¥ã€‚</p>
<ul class="simple">
<li><p>æ³¨æ„ï¼š<code class="docutils literal notranslate"><span class="pre">{'role':</span> <span class="pre">'assistant',</span> <span class="pre">'content':</span> <span class="pre">'&lt;answer&gt;</span> <span class="pre">3</span> <span class="pre">&lt;/answer&gt;'}</span></code>å°†ä¼šåœ¨GRPOTrainerä¸­è¢«ç§»é™¤ï¼Œå¯ä»¥å¿½ç•¥ã€‚'solution'å­—æ®µå°†ä¼šé€ä¼ å…¥ORMä¸­ã€‚åœ¨è‡ªå®šä¹‰æ•°æ®é›†æ—¶ï¼Œ'images'å­—æ®µç»„ç»‡æˆ<code class="docutils literal notranslate"><span class="pre">[&quot;image_path1&quot;,</span> <span class="pre">&quot;image_path2&quot;]</span></code>å³å¯ã€‚</p></li>
</ul>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;images&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;image_path1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;image_path2&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;How many items are there in the image? Output the thinking process in &lt;think&gt; &lt;/think&gt; and \n final answer (number) in &lt;answer&gt; &lt;/answer&gt; tags.&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;solution&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;answer&gt; 3 &lt;/answer&gt;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id2">
<h2>å¥–åŠ±å‡½æ•°å®šä¹‰ï¼š<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h2>
<p>æœ¬ä»»åŠ¡ä½¿ç”¨çš„å¥–åŠ±å‡½æ•°æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ Deepseek-R1 ä¸­æåˆ°çš„æ ¼å¼å¥–åŠ±å‡½æ•°ï¼Œå¦ä¸€æ˜¯ ClevrCount çš„å‡†ç¡®æ€§å¥–åŠ±å‡½æ•°ã€‚å‰è€…å·²ç»åœ¨swiftä¸­å†…ç½®ï¼Œé€šè¿‡ <code class="docutils literal notranslate"><span class="pre">--reward_funcs</span> <span class="pre">format</span></code> å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œè€Œåè€…éœ€è¦æˆ‘ä»¬è‡ªå·±å®šä¹‰ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ external_plugin çš„æ–¹å¼å®šä¹‰å‡†ç¡®æ€§å¥–åŠ±å‡½æ•°ï¼Œå°†ä»£ç æ”¾åœ¨<code class="docutils literal notranslate"><span class="pre">swift/examples/train/grpo/plugin/plugin.py</span></code>ä¸­ã€‚</p>
<p>åœ¨è¿™é‡Œï¼Œå¥–åŠ±å‡½æ•°çš„è¾“å…¥åŒ…æ‹¬completionså’Œsolutionä¸¤ä¸ªå­—æ®µï¼Œåˆ†åˆ«è¡¨ç¤ºæ¨¡å‹ç”Ÿæˆçš„æ–‡æœ¬å’ŒçœŸå€¼ã€‚æ¯ä¸ªéƒ½æ˜¯listï¼Œæ”¯æŒå¤šä¸ªcompletionåŒæ—¶è®¡ç®—ã€‚æ³¨æ„ï¼Œåœ¨è¿™é‡Œï¼Œsolutionå­—æ®µæ˜¯æ•°æ®é›†ä¸­å®šä¹‰çš„å­—æ®µé€ä¼ è€Œæ¥ï¼Œå¦‚æœæœ‰ä»»åŠ¡ä¸Šçš„å˜åŠ¨ï¼Œå¯ä»¥åˆ†åˆ«å¯¹æ•°æ®é›†å’Œå¥–åŠ±å‡½æ•°åšå¯¹åº”çš„æ”¹å˜å³å¯ã€‚</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiModalAccuracyORM</span><span class="p">(</span><span class="n">ORM</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completions</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reward function that checks if the completion is correct.</span>
<span class="sd">        Args:</span>
<span class="sd">            completions (list[str]): Generated outputs</span>
<span class="sd">            solution (list[str]): Ground Truths.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[float]: Reward scores</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">math_verify</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span><span class="p">,</span> <span class="n">verify</span>
        <span class="k">for</span> <span class="n">content</span><span class="p">,</span> <span class="n">sol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">completions</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># Try symbolic verification first</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">verify</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="n">parse</span><span class="p">(</span><span class="n">sol</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Continue to next verification method if this fails</span>

            <span class="c1"># If symbolic verification failed, try string matching</span>
            <span class="k">if</span> <span class="n">reward</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Extract answer from solution if it has think/answer tags</span>
                    <span class="n">sol_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;answer&gt;(.*?)&lt;/answer&gt;&#39;</span><span class="p">,</span> <span class="n">sol</span><span class="p">)</span>
                    <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">sol_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">sol_match</span> <span class="k">else</span> <span class="n">sol</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="c1"># Extract answer from content if it has think/answer tags</span>
                    <span class="n">content_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;answer&gt;(.*?)&lt;/answer&gt;&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
                    <span class="n">student_answer</span> <span class="o">=</span> <span class="n">content_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">content_match</span> <span class="k">else</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="c1"># Compare the extracted answers</span>
                    <span class="k">if</span> <span class="n">student_answer</span> <span class="o">==</span> <span class="n">ground_truth</span><span class="p">:</span>
                        <span class="n">reward</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># Keep reward as 0.0 if both methods fail</span>
            <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rewards</span>
<span class="n">orms</span><span class="p">[</span><span class="s1">&#39;external_r1v_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MultiModalAccuracyORM</span>
</pre></div>
</div>
<section id="id3">
<h3>GRPOè®­ç»ƒå®éªŒè®°å½•<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h3>
<section id="id4">
<h4>è®­ç»ƒå‚æ•°ï¼š<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h4>
<p>æˆ‘ä»¬é€‰å– Qwen2.5-VL-3B-Instruct ä½œä¸ºåŸºç¡€æ¨¡å‹è¿›è¡Œè®­ç»ƒï¼Œé€‰å– Instruct è€Œä¸æ˜¯åŸºæ¨¡çš„ä¸»è¦åŸå› æ˜¯å¯ä»¥æ›´å¿«åœ°è·å– format rewardã€‚æˆ‘ä»¬åœ¨å…«å¡ GPU ä¸Šè¿›è¡Œå®éªŒã€‚å¦‚æœé‡åˆ°vllméƒ¨ç½²qwen2.5-vlæŠ¥é”™ï¼Œå¯ä»¥å‚è€ƒ<a class="reference external" href="https://github.com/vllm-project/vllm/issues/13285">issue</a></p>
<p>ç”±äºä»»åŠ¡ç®€å•ï¼Œæˆ‘ä»¬è®¾ç½®max_completion_lengthä¸º1024ï¼Œå¥–åŠ±å‡½æ•°é€‰æ‹©external_r1v_accå’Œformatï¼Œå­¦ä¹ ç‡å’Œbetaåˆ†åˆ«è®¾ç½®ä¸º1e-6å’Œ0.001ã€‚å…¶ä»–è®¾ç½®å¦‚ä¸‹æ‰€ç¤ºï¼Œbatch_sizeå’Œnum_generationsçš„è®¾ç½®åŸåˆ™å¯ä»¥å‚è€ƒ<a class="reference internal" href="GRPO.html"><span class="doc">GRPOå®Œæ•´æµç¨‹</span></a>ã€‚
é¦–å…ˆæ‹‰èµ· external vLLM server</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">6</span>,7<span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>rollout<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model<span class="w"> </span>Qwen/Qwen2.5-VL-3B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_data_parallel_size<span class="w"> </span><span class="m">2</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">WANDB_API_KEY</span><span class="o">=</span>your_wandb_api_key<span class="w"> </span><span class="se">\</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1,2,3,4,5<span class="w"> </span><span class="se">\</span>
<span class="nv">NPROC_PER_NODE</span><span class="o">=</span><span class="m">6</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>rlhf<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--rlhf_type<span class="w"> </span>grpo<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model<span class="w"> </span>Qwen/Qwen2.5-VL-3B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--external_plugins<span class="w"> </span>examples/train/grpo/plugin/plugin.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--reward_funcs<span class="w"> </span>external_r1v_acc<span class="w"> </span>format<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--use_vllm<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_mode<span class="w"> </span>server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_server_host<span class="w"> </span><span class="m">127</span>.0.0.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_server_port<span class="w"> </span><span class="m">8000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--tuner_type<span class="w"> </span>full<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--torch_dtype<span class="w"> </span>bfloat16<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataset<span class="w"> </span><span class="s1">&#39;AI-ModelScope/clevr_cogen_a_train&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--load_from_cache_file<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_completion_length<span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_train_epochs<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_train_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--learning_rate<span class="w"> </span>1e-6<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_strategy<span class="w"> </span><span class="s1">&#39;steps&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--eval_strategy<span class="w"> </span><span class="s1">&#39;steps&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--eval_steps<span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_steps<span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_total_limit<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--logging_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--output_dir<span class="w"> </span>output/GRPO_CLEVR_COUNTDOWN<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--warmup_ratio<span class="w"> </span><span class="m">0</span>.01<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataloader_num_workers<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_generations<span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--temperature<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--system<span class="w"> </span><span class="s1">&#39;examples/train/grpo/prompt.txt&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--deepspeed<span class="w"> </span>zero3<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--log_completions<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--report_to<span class="w"> </span>wandb<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_iterations<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--async_generate<span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--beta<span class="w"> </span><span class="m">0</span>.001<span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
</section>
<section id="id5">
<h4>å®éªŒç°è±¡<a class="headerlink" href="#id5" title="Link to this heading">ïƒ</a></h4>
<p><img alt="image.png" src="../../../../../../_images/grpo_clevr_count.png" />
ç”±äºæ•°æ®é›†å’Œä»»åŠ¡æ¯”è¾ƒç®€å•ï¼Œæ¨¡å‹è®­ç»ƒäº†500ä¸ªepochå·²ç»åŸºæœ¬æ”¶æ•›ï¼Œæœ‰ä»¥ä¸‹è§‚å¯Ÿã€‚</p>
<ol class="simple">
<li><p>è‡ªå®šä¹‰çš„ClevrORMåœ¨ä¸æ–­å¢åŠ ï¼Œè¯æ˜æ¨¡å‹å­¦ä¹ åˆ°äº†å¦‚ä½•å®Œæˆè¿™ä¸€ä»»åŠ¡ï¼Œæœ€ç»ˆä»»åŠ¡æˆåŠŸç‡ä»åˆå§‹çš„0.4æ”€å‡åˆ°1å·¦å³ã€‚</p></li>
<li><p>ç”±äºæ˜¯Instructæ¨¡å‹ï¼ŒFormat RewardåŸºæœ¬ç¨³å®šåœ¨1ï¼Œè¿™å¯èƒ½ä¹Ÿä¸æ•°æ®é›†æ‰€æœ‰æ ·æœ¬éƒ½æ˜¯ä¸€æ ·çš„queryæœ‰ä¸€å®šå…³ç³»ã€‚</p></li>
<li><p>reward_std ç¨³å®šåˆ°0.1ä»¥ä¸‹ã€‚</p></li>
<li><p>completion lengthæœ€ç»ˆç¨³å®šåœ¨60-80ï¼Œæ¨¡å‹å­¦ä¹ åˆ°çš„å›ºå®šè¾“å‡ºèŒƒå¼æ˜¯é€ä¸ªç‰©ä½“åˆ—ä¸¾æ•°æ•°ã€‚</p></li>
</ol>
<p>step 1:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;&lt;think&gt; The image shows 5 distinct items: a cyan metallic cylinder, a red metallic cylinder, a small purple metallic cylinder, a large gray metallic sphere, and a small yellow metallic cube. To count the number of items, I add the counts of each type of object: 1 cyan cylinder, 1 red cylinder, 1 purple cylinder, 1 gray sphere, and 1 yellow cube. Therefore, the total number of items is 5. &lt;/think&gt;</span><span class="se">\n</span><span class="s2">&lt;answer&gt;5&lt;/answer&gt;&quot;</span>
<span class="s2">&quot;Let&#39;s count the number of items in the image:</span><span class="se">\n</span><span class="s2">1. A large cyan metallic cylinder.</span><span class="se">\n</span><span class="s2">2. A small purple metallic cylinder.</span><span class="se">\n</span><span class="s2">3. A large red metallic cylinder.</span><span class="se">\n</span><span class="s2">4. A large gray metallic sphere.</span><span class="se">\n</span><span class="s2">5. A small yellow metallic cube.</span><span class="se">\n\n</span><span class="s2">&lt;answer&gt;5&lt;/answer&gt;&quot;</span>
<span class="s2">&quot;&lt;think&gt; The image shows four distinct objects: a large cyan metallic cylinder, a smaller purple metallic cylinder, a large red metallic cylinder, and a small yellow metallic cube. Counting each of these items individually, there are five items in total. &lt;/think&gt;</span><span class="se">\n</span><span class="s2">&lt;answer&gt;5&lt;/answer&gt;&quot;</span>
</pre></div>
</div>
<p>step 400:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;&lt;think&gt; Counting the number of items in the image:</span><span class="se">\n</span><span class="s2">1. Green matte sphere</span><span class="se">\n</span><span class="s2">2. Large metallic yellow sphere</span><span class="se">\n</span><span class="s2">3. Small metallic brown cube</span><span class="se">\n\n</span><span class="s2">There are three distinct objects in total.</span><span class="se">\n</span><span class="s2">&lt;/think&gt;</span><span class="se">\n</span><span class="s2">&lt;answer&gt;3&lt;/answer&gt;&quot;</span>
<span class="s2">&quot;&lt;think&gt; Counting the objects in the image:</span><span class="se">\n</span><span class="s2">1. Large yellow metallic sphere</span><span class="se">\n</span><span class="s2">2. Small green rubber sphere</span><span class="se">\n</span><span class="s2">3. Small brown metallic cube</span><span class="se">\n\n</span><span class="s2">There are three distinct items in the image.</span><span class="se">\n</span><span class="s2">&lt;/think&gt;</span><span class="se">\n</span><span class="s2">&lt;answer&gt;3&lt;/answer&gt;&quot;</span>
</pre></div>
</div>
<p>æ€»ä½“æ¥è®²ï¼Œè¿™ä¸€ä»»åŠ¡æ¯”è¾ƒç®€å•ï¼Œrewardçš„æ”¶æ•›ä¹Ÿæ¯”è¾ƒå…¸å‹ã€‚</p>
</section>
</section>
</section>
<section id="geometric-qa">
<h2>Geometric QAä»»åŠ¡<a class="headerlink" href="#geometric-qa" title="Link to this heading">ïƒ</a></h2>
<section id="id6">
<h3>ä»»åŠ¡ä¸æ•°æ®é›†å®šä¹‰<a class="headerlink" href="#id6" title="Link to this heading">ïƒ</a></h3>
<p>æœ¬ä»»åŠ¡ä¸ºGeometric QAä»»åŠ¡ï¼Œä»»åŠ¡æè¿°ä¸ºï¼šç»™å®šä¸€ä¸ªå‡ ä½•å›¾å½¢ï¼Œå›ç­”æœ‰å…³å‡ ä½•å›¾å½¢çš„æ•°å­¦é—®é¢˜ã€‚åŸå§‹æ•°æ®æ¥è‡ªäº<a class="reference external" href="https://arxiv.org/pdf/2312.11370">è®ºæ–‡</a>ï¼Œ<a class="reference external" href="https://github.com/Deep-Agent/R1-V.git">R1-V</a>å¯¹æ•°æ®è¿›è¡Œäº†é¢„å¤„ç†ï¼Œå°†æ‰€æœ‰æ•°æ®å…¨éƒ¨å¤„ç†æˆäº†problem-solutionçš„æ ¼å¼ï¼Œè€Œå›¾åƒåˆ™ä¿ç•™åœ¨imageå­—æ®µä¸­ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¸éœ€è¦é¢å¤–å®šä¹‰æ•°æ®é›†ï¼Œç›´æ¥ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">--dataset</span> <span class="pre">AI-ModelScope/GEOQA_R1V_Train_8K</span></code>å³å¯ã€‚</p>
</section>
<section id="id7">
<h3>å¥–åŠ±å‡½æ•°<a class="headerlink" href="#id7" title="Link to this heading">ïƒ</a></h3>
<p>ç”±äºä¹Ÿæ˜¯æ•°å­¦é¢˜ï¼ŒåŒæ—¶ï¼Œç­”æ¡ˆä¹Ÿå¤„ç†æˆäº†æœ€ç»ˆç»“æœï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ä»¥ä¸Šå®šä¹‰è¿‡çš„<code class="docutils literal notranslate"><span class="pre">MultiModalAccuracyORM</span></code>å¥–åŠ±å‡½æ•°ã€‚</p>
</section>
<section id="id8">
<h3>GRPOè®­ç»ƒå®éªŒè®°å½•<a class="headerlink" href="#id8" title="Link to this heading">ïƒ</a></h3>
<section id="id9">
<h4>è®­ç»ƒå‚æ•°ï¼š<a class="headerlink" href="#id9" title="Link to this heading">ïƒ</a></h4>
<p>é€‰å–çš„æ¨¡å‹å’Œå¤§éƒ¨åˆ†è¶…å‚æ•°ä¸ä¸Šä¸€ä¸ªå®éªŒç›¸ä¼¼ï¼Œä¸»è¦æœ‰ä¸¤ç‚¹ä¸åŒï¼š</p>
<ol class="simple">
<li><p>SWIFT å·²æ”¯æŒ<code class="docutils literal notranslate"><span class="pre">--num_iteration</span></code>å‚æ•°ï¼Œå•æ¬¡rolloutå¯ä»¥è¿›è¡Œå¤šæ¬¡æ›´æ–°ï¼Œè¿™é‡Œè®¾ç½®ä¸º2ã€‚</p></li>
<li><p>åœ¨å®éªŒæ—¶å‘ç°ï¼Œåœ¨æ•°å­¦é—®é¢˜ä¸­ï¼Œè®­ç»ƒå¯èƒ½ä¼šå‡ºç°ä¸ç¨³å®šç°è±¡ï¼Œå¯¼è‡´æ¨¡å‹è®­å´©ï¼Œå…·ä½“è¡¨ç°ä¸ºæ‰€æœ‰rewarè¿…é€Ÿé™ä½ï¼Œlossã€grad_normå’Œkléƒ½è¿…é€Ÿå¢å¤§ï¼Œåç»­ä¹Ÿéš¾ä»¥æ¢å¤æ­£å¸¸çŠ¶æ€ã€‚å› æ­¤ï¼Œè¿™é‡Œè®¾ç½®<code class="docutils literal notranslate"><span class="pre">--max_grad_norm</span> <span class="pre">0.5</span></code>ï¼Œä¿è¯ç¨³å®šè®­ç»ƒï¼Œå½“ç„¶ï¼Œè¿™ç§ç°è±¡çš„å‡ºç°ä¹Ÿæœ‰ä¸€å®šçš„éšæœºæ€§ã€‚</p></li>
</ol>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">WANDB_API_KEY</span><span class="o">=</span>your_wandb_api_key<span class="w"> </span><span class="se">\</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1,2,3,4,5<span class="w"> </span><span class="se">\</span>
<span class="nv">MAX_PIXELS</span><span class="o">=</span><span class="m">401408</span><span class="w"> </span><span class="se">\</span>
<span class="nv">NPROC_PER_NODE</span><span class="o">=</span><span class="m">6</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>rlhf<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--rlhf_type<span class="w"> </span>grpo<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model<span class="w"> </span>Qwen/Qwen2.5-VL-3B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--external_plugins<span class="w"> </span>examples/train/grpo/plugin/plugin.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--reward_funcs<span class="w"> </span>external_r1v_acc<span class="w"> </span>format<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--use_vllm<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_mode<span class="w"> </span>server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_server_host<span class="w"> </span><span class="m">127</span>.0.0.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_server_port<span class="w"> </span><span class="m">8000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--tuner_type<span class="w"> </span>full<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--torch_dtype<span class="w"> </span>bfloat16<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataset<span class="w"> </span><span class="s1">&#39;AI-ModelScope/GEOQA_R1V_Train_8K&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--load_from_cache_file<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_completion_length<span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_train_epochs<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_train_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--learning_rate<span class="w"> </span>1e-6<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_strategy<span class="w"> </span><span class="s1">&#39;steps&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--eval_strategy<span class="w"> </span><span class="s1">&#39;steps&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--eval_steps<span class="w"> </span><span class="m">400</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_steps<span class="w"> </span><span class="m">400</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_total_limit<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--logging_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--output_dir<span class="w"> </span>output/GRPO_GEOQA<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--warmup_ratio<span class="w"> </span><span class="m">0</span>.05<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataloader_num_workers<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_generations<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--temperature<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--repetition_penalty<span class="w"> </span><span class="m">1</span>.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--system<span class="w"> </span><span class="s1">&#39;examples/train/grpo/prompt.txt&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--deepspeed<span class="w"> </span>zero3<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--log_completions<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--report_to<span class="w"> </span>wandb<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_iterations<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--async_generate<span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--beta<span class="w"> </span><span class="m">0</span>.001<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_grad_norm<span class="w"> </span><span class="m">0</span>.5<span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
</section>
<section id="id10">
<h4>å®éªŒç°è±¡<a class="headerlink" href="#id10" title="Link to this heading">ïƒ</a></h4>
<p><img alt="image.png" src="../../../../../../_images/grpo_geoqa.png" />
è®­ç»ƒæ›²çº¿å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p>
<ol class="simple">
<li><p>ç›¸æ¯”äºCountä»»åŠ¡ï¼ŒGeometric QAä»»åŠ¡çš„éš¾åº¦æ˜æ˜¾æ›´å¤§ï¼Œå› æ­¤ï¼ŒAccuracy Rewardæ”¶æ•›æ˜æ˜¾æ›´æ…¢ï¼ŒåŒæ—¶éœ‡è¡å¹…åº¦ä¹Ÿæ˜æ˜¾æ›´å¤§ã€‚</p></li>
<li><p>completion_lengthçš„å˜åŒ–è¶‹åŠ¿æ¯”è¾ƒæ˜æ˜¾ï¼Œæœ€ç»ˆæ”¶æ•›åˆ°250 tokenå·¦å³ã€‚</p></li>
<li><p>rewardåŸºæœ¬æ”¶æ•›ï¼Œæ ‡å‡†å·®åœ¨ä¸€å…±1300ä¸ªstepæ—¶ç¨³å®šåœ¨0.2å·¦å³ã€‚
ä»¥ä¸‹æ˜¯è®­ç»ƒåçš„æ¨¡å‹completitionç¤ºä¾‹ï¼š</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="p">:</span>
<span class="s2">&quot;If AB is the tangent to circle O with the tangent point A, and BO intersects circle O at point C, and point D is located on circle O, what is the measure of angle ADC if the degree of angle ABO is 32.0?&quot;</span>
<span class="n">Assistant</span><span class="p">:</span>
<span class="s2">&quot;&lt;think&gt;</span><span class="se">\n</span><span class="s2">To find the measure of angle ADC, we first need to understand the properties of the tangent and the circle. Since AB is a tangent to the circle at point A, the line segment OA (which is perpendicular to the tangent AB) is perpendicular to AB. This means that angle OAB is 90 degrees.</span><span class="se">\n\n</span><span class="s2">Given that angle ABO is 32 degrees, we can find angle BAO by subtracting angle ABO from 90 degrees:</span><span class="se">\n</span><span class="s2">âˆ BAO = 90Â° - âˆ ABO = 90Â° - 32Â° = 58Â°</span><span class="se">\n\n</span><span class="s2">Since angle BAO is an angle in the minor arc AD, the angle ADC, which is an angle in the minor arc AD, is half the angle BAO. Therefore, angle ADC is:</span><span class="se">\n</span><span class="s2">âˆ ADC = 1/2 Ã— âˆ BAO = 1/2 Ã— 58Â° = 29Â°</span><span class="se">\n\n</span><span class="s2">So, the measure of angle ADC is 29 degrees.</span><span class="se">\n</span><span class="s2">&lt;/think&gt;</span><span class="se">\n</span><span class="s2">&lt;answer&gt;</span><span class="se">\n</span><span class="s2">The measure of angle ADC is 29 degrees.</span><span class="se">\n</span><span class="s2">&lt;/answer&gt;&quot;</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="multimodal-open-r1">
<h2>Multimodal Open R1 æ•°æ®é›†å®éªŒ<a class="headerlink" href="#multimodal-open-r1" title="Link to this heading">ïƒ</a></h2>
<section id="id11">
<h3>ä»»åŠ¡ä¸æ•°æ®é›†å®šä¹‰<a class="headerlink" href="#id11" title="Link to this heading">ïƒ</a></h3>
<p>æœ¬ä»»åŠ¡ä¸ºå‚è€ƒ<a class="reference external" href="https://github.com/EvolvingLMMs-Lab/open-r1-multimodal.git">open-r1-multimodal</a>çš„å®éªŒï¼Œä½¿ç”¨æ•°æ®é›†ï¼š<a class="reference external" href="https://www.modelscope.cn/datasets/lmms-lab/multimodal-open-r1-8k-verified">lmms-lab/multimodal-open-r1-8k-verified</a>ï¼Œè¯¥æ•°æ®é›†ä¸“æ³¨äºå¤šæ¨¡æ€çš„æ•°å­¦æ¨ç†ä»»åŠ¡ï¼Œæ•°æ®ç”±GPT4oåŸºäº<code class="docutils literal notranslate"><span class="pre">Math360K</span></code>å’Œ<code class="docutils literal notranslate"><span class="pre">Geo170K</span></code>æ•°æ®é›†ç”Ÿæˆï¼ŒåŒ…å«æ¨ç†è·¯å¾„å’Œå¯éªŒè¯ç­”æ¡ˆã€‚æ•°æ®é›†ä¸­å·²åŒ…å«äº†image, problemå’Œsolutionå­—æ®µï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦é’ˆå¯¹promptè¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤æ— éœ€é¢å¤–å®šä¹‰æ•°æ®é›†ã€‚</p>
</section>
<section id="id12">
<h3>å¥–åŠ±å‡½æ•°<a class="headerlink" href="#id12" title="Link to this heading">ïƒ</a></h3>
<p>æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ä»¥ä¸Šå®šä¹‰è¿‡çš„<code class="docutils literal notranslate"><span class="pre">MultiModalAccuracyORM</span></code>å¥–åŠ±å‡½æ•°ã€‚</p>
</section>
<section id="id13">
<h3>GRPOè®­ç»ƒå®éªŒè®°å½•<a class="headerlink" href="#id13" title="Link to this heading">ïƒ</a></h3>
<section id="id14">
<h4>è®­ç»ƒå‚æ•°ï¼š<a class="headerlink" href="#id14" title="Link to this heading">ïƒ</a></h4>
<p>é€‰å–çš„æ¨¡å‹å’Œå¤§éƒ¨åˆ†è¶…å‚æ•°ä¸ä¸Šä¸€ä¸ªå®éªŒç›¸ä¼¼ï¼Œç”±äºè®­ç»ƒçš„æ—¶å€™å‡ºç°äº†OOMï¼Œæˆ‘ä»¬è®¾ç½®<code class="docutils literal notranslate"><span class="pre">MAX_PIXELS=262144</span></code>ä»¥é™ä½æ˜¾å­˜å ç”¨ã€‚</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">WANDB_API_KEY</span><span class="o">=</span>your_wandb_api_key<span class="w"> </span><span class="se">\</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1,2,3,4,5<span class="w"> </span><span class="se">\</span>
<span class="nv">MAX_PIXELS</span><span class="o">=</span><span class="m">262144</span><span class="w"> </span><span class="se">\</span>
<span class="nv">MASTER_PORT</span><span class="o">=</span><span class="m">29600</span><span class="w"> </span><span class="se">\</span>
<span class="nv">NPROC_PER_NODE</span><span class="o">=</span><span class="m">6</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>rlhf<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--rlhf_type<span class="w"> </span>grpo<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model<span class="w"> </span>Qwen/Qwen2.5-VL-3B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--external_plugins<span class="w"> </span>examples/train/grpo/plugin/plugin.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--reward_funcs<span class="w"> </span>external_r1v_acc<span class="w"> </span>format<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--use_vllm<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_mode<span class="w"> </span>server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_server_host<span class="w"> </span><span class="m">127</span>.0.0.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_server_port<span class="w"> </span><span class="m">8000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--tuner_type<span class="w"> </span>full<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--torch_dtype<span class="w"> </span>bfloat16<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataset<span class="w"> </span><span class="s1">&#39;lmms-lab/multimodal-open-r1-8k-verified&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--load_from_cache_file<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_completion_length<span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_train_epochs<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_train_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--learning_rate<span class="w"> </span>1e-6<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_strategy<span class="w"> </span><span class="s1">&#39;steps&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--eval_strategy<span class="w"> </span><span class="s1">&#39;steps&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--eval_steps<span class="w"> </span><span class="m">400</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_steps<span class="w"> </span><span class="m">400</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_total_limit<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--logging_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--output_dir<span class="w"> </span>output/GRPO_GEOQA<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--warmup_ratio<span class="w"> </span><span class="m">0</span>.05<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataloader_num_workers<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_generations<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--temperature<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--repetition_penalty<span class="w"> </span><span class="m">1</span>.1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--system<span class="w"> </span><span class="s1">&#39;examples/train/grpo/prompt.txt&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--deepspeed<span class="w"> </span>zero3<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--log_completions<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--report_to<span class="w"> </span>wandb<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_iterations<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--async_generate<span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--beta<span class="w"> </span><span class="m">0</span>.001<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_grad_norm<span class="w"> </span><span class="m">0</span>.5<span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
</section>
<section id="id15">
<h4>å®éªŒç°è±¡<a class="headerlink" href="#id15" title="Link to this heading">ïƒ</a></h4>
<p><img alt="image.png" src="../../../../../../_images/grpo_openr1_multimodal.png" />
è®­ç»ƒæ›²çº¿å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚
ä¸€å…±8kæ•°æ®ï¼Œè®­ç»ƒäº†1268ä¸ªstepï¼ŒAccuracy Rewardæ”¶æ•›åˆ°0.5å·¦å³ï¼Œcompletion_lengthåŸºæœ¬æ”¶æ•›åˆ°200tokenå·¦å³ï¼Œreward_stdæœ€ç»ˆåœ¨0.2å·¦å³éœ‡è¡ã€‚
ä»¥ä¸‹æ˜¯è®­ç»ƒåçš„æ¨¡å‹completitionç¤ºä¾‹ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">User</span><span class="p">:</span>
<span class="s2">&quot;Based on the map, which state falls into the lowest percentage range of lots, and what is that percentage range?&quot;</span>
<span class="n">Assistant</span><span class="p">:</span>
<span class="s2">&quot;&lt;think&gt;</span><span class="se">\n</span><span class="s2">The image provided shows a color-coded map of the USA indicating different ranges of lot percentages across various states. According to the legend at the bottom, the lowest percentage range (6.0</span><span class="si">% - 6.5%</span><span class="s2">) is represented by white. In the image, Alabama (AL) is shaded in white, which corresponds to the 6.0</span><span class="si">% - 6.5%</span><span class="s2"> category. Therefore, based on the map, the state that falls into the lowest percentage range of lots is Alabama, with the percentage range of 6.0</span><span class="si">% - 6.5%</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Therefore, the answer is 6.0</span><span class="si">% - 6.5%</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&lt;/think&gt;</span><span class="se">\n</span><span class="s2">&lt;answer&gt;Alabama&lt;/answer&gt;&quot;</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>