

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ³¨å†Œå¤šæ¨¡æ€æ¨¡å‹æœ€ä½³å®è·µ &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">æ³¨å†Œå¤šæ¨¡æ€æ¨¡å‹æœ€ä½³å®è·µ</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/sources/_generated/sources/ms-swift/source/BestPractices/MLLM-Registration.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>æ³¨å†Œå¤šæ¨¡æ€æ¨¡å‹æœ€ä½³å®è·µ<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h1>
<p>æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ms-swiftä¸­æ³¨å†Œå¤šæ¨¡æ€æ¨¡å‹ï¼Œå¹¶æˆåŠŸæ¨ç†å’Œè®­ç»ƒã€‚æœ¬æ–‡å°†ä»¥Qwen2.5-Omniä¸ºä¾‹å­ï¼Œæ³¨å†Œæ–°çš„model_typeå’Œtemplate <code class="docutils literal notranslate"><span class="pre">my_qwen2_5_omni</span></code>ï¼Œå¹¶æ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘å’ŒéŸ³é¢‘çš„è®­ç»ƒã€‚ç”±äºQwen2.5-Omniå·²ç»åœ¨ms-swiftä¸­æ³¨å†Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ˜¾å¼æŒ‡å®šmodel_typeå’Œtemplateæ¥ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„éƒ¨åˆ†ã€‚</p>
<section id="id2">
<h2>ç¯å¢ƒå‡†å¤‡<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># é¿å…æœªæ¥å‡ºç°ä¸æ–‡æ¡£çš„ä¸å…¼å®¹æƒ…å†µ</span>
pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;ms-swift&gt;=4.0&quot;</span>

pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;transformers==4.57.*&quot;</span><span class="w"> </span><span class="s2">&quot;qwen_omni_utils==0.0.8&quot;</span>
</pre></div>
</div>
</section>
<section id="id3">
<h2>æ³¨å†Œæ¨¡å‹<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h2>
<p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦æ³¨å†Œæ¨¡å‹ï¼Œæ¥è·å–æ¨¡å‹å’Œprocessorã€‚</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">PretrainedConfig</span><span class="p">,</span> <span class="n">PreTrainedModel</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">swift.model</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">ModelGroup</span><span class="p">,</span> <span class="n">ModelMeta</span><span class="p">,</span> <span class="n">MultiModelKeys</span><span class="p">,</span> <span class="n">get_model_processor</span><span class="p">,</span> <span class="n">register_model</span><span class="p">,</span>
                         <span class="n">register_model_arch</span><span class="p">,</span> <span class="n">ModelLoader</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.model.models.qwen</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch_qwen_vl_utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.model.patcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch_get_input_embeddings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.model.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">use_submodel_func</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_env_args</span><span class="p">,</span> <span class="n">Processor</span>

<span class="n">register_model_arch</span><span class="p">(</span>
    <span class="n">MultiModelKeys</span><span class="p">(</span>
        <span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">,</span>
        <span class="c1"># `freeze_llm`, `freeze_vit`, `freeze_aligner`å°†æ ¹æ®ä¸‹é¢çš„å€¼æ¥å†³å®šå…¶è¡Œä¸ºã€‚</span>
        <span class="c1"># ä¾‹å¦‚ï¼šå…¨å‚æ•°è®­ç»ƒï¼Œè‹¥è®¾ç½®`freeze_vit=True`ï¼Œå°†å†»ç»“ä»¥`thinker.audio_tower`å’Œ`thinker.visual`ä¸ºå‰ç¼€çš„æ¨¡å‹å±‚çš„å‚æ•°ã€‚</span>
        <span class="c1"># LoRAè®­ç»ƒï¼Œè‹¥è®¾ç½®`freeze_vit=False`ï¼Œå°†é¢å¤–ä¸ºä»¥`thinker.audio_tower`å’Œ`thinker.visual`ä¸ºå‰ç¼€çš„Linearå±‚æ·»åŠ LoRAã€‚</span>
        <span class="n">language_model</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;thinker.model&#39;</span><span class="p">,</span> <span class="s1">&#39;thinker.lm_head&#39;</span><span class="p">],</span>
        <span class="n">vision_tower</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;thinker.audio_tower&#39;</span><span class="p">,</span> <span class="s1">&#39;thinker.visual&#39;</span><span class="p">],</span>
        <span class="n">aligner</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;thinker.audio_tower.proj&#39;</span><span class="p">,</span> <span class="s1">&#39;thinker.visual.merger&#39;</span><span class="p">],</span>
        <span class="c1"># generatorçš„éƒ¨åˆ†å°†æ°¸è¿œä¸è¿›è¡Œè®­ç»ƒæˆ–å¤„äºå†»ç»“çŠ¶æ€ã€‚</span>
        <span class="c1"># å¦‚æœä½ å¸Œæœ›`thinker.audio_tower`, `thinker.audio_tower.proj`æ°¸è¿œä¸è¿›è¡Œè®­ç»ƒï¼Œä½ å¯ä»¥æ”¾ç½®åˆ°generatorä¸­ï¼Œå¹¶å°†å…¶ä»vision_tower, alignerä¸­ç§»é™¤ã€‚</span>
        <span class="n">generator</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;talker&#39;</span><span class="p">,</span> <span class="s1">&#39;token2wav&#39;</span><span class="p">],</span>
    <span class="p">))</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Qwen2_5OmniLoader</span><span class="p">(</span><span class="n">ModelLoader</span><span class="p">):</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PretrainedConfig</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qwen2_5OmniConfig</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Qwen2_5OmniConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">enable_audio_output</span> <span class="o">=</span> <span class="n">get_env_args</span><span class="p">(</span><span class="s1">&#39;ENABLE_AUDIO_OUTPUT&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enable_audio_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">enable_audio_output</span> <span class="o">=</span> <span class="n">enable_audio_output</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PretrainedConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Processor</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qwen2_5OmniProcessor</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">qwen_omni_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">vision_process</span>
        <span class="n">processor</span> <span class="o">=</span> <span class="n">Qwen2_5OmniProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Control constants in qwen_omni_utils library via environment variables,</span>
        <span class="c1"># e.g., `MAX_PIXELS`, etc.</span>
        <span class="n">patch_qwen_vl_utils</span><span class="p">(</span><span class="n">vision_process</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">processor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">PretrainedConfig</span><span class="p">,</span> <span class="n">processor</span><span class="p">:</span> <span class="n">Processor</span><span class="p">,</span>
                  <span class="n">model_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qwen2_5OmniForConditionalGeneration</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Run my_qwen2_5_omni...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_model_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_model_cls</span> <span class="ow">or</span> <span class="n">Qwen2_5OmniForConditionalGeneration</span>
        <span class="n">model</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">)</span>
        <span class="c1"># For multimodal model consistency, we replace the model&#39;s forward/generate functions</span>
        <span class="c1"># with those of its language_model.</span>
        <span class="c1"># Handle additional parts separately.</span>
        <span class="n">use_submodel_func</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;thinker&#39;</span><span class="p">)</span>
        <span class="c1"># Avoid inplace operations on leaf_variable during training</span>
        <span class="c1"># (replacing parts of input_embeds with images_embeds)</span>
        <span class="n">patch_get_input_embeddings</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">thinker</span><span class="o">.</span><span class="n">visual</span><span class="p">,</span> <span class="s1">&#39;patch_embed&#39;</span><span class="p">)</span>
        <span class="c1"># Some custom settings for model/config (usually not needed; configure based on</span>
        <span class="c1"># specific model if errors occur during training/inference)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">keys_to_ignore_at_inference</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;hidden_states&#39;</span><span class="p">,</span> <span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">talker_config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">model</span>


<span class="n">register_model</span><span class="p">(</span>
    <span class="n">ModelMeta</span><span class="p">(</span>
        <span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="n">ModelGroup</span><span class="p">([</span>
                <span class="n">Model</span><span class="p">(</span><span class="s1">&#39;Qwen/Qwen2.5-Omni-3B&#39;</span><span class="p">,</span> <span class="s1">&#39;Qwen/Qwen2.5-Omni-3B&#39;</span><span class="p">),</span>
                <span class="n">Model</span><span class="p">(</span><span class="s1">&#39;Qwen/Qwen2.5-Omni-7B&#39;</span><span class="p">,</span> <span class="s1">&#39;Qwen/Qwen2.5-Omni-7B&#39;</span><span class="p">),</span>
            <span class="p">]),</span>
        <span class="p">],</span>
        <span class="c1"># ç”¨æ¥è·å–modelå’Œprocessorçš„å‡½æ•°ã€‚</span>
        <span class="n">Qwen2_5OmniLoader</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">,</span>
        <span class="n">is_multimodal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># æ˜¯å¦æ˜¯å¤šæ¨¡æ€æ¨¡å‹</span>
        <span class="n">model_arch</span><span class="o">=</span><span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">,</span>  <span class="c1"># é€šå¸¸åªä¸ºå¤šæ¨¡æ€æ¨¡å‹è®¾ç½®</span>
        <span class="c1"># ç”¨äºmodel_typeçš„è‡ªåŠ¨åŒ¹é…</span>
        <span class="n">architectures</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Qwen2_5OmniModel&#39;</span><span class="p">,</span> <span class="s1">&#39;Qwen2_5OmniForConditionalGeneration&#39;</span><span class="p">],</span>
        <span class="c1"># ç”¨æ¥æç¤ºç”¨æˆ·ä¾èµ–ç‰ˆæœ¬ï¼ˆå¯åˆ é™¤ï¼‰</span>
        <span class="n">requires</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;transformers&gt;=4.50&#39;</span><span class="p">,</span> <span class="s1">&#39;soundfile&#39;</span><span class="p">,</span> <span class="s1">&#39;qwen_omni_utils&#39;</span><span class="p">,</span> <span class="s1">&#39;decord&#39;</span><span class="p">],</span>
        <span class="c1"># ç”¨æ¥æç¤ºç”¨æˆ·ï¼ˆå¯åˆ é™¤ï¼‰</span>
        <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;audio&#39;</span><span class="p">],</span>
        <span class="c1"># å…¨å‚æ•°è®­ç»ƒ/merge-loraéœ€è¦é¢å¤–ä¿å­˜çš„æ–‡ä»¶</span>
        <span class="n">additional_saved_files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;spk_dict.pt&#39;</span><span class="p">],</span>
    <span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># æµ‹è¯•ä¸debug</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">processor</span> <span class="o">=</span> <span class="n">get_model_processor</span><span class="p">(</span><span class="s1">&#39;Qwen/Qwen2.5-Omni-7B&#39;</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id4">
<h2>æ³¨å†Œæ¨¡æ¿<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h2>
<p>ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬éœ€è¦æ³¨å†Œæ¨¡æ¿ï¼Œæ¥è‡ªå®šä¹‰å¦‚ä½•å°†æ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘å’ŒéŸ³é¢‘è¿›è¡Œé¢„å¤„ç†ï¼ˆ<code class="docutils literal notranslate"><span class="pre">_encode</span></code>å’Œ<code class="docutils literal notranslate"><span class="pre">_data_collator</span></code>æ–¹æ³•ï¼‰ã€‚è¿™æ˜¯ms-swiftæ”¯æŒå¤šæ¨¡æ€æ¨¡å‹è®­ç»ƒçš„å…³é”®æ¨¡å—ã€‚é¢„å¤„ç†æ–¹å¼è¯·å‚è€ƒtransformersæ¨ç†å®ç°ï¼Œå¹¶è¿›è¡Œå¯¹é½ã€‚</p>
<p>templateçš„åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ol class="simple">
<li><p>æ”¯æŒæ­£å¸¸æ¨ç†ä¸è®­ç»ƒï¼Œé¢„å¤„ç†æ–‡æœ¬å’Œå¤šæ¨¡æ€ä¿¡æ¯ï¼Œå¹¶æ”¯æŒgroundingä»»åŠ¡ã€‚</p></li>
<li><p>æ”¯æŒpadding_freeå’Œpackingè®­ç»ƒã€‚</p></li>
<li><p>æ”¯æŒæ··åˆæ¨¡æ€æ•°æ®è®­ç»ƒã€‚</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers.integrations</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_deepspeed_zero3_enabled</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_model_processor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">StdTemplateInputs</span><span class="p">,</span> <span class="n">Template</span><span class="p">,</span> <span class="n">TemplateMeta</span><span class="p">,</span> <span class="n">get_template</span><span class="p">,</span> <span class="n">register_template</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.template.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Context</span><span class="p">,</span> <span class="n">findall</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.template.vision_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_audio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Processor</span><span class="p">,</span> <span class="n">get_env_args</span><span class="p">,</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">get_packed_seq_params</span><span class="p">,</span> <span class="n">is_deepspeed_enabled</span><span class="p">,</span> <span class="n">to_float_dtype</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Qwen2_5OmniTemplate</span><span class="p">(</span><span class="n">Template</span><span class="p">):</span>
    <span class="n">use_model</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># æ˜¯å¦åœ¨é¢„å¤„ç†çš„è¿‡ç¨‹ä¸­éœ€è¦modelå‚ä¸</span>
    <span class="c1"># éœ€è¦æ³¨æ„æ˜¯ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰çš„å¤šæ¨¡æ€æ¨¡å‹éƒ½èƒ½æ”¯æŒpadding_free/packingã€‚`transformers`åº“å†…çš„æ¨¡å‹é€šå¸¸å¯ä»¥æ”¯æŒ</span>
    <span class="n">support_padding_free</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># æ˜¯å¦æ”¯æŒpadding_freeå’Œpackingï¼ˆå¤šæ¨¡æ€æ¨¡å‹ï¼‰</span>
    <span class="n">norm_bbox</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>  <span class="c1"># groundingä»»åŠ¡ä½¿ç”¨ç»å¯¹åæ ‡è¿˜æ˜¯norm1000åæ ‡</span>

    <span class="c1"># è¿™é‡Œçš„tokenså°†ä¸ä¼šè¢«è£å‰ªï¼ˆä¾‹å¦‚è®¾ç½®`--truncation_strategy left/right`ï¼‰</span>
    <span class="c1"># å¹¶ä¼šä½¿ç”¨ç®€ç•¥æ–¹å¼æ‰“å°ï¼ˆè°ƒç”¨`template.safe_decode`ï¼‰</span>
    <span class="n">placeholder_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;|IMAGE|&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;|AUDIO|&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;|VIDEO|&gt;&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">:</span> <span class="n">Processor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åœ¨åˆå§‹åŒ–processoræ—¶ï¼Œé¢å¤–åˆå§‹åŒ–æ‰€éœ€çš„ä¸€äº›å¸¸é‡&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">processor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init_processor</span><span class="p">(</span><span class="n">processor</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">transformers.models.qwen2_5_omni.processing_qwen2_5_omni</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qwen2_5OmniProcessorKwargs</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">Qwen2_5OmniProcessorKwargs</span><span class="o">.</span><span class="n">_defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_chunk</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="s1">&#39;videos_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;seconds_per_chunk&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_id_per_seconds</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="s1">&#39;videos_kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;position_id_per_seconds&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_audio_in_video</span> <span class="o">=</span> <span class="n">get_env_args</span><span class="p">(</span><span class="s1">&#39;use_audio_in_video&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">=</span> <span class="n">get_env_args</span><span class="p">(</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">feature_extractor</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)</span>
        <span class="c1"># `QWENVL_BBOX_FORMAT`çš„å«ä¹‰å‚è€ƒgroundingæ•°æ®é›†è‡ªå®šä¹‰æ–‡æ¡£</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox_format</span> <span class="o">=</span> <span class="n">get_env_args</span><span class="p">(</span><span class="s1">&#39;QWENVL_BBOX_FORMAT&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;legacy&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">replace_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">media_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;audio&#39;</span><span class="p">],</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">inputs</span><span class="p">:</span> <span class="n">StdTemplateInputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Context</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¯»å–å¤šæ¨¡æ€æ•°æ®ï¼Œå¹¶æ›¿æ¢é€šç”¨å¤šæ¨¡æ€tagã€‚</span>
<span class="sd">        ä¾‹å¦‚ï¼šå›¾åƒtagä»`&lt;image&gt;` -&gt; `&lt;|vision_bos|&gt;&lt;|IMAGE|&gt;&lt;|vision_eos|&gt;`&quot;&quot;&quot;</span>
        <span class="c1"># è¯»å–å¤šæ¨¡æ€æ•°æ®ä¹Ÿå¯ä»¥åœ¨`_encode`å‡½æ•°ä¸­è¿›è¡Œï¼Œæ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥ã€‚</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">qwen_omni_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_image</span><span class="p">,</span> <span class="n">fetch_video</span>
        <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">fetch_image</span><span class="p">({</span><span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]})</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&lt;|vision_bos|&gt;&lt;|IMAGE|&gt;&lt;|vision_eos|&gt;&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s1">&#39;audio&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;vllm&#39;</span><span class="p">:</span>  <span class="c1"># &#39;vllm&#39;æ¨ç†åœºæ™¯ä¸‹ä¸éœ€è¦å¤„ç†</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">audios</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_audio</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">audios</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&lt;|audio_bos|&gt;&lt;|AUDIO|&gt;&lt;|audio_eos|&gt;&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s1">&#39;video&#39;</span><span class="p">:</span>
            <span class="n">video</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">videos</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">_video</span> <span class="o">=</span> <span class="n">fetch_video</span><span class="p">({</span><span class="s1">&#39;video&#39;</span><span class="p">:</span> <span class="n">video</span><span class="p">})</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_video</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">_video</span> <span class="o">=</span> <span class="n">_video</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">videos</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">_video</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_audio_in_video</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">librosa</span>
                <span class="k">if</span> <span class="n">video</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">video</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">):</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">audioread</span>
                    <span class="n">video</span> <span class="o">=</span> <span class="n">audioread</span><span class="o">.</span><span class="n">ffdec</span><span class="o">.</span><span class="n">FFmpegAudioFile</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>
                <span class="n">video</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">audios</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">audio_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">))</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">audio_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&lt;|vision_bos|&gt;&lt;|audio_bos|&gt;&lt;|VIDEO|&gt;&lt;|audio_eos|&gt;&lt;|vision_eos|&gt;&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&lt;|vision_bos|&gt;&lt;|VIDEO|&gt;&lt;|vision_eos|&gt;&#39;</span><span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">replace_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">StdTemplateInputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Context</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ›¿æ¢groundingä»»åŠ¡çš„é€šç”¨tag: `&lt;ref-object&gt;`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_format</span> <span class="o">==</span> <span class="s1">&#39;legacy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;&lt;|object_ref_start|&gt;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s1">&lt;|object_ref_end|&gt;&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">ref</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">replace_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">StdTemplateInputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Context</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ›¿æ¢groundingä»»åŠ¡çš„é€šç”¨tag: `&lt;bbox&gt;`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_format</span> <span class="o">==</span> <span class="s1">&#39;legacy&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;&lt;|box_start|&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_bbox_str</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;|box_end|&gt;&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">bbox</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">packing_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ”¯æŒpacking &amp; mropeã€‚é€šå¸¸æƒ…å†µä¸éœ€è¦ç»§æ‰¿è¯¥å‡½æ•°ï¼Œè¿™é‡Œä¸ºäº†è‡ªå®šä¹‰mropeçš„position_idsã€‚&quot;&quot;&quot;</span>
        <span class="n">position_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])[</span><span class="kc">None</span><span class="p">]</span>
            <span class="n">position_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_position_ids</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">packing_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">packed</span><span class="p">[</span><span class="s1">&#39;position_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">position_ids</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">packed</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_new_tokens_use_audio_in_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">video_grid_thw</span><span class="p">,</span> <span class="n">video_second_per_grid</span><span class="p">,</span> <span class="n">audio_lengths</span><span class="p">,</span>
                                           <span class="n">video_token_id</span><span class="p">,</span> <span class="n">audio_token_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¾…åŠ©å‡½æ•°ï¼Œç”¨äºæ”¯æŒ`use_audio_in_video`ä¸ºTrueçš„æƒ…å†µ&quot;&quot;&quot;</span>
        <span class="n">merge_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">merge_size</span>
        <span class="n">grid_thw</span> <span class="o">=</span> <span class="n">video_grid_thw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">grid_thw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">merge_size</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">grid_thw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="n">merge_size</span>
        <span class="n">audio_token_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">audio_lengths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">video_token_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">grid_thw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">video_token_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">video_token_indices</span><span class="p">,</span>
                                                 <span class="p">(</span><span class="n">video_token_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">video_token_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">video_token_indices</span> <span class="o">*</span> <span class="n">video_second_per_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_id_per_seconds</span><span class="p">)</span>
        <span class="n">tokens_per_chunk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position_id_per_seconds</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_per_chunk</span><span class="p">)</span>
        <span class="n">video_chunk_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">get_chunked_index</span><span class="p">(</span><span class="n">video_token_indices</span><span class="p">,</span> <span class="n">tokens_per_chunk</span><span class="p">)</span>
        <span class="n">audio_chunk_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">get_chunked_index</span><span class="p">(</span><span class="n">audio_token_indices</span><span class="p">,</span> <span class="n">tokens_per_chunk</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">video_chunk_indexes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_chunk_indexes</span><span class="p">))):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">video_chunk_indexes</span><span class="p">):</span>
                <span class="n">video_seq_length</span> <span class="o">=</span> <span class="n">video_chunk_indexes</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">video_chunk_indexes</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">video_token_id</span> <span class="o">*</span> <span class="n">video_seq_length</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_chunk_indexes</span><span class="p">):</span>
                <span class="n">audio_seq_length</span> <span class="o">=</span> <span class="n">audio_chunk_indexes</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">audio_chunk_indexes</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">audio_token_id</span> <span class="o">*</span> <span class="n">audio_seq_length</span>
        <span class="k">return</span> <span class="n">res</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">StdTemplateInputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¿™é‡Œå†³å®šå¦‚ä½•å°†text/images/audios/videos -&gt; input_idsã€labelsã€loss_scaleä»¥åŠpixel_valuesç­‰å¤šæ¨¡æ€å†…å®¹</span>
<span class="sd">        è¿™é‡Œçš„å¤„ç†é€»è¾‘é€šå¸¸å¯ä»¥ä»å¯¹åº”æ¨¡å‹çš„é¢„å¤„ç†ä»£ç å®ç°ä¸­å€Ÿé‰´ã€‚</span>
<span class="sd">        æ¨èï¼šè¯·å…ˆåšæ¨ç†å¯¹é½å†åšè®­ç»ƒ&quot;&quot;&quot;</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="n">Template</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>  <span class="c1"># å¤„ç†çº¯æ–‡æœ¬éƒ¨åˆ†ï¼Œå…·ä½“è¯·å‚è€ƒè‡ªå®šä¹‰æ¨¡å‹æ–‡æ¡£</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info_once</span><span class="p">(</span><span class="s1">&#39;Run qwen2_5_omni template&#39;</span><span class="p">)</span>
        <span class="n">processor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span>
        <span class="c1"># è·å–å¤šæ¨¡æ€å†…å®¹</span>
        <span class="n">media_inputs</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">audio</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">audios</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">images</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">images</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">videos</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">videos</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">do_resize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span><span class="p">)</span>
        <span class="c1"># æˆ‘ä»¬ä¸ä½¿ç”¨`processor`äº§ç”Ÿçš„input_idså’Œattention_maskã€‚å› ä¸ºå…¶ä¸äº§ç”Ÿ`labels`ã€‚</span>
        <span class="n">media_inputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;input_ids&#39;</span><span class="p">)</span>
        <span class="n">media_inputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">)</span>
        <span class="n">media_inputs</span> <span class="o">=</span> <span class="n">to_float_dtype</span><span class="p">(</span><span class="n">media_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_info</span><span class="o">.</span><span class="n">torch_dtype</span><span class="p">)</span>

        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
        <span class="n">loss_scale</span> <span class="o">=</span> <span class="n">encoded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loss_scale&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># audioæ¨¡æ€</span>
        <span class="n">audio_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenize</span><span class="p">(</span><span class="s1">&#39;&lt;|AUDIO|&gt;&#39;</span><span class="p">)</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">audio_token_id</span><span class="p">)</span>  <span class="c1"># æŸ¥æ‰¾æ‰€æœ‰çš„audio_token</span>
        <span class="n">feature_attention_mask</span> <span class="o">=</span> <span class="n">media_inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;feature_attention_mask&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feature_attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">audio_feature_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">feature_attention_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">audio_lengths</span> <span class="o">=</span> <span class="p">((</span><span class="n">audio_feature_lengths</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">audio_lengths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">audio_lengths_origin</span> <span class="o">=</span> <span class="n">audio_lengths</span>
        <span class="c1"># video_audios_maskç”¨äºå¤„ç†`use_audio_in_video`ï¼ŒåŒºåˆ†æ˜¯çº¯audio(0)è¿˜æ˜¯videoä¸­çš„audio(1)</span>
        <span class="n">video_audios_mask</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">audio</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">audios</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">audio</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">audio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;video&#39;</span><span class="p">:</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">audios</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">video_audios_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">video_audios_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">video_audios_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">video_audios_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx_list</span><span class="p">:</span>
            <span class="c1"># è¿‡æ»¤æ‰videoä¸­çš„audioçš„å†…å®¹ï¼ˆå°†åœ¨videoéƒ¨åˆ†å¤„ç†ï¼‰</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_audio_in_video</span><span class="p">:</span>
                <span class="n">audio_lengths</span> <span class="o">=</span> <span class="n">audio_lengths</span><span class="p">[</span><span class="o">~</span><span class="n">video_audios_mask</span><span class="p">]</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_get_new_audio_tokens</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">audio_token_id</span> <span class="o">*</span> <span class="n">audio_lengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># å¯¹input_idsçš„å¤šæ¨¡æ€tokensè¿›è¡Œå±•å¼€</span>
            <span class="n">input_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loss_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extend_tokens</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loss_scale</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span>
                                                                <span class="n">_get_new_audio_tokens</span><span class="p">)</span>

        <span class="c1"># imageå’Œvideoæ¨¡æ€</span>
        <span class="k">for</span> <span class="n">media_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">]:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;|</span><span class="si">{</span><span class="n">media_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">|&gt;&#39;</span>
            <span class="n">token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenize</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">idx_list</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">token_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx_list</span><span class="p">:</span>
                <span class="n">merge_size</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">merge_size</span>
                <span class="n">media_grid_thw</span> <span class="o">=</span> <span class="n">media_inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">media_type</span><span class="si">}</span><span class="s1">_grid_thw&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">media_type</span> <span class="o">==</span> <span class="s1">&#39;video&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_audio_in_video</span><span class="p">:</span>
                    <span class="n">audio_lengths</span> <span class="o">=</span> <span class="n">audio_lengths_origin</span><span class="p">[</span><span class="n">video_audios_mask</span><span class="p">]</span>
                    <span class="n">video_second_per_grid</span> <span class="o">=</span> <span class="n">media_inputs</span><span class="p">[</span><span class="s1">&#39;video_second_per_grid&#39;</span><span class="p">]</span>
                    <span class="n">_get_new_tokens_use_audio_in_video</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_get_new_tokens_use_audio_in_video</span><span class="p">,</span>
                        <span class="n">video_grid_thw</span><span class="o">=</span><span class="n">media_grid_thw</span><span class="p">,</span>
                        <span class="n">video_second_per_grid</span><span class="o">=</span><span class="n">video_second_per_grid</span><span class="p">,</span>
                        <span class="n">audio_lengths</span><span class="o">=</span><span class="n">audio_lengths</span><span class="p">,</span>
                        <span class="n">video_token_id</span><span class="o">=</span><span class="n">token_id</span><span class="p">,</span>
                        <span class="n">audio_token_id</span><span class="o">=</span><span class="n">audio_token_id</span><span class="p">)</span>
                    <span class="n">input_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loss_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extend_tokens</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loss_scale</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span>
                                                                        <span class="n">_get_new_tokens_use_audio_in_video</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">_get_new_tokens</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                        <span class="n">token_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">media_grid_thw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">//</span> <span class="p">(</span><span class="n">merge_size</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">token_id</span> <span class="o">*</span> <span class="n">token_len</span>

                    <span class="n">input_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loss_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extend_tokens</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loss_scale</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span>
                                                                        <span class="n">_get_new_tokens</span><span class="p">)</span>

        <span class="n">encoded</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_ids</span>
        <span class="n">encoded</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="n">encoded</span><span class="p">[</span><span class="s1">&#39;loss_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_scale</span>
        <span class="n">encoded</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">media_inputs</span><span class="p">)</span>  <span class="c1"># å°†å¤šæ¨¡æ€å†…å®¹åŠ å…¥å…¶ä¸­</span>
        <span class="k">return</span> <span class="n">encoded</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_post_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¯¥å‡½æ•°é€šå¸¸ç”¨äºè§£å†³æ··åˆæ¨¡å‹è®­ç»ƒzero2/zero3å¡ä½çš„é—®é¢˜ï¼Œ</span>
<span class="sd">        å³æœ‰çš„è¿›ç¨‹ä¸ºçº¯æ–‡æœ¬æ•°æ®æœªè¿‡vitï¼Œæœ‰çš„è¿›ç¨‹å«å›¾ç‰‡æ•°æ®è¿‡äº†vitã€‚è¿™é‡Œå°†åˆ›å»ºdummy_imageæ¥è§£å†³ã€‚</span>

<span class="sd">        è¯¥å‡½æ•°å°†è¢«æ³¨å†Œåœ¨`model.forward`å‰çš„pre_forward_hookä¸­ã€‚</span>
<span class="sd">        è¯¥å‡½æ•°éœ€è¿”å› å«å¤šæ¨¡æ€ä¿¡æ¯çš„input_embedsã€‚</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inputs</span>

        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span>
        <span class="n">input_features</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_features&#39;</span><span class="p">)</span>
        <span class="n">feature_attention_mask</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;feature_attention_mask&#39;</span><span class="p">)</span>

        <span class="n">base_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">inputs_embeds</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">thinker</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embed_tokens</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
        <span class="n">thinker_config</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">thinker_config</span>
        <span class="c1"># è¾…åŠ©å‡½æ•°ï¼Œç”¨äºå¤„ç†text/image/videoæ··åˆæ¨¡æ€æ•°æ®åœºæ™¯ã€‚ï¼ˆå†…éƒ¨ä¼šåˆ›å»ºdummy_imageï¼‰</span>
        <span class="n">inputs_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_embeds_hf</span><span class="p">(</span><span class="n">inputs_embeds</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">thinker</span><span class="o">.</span><span class="n">visual</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">,</span>
                                                   <span class="n">thinker_config</span><span class="p">)</span>
        <span class="c1"># å«audioçš„æ··åˆæ¨¡æ€æ•°æ®åœºæ™¯</span>
        <span class="k">if</span> <span class="n">input_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_deepspeed_enabled</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_deepspeed_zero3_enabled</span><span class="p">():</span>
                <span class="c1"># æ³¨æ„: ç”±äºtransformerså®ç°ä¸­ï¼Œç»è¿‡audioéƒ¨åˆ†æ¨¡å‹å±‚çš„æ¬¡æ•°ä¸audioæ•°é‡ç›¸å…³</span>
                <span class="c1"># å› æ­¤zero3åœ¨ä¸åŒè¿›ç¨‹audiosæ•°ä¸åŒåœºæ™¯ä¸‹ä¼šå¡ä½ï¼ˆéœ€ä¿®æ”¹transformersä»£ç ä¿®å¤ï¼‰ã€‚æ­¤åœºæ™¯è¯·ä½¿ç”¨zero2ã€‚</span>
                <span class="n">input_features</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">thinker</span><span class="o">.</span><span class="n">audio_tower</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">feature_attention_mask</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">new_ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
                <span class="n">audio_res</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">thinker</span><span class="o">.</span><span class="n">get_audio_features</span><span class="p">(</span><span class="n">input_features</span><span class="p">,</span> <span class="n">feature_attention_mask</span><span class="p">)</span>
                <span class="c1"># å…¼å®¹transformers 5.0</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">audio_res</span><span class="p">,</span> <span class="s1">&#39;last_hidden_state&#39;</span><span class="p">):</span>
                    <span class="n">audio_embeds</span> <span class="o">=</span> <span class="n">audio_res</span><span class="o">.</span><span class="n">last_hidden_state</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">audio_embeds</span> <span class="o">=</span> <span class="n">audio_res</span>
                <span class="n">inputs_embeds</span> <span class="o">=</span> <span class="n">inputs_embeds</span> <span class="o">+</span> <span class="n">audio_embeds</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">audio_res</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">thinker</span><span class="o">.</span><span class="n">get_audio_features</span><span class="p">(</span><span class="n">input_features</span><span class="p">,</span> <span class="n">feature_attention_mask</span><span class="p">)</span>
            <span class="c1"># å…¼å®¹transformers 5.0</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">audio_res</span><span class="p">,</span> <span class="s1">&#39;last_hidden_state&#39;</span><span class="p">):</span>
                <span class="n">audio_embeds</span> <span class="o">=</span> <span class="n">audio_res</span><span class="o">.</span><span class="n">last_hidden_state</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">audio_embeds</span> <span class="o">=</span> <span class="n">audio_res</span>
            <span class="n">audio_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_ids</span> <span class="o">==</span> <span class="n">thinker_config</span><span class="o">.</span><span class="n">audio_token_index</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">inputs_embeds</span><span class="p">)</span>
            <span class="n">audio_embeds</span> <span class="o">=</span> <span class="n">audio_embeds</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">inputs_embeds</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">inputs_embeds</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">inputs_embeds</span> <span class="o">=</span> <span class="n">inputs_embeds</span><span class="o">.</span><span class="n">masked_scatter</span><span class="p">(</span><span class="n">audio_mask</span><span class="p">,</span> <span class="n">audio_embeds</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;inputs_embeds&#39;</span><span class="p">:</span> <span class="n">inputs_embeds</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_position_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¾…åŠ©å‡½æ•°ï¼Œç”¨æ¥è·å–mropeçš„position_ids&quot;&quot;&quot;</span>
        <span class="n">feature_attention_mask</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;feature_attention_mask&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feature_attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">audio_feature_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">feature_attention_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">audio_feature_lengths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">video_second_per_grid</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;video_second_per_grid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span>
        <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
        <span class="n">position_ids</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">thinker</span><span class="o">.</span><span class="n">get_rope_index</span><span class="p">(</span>
            <span class="n">input_ids</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image_grid_thw&#39;</span><span class="p">),</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;video_grid_thw&#39;</span><span class="p">),</span>
            <span class="n">attention_mask</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_audio_in_video</span><span class="p">,</span>
            <span class="n">audio_feature_lengths</span><span class="p">,</span>
            <span class="n">video_second_per_grid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concat_text_position_ids</span><span class="p">(</span><span class="n">position_ids</span><span class="p">)</span>  <span class="c1"># ç¬¬ä¸€ç»´ä¸ºtext_position_ids</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_data_collator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">padding_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¼ å…¥dataloaderçš„`collate_fn`&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_data_collator</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">padding_to</span><span class="o">=</span><span class="n">padding_to</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding_free</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
            <span class="c1"># å…¶ä¸­padding_free/packingåœºæ™¯å°†ä¼šåœ¨packing_rowä¸­å¤„ç†position_idsã€‚</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;position_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_position_ids</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;position_ids&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="c1"># åˆ›å»º`packed_seq_params`ä»¥æ”¯æŒpadding_free/packing &amp; flash-attn</span>
            <span class="n">position_ids</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;position_ids&#39;</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;position_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">position_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;text_position_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text_position_ids</span> <span class="o">=</span> <span class="n">position_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># https://github.com/huggingface/transformers/pull/40194</span>
            <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_packed_seq_params</span><span class="p">(</span><span class="n">text_position_ids</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_data_collator_mm_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¤„ç†`_data_collator`å‡½æ•°ä¸­çš„å¤šæ¨¡æ€éƒ¨åˆ†ã€‚ï¼ˆè¯¥å‡½æ•°å…¼å®¹padding_free/packingï¼‰&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_data_collator_mm_data</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">video_second_per_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_list</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="s1">&#39;video_second_per_grid&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">video_second_per_grid</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;video_second_per_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_second_per_grid</span>
        <span class="n">input_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;input_features&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_features&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">feature_attention_mask</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">b</span><span class="p">[</span><span class="s1">&#39;feature_attention_mask&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;feature_attention_mask&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">input_features</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;input_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">input_features</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;feature_attention_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">feature_attention_mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;`TransformersEngine`ä¼šè°ƒç”¨template.generateæ–¹æ³•è¿›è¡Œæ–‡æœ¬ç”Ÿæˆï¼Œè¿™é‡Œç»§æ‰¿è¿›è¡Œè‡ªå®šä¹‰ã€‚&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;video_grid_thw&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;use_audio_in_video&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_audio_in_video</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="n">register_template</span><span class="p">(</span>
    <span class="n">TemplateMeta</span><span class="p">(</span><span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="p">[],</span> <span class="n">prompt</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&lt;|im_start|&gt;user</span><span class="se">\n</span><span class="s1">{{QUERY}}&lt;|im_end|&gt;</span><span class="se">\n</span><span class="s1">&lt;|im_start|&gt;assistant</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">],</span>
                 <span class="n">chat_sep</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&lt;|im_end|&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">],</span> <span class="n">suffix</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&lt;|im_end|&gt;&#39;</span><span class="p">],</span>
                 <span class="n">system_prefix</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&lt;|im_start|&gt;system</span><span class="se">\n</span><span class="s1">{{SYSTEM}}&lt;|im_end|&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">],</span>
                 <span class="n">default_system</span><span class="o">=</span><span class="s1">&#39;You are a helpful assistant.&#39;</span><span class="p">,</span> <span class="n">stop_words</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&lt;|endoftext|&gt;&#39;</span><span class="p">],</span>
                 <span class="n">agent_template</span><span class="o">=</span><span class="s1">&#39;hermes&#39;</span><span class="p">,</span>
                 <span class="n">template_cls</span><span class="o">=</span><span class="n">Qwen2_5OmniTemplate</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># æµ‹è¯•ä¸debug</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">processor</span> <span class="o">=</span> <span class="n">get_model_processor</span><span class="p">(</span><span class="s1">&#39;Qwen/Qwen2.5-Omni-7B&#39;</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">template_type</span><span class="o">=</span><span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;æè¿°è§†é¢‘&lt;video&gt;ä¸å›¾ç‰‡&lt;image&gt;å†…å®¹ã€‚&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;ä¸€ä¸ªå°å­©å’Œä¸€åªçŒ«å’ªã€‚&#39;</span><span class="p">},</span>
        <span class="p">],</span>
        <span class="s1">&#39;videos&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;https://modelscope-open.oss-cn-hangzhou.aliyuncs.com/images/baby.mp4&#39;</span><span class="p">],</span>
        <span class="s1">&#39;images&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;https://modelscope-open.oss-cn-hangzhou.aliyuncs.com/images/cat.png&#39;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">template</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
    <span class="n">encoded</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;input_ids: &#39;</span> <span class="o">+</span> <span class="n">template</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;labels: &#39;</span> <span class="o">+</span> <span class="n">template</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;keys: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">encoded</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2>æ¨ç†å¯¹é½<a class="headerlink" href="#id5" title="Link to this heading">ïƒ</a></h2>
<p>æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦è¿›è¡ŒTransformersEngineä¸transformersçš„æ¨ç†å¯¹é½ã€‚é€šå¸¸ä½ éœ€è¦å¯¹é½<code class="docutils literal notranslate"><span class="pre">input_ids</span></code>ä»¥åŠè¾“å‡ºå†…å®¹ã€‚ä½ å¯ä»¥ä¹¦å†™ä»¥ä¸‹æµ‹è¯•å‡½æ•°ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qwen2_5OmniForConditionalGeneration</span><span class="p">,</span> <span class="n">Qwen2_5OmniProcessor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qwen_omni_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_mm_info</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">modelscope</span><span class="w"> </span><span class="kn">import</span> <span class="n">snapshot_download</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.infer_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransformersEngine</span><span class="p">,</span> <span class="n">InferRequest</span><span class="p">,</span> <span class="n">RequestConfig</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">def</span><span class="w"> </span><span class="nf">infer_hf</span><span class="p">():</span>
    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">snapshot_download</span><span class="p">(</span><span class="s1">&#39;Qwen/Qwen2.5-Omni-7B&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Qwen2_5OmniForConditionalGeneration</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
        <span class="n">model_dir</span><span class="p">,</span> <span class="n">torch_dtype</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">device_map</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">attn_implementation</span><span class="o">=</span><span class="s1">&#39;flash_attention_2&#39;</span><span class="p">)</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">Qwen2_5OmniProcessor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_dir</span><span class="p">)</span>
    <span class="c1"># ä½¿ç”¨decordè¯»å–è§†é¢‘ï¼ˆæš‚ä¸æ”¯æŒurlï¼‰</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://modelscope-open.oss-cn-hangzhou.aliyuncs.com/images/baby.mp4&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;_baby.mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="n">conversation</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;video&quot;</span><span class="p">,</span> <span class="s2">&quot;video&quot;</span><span class="p">:</span> <span class="s2">&quot;_baby.mp4&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;http://modelscope-open.oss-cn-hangzhou.aliyuncs.com/images/cat.png&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;æè¿°è§†é¢‘å’Œå›¾åƒã€‚&quot;</span><span class="p">},</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">]</span>

    <span class="n">USE_AUDIO_IN_VIDEO</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span><span class="n">conversation</span><span class="p">,</span> <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">audios</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">videos</span> <span class="o">=</span> <span class="n">process_mm_info</span><span class="p">(</span><span class="n">conversation</span><span class="p">,</span> <span class="n">use_audio_in_video</span><span class="o">=</span><span class="n">USE_AUDIO_IN_VIDEO</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">audio</span><span class="o">=</span><span class="n">audios</span><span class="p">,</span> <span class="n">images</span><span class="o">=</span><span class="n">images</span><span class="p">,</span> <span class="n">videos</span><span class="o">=</span><span class="n">videos</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">use_audio_in_video</span><span class="o">=</span><span class="n">USE_AUDIO_IN_VIDEO</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">text_ids</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="n">use_audio_in_video</span><span class="o">=</span><span class="n">USE_AUDIO_IN_VIDEO</span><span class="p">,</span> <span class="n">thinker_do_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">return_audio</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">text_ids</span><span class="p">[:,</span> <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_my_qwen2_5_omni</span><span class="p">():</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">TransformersEngine</span><span class="p">(</span><span class="s1">&#39;Qwen/Qwen2.5-Omni-7B&#39;</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">,</span> <span class="n">attn_impl</span><span class="o">=</span><span class="s1">&#39;flash_attention_2&#39;</span><span class="p">)</span>
    <span class="n">infer_request</span> <span class="o">=</span> <span class="n">InferRequest</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[{</span>
        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;video&gt;&lt;image&gt;æè¿°è§†é¢‘å’Œå›¾åƒã€‚&quot;</span><span class="p">,</span>
    <span class="p">}],</span>
        <span class="n">videos</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;https://modelscope-open.oss-cn-hangzhou.aliyuncs.com/images/baby.mp4&quot;</span><span class="p">],</span>
        <span class="n">images</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;http://modelscope-open.oss-cn-hangzhou.aliyuncs.com/images/cat.png&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">request_config</span> <span class="o">=</span> <span class="n">RequestConfig</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
    <span class="n">input_ids</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">infer_request</span><span class="p">)[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span>
    <span class="n">resp_list</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">infer</span><span class="p">([</span><span class="n">infer_request</span><span class="p">],</span> <span class="n">request_config</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">resp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
    <span class="k">return</span> <span class="n">input_ids</span><span class="p">,</span> <span class="n">resp</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># å¼€å¯debugæ¨¡å¼ï¼Œä¼šæ‰“å°`TransformersEngine.infer`çš„input_idså’Œgenerate_ids</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SWIFT_DEBUG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">input_ids_hf</span><span class="p">,</span> <span class="n">response_hf</span> <span class="o">=</span> <span class="n">infer_hf</span><span class="p">()</span>
    <span class="n">input_ids_swift</span><span class="p">,</span> <span class="n">response_swift</span> <span class="o">=</span> <span class="n">test_my_qwen2_5_omni</span><span class="p">()</span>
    <span class="c1"># æµ‹è¯•input_idså’Œresponseå¯¹é½</span>
    <span class="k">assert</span> <span class="n">input_ids_hf</span> <span class="o">==</span> <span class="n">input_ids_swift</span>
    <span class="k">assert</span> <span class="n">response_hf</span> <span class="o">==</span> <span class="n">response_swift</span>
</pre></div>
</div>
</section>
<section id="id6">
<h2>å¼€å§‹è®­ç»ƒ<a class="headerlink" href="#id6" title="Link to this heading">ïƒ</a></h2>
<p>ä½¿ç”¨pythonä»£ç è®­ç»ƒï¼Œè¿™é€šå¸¸æ›´å®¹æ˜“debugï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">swift</span><span class="w"> </span><span class="kn">import</span> <span class="n">sft_main</span><span class="p">,</span> <span class="n">SftArguments</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MAX_PIXELS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1003520&#39;</span>
    <span class="n">sft_main</span><span class="p">(</span><span class="n">SftArguments</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s1">&#39;Qwen/Qwen2.5-Omni-7B&#39;</span><span class="p">,</span>
        <span class="n">dataset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AI-ModelScope/LaTeX_OCR#5000&#39;</span><span class="p">],</span>
        <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="s1">&#39;my_qwen2_5_omni&#39;</span><span class="p">,</span>
        <span class="n">load_from_cache_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">split_dataset_ratio</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">tuner_type</span><span class="o">=</span><span class="s1">&#39;lora&#39;</span><span class="p">,</span>
        <span class="n">torch_dtype</span><span class="o">=</span><span class="s1">&#39;bfloat16&#39;</span><span class="p">,</span>
        <span class="n">attn_impl</span><span class="o">=</span><span class="s1">&#39;flash_attn&#39;</span><span class="p">,</span>
        <span class="n">padding_free</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">lora_rank</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">lora_alpha</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">target_modules</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all-linear&#39;</span><span class="p">],</span>
        <span class="n">freeze_vit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">freeze_aligner</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">gradient_accumulation_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">eval_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">save_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">save_total_limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">logging_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
        <span class="n">warmup_ratio</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">dataloader_num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">dataset_num_proc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">))</span>
</pre></div>
</div>
<p>ä½¿ç”¨å‘½ä»¤è¡Œè®­ç»ƒï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 4 * 35GiB</span>
<span class="nv">PYTORCH_CUDA_ALLOC_CONF</span><span class="o">=</span><span class="s1">&#39;expandable_segments:True&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1,2,3<span class="w"> </span><span class="se">\</span>
<span class="nv">NPROC_PER_NODE</span><span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="nv">VIDEO_MAX_PIXELS</span><span class="o">=</span><span class="m">50176</span><span class="w"> </span><span class="se">\</span>
<span class="nv">FPS_MAX_FRAMES</span><span class="o">=</span><span class="m">12</span><span class="w"> </span><span class="se">\</span>
<span class="nv">MAX_PIXELS</span><span class="o">=</span><span class="m">1003520</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>sft<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model<span class="w"> </span>Qwen/Qwen2.5-Omni-7B<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model_type<span class="w"> </span>my_qwen2_5_omni<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--template<span class="w"> </span>my_qwen2_5_omni<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--external_plugins<span class="w"> </span><span class="s1">&#39;examples/custom/my_qwen2_5_omni/my_register.py&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataset<span class="w"> </span><span class="s1">&#39;AI-ModelScope/alpaca-gpt4-data-zh#2000&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">              </span><span class="s1">&#39;AI-ModelScope/LaTeX_OCR:human_handwrite#2000&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">              </span><span class="s1">&#39;speech_asr/speech_asr_aishell1_trainsets:validation#2000&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">              </span><span class="s1">&#39;swift/VideoChatGPT:all#2000&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--load_from_cache_file<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--split_dataset_ratio<span class="w"> </span><span class="m">0</span>.01<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--tuner_type<span class="w"> </span>lora<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--torch_dtype<span class="w"> </span>bfloat16<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--attn_impl<span class="w"> </span>flash_attn<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--padding_free<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--packing<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_train_epochs<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_train_batch_size<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--per_device_eval_batch_size<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--learning_rate<span class="w"> </span>1e-4<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--lora_rank<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--lora_alpha<span class="w"> </span><span class="m">32</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--target_modules<span class="w"> </span>all-linear<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--freeze_vit<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--freeze_aligner<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--gradient_accumulation_steps<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--eval_steps<span class="w"> </span><span class="m">50</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_steps<span class="w"> </span><span class="m">50</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--save_total_limit<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--logging_steps<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_length<span class="w"> </span><span class="m">4096</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--output_dir<span class="w"> </span>output<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--warmup_ratio<span class="w"> </span><span class="m">0</span>.05<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataloader_num_workers<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataset_num_proc<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--deepspeed<span class="w"> </span>zero2
</pre></div>
</div>
<p>è®­ç»ƒåå¯¹éªŒè¯é›†è¿›è¡Œæ¨ç†ï¼šï¼ˆç¯å¢ƒå˜é‡è¯·ä¸è®­ç»ƒæ—¶å¯¹é½ï¼‰</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTORCH_CUDA_ALLOC_CONF</span><span class="o">=</span><span class="s1">&#39;expandable_segments:True&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="nv">VIDEO_MAX_PIXELS</span><span class="o">=</span><span class="m">50176</span><span class="w"> </span><span class="se">\</span>
<span class="nv">FPS_MAX_FRAMES</span><span class="o">=</span><span class="m">12</span><span class="w"> </span><span class="se">\</span>
<span class="nv">MAX_PIXELS</span><span class="o">=</span><span class="m">1003520</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>infer<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--adapters<span class="w"> </span>output/vx-xxx/checkpoint-xxx<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--stream<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_new_tokens<span class="w"> </span><span class="m">512</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--load_data_args<span class="w"> </span><span class="nb">true</span>
</pre></div>
</div>
<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†è®­ç»ƒæƒé‡æ¨é€åˆ° Modelscopeï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>swift<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--adapters<span class="w"> </span>output/vx-xxx/checkpoint-xxx<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--push_to_hub<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--hub_model_id<span class="w"> </span><span class="s1">&#39;&lt;your-model-id&gt;&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--hub_token<span class="w"> </span><span class="s1">&#39;&lt;your-sdk-token&gt;&#39;</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>