

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ’ä»¶åŒ– &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">æ’ä»¶åŒ–</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/sources/_generated/sources/ms-swift/source/Customization/Pluginization.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>æ’ä»¶åŒ–<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h1>
<blockquote>
<div><p>[!WARNING]
è¯¥æ–‡æ¡£å¾…æ›´æ–°åˆ°ms-swift4.0</p>
</div></blockquote>
<p>æ’ä»¶åŒ–æ˜¯SWIFT3.0ä¸­æ–°å¢çš„é‡è¦èƒ½åŠ›ã€‚æˆ‘ä»¬å¸Œæœ›é€šè¿‡æ’ä»¶åŒ–çš„æ–¹å¼ï¼Œè®©å¼€å‘è€…å¯¹å¼€å‘æµç¨‹çš„å®šåˆ¶æ›´åŠ è‡ªç„¶ã€‚</p>
<section id="callback">
<h2>callbackå›è°ƒ<a class="headerlink" href="#callback" title="Link to this heading">ïƒ</a></h2>
<p>exampleåœ¨<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/callbacks">è¿™é‡Œ</a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">callback</span></code>æœºåˆ¶æ˜¯transformers Trainerä¸­çš„ä¸€ç§è®­ç»ƒå®šåˆ¶åŒ–æœºåˆ¶ã€‚å¼€å‘è€…å¯ä»¥åœ¨callbackä¸­æ§åˆ¶è®­ç»ƒæµç¨‹ã€‚é€šå¸¸æ¥è¯´ï¼Œcallbackçš„å®šåˆ¶åŒ–ç±»ä¼¼ä¸‹é¢çš„æ ·å­ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CustomCallback</span><span class="p">(</span><span class="n">TrainerCallback</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">TrainerState</span><span class="p">,</span> <span class="n">control</span><span class="p">:</span> <span class="n">TrainerControl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Doing something when the training begins.</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">TrainerState</span><span class="p">,</span> <span class="n">control</span><span class="p">:</span> <span class="n">TrainerControl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Doing something when save checkpoint</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>callbackä¼šåœ¨traineræ„é€ å‰æ³¨å†Œè¿›trainerä¸­ï¼Œexampleä¸­ç»™å‡ºäº†ä¸€ä¸ªç®€å•ç‰ˆæœ¬çš„EarlyStopæ–¹æ¡ˆã€‚æ³¨å†Œä½ è‡ªå·±çš„callbackçš„æ–¹å¼æ¯”è¾ƒç®€å•ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">extra_callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">CustomCallback</span><span class="p">()]</span>
</pre></div>
</div>
<p>å¼€å‘è€…å¯ä»¥åœ¨plugin/callback.pyä¸­å¢åŠ æ–°çš„callbackï¼Œå¹¶å®šåˆ¶è‡ªå·±çš„è®­ç»ƒæµç¨‹ã€‚callbackçš„å…·ä½“å‚æ•°å¯ä»¥æŸ¥çœ‹<a class="reference external" href="https://huggingface.co/docs/transformers/main_classes/callback">è¿™é‡Œ</a>ã€‚</p>
</section>
<section id="loss">
<h2>å®šåˆ¶åŒ–loss<a class="headerlink" href="#loss" title="Link to this heading">ïƒ</a></h2>
<p>exampleåœ¨<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/loss/mapping.py">è¿™é‡Œ</a>.</p>
<p>SWIFTæ”¯æŒåœ¨pluginä¸­å®šåˆ¶lossã€‚å¦‚æœä¸ä½¿ç”¨è¿™ä¸ªèƒ½åŠ›ï¼Œé»˜è®¤ä¼šä½¿ç”¨äº¤å‰ç†µLossï¼ˆCE Lossï¼‰ã€‚å¼€å‘è€…å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ç¼–å†™ä»£ç ï¼Œæ³¨å†Œååœ¨è®­ç»ƒæ—¶è®¾ç½®<code class="docutils literal notranslate"><span class="pre">--loss_type</span> <span class="pre">custom_loss</span></code>ä½¿ç”¨ä½ å®šåˆ¶çš„lossæ–¹æ³•ã€‚
ä¾‹å¦‚åœ¨plugin/loss.pyä¸­æ·»åŠ ä¸‹é¢çš„ä»£ç ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">custom_loss_func</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loss_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_items_in_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="c1"># Write your own loss calculating here</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="n">loss_map</span><span class="p">[</span><span class="s1">&#39;custom_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">custom_loss_func</span>
</pre></div>
</div>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œlosså’Œtrainerè®­ç»ƒçš„ä»»åŠ¡æ˜¯å¼ºç›¸å…³çš„ï¼Œç›®å‰çš„losså®šåˆ¶é’ˆå¯¹ptå’Œsftä»»åŠ¡ï¼Œå¦‚æœæ˜¯äººç±»å¯¹é½ä»»åŠ¡ï¼ˆä¾‹å¦‚DPOã€PPOç­‰ï¼‰æˆ–åˆ†ç±»ä»»åŠ¡ï¼ˆseq_clsï¼‰ä»»åŠ¡åœ¨æ’ä»¶ä¸­æ˜¯æ— æ³•å®šåˆ¶çš„ã€‚</p>
</section>
<section id="loss-scale">
<h2>å®šåˆ¶åŒ–loss_scale<a class="headerlink" href="#loss-scale" title="Link to this heading">ïƒ</a></h2>
<p>exampleåœ¨<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/loss_scale/mapping.py">è¿™é‡Œ</a>.</p>
<p>loss_scaleæœºåˆ¶åœ¨SWIFTä¸­æ˜¯éå¸¸é‡è¦çš„æœºåˆ¶ä¹‹ä¸€ã€‚åœ¨ptå’Œsftä»»åŠ¡ä¸­ï¼Œå¯è®­ç»ƒtokençš„lossæ˜¯å‡åŒ€çš„ï¼Œå³æ¯ä¸ªtokenå¹³ç­‰çš„è¿›è¡Œbpã€‚ä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒæŸäº›tokençš„æƒé‡æ¯”è¾ƒå¤§ï¼Œéœ€è¦è¢«é¢å¤–å…³æ³¨ï¼Œ
åœ¨è¿™ç§æƒ…å†µä¸‹å°±éœ€è¦æ›´é«˜çš„æƒé‡ã€‚loss_scaleå¯ä»¥è®©å¼€å‘è€…è‡ªç”±åœ°å®šä¹‰è‡ªå·±çš„tokenæƒé‡ã€‚</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LastRoundLossScale</span><span class="p">(</span><span class="n">LossScale</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_loss_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context_type</span><span class="p">:</span> <span class="n">ContextType</span><span class="p">,</span> <span class="n">is_last_round</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context_type</span> <span class="o">==</span> <span class="n">ContextType</span><span class="o">.</span><span class="n">RESPONSE</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">context</span><span class="p">],</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">is_last_round</span><span class="p">)]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_loss_scale</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">context_type</span><span class="p">,</span> <span class="n">is_last_round</span><span class="p">)</span>
</pre></div>
</div>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œè¿”å›äº†ä¸€ä¸ªTupleï¼Œç¬¬ä¸€ä¸ªè¿”å›æ˜¯contextï¼ˆæˆ–æ‹†è§£åçš„contextï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯contextå¯¹åº”çš„loss_scaleï¼Œfloatå€¼ä»£è¡¨äº†æƒé‡ã€‚ä¾‹å¦‚ä¸‹é¢çš„æƒé‡è®¾ç½®ï¼š</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[&quot;å­¦ä¹ &quot;, &quot;å¥½&quot;, &quot;æ•°å­¦&quot;, &quot;æ˜¯&quot;, &quot;é‡è¦&quot;, &quot;çš„&quot;]
[1.0, 0.5, 2.0, 0.5, 2.0, 0.1]
</pre></div>
</div>
<p>æˆ‘ä»¬æ›´çœ‹é‡æ•°å­¦å’Œé‡è¦ä¸¤ä¸ªè¯ï¼Œå› æ­¤æˆ‘ä»¬æŠŠå®ƒä»¬çš„æƒé‡æå‡åˆ°2.0ã€‚
å›åˆ°ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬åˆ¤æ–­äº†ä¼ å…¥çš„contextæ˜¯å¦æ˜¯responseï¼Œå¦‚æœæ˜¯responseä¸”å¦‚æœæ˜¯å¤šè½®å¯¹è¯çš„æœ€åä¸€è½®æ‰è¿”å›[1]ï¼Œåœ¨å…¶ä»–æƒ…å†µä¸‹ä½¿ç”¨åŸºç±»çš„å®ç°ï¼ˆåœ¨æœ¬åœºæ™¯ä¸‹loss_scaleæ—¶[0]ï¼‰ã€‚ä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œ
æˆ‘ä»¬åšåˆ°äº†åªæœ‰æœ€åä¸€è½®çš„responseå‚ä¸è®­ç»ƒï¼Œå…¶ä»–responseä¸å‚ä¸è®­ç»ƒã€‚ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå¯ä»¥è®©æ‰€æœ‰tokenï¼ˆpromptã€responseï¼‰å‚ä¸è®­ç»ƒï¼Œæˆ–é’ˆå¯¹agentæŸäº›ç‰¹æ®Šå­—ç¬¦é‡ç‚¹è®­ç»ƒç­‰ã€‚
åœ¨ptå’Œsftä¸­ï¼Œloss_scaleæ˜¯æ•´ä½“æ”¯æŒï¼ˆæ˜¯å¦å‚ä¸è®­ç»ƒï¼Œä»¥åŠæƒé‡å¤§å°ï¼‰çš„ï¼Œè€Œäººç±»å¯¹é½ä¸­åªèƒ½æ”¯æŒæŸäº›tokenæ˜¯å¦å‚ä¸è®­ç»ƒï¼Œæ— æ³•æ”¯æŒæƒé‡å¤§å°ã€‚</p>
</section>
<section id="metric">
<h2>å®šåˆ¶åŒ–metric<a class="headerlink" href="#metric" title="Link to this heading">ïƒ</a></h2>
<p>exampleåœ¨<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/metrics">è¿™é‡Œ</a>.</p>
<p>metricå¯ä»¥å®šåˆ¶è®­ç»ƒæ—¶ä½¿ç”¨çš„è¯„æµ‹å‚æ•°ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">metric_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">compute_acc_metrics</span><span class="p">,</span> <span class="n">preprocess_logits_for_acc</span><span class="p">),</span>
    <span class="s1">&#39;nlg&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">compute_nlg_metrics</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s1">&#39;custom&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">custom_metric</span><span class="p">,</span> <span class="n">custom_preprocess</span><span class="p">),</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">metric_mapping</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
</pre></div>
</div>
<p>åœ¨ä¸Šé¢çš„å®šä¹‰ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†æ–°çš„custom metricï¼Œå®ƒçš„valueæœ‰ä¸¤ä¸ªå€¼ï¼Œç¬¬ä¸€ä¸ªå€¼æ˜¯è®¡ç®—metricçš„è¿‡ç¨‹ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«metric key-valueå¯¹çš„dictï¼Œç¬¬äºŒä¸ªå€¼æ˜¯é’ˆå¯¹logitsåšå‰å¤„ç†ï¼Œè¿”å›å®é™…çš„predictionsã€‚</p>
</section>
<section id="optimizer">
<h2>å®šåˆ¶åŒ–optimizer<a class="headerlink" href="#optimizer" title="Link to this heading">ïƒ</a></h2>
<p>exampleåœ¨<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/optimizers/mapping.py">è¿™é‡Œ</a>.</p>
<ul class="simple">
<li><p>å¯¹æ¨¡å‹ä¸åŒéƒ¨åˆ†é‡‡ç”¨ä¸åŒçš„å­¦ä¹ ç‡ï¼Œä¾‹å¦‚ï¼šViTå’ŒLLMåˆ†åˆ«ä½¿ç”¨ä¸åŒçš„å­¦ä¹ ç‡ï¼Œå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/multimodal/lora_llm_full_vit/custom_plugin.py">è¿™é‡Œ</a>ã€‚</p></li>
</ul>
<p>ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œå¢åŠ è‡ªå·±çš„optimizerå’Œlr_schedulerå®ç°ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_custom_optimizers</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
    <span class="c1"># åˆ›å»ºè‡ªå·±çš„optimizer</span>
    <span class="k">return</span> <span class="n">CustomOptimizer</span><span class="p">(</span><span class="n">optimizer_grouped_parameters</span><span class="p">,</span> <span class="o">**</span><span class="n">optimizer_kwargs</span><span class="p">),</span> <span class="n">CustomScheduler</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">optimizers_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;custom&#39;</span><span class="p">:</span> <span class="n">create_custom_optimizers</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>å½“å¼€å‘è€…éœ€è¦ä½¿ç”¨å…¶ä»–optimizerï¼Œä¾‹å¦‚æŸäº›æ–°è®ºæ–‡ä¸­å®šä¹‰çš„optimizeræ—¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œå®šä¹‰å…¶åˆ›å»ºè¿‡ç¨‹ï¼Œå¹¶åœ¨å‚æ•°ä¸­ä½¿ç”¨ï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>--optimizer<span class="w"> </span>custom
</pre></div>
</div>
<p>å°±å¯ä»¥å®é™…è°ƒç”¨äº†ã€‚</p>
</section>
<section id="agent-template">
<h2>å®šåˆ¶åŒ–agent template<a class="headerlink" href="#agent-template" title="Link to this heading">ïƒ</a></h2>
<p>exampleåœ¨<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/agent_template/mapping.py">è¿™é‡Œ</a>.</p>
</section>
<section id="tuner">
<h2>å®šåˆ¶åŒ–tuner<a class="headerlink" href="#tuner" title="Link to this heading">ïƒ</a></h2>
<p>exampleåœ¨<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/tuner_plugin">è¿™é‡Œ</a>.</p>
<ul class="simple">
<li><p>å¤šæ¨¡æ€æ¨¡å‹å¯¹ViTéƒ¨åˆ†ä½¿ç”¨å…¨å‚æ•°è®­ç»ƒï¼ŒLLMéƒ¨åˆ†ä½¿ç”¨LoRAè®­ç»ƒï¼Œå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/multimodal/lora_llm_full_vit">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>Phi4-multimodalï¼Œç›´æ¥å¯¹å…¶å·²æœ‰LoRAè¿›è¡Œè®­ç»ƒè€Œä¸é¢å¤–é™„åŠ LoRAï¼Œå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/plugins/tuner_phi4_mm.sh">è¿™é‡Œ</a>ã€‚</p></li>
</ul>
<p>tunerå®šåˆ¶ä¹Ÿæ˜¯swiftä¸­æœ‰ç‰¹è‰²çš„èƒ½åŠ›ä¹‹ä¸€ï¼Œå¼€å‘è€…å¯ä»¥æ— è§†å¤æ‚çš„tuneråˆå§‹åŒ–æµç¨‹å’Œä»£ç æ•´åˆæˆæœ¬ï¼Œå°†æ–°çš„tuneræ³¨å†Œåœ¨è¿™é‡Œï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">IA3</span><span class="p">(</span><span class="n">Tuner</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_model</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="s1">&#39;SftArguments&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
        <span class="n">model_arch</span><span class="p">:</span> <span class="n">ModelKeys</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model_meta</span><span class="o">.</span><span class="n">model_arch</span>
        <span class="n">ia3_config</span> <span class="o">=</span> <span class="n">IA3Config</span><span class="p">(</span>
            <span class="n">target_modules</span><span class="o">=</span><span class="n">find_all_linears</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">feedforward_modules</span><span class="o">=</span><span class="s1">&#39;.*&#39;</span> <span class="o">+</span> <span class="n">model_arch</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_peft_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ia3_config</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_pretrained</span><span class="p">(</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">save_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">state_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">safe_serialization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PeftModel</span>
        <span class="n">model</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">save_directory</span><span class="p">,</span> <span class="n">state_dict</span><span class="o">=</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">safe_serialization</span><span class="o">=</span><span class="n">safe_serialization</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_pretrained</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PeftModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†peftçš„IA3åº”ç”¨äºæ¨¡å‹è®­ç»ƒä¸­ï¼Œåœ¨è¿™ä¸ªç±»ä¸­åŒ…å«äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<ul class="simple">
<li><p>prepare_model: å¦‚ä½•å°†åŸå§‹æ¨¡å‹ä½¿ç”¨tunerè¿›è¡Œå°è£…ï¼Œå¹¶è®¾ç½®å¥½å¯è®­ç»ƒå‚æ•°</p></li>
<li><p>save_pretrained: å¦‚ä½•åœ¨è®­ç»ƒä¸­ä¿å­˜æ¨¡å‹</p></li>
<li><p>from_pretrained: å¦‚ä½•åœ¨åç»­è®­ç»ƒå’Œæ¨ç†ä¸­å°†ä¹‹å‰å­˜ä¸‹æ¥çš„checkpointé‡æ–°æ‹‰èµ·</p></li>
</ul>
<p>ä¸Šé¢çš„ä¸‰ä¸ªæ–¹æ³•ä¼šåœ¨swiftè®­ç»ƒæµç¨‹ä¸­è¢«è°ƒç”¨ï¼Œè¿™æ ·å°±åšåˆ°äº†å¼€å‘è€…å¯ä»¥ä¸é˜…è¯»å¤æ‚çš„è®­ç»ƒä»£ç è€Œä½¿ç”¨è‡ªå·±çš„tunerã€‚</p>
</section>
<section id="prm">
<h2>PRM<a class="headerlink" href="#prm" title="Link to this heading">ïƒ</a></h2>
<p>exampleåœ¨<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/rewards/prm.py">è¿™é‡Œ</a>ã€‚</p>
<p>PRMæ˜¯è¿‡ç¨‹å¥–åŠ±æ¨¡å‹ï¼ŒPRMä¼šåœ¨<code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">sample</span></code>å‘½ä»¤ä¸­ä½¿ç”¨ã€‚PRMéœ€è¦æ”¯æŒçš„æ¥å£æ¯”è¾ƒç®€å•ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PRM</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># init here</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infer_requests</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InferRequest</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>
</div>
<p>å…¶ä¸­çš„InferRequestæ¥è‡ªäº<code class="docutils literal notranslate"><span class="pre">swift.infer_engine</span></code>ï¼Œè¿”å›çš„<code class="docutils literal notranslate"><span class="pre">List[Union[float,</span> <span class="pre">List[float]]]</span></code>ï¼Œåˆ—è¡¨ä¸­å¯èƒ½æ˜¯rewardä¹Ÿå¯èƒ½æ˜¯è‹¥å¹²rewardã€‚å¼€å‘è€…å¯ä»¥åœ¨infer_requestsä¸­æ‹¿åˆ°querieså’Œresponsesï¼Œå¹¶æŒ‰ç…§è‡ªå·±çš„æ–¹å¼è¿›è¡Œåˆ‡åˆ†ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Let&#39;s think step by step.

Step1: xxx

Step2: xxx

So, the answer is ...
</pre></div>
</div>
<p>å¼€å‘è€…å¯ä»¥åœ¨è¿™é‡Œå¯¹è¿‡ç¨‹è¿›è¡Œåˆ‡åˆ†ï¼Œå¹¶æŒ‰batchä¼ å…¥PRMä¸­è¿›è¡Œæ¨ç†å¹¶è¿”å›rewardsã€‚æ›´é€šç”¨æ¥è¯´ï¼Œå¼€å‘è€…å¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨ä¸€ä¸ªè¿œç«¯URLï¼Œä¾‹å¦‚ä¸€ä¸ªé—­æºPRMå¤§æ¨¡å‹å¹¶è¿”å›rewardsã€‚</p>
</section>
<section id="orm">
<h2>ORM<a class="headerlink" href="#orm" title="Link to this heading">ïƒ</a></h2>
<p>exampleåœ¨<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/rewards/orm.py">è¿™é‡Œ</a>ã€‚</p>
<p>ORMæ˜¯ç»“æœå¥–åŠ±æ¨¡å‹ã€‚ORMä¸€èˆ¬ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥è¿›è¡Œï¼ŒORMå†³å®šäº†responseæ˜¯å¦æ˜¯æ­£ç¡®çš„ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MathORM</span><span class="p">(</span><span class="n">ORM</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_boxed_result</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">boxed{([^}]*)}&#39;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infer_requests</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InferRequest</span><span class="p">],</span> <span class="n">ground_truths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">infer_requests</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">ground_truth</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">ground_truths</span><span class="p">):</span>
            <span class="n">res1</span> <span class="o">=</span> <span class="n">MathORM</span><span class="o">.</span><span class="n">extract_boxed_result</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">res2</span> <span class="o">=</span> <span class="n">MathORM</span><span class="o">.</span><span class="n">extract_boxed_result</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">res1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">res2</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">rewards</span>


<span class="n">orms</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;math&#39;</span><span class="p">:</span> <span class="n">MathORM</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¯¹æ•°å­¦responseè¿›è¡Œè§£æçš„è¿‡ç¨‹ï¼Œå¦‚æœç»“æœç›¸åŒåˆ™è¿”å›scoreä¸º1.0ï¼Œå¦åˆ™ä¸º0.0ã€‚å’ŒPRMä¸åŒï¼Œè¿™ä¸ªç±»çš„inferä¸­æœ‰ä¸€ä¸ªé¢å¤–å‚æ•°<code class="docutils literal notranslate"><span class="pre">ground_truths</span></code>ï¼Œ
è¯¥å‚æ•°æ˜¯å¯¹åº”çš„infer_requestsçš„å®é™…labelï¼ˆæ•°æ®é›†ä¸­å®šä¹‰çš„æ ‡å‡†responseï¼‰ã€‚</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>