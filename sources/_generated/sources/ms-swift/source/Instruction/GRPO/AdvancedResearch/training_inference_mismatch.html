

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training-Inference-Mismatch &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Training-Inference-Mismatch</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../../_sources/sources/_generated/sources/ms-swift/source/Instruction/GRPO/AdvancedResearch/training_inference_mismatch.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="training-inference-mismatch">
<h1>Training-Inference-Mismatch<a class="headerlink" href="#training-inference-mismatch" title="Link to this heading">ïƒ</a></h1>
<p><strong>ç‰ˆæœ¬ä¾èµ–</strong>ï¼šms-swift&gt;=3.11</p>
<p><strong>TL;DR</strong>: GRPO å¼•å…¥ vLLM åŠ é€Ÿé‡‡æ ·è¿‡ç¨‹çš„åŒæ—¶ï¼Œä¹Ÿå¼•å…¥äº†è®­ç»ƒ-æ¨ç†ä¸ä¸€è‡´ï¼ˆTraining-Inference Mismatchï¼‰çš„é—®é¢˜ï¼Œä»è€Œå¯èƒ½å½±å“è®­ç»ƒç¨³å®šæ€§ã€‚æœ¬æ–‡å°†è§£é‡Šè¿™ä¸ªé—®é¢˜çš„èƒŒæ™¯ã€åŸå› ä»¥åŠç›¸åº”çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">ïƒ</a></h2>
<section id="grpo">
<h3>GRPO çš„åŸºæœ¬å‡è®¾<a class="headerlink" href="#grpo" title="Link to this heading">ïƒ</a></h3>
<p>GRPO (Group Relative Policy Optimization) çš„è®­ç»ƒç›®æ ‡å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p>
<p>$$
\mathcal{L}<em>{\text{GRPO}} = - \mathbb{E}</em>{y \sim \pi_\theta} \left[ \min \left( r_t(\theta) \hat{A}_t, \text{clip}(r_t(\theta), 1-\epsilon, 1+\epsilon) \hat{A}_t \right) \right]
$$</p>
<p>å…¶ä¸­ï¼š</p>
<ul class="simple">
<li><p>$r_t(\theta) = \frac{\pi_\theta(y_t|x, y_{&lt;t})}{\pi_{\theta_{\text{old}}}(y_t|x, y_{&lt;t})}$ æ˜¯é‡è¦æ€§é‡‡æ ·æ¯”</p></li>
<li><p>$\hat{A}_t$ æ˜¯ä¼˜åŠ¿å‡½æ•°ï¼ˆadvantageï¼‰ï¼ŒåŸºäº reward å’Œ group baseline è®¡ç®—</p></li>
<li><p>$\epsilon$ æ˜¯ clipping å‚æ•°</p></li>
</ul>
<p><strong>æ ¸å¿ƒå‡è®¾</strong>ï¼šæ ·æœ¬ $y$ æ˜¯ä»ç­–ç•¥ $\pi_\theta$ ä¸­é‡‡æ ·å¾—åˆ°çš„ã€‚åœ¨å®é™…è®­ç»ƒä¸­ï¼Œè¿™æ„å‘³ç€ï¼š</p>
<ol class="simple">
<li><p>é‡‡æ ·æ¨¡å‹ï¼ˆrollout modelï¼‰ä¸è®­ç»ƒæ¨¡å‹ï¼ˆpolicy modelï¼‰åº”å½“æ˜¯<strong>åŒä¸€ä¸ªæ¨¡å‹</strong> $\pi_\theta$</p></li>
<li><p>ä¸¤ä¸ªæ¨¡å‹çš„æ¦‚ç‡åˆ†å¸ƒåº”å½“<strong>å®Œå…¨ä¸€è‡´</strong>ï¼Œå³ $\pi_{\text{rollout}} = \pi_\theta$</p></li>
</ol>
</section>
<section id="vllm">
<h3>å¼•å…¥ vLLM åçš„å‡è®¾åç¦»<a class="headerlink" href="#vllm" title="Link to this heading">ïƒ</a></h3>
<p>GRPO çš„è®­ç»ƒé€Ÿåº¦å¾ˆå¤§ç¨‹åº¦ä¸Šå—åˆ°é‡‡æ ·è¿‡ç¨‹ï¼ˆrolloutï¼‰çš„é€Ÿåº¦åˆ¶çº¦ã€‚ä¸ºäº†åŠ é€Ÿï¼Œè®­ç»ƒæ¡†æ¶å¼•å…¥é«˜æ•ˆæ¨ç†å¼•æ“ï¼ˆå¦‚ vLLMï¼‰æ¥æ‰§è¡Œé‡‡æ ·ã€‚<strong>ç†æƒ³å‡è®¾</strong>æ˜¯ï¼šé€šè¿‡æƒé‡åŒæ­¥ï¼ŒvLLM ä¸è®­ç»ƒæ¨¡å‹ä¿æŒä¸€è‡´ï¼Œå³ $\pi_{\text{vLLM}} \equiv \pi_\theta$ã€‚</p>
<p>ç„¶è€Œï¼Œåœ¨å®è·µä¸­ï¼Œå³ä½¿æƒé‡å®Œå…¨åŒæ­¥ï¼Œç”±äºç®—å­å®ç°ç­‰å·®å¼‚ï¼Œä¸¤è€…çš„æ¦‚ç‡åˆ†å¸ƒä»ç„¶å­˜åœ¨åå·®ï¼š</p>
<p>$$
\pi_{\text{vLLM}}(y|x) \neq \pi_\theta(y|x)
$$</p>
<p>æ­¤æ—¶ï¼Œå®é™…çš„è®­ç»ƒç›®æ ‡å˜ä¸ºï¼š</p>
<p>$$
\mathcal{L} = - \mathbb{E}<em>{y \sim \pi</em>{\text{vLLM}}} \left[ \min \left( r_t(\theta) \hat{A}_t, \text{clip}(r_t(\theta), 1-\epsilon, 1+\epsilon) \hat{A}_t \right) \right]
$$</p>
<p>å…¶ä¸­æ ·æœ¬æ¥è‡ª $\pi_{\text{vLLM}}$ï¼Œä½†æ¢¯åº¦æ˜¯åŸºäº $\pi_\theta$ è®¡ç®—çš„ï¼Œè¿™<strong>ç ´åäº†ç®—æ³•çš„ on-policy å‡è®¾</strong>ï¼Œå¼•å…¥äº†è®­æ¨ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p>
</section>
</section>
<section id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Link to this heading">ïƒ</a></h2>
<p>é’ˆå¯¹è®­æ¨ä¸ä¸€è‡´é—®é¢˜ï¼Œå¯ä»¥å¼•å…¥**é‡è¦æ€§é‡‡æ ·ï¼ˆImportance Sampling, ISï¼‰**çš„æ ¡æ­£æœºåˆ¶ã€‚</p>
<section id="id1">
<h3>é‡è¦æ€§é‡‡æ ·æ ¡æ­£<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h3>
<p>é‡è¦æ€§é‡‡æ ·çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼šå½“æ ·æœ¬æ¥è‡ªåˆ†å¸ƒ $q$ è€Œéç›®æ ‡åˆ†å¸ƒ $p$ æ—¶ï¼Œå¯ä»¥é€šè¿‡å¼•å…¥æƒé‡æ¥ä¿®æ­£æœŸæœ›çš„è®¡ç®—ï¼š</p>
<p>$$
\mathbb{E}<em>{x \sim p} [f(x)] = \mathbb{E}</em>{x \sim q} \left[ \frac{p(x)}{q(x)} \cdot f(x) \right]
$$</p>
<p>åº”ç”¨åˆ° GRPO çš„åœºæ™¯ï¼Œä¿®æ­£åçš„æŸå¤±å‡½æ•°ä¸ºï¼š</p>
<p>$$
\mathcal{L}<em>{\text{corrected}} = - \mathbb{E}</em>{y \sim \pi_{\text{vLLM}}} \left[ w(x, y) \cdot \min \left( r_t(\theta) \hat{A}_t, \text{clip}(r_t(\theta), 1-\epsilon, 1+\epsilon) \hat{A}_t \right) \right]
$$</p>
<p>å…¶ä¸­ $w(x, y)$ æ˜¯é‡è¦æ€§é‡‡æ ·æƒé‡ï¼Œç”¨äºæ ¡æ­£ vLLM ä¸è®­ç»ƒæ¨¡å‹ä¹‹é—´çš„åˆ†å¸ƒåå·®</p>
<p>é‡è¦æ€§é‡‡æ ·æƒé‡å¯ä»¥åœ¨ä¸åŒç²’åº¦ä¸Šè®¡ç®—å’Œåº”ç”¨ï¼š</p>
<ol class="simple">
<li><p><strong>Token-Level</strong></p></li>
</ol>
<p>æ¯ä¸ª token ä¸Šè®¡ç®—é‡è¦æ€§é‡‡æ ·æ¯”ï¼š</p>
<p>$$
w_{i,t}^{\text{token}} = \frac{\pi_\theta(y_{i,t}|x, y_{i,&lt;t})}{\pi_{\text{vLLM}}(y_{i,t}|x, y_{i,&lt;t})}
$$</p>
<ol class="simple">
<li><p><strong>Sequence-Level</strong></p></li>
</ol>
<p>è®¡ç®—åºåˆ—çº§åˆ«çš„é‡è¦æ€§é‡‡æ ·æ¯”ï¼Œç„¶åå¹¿æ’­åˆ°æ¯ä¸ª tokenï¼š</p>
<p>$$
w_i^{\text{seq}} = \left[ \frac{\pi_\theta(y_i|x)}{\pi_{\text{vLLM}}(y_i|x)} \right]^{\frac{1}{|y_i|}} = \exp\left( \frac{1}{|y_i|} \sum_{t=1}^{|y_i|} \log \frac{\pi_\theta(y_{i,t}|x, y_{i,&lt;t})}{\pi_{\text{vLLM}}(y_{i,t}|x, y_{i,&lt;t})} \right)
$$</p>
</section>
<section id="truncate-vs-mask">
<h3>ç¨³å®šæ€§æ§åˆ¶ï¼šTruncate vs. Mask<a class="headerlink" href="#truncate-vs-mask" title="Link to this heading">ïƒ</a></h3>
<p>è¿‡å¤§çš„é‡è¦æ€§é‡‡æ ·æƒé‡ä¼šå¯¼è‡´æ¢¯åº¦çˆ†ç‚¸ï¼Œç ´åè®­ç»ƒç¨³å®šæ€§ã€‚å› æ­¤éœ€è¦å¯¹æƒé‡è¿›è¡Œæ§åˆ¶ï¼š</p>
<section id="truncate">
<h4>1. Truncateï¼ˆæˆªæ–­ï¼‰<a class="headerlink" href="#truncate" title="Link to this heading">ïƒ</a></h4>
<p>å°†é‡è¦æ€§é‡‡æ ·æƒé‡æˆªæ–­åˆ° $[0, \tau]$ åŒºé—´ï¼š</p>
<p>$$
w_{\text{truncate}} = \min(w, \tau)
$$</p>
<p>è¯¥æ–¹æ³•ä¿ç•™æ‰€æœ‰æ ·æœ¬ï¼Œä½†é™åˆ¶å…¶å½±å“èŒƒå›´ã€‚</p>
</section>
<section id="mask">
<h4>2. Maskï¼ˆå±è”½ï¼‰<a class="headerlink" href="#mask" title="Link to this heading">ïƒ</a></h4>
<p>èˆå¼ƒæƒé‡è¶…è¿‡é˜ˆå€¼çš„ token/sequence æ•°æ®</p>
<p>$$
w_{\text{mask}} = \begin{cases}
w &amp; \text{if } w \leq \tau \
0 &amp; \text{otherwise}
\end{cases}
$$</p>
</section>
</section>
<section id="id2">
<h3>å››ç§æ ¡æ­£æ¨¡å¼<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h3>
<p>ç»“åˆç²’åº¦å’Œæ§åˆ¶ç­–ç•¥ï¼Œå…±è®¾ç½®å››ç§æ ¡æ­£æ¨¡å¼ï¼ˆé€šè¿‡ <code class="docutils literal notranslate"><span class="pre">--rollout_importance_sampling_mode</span></code> å‚æ•°é€‰æ‹©ï¼‰ï¼š</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>æ¨¡å¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>token_truncate</code></td>
<td>Token çº§æˆªæ–­</td>
</tr>
<tr>
<td><code>token_mask</code></td>
<td>Token çº§å±è”½</td>
</tr>
<tr>
<td><code>sequence_truncate</code></td>
<td>Sequence çº§æˆªæ–­</td>
</tr>
<tr>
<td><code>sequence_mask</code></td>
<td>Sequence çº§å±è”½</td>
</tr>
</tbody>
</table><p>å…¶ä¸­é˜ˆå€¼é€šè¿‡ <code class="docutils literal notranslate"><span class="pre">--rollout_importance_sampling_threshold</span></code> å‚æ•°è®¾ç½®ã€‚</p>
</section>
</section>
<section id="metrics">
<h2>Metrics<a class="headerlink" href="#metrics" title="Link to this heading">ïƒ</a></h2>
<p>ä¸ºäº†ç›‘æ§è®­ç»ƒä¸­è®­æ¨ä¸ä¸€è‡´çš„ç¨‹åº¦ï¼Œæˆ‘ä»¬åœ¨logä¸­åŠ å…¥ä»¥ä¸‹æŒ‡æ ‡ï¼ˆå‰ç¼€ä¸º <code class="docutils literal notranslate"><span class="pre">rollout_correction/</span></code>ï¼‰ï¼š</p>
<section id="kl-kl-divergence">
<h3>1. KL æ•£åº¦ï¼ˆKL Divergenceï¼‰<a class="headerlink" href="#kl-kl-divergence" title="Link to this heading">ïƒ</a></h3>
<p>KL æ•£åº¦è¡¡é‡ rollout ç­–ç•¥ä¸è®­ç»ƒç­–ç•¥ä¹‹é—´çš„åç¦»ç¨‹åº¦ã€‚ä¸¤ä¸ªæŒ‡æ ‡éƒ½ä¼°è®¡ $\text{KL}(\pi_{\text{vLLM}} | \pi_\theta)$</p>
<p><strong>ç›´æ¥ä¼°è®¡å™¨ <code class="docutils literal notranslate"><span class="pre">kl</span></code></strong>ï¼š</p>
<p>$$
\text{KL}(\pi_{\text{vLLM}} | \pi_\theta) = \mathbb{E}<em>{\pi</em>{\text{vLLM}}}\left[ \log \frac{\pi_{\text{vLLM}}}{\pi_\theta} \right]
$$</p>
<p><strong>K3 ä¼°è®¡å™¨ <code class="docutils literal notranslate"><span class="pre">k3_kl</span></code></strong>ï¼š</p>
<p>$$
\text{KL}(\pi_{\text{vLLM}} | \pi_\theta) \approx \mathbb{E}<em>{\pi</em>{\text{vLLM}}}\left[ \rho - \log \rho - 1 \right], \quad \rho = \frac{\pi_\theta}{\pi_{\text{vLLM}}}
$$</p>
<p>K3 ä¼°è®¡å™¨åœ¨ KL å€¼è¾ƒå°æ—¶æ•°å€¼æ›´ç¨³å®šï¼Œä¸”å§‹ç»ˆéè´Ÿã€‚</p>
</section>
<section id="perplexity-ppl">
<h3>2. Perplexity (PPL)<a class="headerlink" href="#perplexity-ppl" title="Link to this heading">ïƒ</a></h3>
<p>å›°æƒ‘åº¦è¡¡é‡æ¨¡å‹å¯¹åºåˆ—çš„é¢„æµ‹ä¸ç¡®å®šæ€§ï¼š</p>
<p>$$
\text{PPL} = \exp\left( -\frac{1}{|y|} \sum_{t=1}^{|y|} \log p(y_t) \right)
$$</p>
<p>ç›¸å…³æŒ‡æ ‡ï¼š</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">training_ppl</span></code> / <code class="docutils literal notranslate"><span class="pre">training_log_ppl</span></code>ï¼šè®­ç»ƒç­–ç•¥çš„ PPL åŠå…¶å¯¹æ•°</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rollout_ppl</span></code> / <code class="docutils literal notranslate"><span class="pre">rollout_log_ppl</span></code>ï¼šrollout ç­–ç•¥çš„ PPL åŠå…¶å¯¹æ•°</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_ppl_diff</span></code>ï¼šlog PPL å·®å¼‚ï¼Œæ­£å€¼è¡¨ç¤ºè®­ç»ƒç­–ç•¥åˆ†é…çš„æ¦‚ç‡æ›´ä½</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_ppl_abs_diff</span></code>ï¼šlog PPL ç»å¯¹å·®å¼‚</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_ppl_diff_max</span></code> / <code class="docutils literal notranslate"><span class="pre">log_ppl_diff_min</span></code>ï¼šlog PPL å·®å¼‚çš„æœ€å¤§/æœ€å°å€¼</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ppl_ratio</span></code>ï¼šPPL æ¯”ç‡ $\frac{\text{PPL}<em>{\text{training}}}{\text{PPL}</em>{\text{rollout}}}$</p></li>
</ul>
</section>
<section id="chi-squared-divergence">
<h3>3. Ï‡Â² æ•£åº¦ï¼ˆChi-squared Divergenceï¼‰<a class="headerlink" href="#chi-squared-divergence" title="Link to this heading">ïƒ</a></h3>
<p>Ï‡Â² æ•£åº¦è¡¡é‡é‡è¦æ€§é‡‡æ ·æƒé‡çš„æ–¹å·®ï¼š</p>
<p>$$
\chi^2(\pi_\theta | \pi_{\text{vLLM}}) = \mathbb{E}<em>{\pi</em>{\text{vLLM}}}\left[ \rho^2 \right] - 1, \quad \rho = \frac{\pi_\theta}{\pi_{\text{vLLM}}}
$$</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">chi2_token</span></code>ï¼šToken çº§åˆ« Ï‡Â² æ•£åº¦ï¼Œ$\mathbb{E}[\rho_t^2] - 1$</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chi2_seq</span></code>ï¼šSequence çº§åˆ« Ï‡Â² æ•£åº¦ï¼ˆåŸºäºå‡ ä½•å¹³å‡ï¼‰ï¼Œ$\mathbb{E}[\rho_{\text{geo}}^2] - 1$ï¼Œå…¶ä¸­ $\rho_{\text{geo}} = \exp(\frac{1}{T}\sum_t \log \rho_t)$</p></li>
</ul>
<p>Ï‡Â² æ•£åº¦è¶Šå¤§ï¼Œè¡¨ç¤º IS æƒé‡æ–¹å·®è¶Šå¤§ï¼Œè®­ç»ƒè¶Šä¸ç¨³å®šã€‚<code class="docutils literal notranslate"><span class="pre">chi2_seq</span></code> ä½¿ç”¨å‡ ä½•å¹³å‡è€Œéä¹˜ç§¯ï¼Œä½¿å…¶ä¸ <code class="docutils literal notranslate"><span class="pre">chi2_token</span></code> åœ¨é‡çº§ä¸Šå¯æ¯”è¾ƒã€‚</p>
</section>
<section id="effective-sample-size-ess">
<h3>4. Effective Sample Size (ESS)<a class="headerlink" href="#effective-sample-size-ess" title="Link to this heading">ïƒ</a></h3>
<p>æœ‰æ•ˆæ ·æœ¬å¤§å°è¡¡é‡é‡è¦æ€§é‡‡æ ·åå®é™…èµ·ä½œç”¨çš„æ ·æœ¬æ•°é‡ï¼š</p>
<p>$$
\text{ESS} = \frac{1}{\mathbb{E}\left[\left(\frac{w}{\mathbb{E}[w]}\right)^2\right]}
$$</p>
<p>ESS å€¼è¶Šå¤§ï¼ˆæ¥è¿‘1ï¼‰ï¼Œè¡¨ç¤ºé‡è¦æ€§é‡‡æ ·æƒé‡åˆ†å¸ƒè¶Šå‡åŒ€ï¼Œæ ·æœ¬çš„æœ‰æ•ˆåˆ©ç”¨ç‡è¶Šé«˜ã€‚å½“æ‰€æœ‰æƒé‡ç›¸ç­‰æ—¶ï¼ˆon-policyï¼‰ï¼ŒESS = 1ï¼›å½“æƒé‡å·®å¼‚å¾ˆå¤§æ—¶ï¼ˆä¸¥é‡ off-policyï¼‰ï¼ŒESS ä¼šå¾ˆå°ã€‚</p>
</section>
<section id="is">
<h3>5. IS æƒé‡ç»Ÿè®¡<a class="headerlink" href="#is" title="Link to this heading">ïƒ</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">is_weight_mean</span></code>ï¼šå¹³å‡é‡è¦æ€§é‡‡æ ·æƒé‡ï¼Œç†æƒ³å€¼ä¸º 1.0</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clipped_frac</span></code>ï¼šè¢«æˆªæ–­æˆ–å±è”½çš„æ ·æœ¬æ¯”ä¾‹</p></li>
</ul>
</section>
</section>
<section id="id3">
<h2>ä½¿ç”¨æ–¹å¼<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h2>
<section id="id4">
<h3>ä»…è®°å½•è¯Šæ–­æŒ‡æ ‡<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h3>
<p>å¦‚æœåªæƒ³ç›‘æ§è®­æ¨ä¸ä¸€è‡´çš„ç¨‹åº¦ï¼Œè€Œä¸å¯ç”¨é‡è¦æ€§é‡‡æ ·æ ¡æ­£ï¼Œå¯ä»¥è®¾ç½®ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">log_rollout_offpolicy_metrics</span> <span class="n">true</span>
</pre></div>
</div>
<p>è¿™å°†è®°å½•ä¸Šè¿°æ‰€æœ‰è¯Šæ–­æŒ‡æ ‡ï¼ˆKLã€PPLã€Ï‡Â² ç­‰ï¼‰ï¼Œä½†ä¸ä¼šå¯¹æŸå¤±å‡½æ•°è¿›è¡Œä»»ä½•ä¿®æ­£ã€‚</p>
</section>
<section id="id5">
<h3>å¯ç”¨é‡è¦æ€§é‡‡æ ·æ ¡æ­£<a class="headerlink" href="#id5" title="Link to this heading">ïƒ</a></h3>
<p>åœ¨GRPOè®­ç»ƒä¸­ï¼Œè®¾ç½®ä»¥ä¸‹å‚æ•°å¯ç”¨æ ¡æ­£æœºåˆ¶ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>--rollout_importance_sampling_mode ï¼ˆé»˜è®¤ä¸ºNoneï¼‰
--rollout_importance_sampling_threshold ï¼ˆé»˜è®¤ä¸º2ï¼‰
</pre></div>
</div>
<p>å½“è®¾ç½®äº† <code class="docutils literal notranslate"><span class="pre">rollout_importance_sampling_mode</span></code> æ—¶ï¼Œè¯Šæ–­æŒ‡æ ‡ä¼šè‡ªåŠ¨è®°å½•ï¼Œæ— éœ€é¢å¤–è®¾ç½® <code class="docutils literal notranslate"><span class="pre">log_rollout_offpolicy_metrics</span></code>ã€‚</p>
</section>
</section>
<section id="off-policy-sequence-masking">
<h2>Off-Policy Sequence Masking<a class="headerlink" href="#off-policy-sequence-masking" title="Link to this heading">ïƒ</a></h2>
<p>é™¤äº†é‡è¦æ€§é‡‡æ ·æ ¡æ­£å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <strong>Off-Policy Sequence Masking</strong> æŠ€æœ¯æ¥å¤„ç†è®­æ¨ä¸ä¸€è‡´é—®é¢˜ã€‚è¯¥æŠ€æœ¯æ¥è‡ª <a class="reference external" href="https://arxiv.org/abs/2512.02556">DeepSeek-V3.2 è®ºæ–‡</a>ã€‚</p>
<section id="id6">
<h3>åŸç†<a class="headerlink" href="#id6" title="Link to this heading">ïƒ</a></h3>
<p>Off-Policy Sequence Masking çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå½“å½“å‰ç­–ç•¥ç›¸å¯¹äºæ—§ç­–ç•¥ï¼ˆrollout æˆ– old policyï¼‰å‘ç”Ÿè¾ƒå¤§åç§»æ—¶ï¼Œç›´æ¥ä¸¢å¼ƒï¼ˆmaskï¼‰è¯¥åºåˆ—ï¼Œä¸å‚ä¸æŸå¤±è®¡ç®—ã€‚è¿™ç§æ–¹æ³•ç‰¹åˆ«é’ˆå¯¹<strong>ä¼˜åŠ¿ä¸ºè´Ÿçš„åºåˆ—</strong>ï¼Œå› ä¸ºè¿™äº›åºåˆ—åœ¨ç­–ç•¥åç§»è¾ƒå¤§æ—¶æ›´å®¹æ˜“å¯¼è‡´è®­ç»ƒä¸ç¨³å®šã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œå¯¹äºæ¯ä¸ªåºåˆ—ï¼Œè®¡ç®—ï¼š</p>
<p>$$
\delta_i = \frac{1}{|y_i|} \sum_{t=1}^{|y_i|} \bigl( \log \pi_{\text{old}}(y_{i,t}|x, y_{i,&lt;t}) - \log \pi_\theta(y_{i,t}|x, y_{i,&lt;t}) \bigr)
$$</p>
<p>å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œåºåˆ— $i$ å°†è¢« mask æ‰ï¼ˆå¹³å‡åªåœ¨ completion token ä¸Šè®¡ç®—ï¼Œå³ <code class="docutils literal notranslate"><span class="pre">completion_mask=1</span></code> çš„ä½ç½®ï¼‰ï¼š</p>
<ol class="simple">
<li><p>$\delta_i &gt; \tau$</p></li>
<li><p><strong>ä¸”</strong> $\hat{A}_i &lt; 0$</p></li>
</ol>
<p>å…¶ä¸­ï¼š</p>
<ul class="simple">
<li><p>$\pi_{\text{old}}$ ä¼˜å…ˆä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">rollout_per_token_logps</span></code>ï¼ˆrollout/è¡Œä¸ºç­–ç•¥çš„ logprobsï¼‰ï¼Œè‹¥ä¸å­˜åœ¨åˆ™ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">old_per_token_logps</span></code></p></li>
<li><p>$\tau$ æ˜¯ç”¨æˆ·è®¾ç½®çš„é˜ˆå€¼ï¼ˆ<code class="docutils literal notranslate"><span class="pre">--off_policy_sequence_mask_delta</span></code>ï¼Œé»˜è®¤ None è¡¨ç¤ºå…³é—­ï¼‰</p></li>
</ul>
<p>å‚è€ƒèµ„æ–™</p>
<ol class="simple">
<li><p>https://yingru.notion.site/When-Speed-Kills-Stability-Demystifying-RL-Collapse-from-the-Training-Inference-Mismatch-271211a558b7808d8b12d403fd15edda</p></li>
<li><p>https://fengyao.notion.site/off-policy-rl</p></li>
<li><p>https://github.com/volcengine/verl/blob/main/verl/trainer/ppo/rollout_corr_helper.py</p></li>
<li><p><a class="reference external" href="https://arxiv.org/abs/2512.02556">DeepSeek-V3.2: Pushing the Frontier of Open Large Language Models</a></p></li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>