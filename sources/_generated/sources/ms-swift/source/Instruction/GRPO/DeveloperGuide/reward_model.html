

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¥–åŠ±æ¨¡å‹ &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">å¥–åŠ±æ¨¡å‹</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../../_sources/sources/_generated/sources/ms-swift/source/Instruction/GRPO/DeveloperGuide/reward_model.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>å¥–åŠ±æ¨¡å‹<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h1>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¥–åŠ±æ¨¡å‹æ˜¯æŒ‡å…·æœ‰åˆ†ç±»å¤´æ•°å€¼è¾“å‡ºçš„æ¨¡å‹ï¼Œé€šå¸¸ç§°ä¸ºè¾“å‡ºå¥–åŠ±æ¨¡å‹ï¼ˆORMï¼‰ã€‚è¿™äº›æ¨¡å‹ä¼šå¯¹å…¶ä»–æ¨¡å‹çš„è¾“å‡ºè¿›è¡Œè¯„åˆ†ï¼Œä»è€Œç”Ÿæˆä¸€ä¸ªæ ‡é‡å€¼ï¼Œè¡¨ç¤ºæ¨¡å‹å“åº”çš„è´¨é‡ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨å‚æ•° <code class="docutils literal notranslate"><span class="pre">reward_models</span></code> æ¥åŠ è½½å…·æœ‰åˆ†ç±»å¤´çš„å¥–åŠ±æ¨¡å‹ï¼Œæˆ–è€…åŠ è½½ç»è¿‡<a class="reference external" href="../../RLHF.md#rm">å¥–åŠ±å»ºæ¨¡</a>è®­ç»ƒçš„å¥–åŠ±æ¨¡å‹ï¼Œè¿›è€Œä½¿ç”¨æ¨¡å‹çš„logitsä½œä¸ºå¥–åŠ±ã€‚</p>
<section id="id2">
<h2>è‡ªå®šä¹‰å¥–åŠ±æ¨¡å‹<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h2>
<p>å¯¹äºç”Ÿæˆå¼å¥–åŠ±æ¨¡å‹ï¼Œæœ‰ä¸¤ç§å¸¸è§çš„è°ƒç”¨æ–¹å¼ï¼šä¸€ç§æ˜¯åœ¨ Trainer å†…éƒ¨ç›´æ¥ä½¿ç”¨ reward_model_plugin å®šä¹‰å¥–åŠ±æ¨¡å‹çš„é€»è¾‘ï¼Œå¯ä»¥ä½¿ç”¨TransformersEngineå¯¹å¥–åŠ±æ¨¡å‹è¿›è¡Œæ¨ç†ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡å¤–éƒ¨éƒ¨ç½²çš„æ¨¡å‹æœåŠ¡è¿›è¡Œè°ƒç”¨ã€‚</p>
<ul class="simple">
<li><p>ä½¿ç”¨ reward_model_plugin è°ƒç”¨å¥–åŠ±æ¨¡å‹æ—¶ï¼Œæ¨¡å‹ä¼šè¢«å†…åµŒåœ¨ Trainer å†…éƒ¨ï¼Œæ— éœ€é¢å¤–å ç”¨è®¡ç®—èµ„æºã€‚è¯¥æ–¹å¼ä¼˜ç‚¹æ˜¯æ–¹ä¾¿é›†æˆï¼Œä½†ç”Ÿæˆé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼Œæ›´é€‚åˆå‚æ•°é‡è¾ƒå°çš„å¥–åŠ±æ¨¡å‹åœºæ™¯ã€‚</p></li>
<li><p>å¤–éƒ¨éƒ¨ç½²å¥–åŠ±æ¨¡å‹æ—¶ï¼Œå¯ä»¥é€šè¿‡è¯¸å¦‚ swift deploy æˆ– vllm serve ç­‰å‘½ä»¤å°†æ¨¡å‹æœåŠ¡éƒ¨ç½²äºç‹¬ç«‹è®¾å¤‡ï¼Œå¤§å¹…æå‡æ¨ç†é€Ÿåº¦ï¼Œé€‚åˆå‚æ•°é‡è¾ƒå¤§çš„æ¨¡å‹ã€‚ä½†è¿™æ ·éœ€è¦é¢„ç•™é¢å¤–çš„ç¡¬ä»¶èµ„æºã€‚</p></li>
</ul>
<section id="id3">
<h3>å†…éƒ¨æ’ä»¶<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h3>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ reward_model_plugin ä¸­çµæ´»åœ°è‡ªå®šä¹‰å¥–åŠ±æ¨¡å‹çš„å¤„ç†é€»è¾‘ã€‚è¿™ä½¿å¾—å®ç°è¯¸å¦‚ç”Ÿæˆå¼å¥–åŠ±æ¨¡å‹ç­‰æŠ€æœ¯æˆä¸ºå¯èƒ½ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul class="simple">
<li><p>è‡ªå®šä¹‰æ¨¡å‹çš„ç³»ç»Ÿæç¤ºï¼šå®šä¹‰ç‰¹å®šçš„æŒ‡ä»¤å’Œä¸Šä¸‹æ–‡ä»¥æŒ‡å¯¼è¯„ä¼°è¿‡ç¨‹ã€‚</p></li>
<li><p>å¤„ç†æ¨¡å‹äº¤äº’å†å²ï¼šç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œä»¥æä¾›æœ‰æ„ä¹‰ä¸”å…·æœ‰ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„è¯„ä¼°ã€‚</p></li>
<li><p>å®šä¹‰è‡ªå®šä¹‰è¯„ä¼°æ ‡å‡†ï¼šè®¾ç½®ç‹¬ç‰¹çš„æ ‡å‡†å’Œåº¦é‡ï¼Œç”¨äºè¯„ä¼°æ¨¡å‹çš„å“åº”ï¼Œè¶…è¶Šé»˜è®¤çš„å‡†ç¡®æ€§å’Œç›¸å…³æ€§è¡¡é‡æ ‡å‡†ã€‚</p></li>
</ul>
<p>é€šè¿‡reward_model_pluginï¼Œå¼€å‘è€…å¯ä»¥é’ˆå¯¹å…¶åº”ç”¨çš„ç‰¹å®šéœ€æ±‚å®šåˆ¶å¥–åŠ±è¯„ä¼°è¿‡ç¨‹ã€‚è¿™ç§çµæ´»æ€§å…è®¸æ›´ç»†è‡´å’Œæœ‰æ•ˆçš„åŸºäºå¥–åŠ±çš„è®­ç»ƒç­–ç•¥ã€‚</p>
<p>å¥–åŠ±æ¨¡å‹é€šè¿‡pluginçš„<code class="docutils literal notranslate"><span class="pre">__call__</span></code>æ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼Œè¯¥æ–¹æ³•æ¥å— <code class="docutils literal notranslate"><span class="pre">inputs</span></code> ä½œä¸ºå‚æ•°ï¼ŒåŒ…å«äº†æ¨¡å‹è¾“å…¥è¾“å‡ºçš„ messages å’Œæ•°æ®é›†ä¸­çš„å…¶ä»–åˆ—</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[</span>
<span class="s2">    {</span>
<span class="s2">        &#39;messages&#39;: [</span>
<span class="s2">                {&#39;role&#39;: &#39;system&#39;, &#39;content&#39;: &#39;system prompt&#39;},</span>
<span class="s2">                {&#39;role&#39;: &#39;query&#39;, &#39;content&#39;: &#39;query&#39;},</span>
<span class="s2">                {&#39;role&#39;: &#39;user&#39;, &#39;content&#39;: &#39;completions1&#39;},</span>
<span class="s2">            ],</span>
<span class="s2">        &#39;solution&#39;: &quot;abc&quot;,</span>
<span class="s2">    },</span>
<span class="s2">    {</span>
<span class="s2">        &#39;messages&#39;: [</span>
<span class="s2">                {&#39;role&#39;: &#39;system&#39;, &#39;content&#39;: &#39;system prompt&#39;},</span>
<span class="s2">                {&#39;role&#39;: &#39;query&#39;, &#39;content&#39;: &#39;query&#39;},</span>
<span class="s2">                {&#39;role&#39;: &#39;user&#39;, &#39;content&#39;: &#39;completions2&#39;},</span>
<span class="s2">            ],</span>
<span class="s2">        &#39;solution&#39;: &quot;abc&quot;,</span>
<span class="s2">    }</span>
<span class="s2">]</span>
</pre></div>
</div>
<p>åœ¨æ’ä»¶ä¸­ä½¿ç”¨ TransformersEngine è¿›è¡Œå¥–åŠ±æ¨¡å‹çš„æ¨ç†ï¼Œ æˆ‘ä»¬åªéœ€æ„é€  messages ï¼Œå¹¶é€šè¿‡ infer æ¥å£è°ƒç”¨ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RMPlugin</span><span class="p">(</span><span class="n">DefaultRMPlugin</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="c1"># initilize TransformersEngine to infer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">TransformersEngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="o">...</span>
        <span class="n">query</span> <span class="o">=</span> <span class="o">...</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">}]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">infer</span><span class="p">([</span><span class="n">messages</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_config</span><span class="p">,</span> <span class="n">use_tqdm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="o">...</span>
        <span class="k">return</span> <span class="n">rewards</span>
</pre></div>
</div>
<p>æˆ‘ä»¬åœ¨ <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/rewards/rm_plugin.py">rm_plugin.py</a> ä¸­æä¾›äº†ä¸€ä¸ªç®€å•çš„ç”Ÿæˆå¼å¥–åŠ±æ¨¡å‹ç¤ºä¾‹ï¼ˆGenRMPluginï¼‰ã€‚</p>
<p>åœ¨ <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/grpo/plugin/plugin.py">plugin.py</a> ä¸­è‡ªå®šä¹‰å¥–åŠ±æ¨¡å‹æ’ä»¶ï¼Œå¹¶ä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">external_plugins</span></code> å‚æ•°è¿›è¡Œæ³¨å†Œã€‚</p>
<p>æ³¨æ„ï¼š</p>
<ol class="simple">
<li><p>åœ¨ GRPOTrainer ä¸­ï¼Œreward_model ä¼šä¾æ¬¡appendåˆ° reward_funcs ä¸­ã€‚å› æ­¤ï¼Œreward_weights çš„é¡ºåºå¯¹åº” [reward_funcs, reward_model]ã€‚</p></li>
<li><p>reward_model_plugin é»˜è®¤ä¸º defaultï¼Œå³ä½¿ç”¨ ORM å¤„ç†é€»è¾‘ã€‚</p></li>
<li><p>å¯¹äºå‚æ•°é‡è¾ƒå¤§çš„æ¨¡å‹ï¼ŒTransformersEngine ç”Ÿæˆé€Ÿåº¦è¾ƒæ…¢ï¼Œè¯·ä½¿ç”¨<a class="reference external" href="#%E5%A4%96%E9%83%A8%E9%83%A8%E7%BD%B2">å¤–éƒ¨éƒ¨ç½²</a>æ–¹æ³•</p></li>
</ol>
<p>å¯¹äº BERT è¿™ç±»æ— æ³•é€šè¿‡ reward_model åŠ è½½çš„æ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥å†…ç½®åœ¨ reward_function ä¸­è¿›è¡ŒåŠ è½½ï¼Œå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/issues/4580">issue</a></p>
</section>
<section id="id4">
<h3>å¤–éƒ¨éƒ¨ç½²<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h3>
<p><strong>ç¤ºä¾‹ 2ï¼šä½¿ç”¨ swift deploy éƒ¨ç½²å¥–åŠ±æ¨¡å‹å¹¶è¿›è¡Œè¿œç¨‹è°ƒç”¨</strong></p>
<p>è¿™ç±»æ–¹æ³•åˆ™ä¸éœ€è¦ä½¿ç”¨ reward_model_plugin , è€Œæ˜¯ç›´æ¥åœ¨å¥–åŠ±å‡½æ•°ä¸­è¿›è¡Œè°ƒç”¨å³å¯</p>
<p>é¦–å…ˆç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨æ¨¡å‹æœåŠ¡ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># æ³¨æ„éƒ¨ç½²çš„è®¾å¤‡ä¸è¦ä¸è®­ç»ƒè®¾å¤‡é‡å </span>
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1,2,3<span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>deploy<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model<span class="w"> </span>Qwen/Qwen2.5-72B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_tensor_parallel_size<span class="w"> </span><span class="m">4</span>

<span class="c1"># [INFO:swift] model_list: [&#39;Qwen2.5-72B-Instruct&#39;]</span>
<span class="c1"># INFO:     Started server process [xxxxxx]</span>
<span class="c1"># INFO:     Waiting for application startup.</span>
<span class="c1"># INFO:     Application startup complete.</span>
<span class="c1"># INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)</span>
</pre></div>
</div>
<p>åœ¨å¥–åŠ±å‡½æ•°ä¸­é€šè¿‡ OpenAI åº“åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼ŒæŒ‡å®šæ¨¡å‹æœåŠ¡çš„åœ°å€å’Œç«¯å£ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RMReward</span><span class="p">(</span><span class="n">ORM</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span>
                <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;EMPTY&#39;</span><span class="p">,</span>
                <span class="n">base_url</span><span class="o">=</span><span class="s1">&#39;http://127.0.0.1:8000/v1&#39;</span><span class="p">,</span> <span class="c1"># è‹¥åœ¨æœ¬åœ°éƒ¨ç½²åˆ™ä¸º 127.0.0.1</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">list</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Failed to connect to the model service. Please deploy the model &#39;</span>
                               <span class="s2">&quot;using &#39;swift deploy&#39; or &#39;vllm serve&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completions</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">completion</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">completions</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
            <span class="n">rm_prompt</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># æ„å»º reward model çš„prompt</span>
            <span class="n">chat_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_model_name</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;You are a helpful assistant.&#39;</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">rm_prompt</span>
                    <span class="p">},</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">chat_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># æ ¹æ®å¥–åŠ±æ¨¡å‹ç”Ÿæˆç»“æœæå–å¥–åŠ±å€¼</span>
            <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rewards</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>