

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GRPO &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">GRPO</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../../../_sources/sources/_generated/sources/ms-swift/source/Instruction/GRPO/GetStarted/GRPO.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="grpo">
<h1>GRPO<a class="headerlink" href="#grpo" title="Link to this heading">ïƒ</a></h1>
<p>GRPOTraineråœ¨ms-swift3.5è¿›è¡Œäº†ä»£ç é‡æ„ï¼Œå¦‚æœä½ ä½¿ç”¨çš„swiftç‰ˆæœ¬&lt;3.5, è¯·å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/v3.4.1/docs/source/Instruction/GRPO.md">stableæ–‡æ¡£</a></p>
<p><a class="reference external" href="https://arxiv.org/abs/2402.03300">GRPO(Group Relative Policy Optimization)</a> ç®—æ³•åˆ©ç”¨ç»„å†…ç›¸å¯¹ä¼˜åŠ¿è®¡ç®—æ¥æ›¿ä»£ PPO ç®—æ³•ä¸­ç‹¬ç«‹çš„ä»·å€¼æ¨¡å‹ï¼Œå¹¶ç›´æ¥åœ¨æŸå¤±å‡½æ•°ä¸­åŠ å…¥ KL æ•£åº¦æƒ©ç½šæ¥æé«˜è®­ç»ƒç¨³å®šæ€§ã€‚</p>
<section id="id1">
<h2>ç®—æ³•åŸç†<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h2>
<p>GRPO ç›®æ ‡å‡½æ•°</p>
<p>$
{\scriptstyle
\begin{aligned}
\mathcal{J}<em>{G R P O}(\theta) &amp; =\mathbb{E}</em>{\left[q \sim P(Q),\left{o_i\right}<em>{i=1}^G \sim \pi</em>{\theta_{o l d}}(O \mid q)\right]} \
&amp; \frac{1}{G} \sum_{i=1}^G \frac{1}{\left|o_i\right|} \sum_{t=1}^{\left|o_i\right|}\left{\min \left[\frac{\pi_\theta\left(o_{i, t} \mid q, o_{i,&lt;t}\right)}{\pi_{\theta_{o l d}}\left(o_{i, t} \mid q, o_{i,&lt;t}\right)} \hat{A}<em>{i, t}, \operatorname{clip}\left(\frac{\pi</em>\theta\left(o_{i, t} \mid q, o_{i,&lt;t}\right)}{\pi_{\theta_{o l d}}\left(o_{i, t} \mid q, o_{i,&lt;t}\right)}, 1-\varepsilon, 1+\varepsilon\right) \hat{A}<em>{i, t}\right]-\beta \mathbb{D}</em>{K L}\left[\pi_\theta| | \pi_{r e f}\right]\right}
\end{aligned}
}
$</p>
<p>å…¶ä¸­ä¼˜åŠ¿å‡½æ•°å®šä¹‰ä¸º</p>
<p>$
\hat{A}<em>{i,t} = \frac{R_i - \text{mean}({R_j}</em>{j=1}^G)}{\text{std}({R_j}_{j=1}^G)}
$</p>
<details> <summary>GRPOç®—æ³•ä¼ªä»£ç </summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ========== 1. Rollout Generation Phase ==========</span>
<span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;Question: Which is bigger? 9.11 or 9.9?&quot;</span>

<span class="c1"># Generate multiple completions through parallel sampling</span>
<span class="n">completions</span> <span class="o">=</span> <span class="n">rollout_function</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">current_policy_model</span><span class="p">,</span>
    <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
    <span class="n">num_generations</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>  <span class="c1"># Hyperparameter: number of samples per prompt</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span>     <span class="c1"># Hyperparameter: sampling diversity</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">completions = [</span>
<span class="sd">    (completion 1) &quot;The larger number is 9.11...&quot;,</span>
<span class="sd">    (completion 2) &quot;9.9 is bigger than...&quot;,</span>
<span class="sd">    ...</span>
<span class="sd">    (completion 8) &quot;After calculation, 9.11...&quot;</span>
<span class="sd">]</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ========== 2. Reward Calculation Phase ==========</span>
<span class="c1"># Evaluate generated completions using reward model</span>
<span class="n">rewards</span> <span class="o">=</span> <span class="n">reward_function</span><span class="p">(</span>
    <span class="n">completions</span><span class="o">=</span><span class="n">completions</span><span class="p">,</span>
    <span class="n">ground_truth</span><span class="o">=</span><span class="s2">&quot;9.11&quot;</span>  <span class="c1"># Expected correct answer</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">rewards = [</span>
<span class="sd">    (reward 1) 1.0,  # Correct answer</span>
<span class="sd">    (reward 2) 0.0,  # Incorrect</span>
<span class="sd">    ...</span>
<span class="sd">    (reward 8) 1.0   # Correct</span>
<span class="sd">]</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Normalize rewards to advantages</span>
<span class="n">rewards_mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>  <span class="c1"># Î¼ = 0.5</span>
<span class="n">rewards_std</span> <span class="o">=</span> <span class="n">std</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>    <span class="c1"># Ïƒ = 0.25</span>
<span class="n">advantages</span> <span class="o">=</span> <span class="p">(</span><span class="n">rewards</span> <span class="o">-</span> <span class="n">rewards_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rewards_std</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>  <span class="c1"># Standardization</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">advantages = [</span>
<span class="sd">    (advantage 1)  2.0,  # (1.0 - 0.5)/0.25</span>
<span class="sd">    (advantage 2) -2.0,</span>
<span class="sd">    ...</span>
<span class="sd">    (advantage 8)  2.0</span>
<span class="sd">]</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ========== 3. Policy Optimization Phase ==========</span>
<span class="c1"># Get token-level log probabilities from different models</span>
<span class="n">current_logps</span> <span class="o">=</span> <span class="n">get_per_token_logps</span><span class="p">(</span><span class="n">current_policy_model</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">completions</span><span class="p">)</span>  <span class="c1"># Ï€_Î¸</span>
<span class="n">old_logps</span> <span class="o">=</span> <span class="n">get_per_token_logps</span><span class="p">(</span><span class="n">old_policy_model</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">completions</span><span class="p">)</span>          <span class="c1"># Ï€_Î¸_old</span>
<span class="n">ref_logps</span> <span class="o">=</span> <span class="n">get_per_token_logps</span><span class="p">(</span><span class="n">reference_model</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">completions</span><span class="p">)</span>           <span class="c1"># Ï€_ref</span>

<span class="c1"># PPO Clipped Objective</span>
<span class="n">is_ratio</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">current_logps</span> <span class="o">-</span> <span class="n">old_logps</span><span class="p">)</span>  <span class="c1"># Importance sampling ratio: e^(Ï€_Î¸ - Ï€_Î¸_old)</span>
<span class="n">clipped_ratio</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">is_ratio</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">Îµ</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">Îµ</span><span class="p">)</span>   <span class="c1"># Îµ=0.2 typically</span>

<span class="c1"># Policy gradient term (dual form)</span>
<span class="n">policy_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">mean</span><span class="p">(</span>
    <span class="n">minimum</span><span class="p">(</span><span class="n">is_ratio</span> <span class="o">*</span> <span class="n">advantages</span><span class="p">,</span>       <span class="c1"># Unclipped objective</span>
           <span class="n">clipped_ratio</span> <span class="o">*</span> <span class="n">advantages</span><span class="p">)</span>  <span class="c1"># Clipped objective</span>
<span class="p">)</span>

<span class="c1"># KL Divergence Penalty (K3 estimator)</span>
<span class="c1"># KL(Ï€_Î¸||Ï€_ref) â‰ˆ e^(logÏ€_ref - logÏ€_Î¸) - (logÏ€_ref - logÏ€_Î¸) - 1</span>
<span class="n">kl_penalty</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">mean</span><span class="p">(</span>
    <span class="n">exp</span><span class="p">(</span><span class="n">ref_logps</span> <span class="o">-</span> <span class="n">current_logps</span><span class="p">)</span> <span class="o">-</span>
    <span class="p">(</span><span class="n">ref_logps</span> <span class="o">-</span> <span class="n">current_logps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Total Loss = Policy Loss + KL Penalty</span>
<span class="n">total_loss</span> <span class="o">=</span> <span class="n">policy_loss</span> <span class="o">+</span> <span class="n">kl_penalty</span>

<span class="c1"># ========== 4. Update Rule ==========</span>
<span class="c1"># Apply gradient descent to minimize total_loss</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>
</div>
</details><p>è®­ç»ƒè„šæœ¬ç¤ºä¾‹å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/grpo">examples</a></p>
<p>GRPOå‚æ•°å‚è€ƒ<a class="reference external" href="../../../Instruction/Command-line-parameters.md#grpo%E5%8F%82%E6%95%B0">æ–‡æ¡£</a></p>
</section>
<section id="id2">
<h2>é›†ç¾¤æ”¯æŒ<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h2>
<p><img alt="../../../../../../../../_images/grpo.png" src="../../../../../../../../_images/grpo.png" /></p>
<p>GRPO è®­ç»ƒæ¡†æ¶æ”¯æŒé›†æˆé«˜æ€§èƒ½æ¨ç†å¼•æ“ï¼ˆå¦‚ vLLMï¼‰æ¥åŠ é€Ÿé‡‡æ ·è¿‡ç¨‹ï¼Œæä¾›ä»¥ä¸‹ä¸¤ç§éƒ¨ç½²æ¨¡å¼ï¼š</p>
<section id="colocate-internal-mode">
<h3>1. Colocate(Internal) Mode<a class="headerlink" href="#colocate-internal-mode" title="Link to this heading">ïƒ</a></h3>
<p>è®­ç»ƒä¸æ¨ç†å…±äº«GPUèµ„æºï¼Œåœ¨ Trainer å†…éƒ¨å¯åŠ¨æ¨ç†æœåŠ¡ï¼Œ</p>
<p>å¯åŠ¨å‚æ•°</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--use_vllm<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
--vllm_mode<span class="w"> </span>colocate
</pre></div>
</div>
<section id="colocate">
<h4>Colocate æ¨¡å¼ä¸‹çš„æ˜¾å­˜ä¼˜åŒ–æ–¹æ¡ˆ<a class="headerlink" href="#colocate" title="Link to this heading">ïƒ</a></h4>
<p>åœ¨ Colocate æ¨¡å¼ä¸‹è¿è¡Œæ—¶ï¼Œå®¹æ˜“å‡ºç°æ˜¾å­˜ä¸è¶³ï¼ˆOOMï¼‰çš„æƒ…å†µã€‚ä»¥ä¸‹æ˜¯å‡ ç§æœ‰æ•ˆçš„æ˜¾å­˜ä¼˜åŒ–æ–¹æ³•å’Œå‚æ•°é…ç½®ï¼š</p>
<ol class="simple">
<li><p>é™ä½<code class="docutils literal notranslate"><span class="pre">vllm_gpu_memory_utilization</span></code> å‚æ•°</p></li>
<li><p>åœ¨è®­ç»ƒé˜¶æ®µï¼Œé‡Šæ”¾ vLLM å ç”¨çš„æ˜¾å­˜ï¼š</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--sleep_level<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<ol class="simple">
<li><p>åœ¨vLLM æ¨ç†é˜¶æ®µï¼Œé‡Šæ”¾æ¨¡å‹å’Œä¼˜åŒ–å™¨å ç”¨çš„æ˜¾å­˜ï¼š</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--offload_optimizer<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
--offload_model<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<ol class="simple">
<li><p>åœ¨vLLMä¸­ä½¿ç”¨ Tensor Parallel æŠ€æœ¯ï¼š</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--vllm_tensor_parallel_size<span class="w"> </span><span class="o">[</span>tp_size<span class="o">]</span>
</pre></div>
</div>
<ol class="simple">
<li><p>åˆ†æ‰¹ Gather æ¨¡å‹æƒé‡ï¼ˆzero3ä¸‹åŒæ­¥ vLLM æƒé‡æ—¶ï¼‰ï¼š</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--move_model_batches<span class="w"> </span><span class="o">[</span>æ‰¹æ¬¡æ•°é‡<span class="o">]</span>
</pre></div>
</div>
<ol class="simple">
<li><p>å°† Megatron å¯¼å‡ºçš„ç”¨äº vLLM æ›´æ–°çš„ HF æ ¼å¼æƒé‡å­˜æ”¾åœ¨ CPU ä¸»å­˜ä¸­ï¼Œä»¥é™ä½ GPU æ˜¾å­˜å ç”¨ï¼š</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--offload_bridge<span class="w"> </span><span class="nb">true</span>
</pre></div>
</div>
</section>
</section>
<section id="async-external-mode">
<h3>2. Async(External) Mode<a class="headerlink" href="#async-external-mode" title="Link to this heading">ïƒ</a></h3>
<p>è®­ç»ƒä¸æ¨ç†èµ„æºåˆ†ç¦»ï¼Œå¯åŠ¨å•ç‹¬çš„æ¨ç†æœåŠ¡å™¨</p>
<p>ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">rollout</span></code>å‘½ä»¤éƒ¨ç½²vLLM æœåŠ¡å™¨, ç°ä»…æ”¯æŒvLLM backend</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>rollout<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--model<span class="w"> </span>Qwen/Qwen2.5-VL-7B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--vllm_tensor_parallel_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--vllm_data_parallel_size<span class="w"> </span><span class="m">1</span>

<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1<span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>rollout<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--model<span class="w"> </span>Qwen/Qwen2.5-VL-7B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--vllm_tensor_parallel_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--vllm_data_parallel_size<span class="w"> </span><span class="m">1</span>

<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>,1,2,3<span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>rollout<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--model<span class="w"> </span>Qwen/Qwen2.5-VL-7B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--vllm_tensor_parallel_size<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--vllm_data_parallel_size<span class="w"> </span><span class="m">2</span>
</pre></div>
</div>
<p>æ›´å¤š rollout å‚æ•°å‚è€ƒ<a class="reference external" href="../../../Instruction/Command-line-parameters.md#vllm%E5%8F%82%E6%95%B0">vLLMå‚æ•°</a>å’Œ<a class="reference external" href="../../../Instruction/Command-line-parameters.md#rollout%E5%8F%82%E6%95%B0">rollout å‚æ•°</a></p>
<p>æ³¨æ„ï¼šåœ¨ä½¿ç”¨ use_async_engine æ—¶ï¼Œä»…å¼€å¯ DP å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯ï¼Œç›¸å…³é—®é¢˜å‚è€ƒï¼š <a class="reference external" href="https://github.com/vllm-project/vllm/issues/18567">vllm issue</a>ã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œè¯·å°è¯•åŒæ—¶å¯ç”¨ TP å’Œ DPï¼Œæˆ–å‡çº§vLLM</p>
<p>è®­ç»ƒä½¿ç”¨ä»¥ä¸‹å‚æ•°é…ç½®å¤–éƒ¨ vLLM æœåŠ¡å™¨</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--use_vllm<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
--vllm_mode<span class="w"> </span>server<span class="w"> </span><span class="se">\</span>
--vllm_server_host<span class="w"> </span>&lt;æœåŠ¡å™¨IP&gt;<span class="w"> </span><span class="se">\</span>
--vllm_server_port<span class="w"> </span>&lt;æœåŠ¡ç«¯å£&gt;<span class="w"> </span><span class="se">\</span>
--vllm_server_timeout<span class="w"> </span>&lt;è¶…æ—¶æ—¶é—´&gt;<span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<section id="id3">
<h4>æƒé‡åŒæ­¥åŠ é€Ÿ<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h4>
<p>swift 3.10 ä¼˜åŒ–äº†æƒé‡åŒæ­¥ï¼Œè®¾ç½®ä»¥ä¸‹å‚æ•°å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ– LoRA è®­ç»ƒçš„æƒé‡åŒæ­¥é€Ÿåº¦ã€‚</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># rollout(server mode)</span>
swift<span class="w"> </span>rollout<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_enable_lora<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_max_lora_rank<span class="w"> </span>xxx<span class="w"> </span><span class="c1"># ä¸è®­ç»ƒè„šæœ¬lora_rankä¸€è‡´</span>
<span class="w">    </span>...

<span class="c1"># grpo(colocate mode)</span>
swift<span class="w"> </span>rlhf<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--rlhf_type<span class="w"> </span>grpo<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_mode<span class="w"> </span>colocate<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--vllm_enable_lora<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>...
</pre></div>
</div>
<p>æ³¨æ„ï¼šä»¥ä¸‹æƒ…å†µæ— æ³•ä½¿ç”¨è¯¥ä¼˜åŒ–ï¼š</p>
<ul class="simple">
<li><p>è®­ç»ƒå¤šæ¨¡æ€æ¨¡å‹çš„ViTå±‚(freeze_vit false)</p></li>
<li><p>MoE æ¨¡å‹</p></li>
</ul>
<p>ä¼˜åŒ–å®ç°ç»†èŠ‚è¯·å‚è€ƒè¯¥<a class="reference external" href="https://github.com/modelscope/ms-swift/pull/5773">PR</a></p>
</section>
</section>
</section>
<section id="logged-metrics">
<h2>logged metrics<a class="headerlink" href="#logged-metrics" title="Link to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p>completions/mean_lengthï¼šç”Ÿæˆçš„ completion çš„å¹³å‡é•¿åº¦ã€‚</p></li>
<li><p>completions/min_lengthï¼šç”Ÿæˆçš„ completion çš„æœ€å°é•¿åº¦ã€‚</p></li>
<li><p>completions/max_lengthï¼šç”Ÿæˆçš„ completion çš„æœ€å¤§é•¿åº¦ã€‚</p></li>
<li><p>completions/clipped_ratioï¼šè¢«é•¿åº¦æˆªæ–­çš„ completion å æ¯”ã€‚</p></li>
<li><p>reward/{reward_func_name}/meanï¼šæŸä¸ªç‰¹å®š reward function çš„å¹³å‡å¥–åŠ±å€¼ã€‚</p></li>
<li><p>reward/{reward_func_name}/stdï¼šæŸä¸ªç‰¹å®š reward function çš„å¥–åŠ±æ ‡å‡†å·®ã€‚</p></li>
</ul>
<blockquote>
<div><p>æ³¨æ„, ä¸Šè¿°ä¸¤ä¸ªæŒ‡æ ‡æ˜¯åœ¨æ‰€æœ‰ completions èŒƒå›´å†…ç»Ÿè®¡å¾—åˆ°çš„ã€‚</p>
</div></blockquote>
<ul class="simple">
<li><p>rewardï¼šåŠ æƒ reward_weights åçš„æ•´ä½“å¹³å‡å¥–åŠ±ã€‚</p></li>
<li><p>reward_stdï¼šåŠ æƒ reward_weights åï¼Œæ¯ä¸ª batch å†…æ•´ä½“å¥–åŠ±çš„æ ‡å‡†å·®ã€‚</p></li>
</ul>
<blockquote>
<div><p>æ³¨æ„ï¼šä¸Šè¿°ä¸¤ä¸ªæŒ‡æ ‡æ˜¯å…ˆåœ¨æ¯ä¸ªç»„å†…åˆ†åˆ«è®¡ç®—å‡å€¼/stdï¼Œç„¶åå†å¯¹å„ç»„çš„ç»“æœå–å¹³å‡ã€‚</p>
</div></blockquote>
<ul class="simple">
<li><p>frac_reward_zero_stdï¼šåœ¨ç”Ÿæˆ batch ä¸­ï¼Œreward æ ‡å‡†å·®ä¸ºé›¶çš„æ ·æœ¬æ¯”ä¾‹ï¼Œæ„å‘³ç€è¯¥ prompt ä¸Šçš„ç­”æ¡ˆå‡ ä¹æ— å¤šæ ·æ€§ï¼ˆæ‰€æœ‰å›ç­”å¥–åŠ±ä¸€è‡´ï¼‰ã€‚</p></li>
<li><p>klï¼šç”Ÿæˆçš„ completion ä¸Šï¼Œæ¨¡å‹ä¸å‚è€ƒæ¨¡å‹ä¹‹é—´çš„å¹³å‡ KL æ•£åº¦ã€‚ä»…å½“ beta éé›¶æ—¶è®°å½•ã€‚</p></li>
<li><p>clip_ratio/region_meanï¼šä¸åŒå¥å­ä¸­è¢« CLIP çš„çš„ token å¹³å‡æ¯”ä¾‹</p></li>
<li><p>clip_ratio/low_meanï¼šä¸åŒå¥å­ä¸­è¢« ä¸‹CLIP çš„çš„ token å¹³å‡æ¯”ä¾‹</p></li>
<li><p>clip_ratio/low_minï¼šä¸åŒå¥å­ä¸­è¢« ä¸‹CLIP çš„çš„ token æœ€å°æ¯”ä¾‹</p></li>
<li><p>clip_ratio/high_meanï¼šä¸åŒå¥å­ä¸­è¢« ä¸ŠCLIP çš„çš„ token å¹³å‡æ¯”ä¾‹</p></li>
<li><p>clip_ratio/high_maxï¼šä¸åŒå¥å­ä¸­è¢« ä¸ŠCLIP çš„çš„ token æœ€å¤§æ¯”ä¾‹</p></li>
</ul>
<blockquote>
<div><p>æ³¨æ„ï¼šå¦‚æœå¼€å¯<code class="docutils literal notranslate"><span class="pre">overlong_filter</span></code>, kl å’Œ clip_ratio æŒ‡æ ‡ä¼šè¿‡æ»¤è¶…é•¿çš„æ ·æœ¬</p>
</div></blockquote>
<p>å¦‚æœè®¾ç½®äº†<code class="docutils literal notranslate"><span class="pre">log_entropy</span></code>å‚æ•°ï¼Œåˆ™ä¼šé¢å¤–è®°å½•entropyç›¸å…³æŒ‡æ ‡ï¼ŒåŒ…æ‹¬</p>
<ul class="simple">
<li><p>entropy/mean: ä¸åŒå¥å­ä¸­çš„ entropy å‡å€¼</p></li>
<li><p>entropy/max: ä¸åŒå¥å­ä¸­çš„ entropy æœ€å¤§å€¼</p></li>
<li><p>entropy/min: ä¸åŒå¥å­ä¸­çš„ entropy æœ€å°å€¼</p></li>
</ul>
<blockquote>
<div><p>æ³¨æ„è¿™é‡Œçš„ å¥å­ entropy æŒ‡ completion ä¸­çš„ token entropy å‡å€¼</p>
</div></blockquote>
<p>å¦‚æœè®¾ç½®äº†<code class="docutils literal notranslate"><span class="pre">top_entropy_quantile</span></code>å‚æ•°&lt;1.0, åˆ™ä¼šè®°å½•entropy thresholdçš„å€¼</p>
<ul class="simple">
<li><p>entropy/threshold: åˆ†ä½ç‚¹å¤„çš„ entropy å€¼ï¼Œå°äºè¯¥å€¼çš„ token å°†ä¸ä¼šè¢«è®¡ç®— loss</p></li>
</ul>
<p>è®­æ¨ä¸€è‡´æ€§æŒ‡æ ‡ï¼Œå‰ç¼€ä¸ºrollout_correction (ms-swift&gt;=3.11)ï¼Œéœ€è®¾ç½®<code class="docutils literal notranslate"><span class="pre">log_rollout_offpolicy_metrics=true</span></code>æˆ–<code class="docutils literal notranslate"><span class="pre">rollout_importance_sampling_mode</span></code>ï¼š</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kl</span></code> / <code class="docutils literal notranslate"><span class="pre">k3_kl</span></code>ï¼šè®­ç»ƒç­–ç•¥ä¸ rollout ç­–ç•¥ä¹‹é—´çš„ KL æ•£åº¦ï¼ˆç›´æ¥ä¼°è®¡å™¨ / K3 ä¼°è®¡å™¨ï¼‰</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">training_ppl</span></code> / <code class="docutils literal notranslate"><span class="pre">rollout_ppl</span></code>ï¼šè®­ç»ƒç­–ç•¥å’Œ rollout ç­–ç•¥çš„å›°æƒ‘åº¦</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_ppl_diff</span></code>ï¼šlog PPL å·®å¼‚ï¼Œåæ˜ åˆ†å¸ƒåç§»ç¨‹åº¦</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ppl_ratio</span></code>ï¼šPPL æ¯”ç‡</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chi2_token</span></code> / <code class="docutils literal notranslate"><span class="pre">chi2_seq</span></code>ï¼šToken/Sequence çº§åˆ«çš„ Ï‡Â² æ•£åº¦</p></li>
</ul>
<p>IS æ ¡æ­£æŒ‡æ ‡ï¼ˆéœ€è®¾ç½®<code class="docutils literal notranslate"><span class="pre">rollout_importance_sampling_mode</span></code>ï¼‰ï¼š</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">is_weight_mean</span></code>ï¼šå¹³å‡é‡è¦æ€§é‡‡æ ·æƒé‡</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ess</span></code>ï¼šæœ‰æ•ˆæ ·æœ¬å¤§å°ï¼ˆEffective Sample Sizeï¼‰</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clipped_frac</span></code>ï¼šè¢«æˆªæ–­æˆ–å±è”½çš„æ ·æœ¬æ¯”ä¾‹</p></li>
</ul>
<blockquote>
<div><p>è®­æ¨ä¸€è‡´æ€§æŒ‡æ ‡è¯¦ç»†è¯´æ˜è¯·å‚è€ƒæ–‡æ¡£ <a class="reference internal" href="../AdvancedResearch/training_inference_mismatch.html"><span class="doc">Training-Inference-Mismatch</span></a></p>
</div></blockquote>
<p>å¦‚æœè®¾ç½®äº†<code class="docutils literal notranslate"><span class="pre">log_completions</span></code>, å°†ä¿å­˜è®­ç»ƒåŠ¨æ€åœ¨outputå¯¹åº”æ–‡ä»¶å¤¹ä¸­ï¼ŒåŒ…æ‹¬</p>
<ul class="simple">
<li><p>stepï¼šè®°å½•æ—¶çš„è®­ç»ƒæ­¥æ•°</p></li>
<li><p>promptï¼šæ¨¡å‹è¾“å…¥</p></li>
<li><p>completionï¼šæ¨¡å‹é‡‡æ ·å›ç­”</p></li>
<li><p>{reward_func_name}ï¼šç‰¹å®šå¥–åŠ±</p></li>
<li><p>entropyï¼šentropy token å‡å€¼ï¼Œåœ¨è®¾ç½®<code class="docutils literal notranslate"><span class="pre">log_entropy</span></code>æ—¶è®°å½•</p></li>
</ul>
<p>è®¾ç½® <code class="docutils literal notranslate"><span class="pre">report_to</span> <span class="pre">wandb/swanlab</span></code> å°†è®­ç»ƒåŠ¨æ€Tableæ¨é€åˆ°å¯¹åº”çš„å¹³å°</p>
<p>å¦‚æœéœ€è¦åœ¨Tableä¸­é¢å¤–è®°å½•å…¶ä»–åˆ—ï¼Œè¯·åœ¨ <code class="docutils literal notranslate"><span class="pre">GRPOTrainer._generate_and_score_completions</span></code> æ–¹æ³•ä¸­ï¼Œè®¾ç½® metrics_to_gather å­—å…¸ã€‚</p>
<p>é»˜è®¤è‡ªåŠ¨æ£€æµ‹</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">image</span></code>ï¼šè§†è§‰æ•°æ®é›†å›¾åƒè¾“å…¥ã€‚(æš‚æ—¶åªæ”¯æŒwandb)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">solution</span></code>ï¼šæ•°æ®é›†ä¸­çš„ solution åˆ—ã€‚</p></li>
</ul>
</section>
<section id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Link to this heading">ïƒ</a></h2>
<p><strong>1. è®­ç»ƒè¿‡ç¨‹ä¸­ loss ç­‰äº0 / æ¥è¿‘0 / å°äº0</strong></p>
<p>æ­£å¸¸æƒ…å†µï¼Œ å‚è€ƒ<a class="reference external" href="https://github.com/huggingface/open-r1/issues/239#issuecomment-2646297851">issue</a></p>
<p><strong>2. num_generations / æ‰¹é‡å¤§å°ç›¸å…³</strong></p>
<p>åœ¨ GRPO ä¸­ï¼Œbatch_size ä»¥ completionï¼ˆæ¨¡å‹ç”Ÿæˆç»“æœï¼‰ ä¸ºå•ä½ã€‚ä¾‹å¦‚ï¼Œè®¾ç½® per_device_train_batch_size=8 è¡¨ç¤ºæ¯å¼  GPU åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šåŒæ—¶å¤„ç† 8 ä¸ª completion çš„ loss è®¡ç®—ã€‚</p>
<p>è®­ç»ƒé˜¶æ®µï¼Œåœ¨ä¸€æ¬¡å®Œæ•´çš„æ¢¯åº¦ç´¯è®¡ batch ä¸­ï¼Œæ€»çš„æ‰¹é‡å¤§å°ç­‰äºï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">effective_batch_size</span> <span class="o">=</span> <span class="n">num_processes</span> <span class="o">*</span> <span class="n">per_device_train_batch_size</span> <span class="o">*</span> <span class="n">gradient_accumulation_steps</span>
</pre></div>
</div>
<p>é‡‡æ ·é˜¶æ®µï¼Œæ€»çš„æ‰¹é‡å¤§å° (completion-level) æ•°é‡ç­‰äº:</p>
<ol class="simple">
<li><p>è®¾ç½® generation_batch_size ä¸‹ï¼Œç­‰äº generation_batch_size</p></li>
<li><p>è®¾ç½® steps_per_generation ä¸‹ï¼Œç­‰äº per_device_train_batch_size * steps_per_generation * num_processes</p></li>
<li><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œsteps_per_generation = gradient_accumulation_stepsï¼Œgeneration_batch_size = per_device_train_batch_size * steps_per_generation * num_processes = per_device_train_batch_size * gradient_accumulation_steps * num_processes = effective_batch_size</p></li>
</ol>
<p>åœ¨è¯„ä¼°é˜¶æ®µï¼Œcompletion çš„æ•°é‡ç­‰äºï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">num_processes</span> <span class="o">*</span> <span class="n">per_device_eval_batch_size</span>
</pre></div>
</div>
<p>å‚æ•° <code class="docutils literal notranslate"><span class="pre">num_generations</span></code> å¿…é¡»èƒ½å¤Ÿè¢«ä»¥ä¸Šé‡‡æ ·é˜¶æ®µå’Œè¯„ä¼°çš„æ€»æ‰¹é‡å¤§å°æ•´é™¤ï¼Œä»¥ä¿è¯ç”Ÿæˆä»»åŠ¡å¯ä»¥å‡åŒ€åˆ†é…åˆ°å„ä¸ªè®¾å¤‡ä¸Šã€‚</p>
<p><strong>ç¤ºä¾‹</strong></p>
<ul class="simple">
<li><p>num_processes = 8</p></li>
<li><p>per_device_train_batch_size = 4</p></li>
<li><p>gradient_accumulation_steps = 8</p></li>
<li><p>generation_batch_size = 512</p></li>
<li><p>num_generations = 64</p></li>
</ul>
<ol class="simple">
<li><p>é‡‡æ ·éœ€è¦çš„æ€»æ•°æ®(prompt)é‡ç­‰äº 512 / 64 = 8</p></li>
<li><p>æ¯æ¬¡é‡‡æ · 512 æ¡æ¨¡å‹å›å¤</p></li>
<li><p>æ¯æ¬¡æ›´æ–°æ¨¡å‹æƒé‡æ‰¹é‡å¤§å°ä¸º 8 *4 * 8 = 256</p></li>
</ol>
<p><strong>3. ä¸ºä»€ä¹ˆ KL å‡ºç°äº†NaN</strong></p>
<p>å¼€å¯ overlong_filter åï¼ŒæŸä¸€å¡ä¸Šçš„æ‰€æœ‰ completion éƒ½è¢«æˆªæ–­</p>
<p><strong>4. è®­ç»ƒçš„stepsæ€ä¹ˆè®¡ç®—?</strong></p>
<p>å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/issues/3912">issue</a></p>
<p><strong>5. clip_ratioä¸ºä»€ä¹ˆæ€»æ˜¯0?</strong></p>
<p>Clipæœºåˆ¶çš„æ ¸å¿ƒç›®çš„æ˜¯é™åˆ¶ç­–ç•¥æ›´æ–°çš„å¹…åº¦ï¼Œé˜²æ­¢å› å•æ¬¡æ›´æ–°è¿‡å¤§è€Œå¯¼è‡´ç­–ç•¥æ€§èƒ½å´©æºƒï¼ˆå³ç­–ç•¥æ›´æ–°åè¡¨ç°æ€¥å‰§ä¸‹é™ï¼‰ã€‚
Clipæ“ä½œçš„å…·ä½“å…¬å¼å¦‚ä¸‹ï¼š</p>
<p>$
L_{\text{CLIP}}(\theta) = \mathbb{E}<em>{t} \left[ \min\left(r</em>{t}(\theta) \hat{A}<em>{t}, \text{clip}(r</em>{t}(\theta), 1 - \epsilon, 1 + \epsilon) \hat{A}_{t} \right) \right]
$</p>
<p>å…¶ä¸­ï¼š$r_{t}(\theta) = \frac{\pi_{\theta}(a_{t} \mid s_{t})}{\pi_{\text{old}}(a_{t} \mid s_{t})}$ æ˜¯é‡è¦æ€§é‡‡æ ·æ¯”ï¼Œè¡¡é‡æ–°æ—§ç­–ç•¥çš„å·®å¼‚ã€‚$\hat{A}<em>{t}$ æ˜¯ä¼˜åŠ¿å‡½æ•°ï¼ˆadvantage functionï¼‰ï¼Œè¡¨ç¤ºåŠ¨ä½œçš„ç›¸å¯¹æ”¶ç›Šã€‚$\epsilon$ ç”¨äºé™åˆ¶ $r</em>{t}(\theta)$ çš„åç¦»èŒƒå›´ã€‚</p>
<p>åœ¨ on-policy è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œç”±äºæ¯æ¬¡æ›´æ–°éƒ½ä½¿ç”¨æœ€æ–°ç­–ç•¥ç”Ÿæˆçš„æ•°æ®ï¼Œæ–°æ—§ç­–ç•¥ç›¸åŒï¼Œå³ $\pi_{\theta} = \pi_{\text{old}}$</p>
<p>å› æ­¤é‡è¦æ€§é‡‡æ ·æ¯”æ’ä¸º 1ï¼Œæ­¤æ—¶ï¼Œclip æ“ä½œä¸ä¼šç”Ÿæ•ˆã€‚</p>
<p>åœ¨è®¾ç½®ä»¥ä¸‹å‚æ•°æƒ…å†µä¸‹ï¼Œç®—æ³•ä¸ºoff-policy (near-on-policy)</p>
<ol class="simple">
<li><p>num_iterations &gt; 1, æˆ–è€…</p></li>
<li><p>gradient_accumulation_steps % steps_per_generation != 0</p></li>
</ol>
<p>å‚è€ƒ<a class="reference external" href="https://github.com/huggingface/open-r1/issues/239#issuecomment-2646297851">issue</a></p>
<p><strong>6. ä¸ºä»€ä¹ˆæ²¡æœ‰è®¾ç½®val_datasetï¼Œä»ç„¶æœ‰éªŒè¯è¿‡ç¨‹ï¼Œå¦‚ä½•å–æ¶ˆ</strong></p>
<p>å½“æ²¡æœ‰æ˜¾å¼ä¼ å…¥<code class="docutils literal notranslate"><span class="pre">val_dataset</span></code>æ—¶ï¼Œå‚æ•°<code class="docutils literal notranslate"><span class="pre">split_dataset_ratio</span></code>è´Ÿè´£åˆ‡åˆ†éƒ¨åˆ†<code class="docutils literal notranslate"><span class="pre">dataset</span></code>ä¸ºéªŒè¯æ•°æ®é›†ï¼Œé»˜è®¤åˆ‡åˆ†1%æ•°æ®ï¼ˆåœ¨&quot;ms-swift&gt;=3.6&quot;ä¸­ï¼Œ<code class="docutils literal notranslate"><span class="pre">split_dataset_ratio</span></code>çš„é»˜è®¤å€¼å°†ä»0.01ä¿®æ”¹ä¸º0.ï¼‰</p>
<p>é€šè¿‡è®¾ç½®<code class="docutils literal notranslate"><span class="pre">--split_dataset_ratio</span> <span class="pre">0</span></code> æ¥å–æ¶ˆéªŒè¯è¿‡ç¨‹</p>
<p><strong>7. å¦‚ä½•è®¾ç½®è®­ç»ƒçš„ <code class="docutils literal notranslate"><span class="pre">mini-batch</span> <span class="pre">size</span></code></strong></p>
<p>åœ¨ GRPO è®­ç»ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼é…ç½® mini-batch æ›´æ–°ï¼š</p>
<ul class="simple">
<li><p>è®¾ç½® <code class="docutils literal notranslate"><span class="pre">generation_batch_size</span></code> ä¸ºè®­ç»ƒ global batch size (effective_batch_size) çš„æ•´æ•°å€</p></li>
<li><p>æˆ–è®¾ç½® <code class="docutils literal notranslate"><span class="pre">steps_per_generation</span></code> ä¸º <code class="docutils literal notranslate"><span class="pre">gradient_accumulation_steps</span></code> çš„æ•´æ•°å€</p></li>
</ul>
<p>å…¸å‹é…ç½®ç¤ºä¾‹ï¼š</p>
<ul class="simple">
<li><p>å½“é…ç½®ï¼š
steps_per_generation = 16, gradient_accumulation_steps = 8, mini_batch_size = steps_per_generation / gradient_accumulation_steps = 2. åˆ™ 1 æ¬¡ rollout ç»“æœå°†æ‹†åˆ†æˆ 2 æ‰¹ mini-batch è¿›è¡Œæ›´æ–°ã€‚</p></li>
</ul>
<p><strong>8. swift deploy ä¸ swift rollout çš„åŒºåˆ«</strong></p>
<ul class="simple">
<li><p>swift deploy ä¸»è¦ç”¨äºæ¨¡å‹çš„éƒ¨ç½²å’Œæ¨ç†ï¼Œæ”¯æŒ PTã€vLLMã€SGLang ç­‰å¤šç§å¼•æ“ï¼Œå…¼å®¹æµå¼æ¨ç†ä¸ OpenAI API çš„è°ƒç”¨æ ¼å¼ã€‚</p></li>
<li><p>swift rollout åˆ™ä¸“æ³¨äº GRPO æ¨ç†åŠ é€Ÿï¼Œç›®å‰ä»…æ”¯æŒ vLLM å¼•æ“ï¼Œå¹¶å†…ç½®äº†æƒé‡è‡ªåŠ¨åŒæ­¥çš„åŠŸèƒ½ã€‚</p></li>
</ul>
<p><strong>9. å¦‚ä½•å–æ¶ˆ KL é¡¹æŸå¤±</strong></p>
<p>å°†å‚æ•°è®¾ç½®ä¸º <code class="docutils literal notranslate"><span class="pre">--beta</span> <span class="pre">0</span></code>ï¼Œå³å¯å…³é—­ KL æŸå¤±çš„è®¡ç®—ï¼Œå¹¶ä¸”ä¸ä¼šåŠ è½½å‚è€ƒæ¨¡å‹ï¼ˆref modelï¼‰ã€‚</p>
</section>
<section id="rl">
<h2>RLå¾®ä¿¡ç¾¤<a class="headerlink" href="#rl" title="Link to this heading">ïƒ</a></h2>
<img src="https://raw.githubusercontent.com/modelscope/ms-swift/main/docs/resources/wechat/grpo.png" width="250"></section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>