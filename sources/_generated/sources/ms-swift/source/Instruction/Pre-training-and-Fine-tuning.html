

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¢„è®­ç»ƒä¸å¾®è°ƒ &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">é¢„è®­ç»ƒä¸å¾®è°ƒ</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/sources/_generated/sources/ms-swift/source/Instruction/Pre-training-and-Fine-tuning.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>é¢„è®­ç»ƒä¸å¾®è°ƒ<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h1>
<p>è®­ç»ƒèƒ½åŠ›ï¼š</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å…¨å‚æ•°</th>
<th>LoRA</th>
<th>QLoRA</th>
<th>Deepspeed</th>
<th>å¤šæœº</th>
<th>å¤šæ¨¡æ€</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/pretrain">é¢„è®­ç»ƒ</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/lora_sft.sh">æŒ‡ä»¤ç›‘ç£å¾®è°ƒ</a></td>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/full/train.sh">âœ…</a></td>
<td>âœ…</td>
<td><a href="https://github.com/modelscope/ms-swift/tree/main/examples/train/qlora">âœ…</a></td>
<td><a href="https://github.com/modelscope/ms-swift/tree/main/examples/train/multi-gpu/deepspeed">âœ…</a></td>
<td><a href="https://github.com/modelscope/ms-swift/tree/main/examples/train/multi-node">âœ…</a></td>
<td><a href="https://github.com/modelscope/ms-swift/tree/main/examples/train/multimodal">âœ…</a></td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/grpo">GRPO</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/rlhf/gkd">GKD</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/multimodal/rlhf/gkd">âœ…</a></td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/rlhf/ppo">PPO</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/rlhf/dpo">DPO</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/multimodal/rlhf/dpo">âœ…</a></td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/rlhf/kto.sh">KTO</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/multimodal/rlhf/kto.sh">âœ…</a></td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/rlhf/rm.sh">å¥–åŠ±æ¨¡å‹</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/rlhf/cpo.sh">CPO</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/rlhf/simpo.sh">SimPO</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/rlhf/orpo.sh">ORPO</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/embedding">Embedding</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/tree/main/examples/train/reranker">Reranker</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><a href="https://github.com/modelscope/ms-swift/blob/main/examples/train/seq_cls">åºåˆ—åˆ†ç±»</a></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
</tbody>
</table><section id="id2">
<h2>ç¯å¢ƒå‡†å¤‡<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h2>
<p>æ¨èçš„ç¬¬ä¸‰æ–¹åº“ç‰ˆæœ¬å‚è€ƒ<a class="reference internal" href="../GetStarted/SWIFT-installation.html"><span class="doc">SWIFTå®‰è£…æ–‡æ¡£</span></a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>ms-swift<span class="w"> </span>-U

<span class="c1"># è‹¥ä½¿ç”¨deepspeed zero2/zero3</span>
pip<span class="w"> </span>install<span class="w"> </span>deepspeed<span class="w"> </span>-U
</pre></div>
</div>
</section>
<section id="id3">
<h2>é¢„è®­ç»ƒ<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h2>
<p>é¢„è®­ç»ƒä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">pt</span></code>å‘½ä»¤ï¼Œè¿™å°†è‡ªåŠ¨ä½¿ç”¨ç”Ÿæˆå¼è€Œéå¯¹è¯å¼çš„templateï¼Œå³å°†<code class="docutils literal notranslate"><span class="pre">use_chat_template</span></code>è®¾ç½®ä¸ºFalseï¼ˆå…¶ä»–æ‰€æœ‰çš„å‘½ä»¤ï¼Œä¾‹å¦‚<code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">sft/rlhf/infer</span></code>ï¼Œéƒ½é»˜è®¤å°†<code class="docutils literal notranslate"><span class="pre">use_chat_template</span></code>è®¾ç½®ä¸ºTrueï¼‰ã€‚æ­¤å¤–ï¼Œ<code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">pt</span></code>ä¸<code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">sft</span></code>ç›¸æ¯”ï¼Œå…·æœ‰ä¸åŒçš„æ•°æ®é›†æ ¼å¼ï¼Œå¯ä»¥å‚è€ƒ<a class="reference internal" href="../Customization/Custom-dataset.html"><span class="doc">è‡ªå®šä¹‰æ•°æ®é›†æ–‡æ¡£</span></a>ã€‚</p>
<p>ä½¿ç”¨CLIè¿›è¡Œé¢„è®­ç»ƒçš„è„šæœ¬å¯ä»¥å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/pretrain/train.sh">è¿™é‡Œ</a>ã€‚æ›´å¤šè®­ç»ƒæŠ€æœ¯çš„ä»‹ç»å¯ä»¥å‚è€ƒå¾®è°ƒç« èŠ‚ã€‚</p>
<p>å°è´´å£«ï¼š</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">pt</span></code>ä¸<code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">sft</span> <span class="pre">--use_chat_template</span> <span class="pre">false</span> <span class="pre">--loss_scale</span> <span class="pre">all</span></code>ç­‰ä»·ã€‚</p></li>
</ul>
</section>
<section id="id4">
<h2>å¾®è°ƒ<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h2>
<p>ms-swiftä½¿ç”¨äº†åˆ†å±‚å¼çš„è®¾è®¡æ€æƒ³ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œç•Œé¢ã€Web-UIç•Œé¢å’Œç›´æ¥ä½¿ç”¨Pythonçš„æ–¹å¼è¿›è¡Œå¾®è°ƒã€‚</p>
<section id="cli">
<h3>ä½¿ç”¨CLI<a class="headerlink" href="#cli" title="Link to this heading">ïƒ</a></h3>
<p>æˆ‘ä»¬æä¾›äº†10åˆ†é’Ÿåœ¨å•å¡3090ä¸Šå¯¹Qwen2.5-7B-Instructè¿›è¡Œè‡ªæˆ‘è®¤çŸ¥å¾®è°ƒçš„æœ€ä½³å®è·µï¼Œå…·ä½“å‚è€ƒ<a class="reference internal" href="../GetStarted/Quick-start.html"><span class="doc">è¿™é‡Œ</span></a>ï¼Œè¿™å¯ä»¥å¸®åŠ©æ‚¨å¿«é€Ÿäº†è§£SWIFTã€‚</p>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬ç»™å‡ºäº†ä¸€ç³»åˆ—è„šæœ¬å¸®åŠ©æ‚¨äº†è§£SWIFTçš„è®­ç»ƒèƒ½åŠ›ï¼š</p>
<ul class="simple">
<li><p>è½»é‡åŒ–è®­ç»ƒï¼šSWIFTæ”¯æŒçš„è½»é‡å¾®è°ƒç¤ºä¾‹å¯ä»¥å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/tuners">è¿™é‡Œ</a>ã€‚ï¼ˆæ³¨æ„ï¼šè¿™äº›æ–¹å¼é¢„è®­ç»ƒä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œä½†é¢„è®­ç»ƒé€šå¸¸ä½¿ç”¨å…¨å‚æ•°è®­ç»ƒï¼‰ã€‚</p></li>
<li><p>åˆ†å¸ƒå¼è®­ç»ƒï¼šSWIFTæ”¯æŒçš„åˆ†å¸ƒå¼è®­ç»ƒæŠ€æœ¯åŒ…æ‹¬ï¼šDDPã€device_mapã€DeepSpeed ZeRO2/ZeRO3ã€FSDPã€‚</p>
<ul>
<li><p>device_map: ç®€æ˜“æ¨¡å‹å¹¶è¡Œã€‚å¦‚æœå­˜åœ¨å¤šGPUï¼Œdevice_mapä¼šè‡ªåŠ¨å¼€å¯ã€‚è¿™ä¼šå°†æ¨¡å‹æŒ‰å±‚å‡åŒ€çš„åˆ’åˆ†åˆ°å¯è§çš„GPUä¸­ï¼Œæ˜¾è‘—é™ä½æ˜¾å­˜æ¶ˆè€—ï¼Œä½†æ˜¯è®­ç»ƒé€Ÿåº¦é€šå¸¸ä¼šé™ä½ï¼Œå› ä¸ºæ˜¯ä¸²è¡Œçš„ã€‚</p></li>
<li><p>DDP+device_mapï¼šå°†æŒ‰ç»„å¯¹æ¨¡å‹è¿›è¡Œdevice_mapåˆ’åˆ†ï¼Œå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/multi-gpu/ddp_device_map/train.sh">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>DeepSpeed ZeRO2/ZeRO3: èŠ‚çº¦æ˜¾å­˜èµ„æºï¼Œä½†è®­ç»ƒé€Ÿåº¦ä¸‹é™ã€‚ZeRO2å°†å¯¹ä¼˜åŒ–å™¨çŠ¶æ€ã€æ¨¡å‹æ¢¯åº¦è¿›è¡Œåˆ†ç‰‡ã€‚ZeRO3åœ¨ZeRO2åŸºç¡€ä¸Šï¼Œå¯¹æ¨¡å‹å‚æ•°è¿›è¡Œåˆ†ç‰‡ï¼Œæ›´åŠ èŠ‚çº¦æ˜¾å­˜ï¼Œä½†è®­ç»ƒé€Ÿåº¦æ›´æ…¢ã€‚å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/multi-gpu/deepspeed">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>FSDP+QLoRA: åŒå¡3090è¿è¡Œ70Bæ¨¡å‹çš„è®­ç»ƒï¼Œå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/multi-gpu/fsdp_qlora/train.sh">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>å¤šæœºå¤šå¡è®­ç»ƒ: æˆ‘ä»¬ä¹¦å†™äº†ä½¿ç”¨swiftã€torchrunã€dlcã€deepspeedã€accelerateå¯åŠ¨å¤šèŠ‚ç‚¹è¿è¡Œçš„shellè„šæœ¬ç¤ºä¾‹ã€‚é™¤äº†dlcå’Œdeepspeedï¼Œå…¶ä»–å¯åŠ¨è„šæœ¬éƒ½éœ€è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸­å¯åŠ¨æ‰å¯è¿è¡Œã€‚å…·ä½“å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/multi-node">è¿™é‡Œ</a>ã€‚</p></li>
</ul>
</li>
<li><p>é‡åŒ–è®­ç»ƒï¼šæ”¯æŒä½¿ç”¨GPTQã€AWQã€AQLMã€BNBã€HQQã€EETQé‡åŒ–æŠ€æœ¯çš„QLoRAè®­ç»ƒã€‚å¾®è°ƒ7Bæ¨¡å‹åªéœ€è¦9GBæ˜¾å­˜èµ„æºã€‚å…·ä½“å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/qlora">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>å¤šæ¨¡æ€è®­ç»ƒï¼šSWIFTæ”¯æŒå¤šæ¨¡æ€æ¨¡å‹çš„é¢„è®­ç»ƒã€å¾®è°ƒå’ŒRLHFã€‚æ”¯æŒCaptionã€VQAã€OCRã€<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/notebook/qwen2_5-vl-grounding/zh.ipynb">Grounding</a>ä»»åŠ¡ã€‚æ”¯æŒå›¾åƒã€è§†é¢‘å’ŒéŸ³é¢‘ä¸‰ç§æ¨¡æ€ã€‚å…·ä½“å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/multimodal">è¿™é‡Œ</a>ã€‚å¤šæ¨¡æ€è‡ªå®šä¹‰æ•°æ®é›†æ ¼å¼å‚è€ƒ<a class="reference internal" href="../Customization/Custom-dataset.html"><span class="doc">è‡ªå®šä¹‰æ•°æ®é›†æ–‡æ¡£</span></a>ã€‚</p>
<ul>
<li><p>å¯¹ViT/Alignerä½¿ç”¨å…¨å‚æ•°è®­ç»ƒï¼ŒLLMä½¿ç”¨LoRAè®­ç»ƒï¼Œå¹¶é‡‡ç”¨ä¸åŒå­¦ä¹ ç‡çš„ä¾‹å­å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/multimodal/lora_llm_full_vit">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>å¤šæ¨¡æ€æ¨¡å‹packingï¼Œå¢åŠ è®­ç»ƒé€Ÿåº¦ï¼Œä¾‹å­å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/packing">è¿™é‡Œ</a>ã€‚</p></li>
</ul>
</li>
<li><p>RLHFè®­ç»ƒï¼šå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/rlhf">è¿™é‡Œ</a>ã€‚å¤šæ¨¡æ€æ¨¡å‹å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/multimodal/rlhf">è¿™é‡Œ</a>ã€‚GRPOè®­ç»ƒå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/grpo/internal">è¿™é‡Œ</a>ã€‚å¼ºåŒ–å¾®è°ƒæŸ¥çœ‹<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/rft">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>Megatronè®­ç»ƒï¼šæ”¯æŒä½¿ç”¨Megatronçš„å¹¶è¡ŒæŠ€æœ¯æ¥åŠ é€Ÿå¤§æ¨¡å‹çš„è®­ç»ƒï¼ŒåŒ…æ‹¬æ•°æ®å¹¶è¡Œã€å¼ é‡å¹¶è¡Œã€æµæ°´çº¿å¹¶è¡Œã€åºåˆ—å¹¶è¡Œï¼Œä¸Šä¸‹æ–‡å¹¶è¡Œã€‚å‚è€ƒ<a class="reference internal" href="../Megatron-SWIFT/Quick-start.html"><span class="doc">Megatron-SWIFTè®­ç»ƒæ–‡æ¡£</span></a>ã€‚</p></li>
<li><p>åºåˆ—åˆ†ç±»æ¨¡å‹è®­ç»ƒï¼šå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/seq_cls">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>Embeddingæ¨¡å‹è®­ç»ƒï¼šå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/embedding">è¿™é‡Œ</a></p></li>
<li><p>Agentè®­ç»ƒï¼šå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/agent">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>Any-to-Anyæ¨¡å‹è®­ç»ƒï¼šå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/all_to_all">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>å…¶ä»–èƒ½åŠ›ï¼š</p>
<ul>
<li><p>æ•°æ®æµå¼è¯»å–: åœ¨æ•°æ®é‡è¾ƒå¤§æ—¶å‡å°‘å†…å­˜ä½¿ç”¨ã€‚å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/streaming/streaming.sh">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>packing: å°†å¤šä¸ªåºåˆ—æ‹¼æˆä¸€ä¸ªï¼Œè®©æ¯ä¸ªè®­ç»ƒæ ·æœ¬å°½å¯èƒ½æ¥è¿‘max_lengthï¼Œæé«˜æ˜¾å¡åˆ©ç”¨ç‡ï¼Œå‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/packing">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>é•¿æ–‡æœ¬è®­ç»ƒ: å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/sequence_parallel">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>lazy tokenize: åœ¨è®­ç»ƒæœŸé—´å¯¹æ•°æ®è¿›è¡Œtokenizeè€Œä¸æ˜¯åœ¨è®­ç»ƒå‰tokenizeï¼ˆå¤šæ¨¡æ€æ¨¡å‹å¯ä»¥é¿å…åœ¨è®­ç»ƒå‰è¯»å…¥æ‰€æœ‰å¤šæ¨¡æ€èµ„æºï¼‰ï¼Œè¿™å¯ä»¥é¿å…é¢„å¤„ç†ç­‰å¾…å¹¶èŠ‚çº¦å†…å­˜ã€‚å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/streaming/lazy_tokenize.sh">è¿™é‡Œ</a>ã€‚</p></li>
</ul>
</li>
</ul>
<p>å°å¸–å£«ï¼š</p>
<ul class="simple">
<li><p>åœ¨ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">sft</span></code>é€šè¿‡LoRAæŠ€æœ¯å¾®è°ƒbaseæ¨¡å‹ä¸ºchatæ¨¡å‹æ—¶ï¼Œæœ‰æ—¶éœ€è¦æ‰‹åŠ¨è®¾ç½®æ¨¡æ¿ã€‚é€šè¿‡æ·»åŠ <code class="docutils literal notranslate"><span class="pre">--template</span> <span class="pre">default</span></code>å‚æ•°æ¥é¿å…baseæ¨¡å‹å› æœªè§è¿‡å¯¹è¯æ¨¡æ¿ä¸­çš„ç‰¹æ®Šå­—ç¬¦è€Œæ— æ³•æ­£å¸¸åœæ­¢çš„æƒ…å†µã€‚å…·ä½“å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/base_to_chat">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>å¦‚æœéœ€è¦åœ¨<strong>æ–­ç½‘</strong>ç¯å¢ƒä¸‹è¿›è¡Œè®­ç»ƒï¼Œè¯·è®¾ç½®<code class="docutils literal notranslate"><span class="pre">--model</span> <span class="pre">&lt;model_dir&gt;</span></code>å’Œ<code class="docutils literal notranslate"><span class="pre">--check_model</span> <span class="pre">false</span></code>ã€‚å¦‚æœå¯¹åº”çš„æ¨¡å‹éœ€è¦<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span></code>githubçš„ä»“åº“ï¼Œä¾‹å¦‚<code class="docutils literal notranslate"><span class="pre">deepseek-ai/Janus-Pro-7B</span></code>ï¼Œè¯·è®¾ç½®æ‰‹åŠ¨ä¸‹è½½ä»“åº“ï¼Œå¹¶è®¾ç½®<code class="docutils literal notranslate"><span class="pre">--local_repo_path</span> <span class="pre">&lt;repo_dir&gt;</span></code>ã€‚å…·ä½“å‚æ•°å«ä¹‰è¯·å‚è€ƒ<a class="reference internal" href="Command-line-parameters.html"><span class="doc">å‘½ä»¤è¡Œå‚æ•°æ–‡æ¡£</span></a>ã€‚</p></li>
<li><p>æ— æ³•å¯¹QLoRAè®­ç»ƒçš„æ¨¡å‹è¿›è¡ŒMerge LoRAï¼Œå› æ­¤ä¸å»ºè®®ä½¿ç”¨QLoRAè¿›è¡Œå¾®è°ƒï¼Œæ— æ³•åœ¨æ¨ç†å’Œéƒ¨ç½²æ—¶ä½¿ç”¨vLLM/Sglang/LMDeployè¿›è¡Œæ¨ç†åŠ é€Ÿã€‚å»ºè®®ä½¿ç”¨LoRA/å…¨å‚æ•°è¿›è¡Œå¾®è°ƒï¼Œåˆå¹¶ä¸ºå®Œæ•´æƒé‡åå†ä½¿ç”¨GPTQ/AWQ/BNBè¿›è¡Œ<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/export/quantize">é‡åŒ–</a>ã€‚</p></li>
<li><p>å¦‚æœä½¿ç”¨NPUè¿›è¡Œè®­ç»ƒï¼Œåªéœ€è¦å°†shellä¸­çš„<code class="docutils literal notranslate"><span class="pre">CUDA_VISIBLE_DEVICES</span></code>ä¿®æ”¹ä¸º<code class="docutils literal notranslate"><span class="pre">ASCEND_RT_VISIBLE_DEVICES</span></code>ã€‚</p></li>
<li><p>SWIFTé»˜è®¤åœ¨è®­ç»ƒæ—¶è®¾ç½®<code class="docutils literal notranslate"><span class="pre">--gradient_checkpointing</span> <span class="pre">true</span></code>æ¥èŠ‚çº¦æ˜¾å­˜ï¼Œè¿™ä¼šç•¥å¾®é™ä½è®­ç»ƒé€Ÿåº¦ã€‚</p></li>
<li><p>è‹¥ä½¿ç”¨DDPè¿›è¡Œè®­ç»ƒï¼Œå‡ºç°æŠ¥é”™ï¼š<code class="docutils literal notranslate"><span class="pre">RuntimeError:</span> <span class="pre">Expected</span> <span class="pre">to</span> <span class="pre">mark</span> <span class="pre">a</span> <span class="pre">variable</span> <span class="pre">ready</span> <span class="pre">only</span> <span class="pre">once.</span></code>ï¼Œè¯·é¢å¤–è®¾ç½®å‚æ•°<code class="docutils literal notranslate"><span class="pre">--gradient_checkpointing_kwargs</span> <span class="pre">'{&quot;use_reentrant&quot;:</span> <span class="pre">false}'</span></code>æˆ–è€…ä½¿ç”¨DeepSpeedè¿›è¡Œè®­ç»ƒã€‚</p></li>
<li><p>å¦‚æœè¦ä½¿ç”¨deepspeedï¼Œä½ éœ€è¦å®‰è£…deepspeedï¼š<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">deepspeed</span> <span class="pre">-U</span></code>ã€‚ä½¿ç”¨deepspeedå¯ä»¥èŠ‚çº¦æ˜¾å­˜ï¼Œä½†ä¼šç•¥å¾®é™ä½è®­ç»ƒé€Ÿåº¦ã€‚</p></li>
<li><p>å¦‚æœæ‚¨çš„æœºå™¨æ˜¯A100ç­‰é«˜æ€§èƒ½æ˜¾å¡ï¼Œä¸”æ¨¡å‹æ”¯æŒflash-attnï¼Œæ¨èä½ å®‰è£…<a class="reference external" href="https://github.com/Dao-AILab/flash-attention/releases">flash-attn</a>ï¼Œå¹¶è®¾ç½®<code class="docutils literal notranslate"><span class="pre">--attn_impl</span> <span class="pre">flash_attn</span></code>ï¼Œè¿™å°†ä¼šåŠ å¿«è®­ç»ƒå’Œæ¨ç†çš„é€Ÿåº¦å¹¶ç•¥å¾®é™ä½æ˜¾å­˜å ç”¨ã€‚</p></li>
</ul>
<p><strong>å¦‚ä½•debugï¼š</strong></p>
<p>ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è¿›è¡Œdebugï¼Œè¿™ä¸ä½¿ç”¨å‘½ä»¤è¡Œå¾®è°ƒæ˜¯ç­‰ä»·çš„ï¼Œä½†æ­¤æ–¹å¼ä¸æ”¯æŒåˆ†å¸ƒå¼ã€‚å¾®è°ƒå‘½ä»¤è¡Œè¿è¡Œå…¥å£å¯ä»¥æŸ¥çœ‹<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/cli/sft.py">è¿™é‡Œ</a>ã€‚</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">swift</span><span class="w"> </span><span class="kn">import</span> <span class="n">sft_main</span><span class="p">,</span> <span class="n">SftArguments</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sft_main</span><span class="p">(</span><span class="n">SftArguments</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s1">&#39;Qwen/Qwen2.5-7B-Instruct&#39;</span><span class="p">,</span>
    <span class="n">tuner_type</span><span class="o">=</span><span class="s1">&#39;lora&#39;</span><span class="p">,</span>
    <span class="n">dataset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AI-ModelScope/alpaca-gpt4-data-zh#500&#39;</span><span class="p">,</span>
             <span class="s1">&#39;AI-ModelScope/alpaca-gpt4-data-en#500&#39;</span><span class="p">,</span>
             <span class="s1">&#39;swift/self-cognition#500&#39;</span><span class="p">],</span>
    <span class="n">torch_dtype</span><span class="o">=</span><span class="s1">&#39;bfloat16&#39;</span><span class="p">,</span>
    <span class="c1"># ...</span>
<span class="p">))</span>
</pre></div>
</div>
</section>
<section id="web-ui">
<h3>ä½¿ç”¨Web-UI<a class="headerlink" href="#web-ui" title="Link to this heading">ïƒ</a></h3>
<p>å¦‚æœä½ è¦ä½¿ç”¨ç•Œé¢çš„æ–¹å¼è¿›è¡Œè®­ç»ƒï¼Œå¯ä»¥æŸ¥çœ‹<a class="reference internal" href="../GetStarted/Web-UI.html"><span class="doc">Web-UIæ–‡æ¡£</span></a>ã€‚</p>
</section>
<section id="python">
<h3>ä½¿ç”¨python<a class="headerlink" href="#python" title="Link to this heading">ïƒ</a></h3>
<ul class="simple">
<li><p>Qwen2.5è‡ªæˆ‘è®¤çŸ¥å¾®è°ƒnotebookæŸ¥çœ‹<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/notebook/qwen2_5-self-cognition/self-cognition-sft.ipynb">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>Qwen2VLè¿›è¡ŒOCRä»»åŠ¡notebookæŸ¥çœ‹<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/notebook/qwen2vl-ocr/ocr-sft.ipynb">è¿™é‡Œ</a>ã€‚</p></li>
</ul>
</section>
</section>
<section id="merge-lora">
<h2>Merge LoRA<a class="headerlink" href="#merge-lora" title="Link to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p>æŸ¥çœ‹<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/export/merge_lora.sh">è¿™é‡Œ</a>ã€‚</p></li>
</ul>
</section>
<section id="id5">
<h2>æ¨ç†ï¼ˆå¾®è°ƒåæ¨¡å‹ï¼‰<a class="headerlink" href="#id5" title="Link to this heading">ïƒ</a></h2>
<p>ä½¿ç”¨CLIå¯¹LoRAè®­ç»ƒçš„checkpointè¿›è¡Œæ¨ç†ï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>infer<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--adapters<span class="w"> </span>output/vx-xxx/checkpoint-xxx<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--infer_backend<span class="w"> </span>transformers<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--stream<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--temperature<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_new_tokens<span class="w"> </span><span class="m">2048</span>
</pre></div>
</div>
<ul class="simple">
<li><p>adaptersæ–‡ä»¶å¤¹ä¸­åŒ…å«äº†è®­ç»ƒçš„å‚æ•°æ–‡ä»¶<code class="docutils literal notranslate"><span class="pre">args.json</span></code>ï¼Œå› æ­¤ä¸éœ€è¦é¢å¤–æŒ‡å®š<code class="docutils literal notranslate"><span class="pre">--model</span></code>ï¼Œ<code class="docutils literal notranslate"><span class="pre">--system</span></code>ï¼Œswiftä¼šè‡ªåŠ¨è¯»å–è¿™äº›å‚æ•°ã€‚å¦‚æœè¦å…³é—­æ­¤è¡Œä¸ºï¼Œå¯ä»¥è®¾ç½®<code class="docutils literal notranslate"><span class="pre">--load_args</span> <span class="pre">false</span></code>ã€‚</p></li>
<li><p>å¦‚æœä½¿ç”¨å…¨å‚æ•°è®­ç»ƒï¼Œè¯·ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">--model</span></code>æ›¿ä»£<code class="docutils literal notranslate"><span class="pre">--adapters</span></code>æŒ‡å®šè®­ç»ƒçš„checkpointç›®å½•ã€‚æ›´å¤šå‚è€ƒ<a class="reference external" href="./Inference-and-deployment.md#%E6%8E%A8%E7%90%86">æ¨ç†å’Œéƒ¨ç½²æ–‡æ¡£</a>ã€‚</p></li>
<li><p>ä½ å¯ä»¥ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">app</span></code>æ›¿ä»£<code class="docutils literal notranslate"><span class="pre">swift</span> <span class="pre">infer</span></code>è¿›è¡Œç•Œé¢æ¨ç†ã€‚</p></li>
<li><p>ä½ å¯ä»¥é€‰æ‹©å¯¹LoRAè¿›è¡Œmergeï¼ˆé¢å¤–æŒ‡å®š<code class="docutils literal notranslate"><span class="pre">--merge_lora</span> <span class="pre">true</span></code>ï¼‰ï¼Œç„¶åæŒ‡å®š<code class="docutils literal notranslate"><span class="pre">--infer_backend</span> <span class="pre">vllm/sglang/lmdeploy</span></code>è¿›è¡Œæ¨ç†åŠ é€Ÿã€‚</p></li>
</ul>
<p>å¯¹æ•°æ®é›†ä¸­çš„éªŒè¯é›†è¿›è¡Œæ‰¹é‡æ¨ç†ï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>infer<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--adapters<span class="w"> </span>output/vx-xxx/checkpoint-xxx<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--infer_backend<span class="w"> </span>transformers<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--temperature<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_new_tokens<span class="w"> </span><span class="m">2048</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--load_data_args<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_batch_size<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ä½ å¯ä»¥è®¾ç½®<code class="docutils literal notranslate"><span class="pre">--max_batch_size</span> <span class="pre">8</span></code>ï¼Œä»è€Œä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">--infer_backend</span> <span class="pre">transformers</span></code>è¿›è¡Œæ‰¹é‡å¤„ç†ã€‚è‹¥ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">infer_backend</span> <span class="pre">vllm/sglang/lmdeploy</span></code>åˆ™æ— éœ€æŒ‡å®šï¼Œä¼šè¿›è¡Œè‡ªåŠ¨batchã€‚</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--load_data_args</span> <span class="pre">true</span></code>ä¼šé¢å¤–è¯»å–è®­ç»ƒå­˜å‚¨å‚æ•°æ–‡ä»¶<code class="docutils literal notranslate"><span class="pre">args.json</span></code>ä¸­çš„æ•°æ®å‚æ•°ã€‚</p></li>
</ul>
<p>è‹¥æƒ³å¯¹é¢å¤–çš„æµ‹è¯•é›†è¿›è¡Œæ¨ç†ï¼Œè€Œä¸ä½¿ç”¨è®­ç»ƒæ—¶çš„éªŒè¯é›†ï¼Œä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">--val_dataset</span> <span class="pre">&lt;dataset_path&gt;</span></code>è¿›è¡Œæ¨ç†ï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>infer<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--adapters<span class="w"> </span>output/vx-xxx/checkpoint-xxx<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--infer_backend<span class="w"> </span>transformers<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--temperature<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_new_tokens<span class="w"> </span><span class="m">2048</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--val_dataset<span class="w"> </span>&lt;dataset-path&gt;<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_batch_size<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<p>ä½¿ç”¨Pythonå¯¹è®­ç»ƒåLoRAæ¨ç†çš„ä¾‹å­å¦‚ä¸‹ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">swift.infer_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransformersEngine</span><span class="p">,</span> <span class="n">RequestConfig</span><span class="p">,</span> <span class="n">InferRequest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_model_processor</span><span class="p">,</span> <span class="n">get_template</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">safe_snapshot_download</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">peft</span><span class="w"> </span><span class="kn">import</span> <span class="n">PeftModel</span>
<span class="c1"># è¯·è°ƒæ•´ä¸‹é¢å‡ è¡Œ</span>
<span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;Qwen/Qwen2.5-7B-Instruct&#39;</span>
<span class="n">lora_checkpoint</span> <span class="o">=</span> <span class="n">safe_snapshot_download</span><span class="p">(</span><span class="s1">&#39;swift/test_lora&#39;</span><span class="p">)</span>  <span class="c1"># ä¿®æ”¹æˆcheckpoint_dir</span>
<span class="n">template_type</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># None: ä½¿ç”¨å¯¹åº”æ¨¡å‹é»˜è®¤çš„template_type</span>
<span class="n">default_system</span> <span class="o">=</span> <span class="s2">&quot;You are a helpful assistant.&quot;</span>  <span class="c1"># None: ä½¿ç”¨å¯¹åº”æ¨¡å‹é»˜è®¤çš„default_system</span>

<span class="c1"># åŠ è½½æ¨¡å‹å’Œå¯¹è¯æ¨¡æ¿</span>
<span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">get_model_processor</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="k">if</span> <span class="n">lora_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">PeftModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lora_checkpoint</span><span class="p">)</span>
<span class="n">template_type</span> <span class="o">=</span> <span class="n">template_type</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">model_meta</span><span class="o">.</span><span class="n">template</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">template_type</span><span class="o">=</span><span class="n">template_type</span><span class="p">,</span> <span class="n">default_system</span><span class="o">=</span><span class="n">default_system</span><span class="p">)</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">TransformersEngine</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">request_config</span> <span class="o">=</span> <span class="n">RequestConfig</span><span class="p">(</span><span class="n">max_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># è¿™é‡Œä½¿ç”¨äº†2ä¸ªinfer_requestæ¥å±•ç¤ºbatchæ¨ç†</span>
<span class="n">infer_requests</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">InferRequest</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;who are you?&#39;</span><span class="p">}]),</span>
    <span class="n">InferRequest</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;æµ™æ±Ÿçš„çœä¼šåœ¨å“ªï¼Ÿ&#39;</span><span class="p">},</span>
                           <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;æµ™æ±Ÿçš„çœä¼šåœ¨å“ªï¼Ÿ&#39;</span><span class="p">},</span>
                           <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;è¿™é‡Œæœ‰ä»€ä¹ˆå¥½åƒçš„&#39;</span><span class="p">},]),</span>
<span class="p">]</span>
<span class="n">resp_list</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">infer_requests</span><span class="p">,</span> <span class="n">request_config</span><span class="p">)</span>
<span class="n">query0</span> <span class="o">=</span> <span class="n">infer_requests</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;response0: </span><span class="si">{</span><span class="n">resp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;response1: </span><span class="si">{</span><span class="n">resp_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>å¤šæ¨¡æ€æ¨¡å‹çš„LoRAæ¨ç†ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">swift.infer_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransformersEngine</span><span class="p">,</span> <span class="n">RequestConfig</span><span class="p">,</span> <span class="n">InferRequest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_model_processor</span><span class="p">,</span> <span class="n">get_template</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">safe_snapshot_download</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">peft</span><span class="w"> </span><span class="kn">import</span> <span class="n">PeftModel</span>
<span class="c1"># è¯·è°ƒæ•´ä¸‹é¢å‡ è¡Œ</span>
<span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;Qwen/Qwen2.5-VL-7B-Instruct&#39;</span>
<span class="n">lora_checkpoint</span> <span class="o">=</span> <span class="n">safe_snapshot_download</span><span class="p">(</span><span class="s1">&#39;swift/test_grounding&#39;</span><span class="p">)</span>  <span class="c1"># ä¿®æ”¹æˆcheckpoint_dir</span>
<span class="n">template_type</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># None: ä½¿ç”¨å¯¹åº”æ¨¡å‹é»˜è®¤çš„template_type</span>
<span class="n">default_system</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># None: ä½¿ç”¨å¯¹åº”æ¨¡å‹é»˜è®¤çš„default_system</span>

<span class="c1"># åŠ è½½æ¨¡å‹å’Œå¯¹è¯æ¨¡æ¿</span>
<span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">get_model_processor</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="k">if</span> <span class="n">lora_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">PeftModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lora_checkpoint</span><span class="p">)</span>
<span class="n">template_type</span> <span class="o">=</span> <span class="n">template_type</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">model_meta</span><span class="o">.</span><span class="n">template</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">template_type</span><span class="o">=</span><span class="n">template_type</span><span class="p">,</span> <span class="n">default_system</span><span class="o">=</span><span class="n">default_system</span><span class="p">)</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">TransformersEngine</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">request_config</span> <span class="o">=</span> <span class="n">RequestConfig</span><span class="p">(</span><span class="n">max_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># è¿™é‡Œä½¿ç”¨äº†2ä¸ªinfer_requestæ¥å±•ç¤ºbatchæ¨ç†</span>
<span class="n">infer_requests</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">InferRequest</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;who are you?&#39;</span><span class="p">}]),</span>
    <span class="n">InferRequest</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;image&gt;Task: Object Detection&#39;</span><span class="p">}],</span>
                 <span class="n">images</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;http://modelscope-open.oss-cn-hangzhou.aliyuncs.com/images/animal.png&#39;</span><span class="p">]),</span>
<span class="p">]</span>
<span class="n">resp_list</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">infer_requests</span><span class="p">,</span> <span class="n">request_config</span><span class="p">)</span>
<span class="n">query0</span> <span class="o">=</span> <span class="n">infer_requests</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;response0: </span><span class="si">{</span><span class="n">resp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;response1: </span><span class="si">{</span><span class="n">resp_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>å¦‚æœä½¿ç”¨ms-swiftè®­ç»ƒçš„æ¨¡å‹ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–è®­ç»ƒçš„é…ç½®ï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">swift</span><span class="w"> </span><span class="kn">import</span> <span class="n">safe_snapshot_download</span><span class="p">,</span> <span class="n">BaseArguments</span>

<span class="n">lora_adapters</span> <span class="o">=</span> <span class="n">safe_snapshot_download</span><span class="p">(</span><span class="s1">&#39;swift/test_lora&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">BaseArguments</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">lora_adapters</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;args.model: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;args.model_type: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;args.template_type: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">template</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;args.default_system: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">system</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>å¯¹å…¨å‚æ•°è®­ç»ƒçš„checkpointè¿›è¡Œæ¨ç†ï¼Œå°†<code class="docutils literal notranslate"><span class="pre">model</span></code>è®¾ç½®ä¸ºcheckpoint_dirï¼Œå¹¶å°†lora_checkpointè®¾ç½®ä¸ºNoneå³å¯ã€‚æ›´å¤šå‚è€ƒ<a class="reference external" href="./Inference-and-deployment.md#%E6%8E%A8%E7%90%86">æ¨ç†å’Œéƒ¨ç½²æ–‡æ¡£</a>ã€‚</p></li>
<li><p>ä½¿ç”¨æµå¼æ¨ç†ä»¥åŠ<code class="docutils literal notranslate"><span class="pre">VllmEngine</span></code>ã€<code class="docutils literal notranslate"><span class="pre">SglangEngine</span></code>ã€<code class="docutils literal notranslate"><span class="pre">LmdeployEngine</span></code>è¿›è¡Œæ¨ç†åŠ é€Ÿï¼Œå¯ä»¥å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/infer/demo.py">å¤§æ¨¡å‹</a>å’Œ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/infer/demo_mllm.py">å¤šæ¨¡æ€å¤§æ¨¡å‹</a>æ¨ç†ç¤ºä¾‹ã€‚</p></li>
<li><p>å¾®è°ƒåçš„æ¨¡å‹ä½¿ç”¨huggingface transformers/peftç”Ÿæ€æ¨ç†ï¼Œå¯ä»¥å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/infer/demo_hf.py">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>è‹¥è®­ç»ƒäº†å¤šä¸ªLoRAï¼Œè¦è¿›è¡Œå¤šLoRAåˆ‡æ¢ï¼Œå¯ä»¥å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/infer/demo_lora.py">æ¨ç†</a>ã€<a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/deploy/lora">éƒ¨ç½²</a>æ ·ä¾‹ã€‚</p></li>
<li><p>å¯¹å¤šæ¨¡æ€æ¨¡å‹è¿›è¡ŒGroundingä»»åŠ¡çš„ç”»æ¡†ï¼Œå¯ä»¥å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/infer/demo_grounding.py">è¿™é‡Œ</a>ã€‚</p></li>
<li><p>å¯¹LoRAå¾®è°ƒåçš„Bertè¿›è¡Œæ¨ç†ï¼Œå¯ä»¥å‚è€ƒ<a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/infer/demo_bert.py">è¿™é‡Œ</a>ã€‚</p></li>
</ul>
</section>
<section id="id6">
<h2>éƒ¨ç½²ï¼ˆå¾®è°ƒåæ¨¡å‹ï¼‰<a class="headerlink" href="#id6" title="Link to this heading">ïƒ</a></h2>
<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨éƒ¨ç½²æœåŠ¡ç«¯ã€‚å¦‚æœæƒé‡ä½¿ç”¨å…¨å‚æ•°è®­ç»ƒï¼Œè¯·ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">--model</span></code>æ›¿ä»£<code class="docutils literal notranslate"><span class="pre">--adapters</span></code>æŒ‡å®šè®­ç»ƒçš„checkpointç›®å½•ã€‚ä½ å¯ä»¥å‚è€ƒ<a class="reference external" href="./Inference-and-deployment.md#%E9%83%A8%E7%BD%B2">æ¨ç†å’Œéƒ¨ç½²æ–‡æ¡£</a>ä»‹ç»çš„å®¢æˆ·ç«¯è°ƒç”¨æ–¹å¼ï¼šcurlã€openaiåº“å’Œswiftå®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨ã€‚</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>deploy<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--adapters<span class="w"> </span>output/vx-xxx/checkpoint-xxx<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--infer_backend<span class="w"> </span>transformers<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--temperature<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_new_tokens<span class="w"> </span><span class="m">2048</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--served_model_name<span class="w"> </span><span class="s1">&#39;&lt;model-name&gt;&#39;</span>
</pre></div>
</div>
<p>è¿™é‡Œå°†ç»™å‡ºä½¿ç”¨vLLMå¯¹å¤šLoRAè¿›è¡Œéƒ¨ç½²å¹¶è°ƒç”¨çš„å®Œæ•´ä¾‹å­ã€‚</p>
<section id="id7">
<h3>æœåŠ¡ç«¯<a class="headerlink" href="#id7" title="Link to this heading">ïƒ</a></h3>
<p>é¦–å…ˆä½ éœ€è¦å®‰è£…vLLMï¼š<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">vllm</span> <span class="pre">-U</span></code>ï¼Œå¹¶åœ¨éƒ¨ç½²æ—¶ä½¿ç”¨<code class="docutils literal notranslate"><span class="pre">--infer_backend</span> <span class="pre">vllm</span></code>ï¼Œè¿™é€šå¸¸å¯ä»¥æ˜¾è‘—åŠ é€Ÿæ¨ç†é€Ÿåº¦ã€‚</p>
<p>æˆ‘ä»¬é¢„å…ˆè®­ç»ƒäº†2ä¸ªåŸºæ¨¡å‹ä¸º<code class="docutils literal notranslate"><span class="pre">Qwen/Qwen2.5-7B-Instruct</span></code>çš„ä¸åŒè‡ªæˆ‘è®¤çŸ¥LoRAå¢é‡æƒé‡ï¼ˆå¯ä»¥ç›´æ¥è·‘é€šï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<a class="reference external" href="https://modelscope.cn/models/swift/test_lora/file/view/master">args.json</a>ä¸­æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ã€‚ä½ éœ€è¦åœ¨éƒ¨ç½²æ—¶ä¿®æ”¹<code class="docutils literal notranslate"><span class="pre">--adapters</span></code>æŒ‡å®šè®­ç»ƒå¥½çš„LoRAæƒé‡æœ¬åœ°è·¯å¾„å³å¯ã€‚</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>deploy<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--adapters<span class="w"> </span><span class="nv">lora1</span><span class="o">=</span>swift/test_lora<span class="w"> </span><span class="nv">lora2</span><span class="o">=</span>swift/test_lora2<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--infer_backend<span class="w"> </span>vllm<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--temperature<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max_new_tokens<span class="w"> </span><span class="m">2048</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3>å®¢æˆ·ç«¯<a class="headerlink" href="#id8" title="Link to this heading">ïƒ</a></h3>
<p>è¿™é‡Œåªä»‹ç»ä½¿ç”¨openaiåº“è¿›è¡Œè°ƒç”¨ã€‚ä½¿ç”¨curlã€swiftå®¢æˆ·ç«¯è°ƒç”¨çš„ä¾‹å­å¯ä»¥å‚è€ƒ<a class="reference external" href="./Inference-and-deployment.md#%E9%83%A8%E7%BD%B2">æ¨ç†å’Œéƒ¨ç½²æ–‡æ¡£</a>ã€‚</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAI</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;EMPTY&#39;</span><span class="p">,</span>
    <span class="n">base_url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;http://127.0.0.1:8000/v1&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">list</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;models: </span><span class="si">{</span><span class="n">models</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;who are you?&#39;</span>
<span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">}]</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">models</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">gen</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">models</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="se">\n</span><span class="s1">response: &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">chunk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">models: [&#39;Qwen2.5-7B-Instruct&#39;, &#39;lora1&#39;, &#39;lora2&#39;]</span>
<span class="sd">query: who are you?</span>
<span class="sd">response: I am an artificial intelligence model named swift-robot, developed by swift. I can answer your questions, provide information, and engage in conversation. If you have any inquiries or need assistance, feel free to ask me at any time.</span>
<span class="sd">query: who are you?</span>
<span class="sd">response: I am an artificial intelligence model named Xiao Huang, developed by ModelScope. I can answer your questions, provide information, and engage in conversation. If you have any inquiries or need assistance, feel free to ask me at any time.</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>