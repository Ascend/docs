

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Dataset &mdash; ÊòáËÖæÂºÄÊ∫ê  ÊñáÊ°£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Á¥¢Âºï" href="../../../../../../genindex.html" />
    <link rel="search" title="ÊêúÁ¥¢" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            ÊòáËÖæÂºÄÊ∫ê
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="ÊêúÁ¥¢ÊñáÊ°£" aria-label="ÊêúÁ¥¢ÊñáÊ°£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="ÂØºËà™ËèúÂçï">
              <p class="caption" role="heading"><span class="caption-text">üèÅ ÂºÄÂßã‰ΩøÁî®</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ascend/quick_install.html">Âø´ÈÄüÂÆâË£ÖÊòáËÖæÁéØÂ¢É</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üèóÔ∏è  Âü∫Á°ÄËÆæÊñΩ‰∏éÊ°ÜÊû∂</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üß† ËÆ≠ÁªÉ‰∏éÂæÆË∞ÉÊ°ÜÊû∂</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üöÄ Êé®ÁêÜ‰∏éÊúçÂä°</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üé® Â§öÊ®°ÊÄÅ„ÄÅÂ∫îÁî®‰∏éËØÑÊµã</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ÁßªÂä®ÁâàÂØºËà™ËèúÂçï" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">ÊòáËÖæÂºÄÊ∫ê</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="È°µÈù¢ÂØºËà™">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Custom Dataset</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/sources/_generated/sources/ms-swift/source_en/Customization/Custom-dataset.md.txt" rel="nofollow"> Êü•ÁúãÈ°µÈù¢Ê∫êÁ†Å</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="custom-dataset">
<h1>Custom Dataset<a class="headerlink" href="#custom-dataset" title="Link to this heading">ÔÉÅ</a></h1>
<p>There are three methods for accessing custom datasets, each offering progressively greater control over preprocessing functions but also increasing in complexity. For example, Solution 1 is the most convenient but offers the least control over preprocessing functions, requiring prior conversion of the dataset into a specific format:</p>
<ol class="simple">
<li><p><strong>Recommended</strong>: Directly use the command line parameter to access the dataset with <code class="docutils literal notranslate"><span class="pre">--dataset</span> <span class="pre">&lt;dataset_path1&gt;</span> <span class="pre">&lt;dataset_path2&gt;</span></code>. This will use <code class="docutils literal notranslate"><span class="pre">AutoPreprocessor</span></code> to convert your dataset into a standard format (supporting four dataset formats; see the introduction to AutoPreprocessor below). You can use <code class="docutils literal notranslate"><span class="pre">--columns</span></code> to transform column names. The supported input formats include csv, json, jsonl, txt, and folders (e.g. git clone open-source datasets). This solution does not require modifying <code class="docutils literal notranslate"><span class="pre">dataset_info.json</span></code> and is suitable for users new to ms-swift. The following two solutions are suitable for developers looking to extend ms-swift.</p></li>
<li><p>Add the dataset to <code class="docutils literal notranslate"><span class="pre">dataset_info.json</span></code>, which you can refer to in the built-in <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/dataset/data/dataset_info.json">dataset_info.json</a> of ms-swift. This solution also uses AutoPreprocessor to convert the dataset to a standard format. <code class="docutils literal notranslate"><span class="pre">dataset_info.json</span></code> is a list of metadata for datasets, and one of the fields ms_dataset_id/hf_dataset_id/dataset_path must be filled. Column name transformation can be done through the <code class="docutils literal notranslate"><span class="pre">columns</span></code> field. Datasets added to <code class="docutils literal notranslate"><span class="pre">dataset_info.json</span></code> or registered ones will automatically generate <a class="reference external" href="https://swift.readthedocs.io/en/latest/Instruction/Supported-models-and-datasets.html">supported dataset documentation</a> when running <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/scripts/utils/run_dataset_info.py">run_dataset_info.py</a>. In addition, you can use the external <code class="docutils literal notranslate"><span class="pre">dataset_info.json</span></code> approach by parsing the JSON file with <code class="docutils literal notranslate"><span class="pre">--custom_dataset_info</span> <span class="pre">xxx.json</span></code> (to facilitate users who prefer <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code> over <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span></code>), and then specify <code class="docutils literal notranslate"><span class="pre">--dataset</span> <span class="pre">&lt;dataset_id/dataset_dir/dataset_path&gt;</span></code>.</p></li>
<li><p>Manually register the dataset to have the most flexible customization capability for preprocessing functions, allowing the use of functions to preprocess datasets, but it is more difficult. You can refer to the <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/dataset/dataset/llm.py">built-in datasets</a> or <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/custom">examples</a>. You can specify <code class="docutils literal notranslate"><span class="pre">--external_plugins</span> <span class="pre">xxx.py</span></code> to parse external registration content (convenient for users who use pip install instead of git clone).</p>
<ul class="simple">
<li><p>Solutions one and two leverage solution three under the hood, where the registration process occurs automatically.</p></li>
</ul>
</li>
</ol>
<p>The following is an introduction to the dataset formats that <code class="docutils literal notranslate"><span class="pre">AutoPreprocessor</span></code> can handle:</p>
<p>The standard dataset format for ms-swift accepts keys such as: 'messages', 'rejected_response', 'label', 'images', 'videos', 'audios', 'tools', and 'objects'. Among these, 'messages' is a required key. 'rejected_response' is used for DPO and other RLHF training, 'label' is used for KTO training and classification model training. The keys 'images', 'videos', and 'audios' are used to store paths or URLs for multimodal data, 'tools' is used for Agent tasks, and 'objects' is used for grounding tasks.</p>
<p>There are three core preprocessors in ms-swift: <code class="docutils literal notranslate"><span class="pre">MessagesPreprocessor</span></code>, <code class="docutils literal notranslate"><span class="pre">AlpacaPreprocessor</span></code>, and <code class="docutils literal notranslate"><span class="pre">ResponsePreprocessor</span></code>. <code class="docutils literal notranslate"><span class="pre">MessagesPreprocessor</span></code> is used to convert datasets in the messages and sharegpt format into the standard format. <code class="docutils literal notranslate"><span class="pre">AlpacaPreprocessor</span></code> converts datasets in the alpaca format, while <code class="docutils literal notranslate"><span class="pre">ResponsePreprocessor</span></code> converts datasets in the query/response format. <code class="docutils literal notranslate"><span class="pre">AutoPreprocessor</span></code> automatically selects the appropriate preprocessor for the task.</p>
<p>The following four formats will all be converted into the <code class="docutils literal notranslate"><span class="pre">messages</span></code> field of the ms-swift standard format under the processing of <code class="docutils literal notranslate"><span class="pre">AutoPreprocessor</span></code>, meaning they can all be directly used with <code class="docutils literal notranslate"><span class="pre">--dataset</span> <span class="pre">&lt;dataset-path&gt;</span></code>:</p>
<p>Messages format (standard format):</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;&lt;system&gt;&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;query1&gt;&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;&lt;response1&gt;&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;query2&gt;&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;&lt;response2&gt;&quot;}]}
</pre></div>
</div>
<ul class="simple">
<li><p>Note: The system part is optional. The system in the dataset has a higher priority than the <code class="docutils literal notranslate"><span class="pre">--system</span></code> passed through the command line, followed by the <code class="docutils literal notranslate"><span class="pre">default_system</span></code> defined in the template.</p></li>
</ul>
<p>ShareGPT format:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;system&quot;: &quot;&lt;system&gt;&quot;, &quot;conversation&quot;: [{&quot;human&quot;: &quot;&lt;query1&gt;&quot;, &quot;assistant&quot;: &quot;&lt;response1&gt;&quot;}, {&quot;human&quot;: &quot;&lt;query2&gt;&quot;, &quot;assistant&quot;: &quot;&lt;response2&gt;&quot;}]}
</pre></div>
</div>
<p>Query-Response format:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;system&quot;: &quot;&lt;system&gt;&quot;, &quot;query&quot;: &quot;&lt;query2&gt;&quot;, &quot;response&quot;: &quot;&lt;response2&gt;&quot;, &quot;history&quot;: [[&quot;&lt;query1&gt;&quot;, &quot;&lt;response1&gt;&quot;]]}
</pre></div>
</div>
<p>Note: The following fields will be automatically converted to the corresponding system, query, and response fields. (The 'solution' field will be retained)</p>
<ul class="simple">
<li><p>system: 'system', 'system_prompt'.</p></li>
<li><p>query: 'query', 'prompt', 'input', 'instruction', 'question', 'problem'.</p></li>
<li><p>response: 'response', 'answer', 'output', 'targets', 'target', 'answer_key', 'answers', 'solution', 'text', 'completion', 'content'.</p></li>
</ul>
<p>Alpaca format:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;system&quot;: &quot;&lt;system&gt;&quot;, &quot;instruction&quot;: &quot;&lt;query-inst&gt;&quot;, &quot;input&quot;: &quot;&lt;query-input&gt;&quot;, &quot;output&quot;: &quot;&lt;response&gt;&quot;}
</pre></div>
</div>
<ul class="simple">
<li><p>Note: The instruction and input fields will be combined into the query field. If instruction and input are not empty strings, then <code class="docutils literal notranslate"><span class="pre">query</span> <span class="pre">=</span> <span class="pre">f'{instruction}\n{input}'</span></code>.</p></li>
</ul>
<section id="standard-dataset-format">
<h2>Standard Dataset Format<a class="headerlink" href="#standard-dataset-format" title="Link to this heading">ÔÉÅ</a></h2>
<p>The following outlines the standard dataset format for ms-swift, where the &quot;system&quot; field is optional and uses the &quot;default_system&quot; defined in the template by default. The four dataset formats introduced earlier can also be processed by AutoPreprocessor into the standard dataset format.</p>
<section id="pre-training">
<h3>Pre-training<a class="headerlink" href="#pre-training" title="Link to this heading">ÔÉÅ</a></h3>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;I love music&quot;}]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Coach, I want to play basketball&quot;}]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Which is more authoritative, tomato and egg rice or the third fresh stir-fry?&quot;}]}
</pre></div>
</div>
</section>
<section id="supervised-fine-tuning">
<h3>Supervised Fine-tuning<a class="headerlink" href="#supervised-fine-tuning" title="Link to this heading">ÔÉÅ</a></h3>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless assistant&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Tell me tomorrow&#39;s weather&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Tomorrow&#39;s weather will be sunny&quot;}]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless math calculator&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is 1 + 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 2&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What about adding 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 3&quot;}]}
</pre></div>
</div>
<ul class="simple">
<li><p>You can control whether the loss is computed for specific parts of the model's response by adding the <code class="docutils literal notranslate"><span class="pre">&quot;loss&quot;</span></code> field (requires ms-swift &gt;= 3.8). This field defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code>. If <code class="docutils literal notranslate"><span class="pre">&quot;loss&quot;</span></code> is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, the corresponding content will contribute to the loss calculation (equivalent to a <code class="docutils literal notranslate"><span class="pre">loss_scale</span></code> of 1). If <code class="docutils literal notranslate"><span class="pre">&quot;loss&quot;</span></code> is set to <code class="docutils literal notranslate"><span class="pre">false</span></code>, the corresponding content will be excluded from loss computation. Note that this feature only takes effect for messages where <code class="docutils literal notranslate"><span class="pre">&quot;role&quot;</span></code> is <code class="docutils literal notranslate"><span class="pre">&quot;assistant&quot;</span></code>, and it has higher priority than the command-line argument <code class="docutils literal notranslate"><span class="pre">--loss_scale</span></code>. Example data format:</p></li>
</ul>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Hello!&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Hi, how can I help you?&quot;, &quot;loss&quot;: false}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is 1+1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 2&quot;, &quot;loss&quot;: true}]}
</pre></div>
</div>
<section id="channel-loss">
<h4>Channel Loss<a class="headerlink" href="#channel-loss" title="Link to this heading">ÔÉÅ</a></h4>
<p>If you want to use channel loss, you need to set <code class="docutils literal notranslate"><span class="pre">--enable_channel_loss</span> <span class="pre">true</span></code> and add a &quot;channel&quot; field to your dataset. Channel loss is compatible with techniques such as packing, padding-free, and loss scaling.</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless assistant&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Tell me tomorrow&#39;s weather&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Tomorrow&#39;s weather will be sunny&quot;}], &quot;channel&quot;: &quot;general&quot;}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless math calculator&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is 1 + 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 2&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What about adding 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 3&quot;}], &quot;channel&quot;: &quot;math&quot;}
</pre></div>
</div>
</section>
</section>
<section id="rlhf">
<h3>RLHF<a class="headerlink" href="#rlhf" title="Link to this heading">ÔÉÅ</a></h3>
<section id="dpo-orpo-cpo-simpo-rm">
<h4>DPO/ORPO/CPO/SimPO/RM<a class="headerlink" href="#dpo-orpo-cpo-simpo-rm" title="Link to this heading">ÔÉÅ</a></h4>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless assistant&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Tell me tomorrow&#39;s weather&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Tomorrow&#39;s weather will be sunny&quot;}], &quot;rejected_response&quot;: &quot;I don&#39;t know&quot;}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless math calculator&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is 1 + 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 2&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What about adding 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 3&quot;}], &quot;rejected_response&quot;: &quot;I don&#39;t know&quot;}
</pre></div>
</div>
<p>The format of multimodal data should follow the specifications in <a class="reference external" href="#multimodal">Multimodal Dataset</a>, with additional columns such as <code class="docutils literal notranslate"><span class="pre">images</span></code> to represent other modality inputs. When it is necessary to associate different image information with preference data, the <code class="docutils literal notranslate"><span class="pre">rejected_images</span></code> field can be used to indicate the images related to the rejected responses. In the alignment dataset, at least one of <code class="docutils literal notranslate"><span class="pre">rejected_images</span></code> or <code class="docutils literal notranslate"><span class="pre">rejected_response</span></code> must be provided for each entry.</p>
<blockquote>
<div><p>Note: RM additionally supports the margin column. For details, refer to the <a class="reference external" href="../Instruction/RLHF.md#rm">RM documentation</a>.</p>
</div></blockquote>
<p>Sure, you can also directly use <code class="docutils literal notranslate"><span class="pre">rejected_messages</span></code> instead of only providing <code class="docutils literal notranslate"><span class="pre">rejected_response</span></code> / <code class="docutils literal notranslate"><span class="pre">rejected_images</span></code>, which offers greater flexibility (e.g., for multimodal or agent scenarios). If you use &quot;rejected_messages&quot;, then in multimodal scenarios you must also provide &quot;rejected_images&quot;, &quot;rejected_audios&quot;, &quot;rejected_videos&quot;, etc.; in Agent scenarios you must also provide &quot;rejected_tools&quot;, etc. An example of the multimodal data format is as follows:</p>
<ul class="simple">
<li><p>If using <code class="docutils literal notranslate"><span class="pre">rejected_response</span></code>, the default values for 'rejected_images/rejected_audios/rejected_videos/rejected_tools' are 'images/audios/videos/tools'; if using <code class="docutils literal notranslate"><span class="pre">rejected_messages</span></code>, they need to be passed in additionally.</p></li>
</ul>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;What is this?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;This is a kitten.&quot;}], &quot;images&quot;: [&quot;kitten.png&quot;], &quot;rejected_messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;What is this?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;This is a puppy.&quot;}], &quot;rejected_images&quot;: [&quot;kitten.png&quot;]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;What is this?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;This is a kitten.&quot;}], &quot;images&quot;: [&quot;kitten.png&quot;], &quot;rejected_messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;What is this?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;This is a kitten.&quot;}], &quot;rejected_images&quot;: [&quot;puppy.png&quot;]}
</pre></div>
</div>
<p>The above format is equivalent to:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;What is this?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;This is a kitten.&quot;}], &quot;images&quot;: [&quot;kitten.png&quot;], &quot;rejected_response&quot;: &quot;This is a puppy.&quot;}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;What is this?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;This is a kitten.&quot;}], &quot;images&quot;: [&quot;kitten.png&quot;], &quot;rejected_images&quot;: [&quot;puppy.png&quot;]}
# Example 1 can also be written as:
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;What is this?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;This is a kitten.&quot;}], &quot;images&quot;: [&quot;kitten.png&quot;], &quot;rejected_response&quot;: [{&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;This is a puppy.&quot;}]}
</pre></div>
</div>
<p>You can also organize the Agent dataset in the following format:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span># It will find the position of the last user in `messages`, and replace the subsequent content with `rejected_response` to form `rejected_messages`
{&quot;tools&quot;: &quot;[{\&quot;type\&quot;: \&quot;function\&quot;, \&quot;function\&quot;: {\&quot;name\&quot;: \&quot;realtime_aqi\&quot;, \&quot;description\&quot;: \&quot;Weather forecast. Get real-time air quality, including current air quality, PM2.5, and PM10 information.\&quot;, \&quot;parameters\&quot;: {\&quot;type\&quot;: \&quot;object\&quot;, \&quot;properties\&quot;: {\&quot;city\&quot;: {\&quot;type\&quot;: \&quot;string\&quot;, \&quot;description\&quot;: \&quot;City name, e.g., Shanghai\&quot;}}, \&quot;required\&quot;: [\&quot;city\&quot;]}}}]&quot;, &quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is the weather like in Beijing and Shanghai today?&quot;}, {&quot;role&quot;: &quot;tool_call&quot;, &quot;content&quot;: &quot;{\&quot;name\&quot;: \&quot;realtime_aqi\&quot;, \&quot;arguments\&quot;: {\&quot;city\&quot;: \&quot;Beijing\&quot;}}&quot;}, {&quot;role&quot;: &quot;tool_call&quot;, &quot;content&quot;: &quot;{\&quot;name\&quot;: \&quot;realtime_aqi\&quot;, \&quot;arguments\&quot;: {\&quot;city\&quot;: \&quot;Shanghai\&quot;}}&quot;}, {&quot;role&quot;: &quot;tool_response&quot;, &quot;content&quot;: &quot;{\&quot;city\&quot;: \&quot;Beijing\&quot;, \&quot;aqi\&quot;: \&quot;10\&quot;, \&quot;unit\&quot;: \&quot;celsius\&quot;}&quot;}, {&quot;role&quot;: &quot;tool_response&quot;, &quot;content&quot;: &quot;{\&quot;city\&quot;: \&quot;Shanghai\&quot;, \&quot;aqi\&quot;: \&quot;72\&quot;, \&quot;unit\&quot;: \&quot;fahrenheit\&quot;}&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;According to the weather forecast tool, the air quality index (AQI) in Beijing is 10, which indicates good air quality; whereas in Shanghai, the AQI is 72, indicating mild pollution.&quot;}], &quot;rejected_response&quot;: [{&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;I don&#39;t know.&quot;}]}
</pre></div>
</div>
</section>
<section id="kto">
<h4>KTO<a class="headerlink" href="#kto" title="Link to this heading">ÔÉÅ</a></h4>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless assistant&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Tell me tomorrow&#39;s weather&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;I don&#39;t know&quot;}], &quot;label&quot;: false}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless math calculator&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is 1 + 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 2&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What about adding 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 3&quot;}], &quot;label&quot;: true}
</pre></div>
</div>
</section>
<section id="ppo-grpo">
<h4>PPO/GRPO<a class="headerlink" href="#ppo-grpo" title="Link to this heading">ÔÉÅ</a></h4>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless assistant&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Tell me tomorrow&#39;s weather&quot;}]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless math calculator&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is 1 + 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 2&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What about adding 1?&quot;}]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is your name?&quot;}]}
</pre></div>
</div>
<ul class="simple">
<li><p>Note: GRPO will pass through all additional field content to the ORM, unlike other training methods that, by default, delete extra fields. For example, you can additionally pass in 'solution'. The custom ORM needs to include a positional argument called <code class="docutils literal notranslate"><span class="pre">completions</span></code>, with other arguments as keyword arguments passed through from the additional dataset fields.</p></li>
</ul>
</section>
<section id="gkd">
<h4>GKD<a class="headerlink" href="#gkd" title="Link to this heading">ÔÉÅ</a></h4>
<p>If <code class="docutils literal notranslate"><span class="pre">seq_kd</span></code> is not enabled, i.e., the parameter is set to False, the dataset format is as follows (you can use a teacher model to pre-distill the data):</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless assistant&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Tell me tomorrow&#39;s weather&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Tomorrow&#39;s weather will be sunny&quot;}]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless math calculator&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is 1 + 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 2&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What about adding 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 3&quot;}]}
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">seq_kd</span></code> is enabled, the final round of the 'assistant' part is not required (the teacher model generates data during training):</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless assistant&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Tell me tomorrow&#39;s weather&quot;}]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless math calculator&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is 1 + 1?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;It equals 2&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What about adding 1?&quot;}]}
</pre></div>
</div>
</section>
</section>
<section id="sequence-classification">
<h3>Sequence Classification<a class="headerlink" href="#sequence-classification" title="Link to this heading">ÔÉÅ</a></h3>
<p><strong>Single-label Task</strong>:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;The weather is really nice today&quot;}], &quot;label&quot;: 1}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Today is really unlucky&quot;}], &quot;label&quot;: 0}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;So happy&quot;}], &quot;label&quot;: 1}
</pre></div>
</div>
<p><strong>Multi-label Task</strong>:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;sentence&gt;&quot;}], &quot;label&quot;: []}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;sentence&gt;&quot;}], &quot;label&quot;: [0, 2]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;sentence&gt;&quot;}], &quot;label&quot;: [1, 3, 5]}
</pre></div>
</div>
<p><strong>Single Regression Task</strong>:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Calculate the similarity between two sentences, with a range of 0-1.\nsentence1: &lt;sentence1&gt;\nsentence2: &lt;sentence2&gt;&quot;}], &quot;label&quot;: 0.8}
</pre></div>
</div>
<p><strong>Multi Regression Task</strong>:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;sentence&gt;&quot;}], &quot;label&quot;: [1.2, -0.6, 0.8]}
</pre></div>
</div>
</section>
<section id="embedding">
<h3>Embedding<a class="headerlink" href="#embedding" title="Link to this heading">ÔÉÅ</a></h3>
<p>Please refer to <a class="reference external" href="../BestPractices/Embedding.md#dataset-format">Embedding training document</a>.</p>
</section>
<section id="reranker">
<h3>Reranker<a class="headerlink" href="#reranker" title="Link to this heading">ÔÉÅ</a></h3>
<p>Please refer to <a class="reference external" href="../BestPractices/Reranker.md#dataset-format">Reranker training document</a>.</p>
</section>
<section id="multimodal">
<h3>Multimodal<a class="headerlink" href="#multimodal" title="Link to this heading">ÔÉÅ</a></h3>
<p>For multimodal datasets, the format is the same as the aforementioned tasks. The difference lies in the addition of several keys: <code class="docutils literal notranslate"><span class="pre">images</span></code>, <code class="docutils literal notranslate"><span class="pre">videos</span></code>, and <code class="docutils literal notranslate"><span class="pre">audios</span></code>, which represent the URLs or paths (preferably absolute paths) of multimodal resources. The tags <code class="docutils literal notranslate"><span class="pre">&lt;image&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;video&gt;</span></code>, and <code class="docutils literal notranslate"><span class="pre">&lt;audio&gt;</span></code> indicate where to insert images, videos, or audio. MS-Swift supports multiple images, videos, and audio files. These special tokens will be replaced during preprocessing, as referenced <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/template/templates/qwen.py#L198">here</a>. The four examples below respectively demonstrate the data format for plain text, as well as formats containing image, video, and audio data.</p>
<p>Pre-training:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Pre-trained text goes here&quot;}]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;&lt;image&gt;is a puppy, &lt;image&gt;is a kitten&quot;}], &quot;images&quot;: [&quot;/xxx/x.jpg&quot;, &quot;/xxx/x.png&quot;]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;&lt;audio&gt;describes how nice the weather is today&quot;}], &quot;audios&quot;: [&quot;/xxx/x.wav&quot;]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;&lt;image&gt;is an elephant, &lt;video&gt;is a lion running&quot;}], &quot;images&quot;: [&quot;/xxx/x.jpg&quot;], &quot;videos&quot;: [&quot;/xxx/x.mp4&quot;]}
</pre></div>
</div>
<p>Supervised Fine-tuning:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Where is the capital of Zhejiang?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;The capital of Zhejiang is Hangzhou.&quot;}]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;&lt;image&gt;What is the difference between the two images?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;The first one is a kitten, and the second one is a puppy.&quot;}], &quot;images&quot;: [&quot;/xxx/x.jpg&quot;, &quot;/xxx/x.png&quot;]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;audio&gt;What did the audio say?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;The weather is really nice today.&quot;}], &quot;audios&quot;: [&quot;/xxx/x.mp3&quot;]}
{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a helpful and harmless assistant.&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;What is in the image, &lt;video&gt;What is in the video?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;The image shows an elephant, and the video shows a puppy running on the grass.&quot;}], &quot;images&quot;: [&quot;/xxx/x.jpg&quot;], &quot;videos&quot;: [&quot;/xxx/x.mp4&quot;]}
</pre></div>
</div>
<ul class="simple">
<li><p>Note: The following fields will be automatically converted to the corresponding images, videos, and audios fields.</p>
<ul>
<li><p>images: image, images.</p></li>
<li><p>videos: video, videos.</p></li>
<li><p>audios: audio, audios.</p></li>
</ul>
</li>
<li><p>If you need to pass base64 data instead of file paths, here are sample examples: <code class="docutils literal notranslate"><span class="pre">&quot;videos&quot;:</span> <span class="pre">['data:video/mp4;base64,{base64_encoded}']</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;images&quot;:</span> <span class="pre">['data:image/jpg;base64,{base64_encoded}']</span></code>.</p></li>
<li><p>If you wish to directly pass in video frames instead of a video file, you can use the following format: <code class="docutils literal notranslate"><span class="pre">&quot;videos&quot;:</span> <span class="pre">[[&quot;/xxx/x.png&quot;,</span> <span class="pre">&quot;/xxx/y.png&quot;],</span> <span class="pre">[&quot;/xxx/a.png&quot;,</span> <span class="pre">&quot;/xxx/b.png&quot;,</span> <span class="pre">&quot;/xxx/c.png&quot;]]</span></code>. This format is supported only by certain models, including Qwen2/2.5/3-VL, Qwen2.5/3-Omni, and their derivative models.</p></li>
</ul>
<p>The data format for RLHF and sequence classification of multimodal models can reference the format of pure text large models, with additional fields such as <code class="docutils literal notranslate"><span class="pre">images</span></code> added on top of that.</p>
<section id="grounding">
<h4>Grounding<a class="headerlink" href="#grounding" title="Link to this heading">ÔÉÅ</a></h4>
<p>For grounding (object detection) tasks, ms-swift supports two methods:</p>
<ol class="simple">
<li><p>Directly use the data format of the grounding task corresponding to the model. For example, the format for qwen2-vl is as follows:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a helpful assistant.&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;image&gt;Describe the image.&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;|object_ref_start|&gt;a dog&lt;|object_ref_end|&gt;&lt;|box_start|&gt;(221,423),(569,886)&lt;|box_end|&gt; and &lt;|object_ref_start|&gt;a woman&lt;|object_ref_end|&gt;&lt;|box_start|&gt;(451,381),(733,793)&lt;|box_end|&gt; are playing on the beach&quot;</span><span class="p">}],</span> <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/xxx/x.jpg&quot;</span><span class="p">]}</span>
<span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a helpful assistant.&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;image&gt;Find the &lt;|object_ref_start|&gt;sheep&lt;|object_ref_end|&gt; in the image&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;|box_start|&gt;(101,201),(150,266)&lt;|box_end|&gt;&lt;|box_start|&gt;(401,601),(550,666)&lt;|box_end|&gt;&quot;</span><span class="p">}],</span> <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/xxx/x.jpg&quot;</span><span class="p">]}</span>
<span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a helpful assistant.&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;image&gt;Help me open Google Chrome&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Action: click(start_box=&#39;&lt;|box_start|&gt;(246,113)&lt;|box_end|&gt;&#39;)&quot;</span><span class="p">}],</span> <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/xxx/x.jpg&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<p>When using this type of data, please note:</p>
<ul class="simple">
<li><p>Different models have different special characters and data format for the grounding task.</p></li>
<li><p>The handling of bounding box normalization varies across different models: for example, qwen2.5-vl uses absolute coordinates, while qwen2/3-vl and internvl2.5 require bounding box coordinates to be normalized to the thousandth scale.</p>
<ul>
<li><p>Note: Qwen2.5-VL uses absolute coordinates, so you need to be careful with image resizing each time. If you use the dataset format from Option 1, you need to resize the images in advance (height and width must be multiples of 28) and scale the coordinates accordingly. If you use the dataset format from Option 2, ms-swift will handle image resizing for you. You can still use <code class="docutils literal notranslate"><span class="pre">MAX_PIXELS</span></code> or <code class="docutils literal notranslate"><span class="pre">--max_pixels</span></code> for image resizing (training only; for inference, you still need to handle image resizing yourself).</p></li>
</ul>
</li>
</ul>
<ol class="simple">
<li><p>Use ms-swift's grounding data format:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a helpful assistant.&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;image&gt;Describe the image.&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ref-object&gt;&lt;bbox&gt; and &lt;ref-object&gt;&lt;bbox&gt; are playing on the beach&quot;</span><span class="p">}],</span> <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/xxx/x.jpg&quot;</span><span class="p">],</span> <span class="s2">&quot;objects&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ref&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a dog&quot;</span><span class="p">,</span> <span class="s2">&quot;a woman&quot;</span><span class="p">],</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">331.5</span><span class="p">,</span> <span class="mf">761.4</span><span class="p">,</span> <span class="mf">853.5</span><span class="p">,</span> <span class="mf">1594.8</span><span class="p">],</span> <span class="p">[</span><span class="mf">676.5</span><span class="p">,</span> <span class="mf">685.8</span><span class="p">,</span> <span class="mf">1099.5</span><span class="p">,</span> <span class="mf">1427.4</span><span class="p">]]}}</span>
<span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a helpful assistant.&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;image&gt;Find the &lt;ref-object&gt; in the image&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;bbox&gt;&lt;bbox&gt;&quot;</span><span class="p">}],</span> <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/xxx/x.jpg&quot;</span><span class="p">],</span> <span class="s2">&quot;objects&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ref&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sheep&quot;</span><span class="p">],</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">90.9</span><span class="p">,</span> <span class="mf">160.8</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mf">212.8</span><span class="p">],</span> <span class="p">[</span><span class="mf">360.9</span><span class="p">,</span> <span class="mf">480.8</span><span class="p">,</span> <span class="mi">495</span><span class="p">,</span> <span class="mf">532.8</span><span class="p">]]}}</span>
<span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a helpful assistant.&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;image&gt;Help me open Google Chrome&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Action: click(start_box=&#39;&lt;bbox&gt;&#39;)&quot;</span><span class="p">}],</span> <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/xxx/x.jpg&quot;</span><span class="p">],</span> <span class="s2">&quot;objects&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ref&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;bbox&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">615</span><span class="p">,</span> <span class="mi">226</span><span class="p">]]}}</span>
</pre></div>
</div>
<p>The format will automatically convert the dataset format to the corresponding model's grounding task format and select the appropriate model's bbox normalization method. Compared to the general format, this format includes an additional &quot;objects&quot; field, which contains the following subfields:</p>
<ul class="simple">
<li><p>ref: Used to replace the <code class="docutils literal notranslate"><span class="pre">&lt;ref-object&gt;</span></code> placeholder in messages. The length of <code class="docutils literal notranslate"><span class="pre">ref</span></code> should match the number of <code class="docutils literal notranslate"><span class="pre">&lt;ref-object&gt;</span></code> instances.</p></li>
<li><p>bbox: Used to replace the <code class="docutils literal notranslate"><span class="pre">&lt;bbox&gt;</span></code> placeholder in messages. If the length of each box in the bbox is 2, it represents the x and y coordinates. If the box length is 4, it represents the x and y coordinates of two points. The length of <code class="docutils literal notranslate"><span class="pre">bbox</span></code> should match the number of <code class="docutils literal notranslate"><span class="pre">&lt;bbox&gt;</span></code> instances.</p>
<ul>
<li><p>Note: <code class="docutils literal notranslate"><span class="pre">&lt;ref-object&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;bbox&gt;</span></code> do not have a corresponding relationship; references and bounding boxes replace their own placeholders separately.</p></li>
</ul>
</li>
<li><p>bbox_type: Optional values are 'real' and 'norm1'. The default is 'real', meaning the bbox represents the actual bounding box value. If set to 'norm1', the bbox is normalized to the range 0~1.</p></li>
<li><p>image_id: Typically used for multi-image grounding tasks. This parameter only takes effect when bbox_type is 'real', representing which image the bbox corresponds to, used for scaling the bbox. The index starts from 0, and defaults to all being the 0th image. The length of image_id needs to be consistent with the length of bbox. For example: if the length of bbox is 10 and the length of images is 2, then the length of image_id needs to be 10, with values within the set <code class="docutils literal notranslate"><span class="pre">{0,</span> <span class="pre">1}</span></code>.</p></li>
</ul>
<p>For Qwen2.5-VL/Qwen3-VL, you can set the environment variable <code class="docutils literal notranslate"><span class="pre">QWENVL_BBOX_FORMAT='new'</span></code> (default is <code class="docutils literal notranslate"><span class="pre">'legacy'</span></code>) to be compatible with the <a class="reference external" href="https://github.com/QwenLM/Qwen3-VL/blob/main/cookbooks/2d_grounding.ipynb">official cookbook</a> format. Define your dataset in the following format:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;Locate the &lt;ref-object&gt; in the image&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;[\n\t{\&quot;bbox_2d\&quot;: &lt;bbox&gt;, \&quot;label\&quot;: \&quot;&lt;ref-object&gt;\&quot;},\n\t{\&quot;bbox_2d\&quot;: &lt;bbox&gt;, \&quot;label\&quot;: \&quot;&lt;ref-object&gt;\&quot;}\n]&quot;}], &quot;images&quot;: [&quot;cat.png&quot;], &quot;objects&quot;: {&quot;ref&quot;: [&quot;sheep&quot;, &quot;sheep&quot;, &quot;sheep&quot;], &quot;bbox&quot;: [[90.9, 160.8, 135, 212.8], [360.9, 480.8, 495, 532.8]]}}
</pre></div>
</div>
<p>Testing the final format of the grounding data in ms-swift format:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MAX_PIXELS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1003520&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">swift</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_processor</span><span class="p">,</span> <span class="n">get_template</span>

<span class="n">processor</span> <span class="o">=</span> <span class="n">get_processor</span><span class="p">(</span><span class="s1">&#39;Qwen/Qwen2.5-VL-7B-Instruct&#39;</span><span class="p">)</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="n">processor</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="n">template</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">return_template_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[INPUT_IDS] </span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">])</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[LABELS] </span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;images: </span><span class="si">{</span><span class="n">encoded</span><span class="p">[</span><span class="s2">&quot;template_inputs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="agent-format">
<h3>Agent Format<a class="headerlink" href="#agent-format" title="Link to this heading">ÔÉÅ</a></h3>
<p>Here are example data samples for a text-only Agent and a multimodal Agent:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;tools&quot;: &quot;[{\&quot;type\&quot;: \&quot;function\&quot;, \&quot;function\&quot;: {\&quot;name\&quot;: \&quot;realtime_aqi\&quot;, \&quot;description\&quot;: \&quot;Weather forecast. Get real-time air quality, including current air quality, PM2.5, and PM10 information.\&quot;, \&quot;parameters\&quot;: {\&quot;type\&quot;: \&quot;object\&quot;, \&quot;properties\&quot;: {\&quot;city\&quot;: {\&quot;type\&quot;: \&quot;string\&quot;, \&quot;description\&quot;: \&quot;City name, e.g., Shanghai\&quot;}}, \&quot;required\&quot;: [\&quot;city\&quot;]}}}]&quot;, &quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is the weather like in Beijing and Shanghai today?&quot;}, {&quot;role&quot;: &quot;tool_call&quot;, &quot;content&quot;: &quot;{\&quot;name\&quot;: \&quot;realtime_aqi\&quot;, \&quot;arguments\&quot;: {\&quot;city\&quot;: \&quot;Beijing\&quot;}}&quot;}, {&quot;role&quot;: &quot;tool_call&quot;, &quot;content&quot;: &quot;{\&quot;name\&quot;: \&quot;realtime_aqi\&quot;, \&quot;arguments\&quot;: {\&quot;city\&quot;: \&quot;Shanghai\&quot;}}&quot;}, {&quot;role&quot;: &quot;tool_response&quot;, &quot;content&quot;: &quot;{\&quot;city\&quot;: \&quot;Beijing\&quot;, \&quot;aqi\&quot;: \&quot;10\&quot;, \&quot;unit\&quot;: \&quot;celsius\&quot;}&quot;}, {&quot;role&quot;: &quot;tool_response&quot;, &quot;content&quot;: &quot;{\&quot;city\&quot;: \&quot;Shanghai\&quot;, \&quot;aqi\&quot;: \&quot;72\&quot;, \&quot;unit\&quot;: \&quot;fahrenheit\&quot;}&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;According to the weather forecast tool, the air quality index (AQI) in Beijing is 10, which indicates good air quality; whereas in Shanghai, the AQI is 72, indicating mild pollution.&quot;}]}
{&quot;tools&quot;: &quot;[{\&quot;type\&quot;: \&quot;function\&quot;, \&quot;function\&quot;: {\&quot;name\&quot;: \&quot;click\&quot;, \&quot;description\&quot;: \&quot;Click on a position on the screen\&quot;, \&quot;parameters\&quot;: {\&quot;type\&quot;: \&quot;object\&quot;, \&quot;properties\&quot;: {\&quot;x\&quot;: {\&quot;type\&quot;: \&quot;integer\&quot;, \&quot;description\&quot;: \&quot;X-coordinate representing the horizontal position on the screen\&quot;}, \&quot;y\&quot;: {\&quot;type\&quot;: \&quot;integer\&quot;, \&quot;description\&quot;: \&quot;Y-coordinate representing the vertical position on the screen\&quot;}}, \&quot;required\&quot;: [\&quot;x\&quot;, \&quot;y\&quot;]}}}]&quot;, &quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;What time is it now?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;&lt;think&gt;\nI can check the current time by opening the calendar app.\n&lt;/think&gt;\n&quot;}, {&quot;role&quot;: &quot;tool_call&quot;, &quot;content&quot;: &quot;{\&quot;name\&quot;: \&quot;click\&quot;, \&quot;arguments\&quot;: {\&quot;x\&quot;: 105, \&quot;y\&quot;: 132}}&quot;}, {&quot;role&quot;: &quot;tool_response&quot;, &quot;content&quot;: &quot;{\&quot;images\&quot;: \&quot;&lt;image&gt;\&quot;, \&quot;status\&quot;: \&quot;success\&quot;}&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Successfully opened the calendar app. The current time is 11 o&#39;clock in the morning.&quot;}], &quot;images&quot;: [&quot;desktop.png&quot;, &quot;calendar.png&quot;]}
</pre></div>
</div>
<ul class="simple">
<li><p>When the <code class="docutils literal notranslate"><span class="pre">agent_template</span></code> is set to &quot;react_en&quot;, &quot;hermes&quot;, etc., this format is compatible with training for all model Agents and allows easy switching between different models.</p></li>
<li><p>Among them, <code class="docutils literal notranslate"><span class="pre">tools</span></code> is a JSON string containing a list of tools, and the <code class="docutils literal notranslate"><span class="pre">content</span></code> section of <code class="docutils literal notranslate"><span class="pre">messages</span></code> where the <code class="docutils literal notranslate"><span class="pre">role</span></code> is <code class="docutils literal notranslate"><span class="pre">'tool_call'</span></code> or <code class="docutils literal notranslate"><span class="pre">'tool_response/tool'</span></code> must also be a JSON string.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">tools</span></code> field will be combined with the <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;system&quot;,</span> <span class="pre">...}</span></code> section during training/inference according to the <code class="docutils literal notranslate"><span class="pre">agent_template</span></code>, forming a complete system section.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;tool_call&quot;,</span> <span class="pre">...}</span></code> part will automatically be converted into corresponding formats of <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;assistant&quot;,</span> <span class="pre">...}</span></code> based on the <code class="docutils literal notranslate"><span class="pre">agent_template</span></code>. Multiple consecutive <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;assistant&quot;,</span> <span class="pre">...}</span></code> entries will be concatenated to form a complete assistant_content.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;tool_response&quot;,</span> <span class="pre">...}</span></code> can also be written as <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;tool&quot;,</span> <span class="pre">...}</span></code>, these two forms are equivalent. This part will also be automatically converted according to the <code class="docutils literal notranslate"><span class="pre">agent_template</span></code>. During training, this part does not participate in loss calculations, similar to <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;user&quot;,</span> <span class="pre">...}</span></code>.</p></li>
<li><p>This format supports parallel tool calls; refer to the first data sample for an example. In multimodal Agent data samples, the number of <code class="docutils literal notranslate"><span class="pre">&lt;image&gt;</span></code> tags should match the length of &quot;images&quot;, and their positions indicate where the image features are inserted. It also supports other modalities, such as audios and videos.</p></li>
<li><p>Note: You can also manually process the data into the messages format with roles set to system, user, or assistant. The purpose of agent_template is to automatically map the tools field and the messages with roles tool_call and tool_response into the standard messages format with roles system, user, and assistant.</p></li>
<li><p>For more details, please refer to <a class="reference internal" href="../Instruction/Agent-support.html"><span class="doc">Agent Documentation</span></a>.</p></li>
</ul>
</section>
<section id="text-to-image-format">
<h3>Text-to-Image Format<a class="headerlink" href="#text-to-image-format" title="Link to this heading">ÔÉÅ</a></h3>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;messages&quot;: [{&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are a useful and harmless assistant&quot;}, {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Draw me an apple&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;&lt;image&gt;&quot;}], &quot;images&quot;: [&quot;/xxx/x.jpg&quot;]}
</pre></div>
</div>
</section>
</section>
<section id="dataset-info-json">
<h2>dataset_info.json<a class="headerlink" href="#dataset-info-json" title="Link to this heading">ÔÉÅ</a></h2>
<p>You can refer to the ms-swift built-in <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/dataset/data/dataset_info.json">dataset_info.json</a>. This approach uses the AutoPreprocessor function to convert the dataset into a standard format. The dataset_info.json file contains a list of metadata about the dataset. Here are some examples:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;ms_dataset_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xxx/xxx&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;dataset_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;dataset_dir/dataset_path&gt;&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;ms_dataset_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;dataset_id&gt;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;subsets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;v1&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;split&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;validation&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;input&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;query&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;output&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;response&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;ms_dataset_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;dataset_id&gt;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;hf_dataset_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;hf_dataset_id&gt;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;subsets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">      </span><span class="nt">&quot;subset&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;subset1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;problem&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;query&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;response&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;subset&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;subset2&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;_&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;new_messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;messages&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The following parameters are supported:</p>
<ul class="simple">
<li><p>ms_dataset_id: Refers to the DatasetMeta parameter.</p></li>
<li><p>hf_dataset_id: Refers to the DatasetMeta parameter.</p></li>
<li><p>dataset_path: Refers to the DatasetMeta parameter.</p></li>
<li><p>dataset_name: Refers to the DatasetMeta parameter.</p></li>
<li><p>subsets: Refers to the DatasetMeta parameter.</p></li>
<li><p>split: Refers to the DatasetMeta parameter.</p></li>
<li><p>columns: Transforms column names before preprocessing the dataset.</p></li>
</ul>
</section>
<section id="dataset-registration">
<h2>Dataset Registration<a class="headerlink" href="#dataset-registration" title="Link to this heading">ÔÉÅ</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">register_dataset</span></code> will register the dataset in <code class="docutils literal notranslate"><span class="pre">DATASET_MAPPING</span></code>. You can call the function <code class="docutils literal notranslate"><span class="pre">register_dataset(dataset_meta)</span></code> to complete the dataset registration, where <code class="docutils literal notranslate"><span class="pre">dataset_meta</span></code> will store the metadata of the model. The parameter list for DatasetMeta is as follows:</p>
<ul class="simple">
<li><p>ms_dataset_id: The dataset_id for ModelScope, default is None.</p></li>
<li><p>hf_dataset_id: The dataset_id for HuggingFace, default is None.</p></li>
<li><p>dataset_path: Local path to the <strong>dataset file/folder</strong> (absolute path recommended). Default is None.</p></li>
<li><p>dataset_name: The alias of the dataset, which can be specified via <code class="docutils literal notranslate"><span class="pre">--dataset</span> <span class="pre">&lt;dataset_name&gt;</span></code>. This is very convenient when the dataset_path is long. The default value is None.</p></li>
<li><p>subsets: A list of subdataset names or a list of <code class="docutils literal notranslate"><span class="pre">SubsetDataset</span></code> objects, default is <code class="docutils literal notranslate"><span class="pre">['default']</span></code>. (The concepts of subdatasets and splits only exist for dataset_id or dataset_dir (open source datasets cloned via git)).</p></li>
<li><p>split: Defaults to <code class="docutils literal notranslate"><span class="pre">['train']</span></code>.</p></li>
<li><p>preprocess_func: A preprocessing function or callable object, default is <code class="docutils literal notranslate"><span class="pre">AutoPreprocessor()</span></code>. This preprocessing function takes an <code class="docutils literal notranslate"><span class="pre">HfDataset</span></code> as input and returns an <code class="docutils literal notranslate"><span class="pre">HfDataset</span></code> in the standard format.</p></li>
<li><p>load_function: Defaults to <code class="docutils literal notranslate"><span class="pre">DatasetLoader.load</span></code>. If a custom loading function is needed, it should return an <code class="docutils literal notranslate"><span class="pre">HfDataset</span></code> in the standard format, allowing users maximum flexibility while bypassing the ms-swift dataset loading mechanism. This parameter usually does not need to be modified.</p></li>
</ul>
<p>Below are examples of registering datasets:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">swift.dataset</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ResponsePreprocessor</span><span class="p">,</span> <span class="n">DatasetMeta</span><span class="p">,</span> <span class="n">register_dataset</span><span class="p">,</span> <span class="n">SubsetDataset</span><span class="p">,</span> <span class="n">load_dataset</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CustomPreprocessor</span><span class="p">(</span><span class="n">ResponsePreprocessor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Task: Judge whether the two sentences below are semantically similar.</span>
<span class="s2">Sentence 1: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text1&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">Sentence 2: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;text2&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">Output the category [0/1]: 0 for different meanings, 1 for similar meanings.</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
            <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>


<span class="n">register_dataset</span><span class="p">(</span>
    <span class="n">DatasetMeta</span><span class="p">(</span>
        <span class="n">ms_dataset_id</span><span class="o">=</span><span class="s1">&#39;swift/financial_classification&#39;</span><span class="p">,</span>
        <span class="n">subsets</span><span class="o">=</span><span class="p">[</span><span class="n">SubsetDataset</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]),</span> <span class="n">SubsetDataset</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])],</span>
        <span class="n">preprocess_func</span><span class="o">=</span><span class="n">CustomPreprocessor</span><span class="p">(),</span>
    <span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># load_dataset returns train_dataset and val_dataset based on `split_dataset_ratio`</span>
    <span class="c1"># Here, since we didn&#39;t pass `split_dataset_ratio` (defaults to 0), we take the first one (index 0)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;swift/financial_classification:train&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;swift/financial_classification:test&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dataset[0]: </span><span class="si">{</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test_dataset[0]: </span><span class="si">{</span><span class="n">test_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ÁâàÊùÉÊâÄÊúâ 2024, Ascend„ÄÇ</p>
  </div>

  Âà©Áî® <a href="https://www.sphinx-doc.org/">Sphinx</a> ÊûÑÂª∫Ôºå‰ΩøÁî®ÁöÑ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">‰∏ªÈ¢ò</a>
    Áî± <a href="https://readthedocs.org">Read the Docs</a> ÂºÄÂèë.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>