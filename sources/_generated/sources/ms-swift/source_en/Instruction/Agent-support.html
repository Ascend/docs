

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Support &mdash; ÊòáËÖæÂºÄÊ∫ê  ÊñáÊ°£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Á¥¢Âºï" href="../../../../../../genindex.html" />
    <link rel="search" title="ÊêúÁ¥¢" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            ÊòáËÖæÂºÄÊ∫ê
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="ÊêúÁ¥¢ÊñáÊ°£" aria-label="ÊêúÁ¥¢ÊñáÊ°£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="ÂØºËà™ËèúÂçï">
              <p class="caption" role="heading"><span class="caption-text">üèÅ ÂºÄÂßã‰ΩøÁî®</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ascend/quick_install.html">Âø´ÈÄüÂÆâË£ÖÊòáËÖæÁéØÂ¢É</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üèóÔ∏è  Âü∫Á°ÄËÆæÊñΩ‰∏éÊ°ÜÊû∂</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üß† ËÆ≠ÁªÉ‰∏éÂæÆË∞ÉÊ°ÜÊû∂</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üöÄ Êé®ÁêÜ‰∏éÊúçÂä°</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üé® Â§öÊ®°ÊÄÅ„ÄÅÂ∫îÁî®‰∏éËØÑÊµã</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ÁßªÂä®ÁâàÂØºËà™ËèúÂçï" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">ÊòáËÖæÂºÄÊ∫ê</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="È°µÈù¢ÂØºËà™">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Agent Support</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/sources/_generated/sources/ms-swift/source_en/Instruction/Agent-support.md.txt" rel="nofollow"> Êü•ÁúãÈ°µÈù¢Ê∫êÁ†Å</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="agent-support">
<h1>Agent Support<a class="headerlink" href="#agent-support" title="Link to this heading">ÔÉÅ</a></h1>
<section id="dataset-format">
<h2>Dataset Format<a class="headerlink" href="#dataset-format" title="Link to this heading">ÔÉÅ</a></h2>
<p>Example data samples for the pure text Agent and multimodal Agent are as follows:</p>
<div class="highlight-jsonl notranslate"><div class="highlight"><pre><span></span>{&quot;tools&quot;: &quot;[{\&quot;type\&quot;: \&quot;function\&quot;, \&quot;function\&quot;: {\&quot;name\&quot;: \&quot;realtime_aqi\&quot;, \&quot;description\&quot;: \&quot;Weather forecast. Get real-time air quality, including current air quality, PM2.5, and PM10 information.\&quot;, \&quot;parameters\&quot;: {\&quot;type\&quot;: \&quot;object\&quot;, \&quot;properties\&quot;: {\&quot;city\&quot;: {\&quot;type\&quot;: \&quot;string\&quot;, \&quot;description\&quot;: \&quot;City name, e.g., Shanghai\&quot;}}, \&quot;required\&quot;: [\&quot;city\&quot;]}}}]&quot;, &quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is the weather like in Beijing and Shanghai today?&quot;}, {&quot;role&quot;: &quot;tool_call&quot;, &quot;content&quot;: &quot;{\&quot;name\&quot;: \&quot;realtime_aqi\&quot;, \&quot;arguments\&quot;: {\&quot;city\&quot;: \&quot;Beijing\&quot;}}&quot;}, {&quot;role&quot;: &quot;tool_call&quot;, &quot;content&quot;: &quot;{\&quot;name\&quot;: \&quot;realtime_aqi\&quot;, \&quot;arguments\&quot;: {\&quot;city\&quot;: \&quot;Shanghai\&quot;}}&quot;}, {&quot;role&quot;: &quot;tool_response&quot;, &quot;content&quot;: &quot;{\&quot;city\&quot;: \&quot;Beijing\&quot;, \&quot;aqi\&quot;: \&quot;10\&quot;, \&quot;unit\&quot;: \&quot;celsius\&quot;}&quot;}, {&quot;role&quot;: &quot;tool_response&quot;, &quot;content&quot;: &quot;{\&quot;city\&quot;: \&quot;Shanghai\&quot;, \&quot;aqi\&quot;: \&quot;72\&quot;, \&quot;unit\&quot;: \&quot;fahrenheit\&quot;}&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;According to the weather forecast tool, the air quality index (AQI) in Beijing is 10, which indicates good air quality; whereas in Shanghai, the AQI is 72, indicating mild pollution.&quot;}]}
{&quot;tools&quot;: &quot;[{\&quot;type\&quot;: \&quot;function\&quot;, \&quot;function\&quot;: {\&quot;name\&quot;: \&quot;click\&quot;, \&quot;description\&quot;: \&quot;Click on a position on the screen\&quot;, \&quot;parameters\&quot;: {\&quot;type\&quot;: \&quot;object\&quot;, \&quot;properties\&quot;: {\&quot;x\&quot;: {\&quot;type\&quot;: \&quot;integer\&quot;, \&quot;description\&quot;: \&quot;X-coordinate representing the horizontal position on the screen\&quot;}, \&quot;y\&quot;: {\&quot;type\&quot;: \&quot;integer\&quot;, \&quot;description\&quot;: \&quot;Y-coordinate representing the vertical position on the screen\&quot;}}, \&quot;required\&quot;: [\&quot;x\&quot;, \&quot;y\&quot;]}}}]&quot;, &quot;messages&quot;: [{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;&lt;image&gt;What time is it now?&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;&lt;think&gt;\nI can check the current time by opening the calendar app.\n&lt;/think&gt;\n&quot;}, {&quot;role&quot;: &quot;tool_call&quot;, &quot;content&quot;: &quot;{\&quot;name\&quot;: \&quot;click\&quot;, \&quot;arguments\&quot;: {\&quot;x\&quot;: 105, \&quot;y\&quot;: 132}}&quot;}, {&quot;role&quot;: &quot;tool_response&quot;, &quot;content&quot;: &quot;{\&quot;images\&quot;: \&quot;&lt;image&gt;\&quot;, \&quot;status\&quot;: \&quot;success\&quot;}&quot;}, {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Successfully opened the calendar app. The current time is 11 o&#39;clock in the morning.&quot;}], &quot;images&quot;: [&quot;desktop.png&quot;, &quot;calendar.png&quot;]}
</pre></div>
</div>
<ul class="simple">
<li><p>When the <code class="docutils literal notranslate"><span class="pre">agent_template</span></code> is set to &quot;react_en&quot;, &quot;hermes&quot;, etc., this format is compatible with training for all model Agents and allows easy switching between different models.</p></li>
<li><p>Among them, <code class="docutils literal notranslate"><span class="pre">tools</span></code> is a JSON string containing a list of tools, and the <code class="docutils literal notranslate"><span class="pre">content</span></code> section of <code class="docutils literal notranslate"><span class="pre">messages</span></code> where the <code class="docutils literal notranslate"><span class="pre">role</span></code> is <code class="docutils literal notranslate"><span class="pre">'tool_call'</span></code> or <code class="docutils literal notranslate"><span class="pre">'tool_response/tool'</span></code> must also be a JSON string.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">tools</span></code> field will be combined with the <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;system&quot;,</span> <span class="pre">...}</span></code> section during training/inference according to the <code class="docutils literal notranslate"><span class="pre">agent_template</span></code>, forming a complete system section.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;tool_call&quot;,</span> <span class="pre">...}</span></code> part will automatically be converted into corresponding formats of <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;assistant&quot;,</span> <span class="pre">...}</span></code> based on the <code class="docutils literal notranslate"><span class="pre">agent_template</span></code>. Multiple consecutive <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;assistant&quot;,</span> <span class="pre">...}</span></code> entries will be concatenated to form a complete assistant_content.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;tool_response&quot;,</span> <span class="pre">...}</span></code> can also be written as <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;tool&quot;,</span> <span class="pre">...}</span></code>, these two forms are equivalent. This part will also be automatically converted according to the <code class="docutils literal notranslate"><span class="pre">agent_template</span></code>. During training, this part does not participate in loss calculations, similar to <code class="docutils literal notranslate"><span class="pre">{&quot;role&quot;:</span> <span class="pre">&quot;user&quot;,</span> <span class="pre">...}</span></code>.</p></li>
<li><p>This format supports parallel tool calls; refer to the first data sample for an example. In multimodal Agent data samples, the number of <code class="docutils literal notranslate"><span class="pre">&lt;image&gt;</span></code> tags should match the length of &quot;images&quot;, and their positions indicate where the image features are inserted. It also supports other modalities, such as audios and videos.</p></li>
<li><p>Note: You can also manually process the data into the messages format with roles set to system, user, or assistant. The purpose of agent_template is to automatically map the tools field and the messages with roles tool_call and tool_response into the standard messages format with roles system, user, and assistant.</p></li>
</ul>
<p>The following are the <code class="docutils literal notranslate"><span class="pre">input_ids</span></code> and <code class="docutils literal notranslate"><span class="pre">labels</span></code> after encoding the two data samples mentioned above using the templates for <strong>qwen2_5</strong> and <strong>qwen2_5_vl</strong> , with the selected <code class="docutils literal notranslate"><span class="pre">agent_template</span></code> being <strong>hermes</strong> :</p>
<p>Sample One (Parallel Tool Calls):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[INPUT_IDS] &lt;|im_start|&gt;system
You are Qwen, created by Alibaba Cloud. You are a helpful assistant.

# Tools

You may call one or more functions to assist with the user query.

You are provided with function signatures within &lt;tools&gt;&lt;/tools&gt; XML tags:
&lt;tools&gt;
{&quot;type&quot;: &quot;function&quot;, &quot;function&quot;: {&quot;name&quot;: &quot;realtime_aqi&quot;, &quot;description&quot;: &quot;Weather forecast. Get real-time air quality, including current air quality, PM2.5, and PM10 information.&quot;, &quot;parameters&quot;: {&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: {&quot;city&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;City name, e.g., Shanghai&quot;}}, &quot;required&quot;: [&quot;city&quot;]}}}
&lt;/tools&gt;

For each function call, return a json object with function name and arguments within &lt;tool_call&gt;&lt;/tool_call&gt; XML tags:
&lt;tool_call&gt;
{&quot;name&quot;: &lt;function-name&gt;, &quot;arguments&quot;: &lt;args-json-object&gt;}
&lt;/tool_call&gt;&lt;|im_end|&gt;
&lt;|im_start|&gt;user
What is the weather like in Beijing and Shanghai today?&lt;|im_end|&gt;
&lt;|im_start|&gt;assistant
&lt;tool_call&gt;
{&quot;name&quot;: &quot;realtime_aqi&quot;, &quot;arguments&quot;: {&quot;city&quot;: &quot;Beijing&quot;}}
&lt;/tool_call&gt;
&lt;tool_call&gt;
{&quot;name&quot;: &quot;realtime_aqi&quot;, &quot;arguments&quot;: {&quot;city&quot;: &quot;Shanghai&quot;}}
&lt;/tool_call&gt;&lt;|im_end|&gt;
&lt;|im_start|&gt;user
&lt;tool_response&gt;
{&quot;city&quot;: &quot;Beijing&quot;, &quot;aqi&quot;: &quot;10&quot;, &quot;unit&quot;: &quot;celsius&quot;}
&lt;/tool_response&gt;
&lt;tool_response&gt;
{&quot;city&quot;: &quot;Shanghai&quot;, &quot;aqi&quot;: &quot;72&quot;, &quot;unit&quot;: &quot;fahrenheit&quot;}
&lt;/tool_response&gt;&lt;|im_end|&gt;
&lt;|im_start|&gt;assistant
According to the weather forecast tool, the air quality index (AQI) in Beijing is 10, which indicates good air quality; whereas in Shanghai, the AQI is 72, indicating mild pollution.&lt;|im_end|&gt;

[LABELS] [-100 * 195]&lt;tool_call&gt;
{&quot;name&quot;: &quot;realtime_aqi&quot;, &quot;arguments&quot;: {&quot;city&quot;: &quot;Beijing&quot;}}
&lt;/tool_call&gt;
&lt;tool_call&gt;
{&quot;name&quot;: &quot;realtime_aqi&quot;, &quot;arguments&quot;: {&quot;city&quot;: &quot;Shanghai&quot;}}
&lt;/tool_call&gt;&lt;|im_end|&gt;[-100 * 67]According to the weather forecast tool, the air quality index (AQI) in Beijing is 10, which indicates good air quality; whereas in Shanghai, the AQI is 72, indicating mild pollution.&lt;|im_end|&gt;
</pre></div>
</div>
<p>Sample Two (Multimodal, Mixed Assistant and Tool Call):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[INPUT_IDS] &lt;|im_start|&gt;system
You are a helpful assistant.

# Tools

You may call one or more functions to assist with the user query.

You are provided with function signatures within &lt;tools&gt;&lt;/tools&gt; XML tags:
&lt;tools&gt;
{&quot;type&quot;: &quot;function&quot;, &quot;function&quot;: {&quot;name&quot;: &quot;click&quot;, &quot;description&quot;: &quot;Click on a position on the screen&quot;, &quot;parameters&quot;: {&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: {&quot;x&quot;: {&quot;type&quot;: &quot;integer&quot;, &quot;description&quot;: &quot;X-coordinate representing the horizontal position on the screen&quot;}, &quot;y&quot;: {&quot;type&quot;: &quot;integer&quot;, &quot;description&quot;: &quot;Y-coordinate representing the vertical position on the screen&quot;}}, &quot;required&quot;: [&quot;x&quot;, &quot;y&quot;]}}}
&lt;/tools&gt;

For each function call, return a json object with function name and arguments within &lt;tool_call&gt;&lt;/tool_call&gt; XML tags:
&lt;tool_call&gt;
{&quot;name&quot;: &lt;function-name&gt;, &quot;arguments&quot;: &lt;args-json-object&gt;}
&lt;/tool_call&gt;&lt;|im_end|&gt;
&lt;|im_start|&gt;user
&lt;|vision_start|&gt;[151655 * 729]&lt;|vision_end|&gt;What time is it now?&lt;|im_end|&gt;
&lt;|im_start|&gt;assistant
&lt;think&gt;
I can check the current time by opening the calendar app.
&lt;/think&gt;
&lt;tool_call&gt;
{&quot;name&quot;: &quot;click&quot;, &quot;arguments&quot;: {&quot;x&quot;: 105, &quot;y&quot;: 132}}
&lt;/tool_call&gt;&lt;|im_end|&gt;
&lt;|im_start|&gt;user
&lt;tool_response&gt;
{&quot;images&quot;: &quot;&lt;|vision_start|&gt;[151655 * 729]&lt;|vision_end|&gt;&quot;, &quot;status&quot;: &quot;success&quot;}
&lt;/tool_response&gt;&lt;|im_end|&gt;
&lt;|im_start|&gt;assistant
Successfully opened the calendar app. The current time is 11 o&#39;clock in the morning.&lt;|im_end|&gt;

[LABELS] [-100 * 924]&lt;think&gt;
I can check the current time by opening the calendar app.
&lt;/think&gt;
&lt;tool_call&gt;
{&quot;name&quot;: &quot;click&quot;, &quot;arguments&quot;: {&quot;x&quot;: 105, &quot;y&quot;: 132}}
&lt;/tool_call&gt;&lt;|im_end|&gt;[-100 * 759]Successfully opened the calendar app. The current time is 11 o&#39;clock in the morning.&lt;|im_end|&gt;
</pre></div>
</div>
<p><strong>react_en</strong> is one of the commonly used agent template formats. Below is an example of the <code class="docutils literal notranslate"><span class="pre">input_ids</span></code> and <code class="docutils literal notranslate"><span class="pre">labels</span></code> after encoding by qwen2_5 using <code class="docutils literal notranslate"><span class="pre">agent_template='react_en'</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[INPUT_IDS] &lt;|im_start|&gt;system
Answer the following questions as best you can. You have access to the following tools:

realtime_aqi: Call this tool to interact with the realtime_aqi API. What is the realtime_aqi API useful for? Weather forecast. Get real-time air quality, including current air quality, PM2.5, and PM10 information. Parameters: {&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: {&quot;city&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;City name, e.g., Shanghai&quot;}}, &quot;required&quot;: [&quot;city&quot;]} Format the arguments as a JSON object.

Use the following format:

Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [realtime_aqi]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can be repeated zero or more times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Begin!
&lt;|im_end|&gt;
&lt;|im_start|&gt;user
What is the weather like in Beijing and Shanghai today?&lt;|im_end|&gt;
&lt;|im_start|&gt;assistant
Action: realtime_aqi
Action Input: {&#39;city&#39;: &#39;Beijing&#39;}
Action: realtime_aqi
Action Input: {&#39;city&#39;: &#39;Shanghai&#39;}
Observation:{&quot;city&quot;: &quot;Beijing&quot;, &quot;aqi&quot;: &quot;10&quot;, &quot;unit&quot;: &quot;celsius&quot;}
Observation:{&quot;city&quot;: &quot;Shanghai&quot;, &quot;aqi&quot;: &quot;72&quot;, &quot;unit&quot;: &quot;fahrenheit&quot;}
According to the weather forecast tool, the air quality index (AQI) in Beijing is 10, which indicates good air quality; whereas in Shanghai, the AQI is 72, indicating mild pollution.&lt;|im_end|&gt;

[LABELS] [-100 * 233]Action: realtime_aqi
Action Input: {&#39;city&#39;: &#39;Beijing&#39;}
Action: realtime_aqi
Action Input: {&#39;city&#39;: &#39;Shanghai&#39;}
Observation:[-100 * 45]According to the weather forecast tool, the air quality index (AQI) in Beijing is 10, which indicates good air quality; whereas in Shanghai, the AQI is 72, indicating mild pollution.&lt;|im_end|&gt;
</pre></div>
</div>
<p>The following code can be used to experiment with more models and <code class="docutils literal notranslate"><span class="pre">agent_template</span></code> options. For more selectable values of <code class="docutils literal notranslate"><span class="pre">agent_template</span></code>, refer to <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/agent_template/__init__.py">here</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">swift</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_processor</span><span class="p">,</span> <span class="n">get_template</span>

<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">get_processor</span><span class="p">(</span><span class="s1">&#39;ZhipuAI/GLM-4-9B-0414&#39;</span><span class="p">)</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">agent_template</span><span class="o">=</span><span class="s1">&#39;hermes&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="n">template</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[INPUT_IDS] </span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">])</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[LABELS] </span><span class="si">{</span><span class="n">template</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="tools-format">
<h2>Tools Format<a class="headerlink" href="#tools-format" title="Link to this heading">ÔÉÅ</a></h2>
<p>The tools field provides information about the APIs that the model can call. You need to provide the name, description, and parameters of the tools, as shown in the example below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tools</span> <span class="o">=</span> <span class="p">[{</span>
    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span>
    <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;get_current_weather&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Get the current weather in a given location&#39;</span><span class="p">,</span>
        <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
            <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;The city and state, e.g. San Francisco, CA&#39;</span>
                <span class="p">},</span>
                <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;celsius&#39;</span><span class="p">,</span> <span class="s1">&#39;fahrenheit&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}]</span>
</pre></div>
</div>
</section>
<section id="usage-of-loss-scale">
<h2>Usage of loss_scale<a class="headerlink" href="#usage-of-loss-scale" title="Link to this heading">ÔÉÅ</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">loss_scale</span></code> parameter can be used to adjust the loss weights for different parts of the model output during training. Currently, two configuration methods are supported: exact string matching and regular expression (regex) matching.</p>
<ol class="simple">
<li><p>String Matching Example: ReACT Format</p></li>
</ol>
<p>Take the ReACT format as an example. You can enable the corresponding <code class="docutils literal notranslate"><span class="pre">loss_scale</span></code> configuration via <code class="docutils literal notranslate"><span class="pre">--loss_scale</span> <span class="pre">react</span></code> (see configuration file <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/loss_scale/config/react.json">react.json</a>). This method relies on exact string matching. The dictionary mapping in the configuration must provide a list of two elements, representing:</p>
<ul class="simple">
<li><p>The loss weight for the matched string itself,</p></li>
<li><p>The loss weight for content following the matched string, up to (but not including) the next specified string.</p></li>
</ul>
<p>The specific effects of this configuration are as follows:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">'Action:'</span></code> and <code class="docutils literal notranslate"><span class="pre">'Action</span> <span class="pre">Input:'</span></code> keywords and their subsequent content both have a loss weight of 2;</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">'Thought:'</span></code> and <code class="docutils literal notranslate"><span class="pre">'Final</span> <span class="pre">Answer:'</span></code> keywords and their subsequent content both have a loss weight of 1;</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">'Observation:'</span></code> field itself has a loss weight of 2, but the subsequent tool call result content has a loss weight of 0.</p></li>
</ul>
<ol class="simple">
<li><p>Regular Expression Matching Example: Ignoring Empty Thought Blocks</p></li>
</ol>
<p>When training reasoning models, it may be necessary to exclude loss computation for empty thought blocks in the dataset, such as sequences like <code class="docutils literal notranslate"><span class="pre">'&lt;think&gt;\n\n&lt;/think&gt;\n\n'</span></code>.</p>
<p>In such cases, use <code class="docutils literal notranslate"><span class="pre">--loss_scale</span> <span class="pre">ignore_empty_think</span></code> (see configuration file <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/swift/loss_scale/config/ignore_empty_think.json">ignore_empty_think.json</a>). This configuration uses regular expression matching, where the dictionary mapping only needs to specify a single value‚Äîthe loss weight for the matched content.</p>
<p>The specific effect of this setting is:</p>
<ul class="simple">
<li><p>Any string matching the regular expression <code class="docutils literal notranslate"><span class="pre">&lt;think&gt;\\s*&lt;/think&gt;\\s*</span></code> is assigned a <code class="docutils literal notranslate"><span class="pre">loss_scale</span></code> of 0, meaning no loss is computed for these segments.</p></li>
</ul>
<p>Testing loss_scale using code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">swift</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_processor</span><span class="p">,</span> <span class="n">get_template</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;aaaaa&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;think&gt;</span><span class="se">\n\n</span><span class="s2">&lt;/think&gt;</span><span class="se">\n\n</span><span class="s2">abc&lt;think&gt;</span><span class="se">\n\n</span><span class="s2">&lt;/think&gt;</span><span class="se">\n\n</span><span class="s2">123&quot;</span><span class="p">},</span>
<span class="p">]}</span>

<span class="n">template</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="n">get_processor</span><span class="p">(</span><span class="s1">&#39;Qwen/Qwen3-8B&#39;</span><span class="p">),</span> <span class="n">loss_scale</span><span class="o">=</span><span class="s1">&#39;ignore_empty_think&#39;</span><span class="p">)</span>
<span class="n">template</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]))</span>
<span class="c1"># &#39;[-100 * 14]abc&lt;think&gt;\n\n&lt;/think&gt;\n\n123&lt;|im_end|&gt;\n&#39;</span>
</pre></div>
</div>
<p>For more <code class="docutils literal notranslate"><span class="pre">loss_scale</span></code> plugin designs, please refer to the <a class="reference internal" href="../Customization/Pluginization.html"><span class="doc">Pluginization</span></a> documentation.</p>
</section>
<section id="training">
<h2>Training<a class="headerlink" href="#training" title="Link to this heading">ÔÉÅ</a></h2>
<ul class="simple">
<li><p>Train the Agent capabilities of Base models by switching different models through modifying <code class="docutils literal notranslate"><span class="pre">--model</span></code>. Refer to <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/agent/qwen2_5.sh">here</a>.</p></li>
<li><p>The agent_template for training GLM4 is hermes. Refer to <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/agent/glm4.sh">here</a>.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">--loss_scale</span></code> to adjust the loss weight of the model output section. Refer to <a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/agent/loss_scale">here</a>.</p></li>
</ul>
</section>
<section id="inference">
<h2>Inference<a class="headerlink" href="#inference" title="Link to this heading">ÔÉÅ</a></h2>
<ul class="simple">
<li><p>üöÄFor inference of the original model or fully trained model, refer to <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/infer/demo_agent.py">here</a>.</p></li>
<li><p>For inference after LoRA training, refer to <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/train/agent/loss_scale/infer_lora.py">here</a>.</p></li>
</ul>
</section>
<section id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Link to this heading">ÔÉÅ</a></h2>
<p>For server and client code, refer to <a class="reference external" href="https://github.com/modelscope/ms-swift/blob/main/examples/deploy/agent">here</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ÁâàÊùÉÊâÄÊúâ 2024, Ascend„ÄÇ</p>
  </div>

  Âà©Áî® <a href="https://www.sphinx-doc.org/">Sphinx</a> ÊûÑÂª∫Ôºå‰ΩøÁî®ÁöÑ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">‰∏ªÈ¢ò</a>
    Áî± <a href="https://readthedocs.org">Read the Docs</a> ÂºÄÂèë.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>