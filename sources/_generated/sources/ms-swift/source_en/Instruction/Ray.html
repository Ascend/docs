

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ray Support &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Ray Support</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/sources/_generated/sources/ms-swift/source_en/Instruction/Ray.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ray-support">
<h1>Ray Support<a class="headerlink" href="#ray-support" title="Link to this heading">ïƒ</a></h1>
<p>SWIFT already supports using Ray for multi-GPU or multi-node training. The support status for Ray in existing features is as follows:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Feature</th>
<th>Ray Support</th>
<th>Example</th>
<th>Assignable Roles</th>
</tr>
</thead>
<tbody>
<tr>
<td>pt/sft</td>
<td>âœ…</td>
<td>https://github.com/modelscope/ms-swift/tree/main/examples/train/multi-node/ray</td>
<td>default</td>
</tr>
<tr>
<td>dpo</td>
<td>â</td>
<td></td>
<td></td>
</tr>
<tr>
<td>grpo</td>
<td>â</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ppo</td>
<td>â</td>
<td></td>
<td></td>
</tr>
<tr>
<td>megatron</td>
<td>â</td>
<td></td>
<td></td>
</tr>
<tr>
<td>sampling</td>
<td>âœ…</td>
<td>https://github.com/modelscope/ms-swift/tree/main/examples/sampler/distill</td>
<td>sampler/prm/orm</td>
</tr>
<tr>
<td>distill</td>
<td>âœ…</td>
<td>https://github.com/modelscope/ms-swift/tree/main/examples/sampler/sample</td>
<td>sampler/prm/orm</td>
</tr>
</tbody>
</table><section id="technical-details">
<h2>Technical Details<a class="headerlink" href="#technical-details" title="Link to this heading">ïƒ</a></h2>
<p>Before describing parameter settings, it's necessary to first explain the technical details. Since SWIFT currently uses many existing implementations from transformers and trl internally, decomposing into different Ray roles like veRL or ROLL is impractical, and decomposition would center around Ray, resulting in poor support for non-Ray scenarios.</p>
<p>Therefore, SWIFT adopts a decorator-based technical approach, defining different roles at the function level. These roles can be defined in parameters to specify how they are used. See the example below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">swift.ray</span><span class="w"> </span><span class="kn">import</span> <span class="n">RayHelper</span>

<span class="nd">@RayHelper</span><span class="o">.</span><span class="n">worker</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model1&#39;</span><span class="p">,</span> <span class="s1">&#39;model2&#39;</span><span class="p">])</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyTrainer</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_model1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_model2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_datasets</span><span class="p">()</span>

    <span class="nd">@RayHelper</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">&#39;model1&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_model1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@RayHelper</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">&#39;model2&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_model2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@RayHelper</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">&#39;model1&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model1</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="nd">@RayHelper</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">&#39;model2&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward_model2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model2</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="n">generated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollout</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forward_model2</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>
            <span class="o">...</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">MyTrainer</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
<p>RayHelper distributes decorated methods to different hardware clusters, and local calls are smoothly converted to remote calls in the Ray cluster. You can also partition centered around classes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@RayHelper</span><span class="o">.</span><span class="n">worker</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model1&#39;</span><span class="p">])</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Model1</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="nd">@RayHelper</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">&#39;model1&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

<span class="nd">@RayHelper</span><span class="o">.</span><span class="n">worker</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model2&#39;</span><span class="p">])</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Model2</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="nd">@RayHelper</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">&#39;model2&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward_and_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Trainer</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>SWIFT's support for Ray essentially uses a combination of &#64;worker and &#64;function annotations. The worker specifies Ray cluster roles, and function specifies how to distribute data.</p>
<p>The function annotation has several additional parameters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">group</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">dispatch</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;slice&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">],</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
                 <span class="n">execute</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
                 <span class="n">collect</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;flatten&#39;</span><span class="p">],</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">):</span>
</pre></div>
</div>
<ul>
<li><p>dispatch: How to distribute call input parameters</p>
<ul>
<li><p>slice: Split the input parameters, meaning workers execute with load balancing</p></li>
<li><p>all: All workers receive identical input parameters</p></li>
<li><p>Custom slicing method, format:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span><span class="w"> </span><span class="nf">my_custom_slice</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># n is the number of workers, i is the current worker index, data is the original input parameters</span>
        <span class="c1"># Return the input parameters for the i-th worker</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>execute: How to execute</p>
<ul class="simple">
<li><p>first: Execute on rank0; slice and Callable slicing methods are invalid in this case</p></li>
<li><p>all: Execute on all</p></li>
</ul>
</li>
<li><p>collect: How to collect returned data</p>
<ul>
<li><p>none: Return as-is, format is a list of return values from each worker</p></li>
<li><p>flatten: Flatten the results returned by workers, supports tuple flattening</p></li>
<li><p>Callable: Custom collect method, format:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span><span class="w"> </span><span class="nf">my_custom_collect</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="c1"># result is a list returned by each worker</span>
        <span class="c1"># Return in your desired format</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</section>
<section id="parameter-settings">
<h2>Parameter Settings<a class="headerlink" href="#parameter-settings" title="Link to this heading">ïƒ</a></h2>
<p>After explaining the technical details, we can configure the parameters. Developers can set different hardware configurations according to the role list in different processes. For example, in the sampling function, there are three roles: sampler, prm, orm. You can configure them like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">device_groups</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nproc_per_node</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">  </span><span class="nt">sample_group</span><span class="p">:</span>
<span class="w">    </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GPU</span>
<span class="w">    </span><span class="nt">ranks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">list(range(0, 2))</span>
<span class="w">    </span><span class="nt">workers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sampler</span>
<span class="w">  </span><span class="nt">rm_group</span><span class="p">:</span>
<span class="w">    </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GPU</span>
<span class="w">    </span><span class="nt">ranks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">list(range(2, 4))</span>
<span class="w">    </span><span class="nt">workers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prm</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">orm</span>
</pre></div>
</div>
<ul class="simple">
<li><p>nproc_per_node: The minimum number of GPUs per node required in the Ray cluster.</p></li>
<li><p>xxx_group: The name of each Ray group, can be specified arbitrarily</p>
<ul>
<li><p>device: Device type, currently supports GPU/CPU, etc.</p></li>
<li><p>ranks: Which ranks are allocated to the current group. If CPU, ranks can only be an integer representing the total number of processes needed. If GPU, can be in formats like <code class="docutils literal notranslate"><span class="pre">[0,1,2,3]</span></code>, <code class="docutils literal notranslate"><span class="pre">4</span></code>, <code class="docutils literal notranslate"><span class="pre">list(range(0,</span> <span class="pre">4))</span></code>, etc.</p></li>
<li><p>workers: Which roles are allocated to the current group.</p></li>
</ul>
</li>
</ul>
<p>All available roles can be found in the table at the top of this document.</p>
<p>If using the command line, device_groups can also be passed as <code class="docutils literal notranslate"><span class="pre">--device_groups</span> <span class="pre">xxx</span></code>, where xxx is a JSON string. For configuration simplicity, we strongly recommend using YAML format in conjunction with Ray.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>