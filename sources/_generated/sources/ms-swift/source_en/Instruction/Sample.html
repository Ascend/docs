

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sampling &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Sampling</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../../_sources/sources/_generated/sources/ms-swift/source_en/Instruction/Sample.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sampling">
<h1>Sampling<a class="headerlink" href="#sampling" title="Link to this heading">ïƒ</a></h1>
<p>Sampling is one of the newly supported key capabilities of SWIFT. This feature can be understood as the practical implementation of <code class="docutils literal notranslate"><span class="pre">test-time</span> <span class="pre">compute</span></code>. Additionally, this capability is crucial for the implementation of RFT (Reinforcement Fine-Tuning).</p>
<section id="capability-introduction">
<h2>Capability Introduction<a class="headerlink" href="#capability-introduction" title="Link to this heading">ïƒ</a></h2>
<p>The sampling capability of SWIFT can be demonstrated with the following example:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>swift<span class="w"> </span>sample<span class="w"> </span>--model<span class="w"> </span>LLM-Research/Meta-Llama-3.1-8B-Instruct<span class="w"> </span>--sampler_engine<span class="w"> </span>transformers<span class="w"> </span>--num_return_sequences<span class="w"> </span><span class="m">5</span><span class="w"> </span>--dataset<span class="w"> </span>AI-ModelScope/alpaca-gpt4-data-zh#5
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">jsonl</span></code> file with a timestamp as the filename will be generated in the <code class="docutils literal notranslate"><span class="pre">sample_output</span></code> directory of the current folder. This file should contain 25 lines, each representing a complete <code class="docutils literal notranslate"><span class="pre">messages</span></code> format data.</p>
<p>For a list of sampling parameters, please refer to <a class="reference internal" href="Command-line-parameters.html"><span class="doc">here</span></a>.</p>
</section>
<section id="environment-setup">
<h2>Environment Setup<a class="headerlink" href="#environment-setup" title="Link to this heading">ïƒ</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>ms-swift<span class="o">[</span>llm<span class="o">]</span><span class="w"> </span>-U
</pre></div>
</div>
<p>Or install swift from source:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/modelscope/ms-swift.git
<span class="nb">cd</span><span class="w"> </span>ms-swift
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;.[llm]&#39;</span>
</pre></div>
</div>
</section>
<section id="using-prm-and-orm-for-result-filtering">
<h2>Using PRM and ORM for Result Filtering<a class="headerlink" href="#using-prm-and-orm-for-result-filtering" title="Link to this heading">ïƒ</a></h2>
<p>An important capability of sampling is supervising the process and results, which can be supported by setting additional parameters.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>swift<span class="w"> </span>sample<span class="w"> </span>--model<span class="w"> </span>LLM-Research/Meta-Llama-3.1-8B-Instruct<span class="w"> </span>--sampler_engine<span class="w"> </span>lmdeploy<span class="w"> </span>--num_return_sequences<span class="w"> </span><span class="m">5</span><span class="w"> </span>--n_best_to_keep<span class="w"> </span><span class="m">2</span><span class="w"> </span>--dataset<span class="w"> </span>tastelikefeet/competition_math#5<span class="w"> </span>--prm_model<span class="w"> </span>AI-ModelScope/GRM-llama3.2-3B-rewardmodel-ft<span class="w"> </span>--orm_model<span class="w"> </span>math
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">jsonl</span></code> file with a timestamp as the filename will be generated in the <code class="docutils literal notranslate"><span class="pre">sample_output</span></code> directory of the current folder. This file <strong>will contain at most</strong> 10 lines, each representing a complete <code class="docutils literal notranslate"><span class="pre">messages</span></code> format data.</p>
<blockquote>
<div><p>The reason it contains at most 10 lines is that although 5 data points are processed in total, and 2 are kept for each data point (<code class="docutils literal notranslate"><span class="pre">n_best_to_keep</span></code>), ORM may fail some validations, and failed data will not be retained in the file.
Additionally, after adding <code class="docutils literal notranslate"><span class="pre">--prm_model</span></code> or <code class="docutils literal notranslate"><span class="pre">--orm_model</span></code>, the file format is slightly different and includes a <code class="docutils literal notranslate"><span class="pre">rejected_response</span></code> key, which contains the responses with the lowest PRM scores.</p>
</div></blockquote>
</section>
<section id="customizing-prm-or-orm">
<h2>Customizing PRM or ORM<a class="headerlink" href="#customizing-prm-or-orm" title="Link to this heading">ïƒ</a></h2>
<p>PRM and ORM can be customized by adding a new implementation in the plugin according to the existing code. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CustomPRM</span><span class="p">:</span>

    <span class="c1"># The constructor should be parameterless</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initialize here</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infer_requests</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InferRequest</span><span class="p">],</span>  <span class="n">ground_truths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
        <span class="o">...</span>


<span class="n">prms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;custom&#39;</span><span class="p">:</span> <span class="n">CustomPRM</span><span class="p">}</span>
</pre></div>
</div>
<p>Afterward, use <code class="docutils literal notranslate"><span class="pre">--prm_model</span> <span class="pre">custom</span></code> in the command line.</p>
</section>
<section id="memory-control">
<h2>Memory Control<a class="headerlink" href="#memory-control" title="Link to this heading">ïƒ</a></h2>
<p>If the sampled model and PRM are loaded into memory simultaneously, it may lead to an OOM (Out of Memory) issue. To address this, sampling can be divided into two stages:</p>
<ul class="simple">
<li><p><strong>Stage 1</strong>: Specify <code class="docutils literal notranslate"><span class="pre">--model</span></code> and <code class="docutils literal notranslate"><span class="pre">--sampler_engine</span></code> without specifying <code class="docutils literal notranslate"><span class="pre">--orm_model</span></code> and <code class="docutils literal notranslate"><span class="pre">--prm_model</span></code>. Perform sampling only and save the results to a file.</p></li>
<li><p><strong>Stage 2</strong>: Specify <code class="docutils literal notranslate"><span class="pre">--sampler_engine</span> <span class="pre">no</span></code>, along with <code class="docutils literal notranslate"><span class="pre">--orm_model</span></code> and <code class="docutils literal notranslate"><span class="pre">--prm_model</span></code>, and also specify <code class="docutils literal notranslate"><span class="pre">--cache_files</span></code>. Perform only RM data filtering without re-sampling.</p></li>
</ul>
<p>By dividing the process into two stages, only one model is loaded at a time, avoiding OOM issues.</p>
</section>
<section id="practical-example">
<h2>Practical Example<a class="headerlink" href="#practical-example" title="Link to this heading">ïƒ</a></h2>
<p>Please refer to the <a class="reference external" href="https://github.com/modelscope/ms-swift/tree/main/examples/train/rft/rft.py">Reinforcement Fine-Tuning Script</a>. This script provides a practical example of using sampling for reinforcement fine-tuning.</p>
<blockquote>
<div><p><strong>Note:</strong> The actual effectiveness of this script is strongly related to the quality of the model, data, and RM. Therefore, it is presented only as an example. Users should modify this script and train their own RM and generator models accordingly.</p>
</div></blockquote>
</section>
<section id="sampling-from-large-model">
<h2>Sampling From Large Model<a class="headerlink" href="#sampling-from-large-model" title="Link to this heading">ïƒ</a></h2>
<p>SWIFT's sample supports using the OpenAI API to distill data with large models. Example:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span><span class="s2">&quot;your_api_key&quot;</span><span class="w"> </span><span class="se">\</span>
swift<span class="w"> </span>sample<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--sampler_type<span class="w"> </span>distill<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--sampler_engine<span class="w"> </span>client<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model<span class="w"> </span>deepseek-r1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--stream<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dataset<span class="w"> </span>tastelikefeet/competition_math#5<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--num_return_sequences<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--temperature<span class="w"> </span><span class="m">0</span>.6<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--top_p<span class="w"> </span><span class="m">0</span>.95<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--engine_kwargs<span class="w"> </span><span class="s1">&#39;{&quot;base_url&quot;:&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;}&#39;</span>
</pre></div>
</div>
<p>In this example:</p>
<p><code class="docutils literal notranslate"><span class="pre">base_url</span></code> and <code class="docutils literal notranslate"><span class="pre">model</span></code> represent the API endpoint and model name, respectively. <code class="docutils literal notranslate"><span class="pre">stream</span></code> indicates the stream parameter for the request.</p>
<p>Note: For Deepseek-R1 series models, the output will be formatted as:<code class="docutils literal notranslate"><span class="pre">&lt;thinking&gt;{reasoning_content}&lt;/thinking&gt;\n\n&lt;answer&gt;{content}&lt;/answer&gt;</span></code>.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>