

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Performance data collection based on FSDP or MindSpeed(Megatron) on Ascend devices(zh) &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../search.html" />
    <link rel="next" title="Align the Inference results of the verl and vLLM frameworks on Ascend devices(zh)" href="ascend_consistency.html" />
    <link rel="prev" title="Performance data collection based on FSDP or MindSpeed(Megatron) on Ascend devices(en)" href="ascend_profiling_en.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../verl/index.html">verl</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ascend_quick_start.html">Ascend Quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="ascend_sglang_quick_start.html">Ascend Quickstart with SGLang Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="dockerfile_build_guidance.html">Ascend Dockerfile Build Guidance</a></li>
<li class="toctree-l2"><a class="reference internal" href="ascend_profiling_en.html">Performance data collection based on FSDP or MindSpeed(Megatron) on Ascend devices(en)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Performance data collection based on FSDP or MindSpeed(Megatron) on Ascend devices(zh)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fsdp-mindspeed-megatron">åœ¨æ˜‡è…¾è®¾å¤‡ä¸ŠåŸºäº FSDP æˆ– MindSpeed (Megatron) åç«¯è¿›è¡Œæ€§èƒ½æ•°æ®é‡‡é›†</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">é…ç½®</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">å…¨å±€é‡‡é›†æ§åˆ¶</a></li>
<li class="toctree-l4"><a class="reference internal" href="#profiler">è§’è‰²profileræ§åˆ¶</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id3">ç¤ºä¾‹</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">ç¦ç”¨é‡‡é›†</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">ç«¯åˆ°ç«¯é‡‡é›†</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">ç¦»æ•£æ¨¡å¼é‡‡é›†</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">å¯è§†åŒ–</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">è¿›é˜¶æŒ‡å—ï¼šç²¾ç»†åŒ–é‡‡é›†</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">èƒŒæ™¯ä¸æŒ‘æˆ˜</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">è§£å†³æ–¹æ¡ˆï¼šå…³é”®è·¯å¾„é‡‡æ ·</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rollout">1. Rollout é˜¶æ®µç²¾ç»†åŒ–é‡‡é›†</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compute-log-prob-actor-ref">2. compute_log_prob (Actor &amp; Ref) é˜¶æ®µç²¾ç»†åŒ–é‡‡é›†</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-policy-actor-critic">3. update_policy (Actor &amp; Critic) é˜¶æ®µç²¾ç»†åŒ–é‡‡é›†</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ascend_consistency.html">Align the Inference results of the verl and vLLM frameworks on Ascend devices(zh)</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../verl/index.html">verl</a></li>
      <li class="breadcrumb-item active">Performance data collection based on FSDP or MindSpeed(Megatron) on Ascend devices(zh)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/sources/_generated/sources/verl/ascend_profiling_zh.rst.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="performance-data-collection-based-on-fsdp-or-mindspeed-megatron-on-ascend-devices-zh">
<h1>Performance data collection based on FSDP or MindSpeed(Megatron) on Ascend devices(zh)<a class="headerlink" href="#performance-data-collection-based-on-fsdp-or-mindspeed-megatron-on-ascend-devices-zh" title="Link to this heading">ïƒ</a></h1>
<section id="fsdp-mindspeed-megatron">
<h2>åœ¨æ˜‡è…¾è®¾å¤‡ä¸ŠåŸºäº FSDP æˆ– MindSpeed (Megatron) åç«¯è¿›è¡Œæ€§èƒ½æ•°æ®é‡‡é›†<a class="headerlink" href="#fsdp-mindspeed-megatron" title="Link to this heading">ïƒ</a></h2>
<p>Last updated: 12/20/2025.</p>
<p>è¿™æ˜¯ä¸€ä»½åœ¨æ˜‡è…¾è®¾å¤‡ä¸ŠåŸºäºFSDPæˆ–MindSpeed(Megatron)åç«¯ï¼Œä½¿ç”¨GRPOæˆ–DAPOç®—æ³•è¿›è¡Œæ•°æ®é‡‡é›†çš„æ•™ç¨‹ã€‚</p>
</section>
<section id="id1">
<h2>é…ç½®<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h2>
<p>ä½¿ç”¨ä¸¤çº§profileè®¾ç½®æ¥æ§åˆ¶æ•°æ®é‡‡é›†</p>
<ul class="simple">
<li><p>å…¨å±€é‡‡é›†æ§åˆ¶ï¼šä½¿ç”¨verl/trainer/config/ppo_trainer.yaml(FSDP)ï¼Œæˆ–verl/trainer/config/ppo_megatron_trainer.yaml(MindSpeed)ä¸­çš„é…ç½®é¡¹æ§åˆ¶é‡‡é›†çš„æ¨¡å¼å’Œæ­¥æ•°ã€‚</p></li>
<li><p>è§’è‰²profileæ§åˆ¶ï¼šé€šè¿‡æ¯ä¸ªè§’è‰²ä¸­çš„é…ç½®é¡¹æ§åˆ¶ç­‰å‚æ•°ã€‚</p></li>
</ul>
<section id="id2">
<h3>å…¨å±€é‡‡é›†æ§åˆ¶<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h3>
<p>é€šè¿‡ ppo_trainer.yaml ä¸­çš„å‚æ•°æ§åˆ¶é‡‡é›†æ­¥æ•°å’Œæ¨¡å¼ï¼š</p>
<ul class="simple">
<li><p>global_profiler: æ§åˆ¶é‡‡é›†çš„rankå’Œæ¨¡å¼</p>
<ul>
<li><p>tool: ä½¿ç”¨çš„é‡‡é›†å·¥å…·ï¼Œé€‰é¡¹æœ‰ nsysã€npuã€torchã€torch_memoryã€‚</p></li>
<li><p>steps: æ­¤å‚æ•°å¯ä»¥è®¾ç½®ä¸ºåŒ…å«é‡‡é›†æ­¥æ•°çš„åˆ—è¡¨ï¼Œä¾‹å¦‚ [2, 4]ï¼Œè¡¨ç¤ºå°†é‡‡é›†ç¬¬2æ­¥å’Œç¬¬4æ­¥ã€‚å¦‚æœè®¾ç½®ä¸º nullï¼Œåˆ™ä¸è¿›è¡Œé‡‡é›†ã€‚</p></li>
<li><p>save_path: ä¿å­˜é‡‡é›†æ•°æ®çš„è·¯å¾„ã€‚é»˜è®¤å€¼ä¸º &quot;outputs/profile&quot;ã€‚</p></li>
</ul>
</li>
</ul>
</section>
<section id="profiler">
<h3>è§’è‰²profileræ§åˆ¶<a class="headerlink" href="#profiler" title="Link to this heading">ïƒ</a></h3>
<p>åœ¨æ¯ä¸ªè§’è‰²çš„ <code class="docutils literal notranslate"><span class="pre">profiler</span></code> å­—æ®µä¸­ï¼Œæ‚¨å¯ä»¥æ§åˆ¶è¯¥è§’è‰²çš„é‡‡é›†æ¨¡å¼ã€‚</p>
<ul class="simple">
<li><p>enable: æ˜¯å¦ä¸ºæ­¤è§’è‰²å¯ç”¨æ€§èƒ½åˆ†æã€‚</p></li>
<li><p>all_ranks: æ˜¯å¦ä»æ‰€æœ‰rankæ”¶é›†æ•°æ®ã€‚</p></li>
<li><p>ranks: è¦æ”¶é›†æ•°æ®çš„rankåˆ—è¡¨ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™ä¸æ”¶é›†æ•°æ®ã€‚</p></li>
<li><p>tool_config: æ­¤è§’è‰²ä½¿ç”¨çš„æ€§èƒ½åˆ†æå·¥å…·çš„é…ç½®ã€‚</p></li>
</ul>
<p>é€šè¿‡æ¯ä¸ªè§’è‰²çš„ <code class="docutils literal notranslate"><span class="pre">profiler.tool_config.npu</span></code> ä¸­çš„å‚æ•°æ§åˆ¶å…·ä½“é‡‡é›†è¡Œä¸ºï¼š</p>
<ul class="simple">
<li><p>level: é‡‡é›†çº§åˆ«â€”é€‰é¡¹æœ‰ level_noneã€level0ã€level1 å’Œ level2</p>
<ul>
<li><p>level_none: ç¦ç”¨æ‰€æœ‰åŸºäºçº§åˆ«çš„æ•°æ®é‡‡é›†ï¼ˆå…³é—­ profiler_levelï¼‰ã€‚</p></li>
<li><p>level0: é‡‡é›†é«˜çº§åº”ç”¨æ•°æ®ã€åº•å±‚NPUæ•°æ®å’ŒNPUä¸Šçš„ç®—å­æ‰§è¡Œè¯¦æƒ…ã€‚åœ¨æƒè¡¡æ•°æ®é‡å’Œåˆ†æèƒ½åŠ›åï¼Œlevel0æ˜¯æ¨èçš„é»˜è®¤é…ç½®ã€‚</p></li>
<li><p>level1: åœ¨level0åŸºç¡€ä¸Šå¢åŠ CANNå±‚AscendCLæ•°æ®å’ŒNPUä¸Šçš„AI Coreæ€§èƒ½æŒ‡æ ‡ã€‚</p></li>
<li><p>level2: åœ¨level1åŸºç¡€ä¸Šå¢åŠ CANNå±‚Runtimeæ•°æ®å’ŒAI CPUæŒ‡æ ‡ã€‚</p></li>
</ul>
</li>
<li><p>contents: æ§åˆ¶é‡‡é›†å†…å®¹çš„é€‰é¡¹åˆ—è¡¨ï¼Œä¾‹å¦‚
npuã€cpuã€memoryã€shapesã€moduleã€stackã€‚</p>
<ul>
<li><p>npu: æ˜¯å¦é‡‡é›†è®¾å¤‡ç«¯æ€§èƒ½æ•°æ®ã€‚</p></li>
<li><p>cpu: æ˜¯å¦é‡‡é›†ä¸»æœºç«¯æ€§èƒ½æ•°æ®ã€‚</p></li>
<li><p>memory: æ˜¯å¦å¯ç”¨å†…å­˜åˆ†æã€‚</p></li>
<li><p>shapes: æ˜¯å¦è®°å½•å¼ é‡å½¢çŠ¶ã€‚</p></li>
<li><p>module: æ˜¯å¦è®°å½•æ¡†æ¶å±‚Pythonè°ƒç”¨æ ˆä¿¡æ¯ã€‚ç›¸è¾ƒäºstackï¼Œæ›´æ¨èä½¿ç”¨moduleè®°å½•è°ƒç”¨æ ˆä¿¡æ¯ï¼Œå› å…¶äº§ç”Ÿçš„æ€§èƒ½è†¨èƒ€æ›´ä½ã€‚</p></li>
<li><p>stack: æ˜¯å¦è®°å½•ç®—å­è°ƒç”¨æ ˆä¿¡æ¯ã€‚</p></li>
</ul>
</li>
<li><p>analysis: å¯ç”¨è‡ªåŠ¨æ•°æ®è§£æã€‚</p></li>
<li><p>discrete: ä½¿ç”¨ç¦»æ•£æ¨¡å¼ã€‚</p></li>
</ul>
</section>
</section>
<section id="id3">
<h2>ç¤ºä¾‹<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h2>
<section id="id4">
<h3>ç¦ç”¨é‡‡é›†<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">global_profiler</span><span class="p">:</span>
<span class="w">   </span><span class="nt">steps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"> </span><span class="c1"># disable profile</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>ç«¯åˆ°ç«¯é‡‡é›†<a class="headerlink" href="#id5" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">global_profiler</span><span class="p">:</span>
<span class="w">   </span><span class="nt">steps</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">]</span>
<span class="w">   </span><span class="nt">save_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./outputs/profile</span>
<span class="nt">actor_rollout_ref</span><span class="p">:</span>
<span class="w">   </span><span class="nt">actor</span><span class="p">:</span><span class="w">  </span><span class="c1"># è®¾ç½® actor role çš„ profiler é‡‡é›†é…ç½®å‚æ•°</span>
<span class="w">      </span><span class="nt">profiler</span><span class="p">:</span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="w">         </span><span class="nt">all_ranks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="w">         </span><span class="nt">tool_config</span><span class="p">:</span>
<span class="w">            </span><span class="nt">npu</span><span class="p">:</span>
<span class="w">               </span><span class="nt">discrete</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="w">               </span><span class="nt">contents</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">npu</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">cpu</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># æ§åˆ¶é‡‡é›†åˆ—è¡¨ï¼Œé»˜è®¤cpuã€npuï¼Œå¯é…ç½®memoryã€shapesã€moduleç­‰</span>

<span class="w">  </span><span class="c1"># rollout &amp; ref follow actor settings</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3>ç¦»æ•£æ¨¡å¼é‡‡é›†<a class="headerlink" href="#id6" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">global_profiler</span><span class="p">:</span>
<span class="w">   </span><span class="nt">steps</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5</span><span class="p p-Indicator">]</span>
<span class="w">   </span><span class="nt">save_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./outputs/profile</span>
<span class="nt">actor_rollout_ref</span><span class="p">:</span>
<span class="w">   </span><span class="nt">actor</span><span class="p">:</span>
<span class="w">      </span><span class="nt">profiler</span><span class="p">:</span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">  </span><span class="c1"># è®¾ç½®ä¸º True ä»¥é‡‡é›†è®­ç»ƒé˜¶æ®µ</span>
<span class="w">         </span><span class="nt">all_ranks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="w">         </span><span class="nt">ranks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># å…¨å±€ Rank 0</span>
<span class="w">         </span><span class="nt">tool_config</span><span class="p">:</span>
<span class="w">            </span><span class="nt">npu</span><span class="p">:</span>
<span class="w">               </span><span class="nt">discrete</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="w">               </span><span class="nt">contents</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">npu</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">cpu</span><span class="p p-Indicator">]</span>
<span class="w">   </span><span class="nt">rollout</span><span class="p">:</span>
<span class="w">      </span><span class="nt">profiler</span><span class="p">:</span>
<span class="w">         </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">  </span><span class="c1"># è®¾ç½®ä¸º True ä»¥é‡‡é›†æ¨ç†é˜¶æ®µ</span>
<span class="w">         </span><span class="nt">all_ranks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<span class="w">         </span><span class="nt">ranks</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># åœ¨ Agent Loop æ¨¡å¼ä¸‹ï¼Œæ­¤å¤„æŒ‡æ¨ç†å®ä¾‹çš„ Replica Rank (ä¾‹å¦‚ç¬¬ 0 ä¸ªå®ä¾‹)</span>
<span class="w">         </span><span class="nt">tool_config</span><span class="p">:</span>
<span class="w">            </span><span class="nt">npu</span><span class="p">:</span>
<span class="w">               </span><span class="nt">discrete</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w">  </span><span class="c1"># Agent Loop æ¨¡å¼ä¸‹å¿…é¡»å¼€å¯ç¦»æ•£æ¨¡å¼</span>
<span class="w">   </span><span class="c1"># ref follow actor settings</span>
</pre></div>
</div>
<p><strong>Agent Loop æ¨¡å¼è¯´æ˜</strong>ï¼š</p>
<p>åœ¨ <a class="reference external" href="../advance/agent_loop.rst">Agent Loop</a> æ¨¡å¼ä¸‹ï¼ŒRollout é˜¶æ®µçš„æ€§èƒ½æ•°æ® <strong>å¿…é¡»ä½¿ç”¨ç¦»æ•£æ¨¡å¼</strong> é‡‡é›†ï¼Œæ­¤æ—¶ Profiler ç”±æ¨ç†å¼•æ“åç«¯è§¦å‘ã€‚</p>
<ol class="arabic simple">
<li><p>Rank å®šä¹‰ï¼šRollout é…ç½®ä¸­çš„ ranks æŒ‡ä»£ Replica Rankï¼ˆæ¨ç†å®ä¾‹ç´¢å¼•ï¼‰ï¼Œè€Œéå…¨å±€ Rankã€‚</p></li>
<li><p>æ¨ç†å¼•æ“æ”¯æŒï¼šå½“å‰æ”¯æŒvLLMå’ŒSGLangå¼•æ“ï¼Œæ— éœ€é¢å¤–è®¾ç½®ã€‚å…·ä½“è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul class="simple">
<li><p>vLLM å¼•æ“ï¼šè‡ªåŠ¨é‡‡é›† AsyncLLM è°ƒåº¦æ ˆåŠæ¨ç†è¿›ç¨‹æ€§èƒ½æ•°æ®ã€‚ä¸æ”¯æŒè®¾ç½® analysisï¼ˆé»˜è®¤ä¸è§£æï¼Œéœ€ç¦»çº¿è§£æï¼‰å’Œ profiler_levelï¼ˆé»˜è®¤ level1ï¼‰ã€‚</p></li>
<li><p>SGLang å¼•æ“ï¼šè‡ªåŠ¨é‡‡é›†æ¨ç†è¿›ç¨‹æ€§èƒ½æ•°æ®ã€‚ä¸æ”¯æŒ contents ä¸­çš„ memory é…ç½®é¡¹ã€‚ä¸æ”¯æŒè®¾ç½® analysisï¼ˆé»˜è®¤è§£æï¼‰å’Œ profiler_levelï¼ˆé»˜è®¤ level0ï¼‰ã€‚</p></li>
</ul>
</li>
</ol>
</section>
</section>
<section id="id7">
<h2>å¯è§†åŒ–<a class="headerlink" href="#id7" title="Link to this heading">ïƒ</a></h2>
<p>é‡‡é›†åçš„æ•°æ®å­˜æ”¾åœ¨ç”¨æˆ·è®¾ç½®çš„save_pathä¸‹ï¼Œå¯é€šè¿‡ <a class="reference external" href="https://www.hiascend.com/document/detail/zh/mindstudio/80RC1/GUI_baseddevelopmenttool/msascendinsightug/Insight_userguide_0002.html">MindStudio Insight</a> å·¥å…·è¿›è¡Œå¯è§†åŒ–ã€‚</p>
<p>å¦å¤–åœ¨Linuxç¯å¢ƒä¸‹ï¼ŒMindStudio Insightå·¥å…·æä¾›äº† <a class="reference external" href="https://www.hiascend.com/document/detail/zh/mindstudio/82RC1/GUI_baseddevelopmenttool/msascendinsightug/Insight_userguide_0130.html">JupyterLabæ’ä»¶</a> å½¢æ€ï¼Œæä¾›æ›´ç›´è§‚å’Œäº¤äº’å¼å¼ºçš„æ“ä½œç•Œé¢ã€‚JupyterLabæ’ä»¶ä¼˜åŠ¿å¦‚ä¸‹ï¼š</p>
<ul class="simple">
<li><p>æ— ç¼é›†æˆï¼šæ”¯æŒåœ¨Jupyterç¯å¢ƒä¸­ç›´æ¥è¿è¡ŒMindStudio Insightå·¥å…·ï¼Œæ— éœ€åˆ‡æ¢å¹³å°ï¼Œæ— éœ€æ‹·è´æœåŠ¡å™¨ä¸Šçš„æ•°æ®ï¼Œå®ç°æ•°æ®å³é‡‡å³ç”¨ã€‚</p></li>
<li><p>å¿«é€Ÿå¯åŠ¨ï¼šé€šè¿‡JupyterLabçš„å‘½ä»¤è¡Œæˆ–å›¾å½¢ç•Œé¢ï¼Œå¯å¿«é€Ÿå¯åŠ¨MindStudio Insightå·¥å…·ã€‚</p></li>
<li><p>è¿è¡Œæµç•…ï¼šåœ¨Linuxç¯å¢ƒä¸‹ï¼Œé€šè¿‡JupyterLabç¯å¢ƒå¯åŠ¨MindStudio Insightï¼Œç›¸è¾ƒäºæ•´åŒ…é€šä¿¡ï¼Œæœ‰æ•ˆè§£å†³äº†è¿è¡Œå¡é¡¿é—®é¢˜ï¼Œæ“ä½œä½“éªŒæ˜¾è‘—æå‡ã€‚</p></li>
<li><p>è¿œç¨‹è®¿é—®ï¼šæ”¯æŒè¿œç¨‹å¯åŠ¨MindStudio Insightï¼Œå¯é€šè¿‡æœ¬åœ°æµè§ˆå™¨è¿œç¨‹è¿æ¥æœåŠ¡ç›´æ¥è¿›è¡Œå¯è§†åŒ–åˆ†æï¼Œç¼“è§£äº†å¤§æ¨¡å‹è®­ç»ƒæˆ–æ¨ç†æ•°æ®ä¸Šä¼ å’Œä¸‹è½½çš„å›°éš¾ã€‚</p></li>
</ul>
<p>å¦‚æœanalysiså‚æ•°è®¾ç½®ä¸ºFalseï¼Œé‡‡é›†ä¹‹åéœ€è¦è¿›è¡Œç¦»çº¿è§£æï¼š</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch_npu</span>
<span class="c1"># profiler_pathè¯·è®¾ç½®ä¸º&quot;localhost.localdomain_&lt;PID&gt;_&lt;timestamp&gt;_ascend_pt&quot;ç›®å½•çš„ä¸Šä¸€çº§ç›®å½•</span>
<span class="n">torch_npu</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">analyse</span><span class="p">(</span><span class="n">profiler_path</span><span class="o">=</span><span class="n">profiler_path</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id8">
<h2>è¿›é˜¶æŒ‡å—ï¼šç²¾ç»†åŒ–é‡‡é›†<a class="headerlink" href="#id8" title="Link to this heading">ïƒ</a></h2>
<section id="id9">
<h3>èƒŒæ™¯ä¸æŒ‘æˆ˜<a class="headerlink" href="#id9" title="Link to this heading">ïƒ</a></h3>
<p>ä¸Šè¿°åŸºäºé…ç½®æ–‡ä»¶çš„é‡‡é›†æ–¹å¼è™½ç„¶ä¾¿æ·ï¼Œä½†åœ¨ <strong>é•¿åºåˆ— (Long Context)</strong> æˆ– <strong>å¤§å…¨å±€æ‰¹é‡ (Large Global Batch Size)</strong> çš„è®­ç»ƒåœºæ™¯ä¸­é¢ä¸´æŒ‘æˆ˜ã€‚
åœ¨ä¸€ä¸ªå®Œæ•´çš„è®­ç»ƒæ­¥ (Step) å†…ï¼Œæ¨¡å‹è®¡ç®—å‘ˆç°å‡ºé«˜é¢‘æ¬¡ã€é‡å¤æ€§çš„ç‰¹å¾ï¼š</p>
<ol class="arabic simple">
<li><p>Rollout é˜¶æ®µï¼šåºåˆ—ç”Ÿæˆ (Generate Sequence) æ˜¯ä¸€ä¸ªè‡ªå›å½’è¿‡ç¨‹ï¼Œæ¶‰åŠæˆåƒä¸Šä¸‡æ¬¡ Decoder æ¨¡å‹çš„å‰å‘è®¡ç®—ã€‚</p></li>
<li><p>Training é˜¶æ®µï¼šä¸ºäº†æ§åˆ¶æ˜¾å­˜å³°å€¼ï¼Œverl é€šå¸¸é‡‡ç”¨ Micro-Batch ç­–ç•¥ï¼Œå°†åºå¤§çš„æ•°æ®æµåˆ‡åˆ†ä¸ºå¤šä¸ªå¾®æ‰¹æ¬¡è¿›è¡Œè®¡ç®—ã€‚</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>compute_log_prob (Actor/Ref)ï¼šæ¶‰åŠå¤šè½®çº¯å‰å‘ä¼ æ’­ã€‚</p></li>
<li><p>update_policy (Actor/Critic)ï¼šæ¶‰åŠå¤šè½®å‰å‘ä¸åå‘ä¼ æ’­ã€‚</p></li>
</ul>
</div></blockquote>
<p>è¿™ç§ç‰¹æ€§ä¼šå¯¼è‡´å…¨é‡ Profiling äº§ç”Ÿæµ·é‡ä¸”é‡å¤çš„ç®—å­è®°å½•ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img alt="https://raw.githubusercontent.com/mengchengTang/verl-data/master/verl_ascend_profiler.png" src="https://raw.githubusercontent.com/mengchengTang/verl-data/master/verl_ascend_profiler.png" />
<p>å³ä½¿ä½¿ç”¨äº† <code class="docutils literal notranslate"><span class="pre">discrete</span></code> æ¨¡å¼ï¼Œå•ä¸ªé˜¶æ®µçš„æ€§èƒ½æ•°æ®æ–‡ä»¶ä»å¯èƒ½è¾¾åˆ°æ•° TBï¼Œå¯¼è‡´ <strong>è§£æå¤±è´¥</strong> æˆ– <strong>å¯è§†åŒ–å·¥å…·å¡é¡¿</strong> ã€‚</p>
</section>
<section id="id10">
<h3>è§£å†³æ–¹æ¡ˆï¼šå…³é”®è·¯å¾„é‡‡æ ·<a class="headerlink" href="#id10" title="Link to this heading">ïƒ</a></h3>
<p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ <strong>å…³é”®è·¯å¾„é‡‡æ ·</strong> ç­–ç•¥ï¼šåŸºäº <a class="reference external" href="https://www.hiascend.com/document/detail/zh/canncommercial/80RC2/devaids/auxiliarydevtool/atlasprofiling_16_0038.html">torch_npu.profiler</a> æä¾›çš„APIæ¥å£ï¼Œç›´æ¥ä¿®æ”¹ Python æºç ï¼Œä»…é‡‡é›†å…·æœ‰ä»£è¡¨æ€§çš„æ•°æ®ç‰‡æ®µï¼ˆå¦‚ç‰¹å®š Decode Step æˆ–é¦–ä¸ª Micro-Batchï¼‰ã€‚</p>
<blockquote>
<div><p><strong>é‡è¦æç¤º</strong></p>
<ol class="arabic simple">
<li><p>æœ¬ç« èŠ‚æ¶‰åŠç›´æ¥ä¿®æ”¹æºç ã€‚å»ºè®®ä¿®æ”¹å‰å¤‡ä»½æ–‡ä»¶ï¼Œè°ƒè¯•å®Œæˆåæ¢å¤ã€‚</p></li>
<li><p>ä½¿ç”¨ä»£ç æ’æ¡©é‡‡é›†æ—¶ï¼Œè¯·åŠ¡å¿…åœ¨ <code class="docutils literal notranslate"><span class="pre">ppo_trainer.yaml</span></code> æˆ– <code class="docutils literal notranslate"><span class="pre">ppo_megatron_trainer.yaml</span></code> ä¸­**ç¦ç”¨å…¨å±€é‡‡é›†** (<code class="docutils literal notranslate"><span class="pre">global_profiler:</span> <span class="pre">steps:</span> <span class="pre">null</span></code>)ï¼Œä»¥é¿å… Profiler å†²çªã€‚</p></li>
</ol>
</div></blockquote>
</section>
<section id="rollout">
<h3>1. Rollout é˜¶æ®µç²¾ç»†åŒ–é‡‡é›†<a class="headerlink" href="#rollout" title="Link to this heading">ïƒ</a></h3>
<p>å¯¹äº vLLM æˆ– SGLang æ¨ç†å¼•æ“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶ <code class="docutils literal notranslate"><span class="pre">schedule</span></code> å‚æ•°æ¥æ§åˆ¶é‡‡é›†æ¨¡å‹åœ¨ç‰¹å®štokençš„å‰å‘ä¼ æ’­æ€§èƒ½æ•°æ®ã€‚</p>
<p><strong>vLLM å¼•æ“</strong></p>
<ul class="simple">
<li><p><strong>å‚è€ƒç‰ˆæœ¬</strong>ï¼švLLM v0.11.0, vLLM-Ascend v0.11.0rc1</p></li>
<li><p><strong>ä¿®æ”¹æ–‡ä»¶</strong>ï¼š<code class="docutils literal notranslate"><span class="pre">vllm-ascend/vllm_ascend/worker/worker_v1.py</span></code></p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>   class NPUWorker(WorkerBase):

<span class="w"> </span>       def __init__(self, *args, **kwargs):
<span class="w"> </span>           # ... existing code ...

<span class="gi">+           # Initialize profiler</span>
<span class="gi">+           import torch_npu</span>
<span class="gi">+           experimental_config = torch_npu.profiler._ExperimentalConfig(</span>
<span class="gi">+               profiler_level=torch_npu.profiler.ProfilerLevel.Level1,</span>
<span class="gi">+               export_type=torch_npu.profiler.ExportType.Db,  # å¯é€‰æ‹©torch_npu.profiler.ExportType.Textæ ¼å¼</span>
<span class="gi">+           )</span>
<span class="gi">+           self.profiler_npu = torch_npu.profiler.profile(</span>
<span class="gi">+               activities=[torch_npu.profiler.ProfilerActivity.CPU, torch_npu.profiler.ProfilerActivity.NPU],</span>
<span class="gi">+               with_modules=False,  # é‡‡é›†è°ƒç”¨æ ˆ</span>
<span class="gi">+               profile_memory=False,  # é‡‡é›†å†…å­˜</span>
<span class="gi">+               experimental_config=experimental_config,</span>
<span class="gi">+               # è·³è¿‡ç¬¬ä¸€æ­¥ï¼Œwarmupä¸€æ­¥ï¼Œé‡‡é›†3æ­¥ï¼Œé‡å¤1æ¬¡ã€‚å¦‚æœæƒ³é‡‡é›†ç¬¬30~70ä¸ªdecode stepï¼Œå¯ä»¥è®¾ç½®ä¸ºschedule=torch_npu.profiler.schedule(wait=29, warmup=1, active=30, repeat=1)</span>
<span class="gi">+               schedule=torch_npu.profiler.schedule(wait=1, warmup=1, active=3, repeat=1),</span>
<span class="gi">+               on_trace_ready=torch_npu.profiler.tensorboard_trace_handler(&quot;./outputs/vllm_profile&quot;, analyse_flag=True)  # é‡‡é›†æ•°æ®ä¿å­˜è·¯å¾„ï¼Œæ˜¯å¦åœ¨çº¿è§£æ</span>
<span class="gi">+           )</span>
<span class="gi">+           self.profiler_npu.start()</span>

<span class="w"> </span>           # ... existing code ...

<span class="w"> </span>       def execute_model(self, scheduler_output=None, intermediate_tensors=None, **kwargs):
<span class="w"> </span>           # ... existing code ...
<span class="w"> </span>           output = self.model_runner.execute_model(scheduler_output,
<span class="w"> </span>                                               intermediate_tensors)

<span class="gi">+           self.profiler_npu.step()  # é©±åŠ¨ scheduleï¼Œå¯¹éƒ¨åˆ†decode stepè¿›è¡Œé‡‡é›†</span>

<span class="w"> </span>           # ... existing code ...
</pre></div>
</div>
<p><strong>SGLang å¼•æ“</strong></p>
<ul class="simple">
<li><p><strong>å‚è€ƒç‰ˆæœ¬</strong>ï¼šSGLang master åˆ†æ”¯</p></li>
<li><p><strong>ä¿®æ”¹æ–‡ä»¶</strong>ï¼š<code class="docutils literal notranslate"><span class="pre">sglang/python/sglang/srt/model_executor/model_runner.py</span></code></p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>   # ... existing imports ...
<span class="gi">+   import torch_npu</span>

<span class="w"> </span>   class ModelRunner:

<span class="w"> </span>       def __init__(self, *args, **kwargs):
<span class="w"> </span>           # ... existing init code ...

<span class="gi">+           # Initialize profiler (é…ç½®åŒä¸Šï¼Œç•¥)</span>
<span class="gi">+           experimental_config = torch_npu.profiler._ExperimentalConfig(...)</span>
<span class="gi">+           self.profiler_npu = torch_npu.profiler.profile(</span>
<span class="gi">+               # ...</span>
<span class="gi">+               # è·³è¿‡ç¬¬ä¸€æ­¥ï¼Œwarmupä¸€æ­¥ï¼Œé‡‡é›†3æ­¥ï¼Œé‡å¤1æ¬¡ã€‚</span>
<span class="gi">+               schedule=torch_npu.profiler.schedule(wait=1, warmup=1, active=3, repeat=1),</span>
<span class="gi">+               on_trace_ready=torch_npu.profiler.tensorboard_trace_handler(&quot;./outputs/sglang_profile&quot;, analyse_flag=True)</span>
<span class="gi">+           )</span>
<span class="gi">+           self.profiler_npu.start()</span>

<span class="w"> </span>       def forward(self, forward_batch, **kwargs):
<span class="w"> </span>           # ... existing code ...

<span class="gi">+           self.profiler_npu.step()  # é©±åŠ¨ scheduleï¼Œå¯¹éƒ¨åˆ†decode stepè¿›è¡Œé‡‡é›†</span>
<span class="w"> </span>           return output
</pre></div>
</div>
</section>
<section id="compute-log-prob-actor-ref">
<h3>2. compute_log_prob (Actor &amp; Ref) é˜¶æ®µç²¾ç»†åŒ–é‡‡é›†<a class="headerlink" href="#compute-log-prob-actor-ref" title="Link to this heading">ïƒ</a></h3>
<p>è¯¥é˜¶æ®µè®¡ç®—æ–°æ—§ç­–ç•¥çš„æ¦‚ç‡åˆ†å¸ƒã€‚</p>
<p><strong>FSDP åç«¯</strong></p>
<p>FSDP åç«¯å…è®¸åœ¨ Micro-Batch çº§åˆ«è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚</p>
<ul class="simple">
<li><p><strong>ä¿®æ”¹æ–‡ä»¶</strong>ï¼š<code class="docutils literal notranslate"><span class="pre">verl/workers/actor/dp_actor.py</span></code></p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>   # ... å¼•å…¥ä¾èµ– ...
<span class="gi">+   import torch_npu</span>

<span class="w"> </span>   class DataParallelPPOActor(BasePPOActor):

<span class="w"> </span>       def compute_log_prob(self, data: DataProto, calculate_entropy=False) -&gt; torch.Tensor:

<span class="gi">+           role = &quot;Ref&quot; if self.actor_optimizer is None else &quot;Actor&quot;</span>
<span class="gi">+           # å‡†å¤‡ profiler (é…ç½®åŒä¸Šï¼Œç•¥)</span>
<span class="gi">+           experimental_config = torch_npu.profiler._ExperimentalConfig(...)</span>
<span class="gi">+           self.prof_npu = torch_npu.profiler.profile(</span>
<span class="gi">+               # ...</span>
<span class="gi">+               # wait=0, warmup=0, active=1: ç›´æ¥é‡‡é›†ç¬¬ä¸€ä¸ª micro-batch</span>
<span class="gi">+               schedule=torch_npu.profiler.schedule(wait=0, warmup=0, active=1, repeat=1),</span>
<span class="gi">+               on_trace_ready=torch_npu.profiler.tensorboard_trace_handler(f&quot;./outputs/{role}_compute_log_prob&quot;, analyse_flag=True)</span>
<span class="gi">+           )</span>


<span class="gi">+           # æ­¤å‡½æ•°refå’Œactorå…±ç”¨ï¼Œè®¾ç½®roleæ ‡å¿—ä½æ¥åŒºåˆ†ã€‚å¦‚æœæƒ³é‡‡é›†actor_compute_log_probï¼Œå¯è®¾ç½®if role==&quot;Actor&quot;:</span>
<span class="gi">+           if role==&quot;Ref&quot;:</span>
<span class="gi">+               self.prof_npu.start()</span>

<span class="w"> </span>           for micro_batch in micro_batches:

<span class="w"> </span>               # ... åŸå§‹è®¡ç®—é€»è¾‘ ...
<span class="w"> </span>               with torch.no_grad():
<span class="w"> </span>                   entropy, log_probs = self._forward_micro_batch(...)

<span class="gi">+                   # é©±åŠ¨ scheduleï¼Œå¯¹micro batchè¿›è¡Œé‡‡é›†</span>
<span class="gi">+                   if role==&quot;Ref&quot;:</span>
<span class="gi">+                       self.prof_npu.step()</span>

<span class="w"> </span>               # ...
</pre></div>
</div>
<p><strong>Megatron åç«¯</strong></p>
<p>Megatron åç«¯çš„ Micro-Batch è°ƒåº¦ç”±æ¡†æ¶å†…éƒ¨ç®¡ç†ï¼Œæš‚ä¸æ”¯æŒé€šè¿‡ç®€å•çš„ä»£ç æ’æ¡©è¿›è¡Œ Micro-Batch çº§åˆ«çš„ç²¾ç»†åŒ–é‡‡é›†ã€‚å»ºè®®ä½¿ç”¨å…¨å±€é…ç½®è¿›è¡Œé‡‡é›†ã€‚</p>
</section>
<section id="update-policy-actor-critic">
<h3>3. update_policy (Actor &amp; Critic) é˜¶æ®µç²¾ç»†åŒ–é‡‡é›†<a class="headerlink" href="#update-policy-actor-critic" title="Link to this heading">ïƒ</a></h3>
<p>Update é˜¶æ®µåŒ…å«å‰å‘å’Œåå‘ä¼ æ’­ã€‚</p>
<p><strong>FSDP åç«¯</strong></p>
<p>FSDP åç«¯æ”¯æŒè®¾ç½®å¯¹ Mini-Batch å’Œ Micro-Batch çš„ç²’åº¦è¿›è¡Œé‡‡é›†ã€‚</p>
<ul class="simple">
<li><p><strong>ä¿®æ”¹æ–‡ä»¶</strong>ï¼š<code class="docutils literal notranslate"><span class="pre">verl/workers/actor/dp_actor.py</span></code></p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>   # ... å¼•å…¥ä¾èµ– ...
<span class="gi">+   import torch_npu</span>

<span class="w"> </span>   class DataParallelPPOActor(BasePPOActor):

<span class="w"> </span>       def update_policy(self, data: DataProto):

<span class="gi">+           # å‡†å¤‡ profiler (é…ç½®åŒä¸Šï¼Œç•¥)</span>
<span class="gi">+           experimental_config = torch_npu.profiler._ExperimentalConfig(...)</span>
<span class="gi">+           self.prof_npu = torch_npu.profiler.profile(</span>
<span class="gi">+               # ...</span>
<span class="gi">+               # ä»…é‡‡é›†ç¬¬ä¸€ä¸ª Mini Batchï¼ˆåŒ…å«æ‰€æœ‰ Micro-Batch çš„è®¡ç®—å’Œä¸€æ¬¡ä¼˜åŒ–å™¨æ›´æ–°ï¼‰</span>
<span class="gi">+               schedule=torch_npu.profiler.schedule(wait=0, warmup=0, active=1, repeat=1),</span>
<span class="gi">+               on_trace_ready=torch_npu.profiler.tensorboard_trace_handler(&quot;./outputs/fsdp_actor_update_profile&quot;, analyse_flag=True)</span>
<span class="gi">+           )</span>
<span class="gi">+           self.prof_npu.start()</span>

<span class="w"> </span>           # ... PPO Epochs å¾ªç¯ ...
<span class="w"> </span>           for _ in range(self.config.ppo_epochs):
<span class="w"> </span>               # ... Mini Batch å¾ªç¯ ...
<span class="w"> </span>               for batch_idx, mini_batch in enumerate(mini_batches):
<span class="w"> </span>                   # ... mini_batches åˆ‡åˆ† ...

<span class="w"> </span>                   for i, micro_batch in enumerate(micro_batches):
<span class="w"> </span>                       # ... åŸå§‹ Forward &amp; Backward é€»è¾‘ ...
<span class="w"> </span>                       # ... loss.backward() ...
<span class="w"> </span>                       pass

<span class="w"> </span>                   grad_norm = self._optimizer_step()

<span class="gi">+                   # é©±åŠ¨ scheduleï¼Œå¯¹mini batchè¿›è¡Œé‡‡é›†ï¼Œå¦‚æœæƒ³å¯¹micro batchè¿›è¡Œï¼Œåˆ™å°†self.prof_npu.step()ç§»åŠ¨åˆ°micro_batchçš„å¾ªç¯å†…</span>
<span class="gi">+                   self.prof_npu.step()</span>
</pre></div>
</div>
<p><strong>Megatron åç«¯</strong></p>
<p>Megatron åç«¯æ”¯æŒä»¥ Mini-Batch çš„ç²’åº¦è¿›è¡Œé‡‡é›†ã€‚</p>
<ul class="simple">
<li><p><strong>ä¿®æ”¹æ–‡ä»¶</strong>ï¼š<code class="docutils literal notranslate"><span class="pre">verl/workers/actor/megatron_actor.py</span></code></p></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>   class MegatronPPOActor(BasePPOActor):

<span class="w"> </span>       def update_policy(self, dataloader: Iterable[DataProto]) -&gt; dict:
<span class="w"> </span>           # ...
<span class="gi">+           # å‡†å¤‡ profiler (é…ç½®åŒä¸Šï¼Œç•¥)</span>
<span class="gi">+           experimental_config = torch_npu.profiler._ExperimentalConfig(...)</span>
<span class="gi">+           self.prof_npu = torch_npu.profiler.profile(</span>
<span class="gi">+               # ...</span>
<span class="gi">+               # ä»…é‡‡é›†ç¬¬ä¸€ä¸ª Mini Batch çš„è®¡ç®—ï¼ˆå«æ‰€æœ‰ Micro-Batchï¼‰å’Œä¸€æ¬¡ä¼˜åŒ–å™¨æ›´æ–°</span>
<span class="gi">+               schedule=torch_npu.profiler.schedule(wait=0, warmup=0, active=1, repeat=1),</span>
<span class="gi">+               on_trace_ready=torch_npu.profiler.tensorboard_trace_handler(&quot;./outputs/megatron_actor_update_profile&quot;, analyse_flag=True)</span>
<span class="gi">+           )</span>
<span class="gi">+           self.prof_npu.start()</span>

<span class="w"> </span>           for data in dataloader:
<span class="w"> </span>               # ... å†…éƒ¨ä¼šè°ƒç”¨ self.forward_backward_batch è¿›è¡Œè®¡ç®— ...
<span class="w"> </span>               # ... metric_micro_batch = self.forward_backward_batch(...)

<span class="w"> </span>               # ... self.actor_optimizer.step() ...

<span class="gi">+               # é©±åŠ¨ scheduleï¼Œå¯¹mini batchè¿›è¡Œé‡‡é›†</span>
<span class="gi">+               self.prof_npu.step()</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="é¡µè„š">
        <a href="ascend_profiling_en.html" class="btn btn-neutral float-left" title="Performance data collection based on FSDP or MindSpeed(Megatron) on Ascend devices(en)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> ä¸Šä¸€é¡µ</a>
        <a href="ascend_consistency.html" class="btn btn-neutral float-right" title="Align the Inference results of the verl and vLLM frameworks on Ascend devices(zh)" accesskey="n" rel="next">ä¸‹ä¸€é¡µ <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>