

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DAPO multi model optimization practice &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">DAPO multi model optimization practice</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/sources/_generated/sources/verl/examples/dapo_multi_model_optimization_practice.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dapo-multi-model-optimization-practice">
<h1>DAPO multi model optimization practice<a class="headerlink" href="#dapo-multi-model-optimization-practice" title="Link to this heading">ïƒ</a></h1>
<section id="dapo">
<h2>DAPO ä»‹ç»<a class="headerlink" href="#dapo" title="Link to this heading">ïƒ</a></h2>
<p>Last updated: 01/27/2026.</p>
<p>DAPOçš„è®ºæ–‡å¯ä»¥å‚è€ƒï¼š<a class="reference external" href="https://arxiv.org/pdf/2503.14476">DAPO</a>ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹å‡ ä¸ªå…³é”®æŠ€æœ¯ã€‚</p>
<ul class="simple">
<li><p>â€‹<strong>Clip-Higher</strong>â€‹: é€šè¿‡å¯¹é‡è¦æ€§é‡‡æ ·æ¯”çš„ä¸Šé™å‰ªè£ä¿ƒè¿›äº†ç³»ç»Ÿçš„å¤šæ ·æ€§å¹¶é¿å…äº†ç†µåç¼©ï¼ˆEntropy Collapseï¼‰ã€‚</p></li>
<li><p>â€‹<strong>Dynamic Sampling</strong>â€‹: æé«˜äº†è®­ç»ƒæ•ˆç‡å’Œç¨³å®šæ€§ã€‚DAPOå‡ºäº†ä¸€ç§æ‰§è¡ŒåŠ¨æ€é‡‡æ ·çš„ç­–ç•¥ï¼Œå¹¶è¿‡æ»¤æ‰å‡†ç¡®ç‡ç­‰äº1å’Œ0çš„æç¤ºç»„ï¼Œä»è€Œä¿æŒæ‰¹æ¬¡é—´å…·æœ‰æœ‰æ•ˆæ¢¯åº¦çš„æç¤ºæ•°é‡ä¸€è‡´ã€‚</p></li>
<li><p>â€‹<strong>Token-level Policy Gradient Loss</strong>â€‹: åœ¨é•¿é“¾æ€ç»´å¼ºåŒ–å­¦ä¹  (long-CoT RL) åœºæ™¯ä¸­è‡³å…³é‡è¦ã€‚</p></li>
<li><p>â€‹<strong>Overlong Reward Shaping</strong>â€‹: å‡å°‘å¥–åŠ±å™ªå£°å¹¶ç¨³å®šäº†è®­ç»ƒã€‚</p></li>
</ul>
<p>åœ¨verlä¸­ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹è®¾ç½®ï¼Œä»è€Œè¿›è¡ŒDAPOç®—æ³•çš„è¿è¡Œã€‚</p>
<ul class="simple">
<li><p><strong>å¥–åŠ±æ¨¡å‹çš„ç®¡ç†ç­–ç•¥ä¸º DAPO</strong>
åœ¨dapoç®—æ³•ä¸­ï¼Œå¿…é¡»é…ç½®æˆdapoã€‚</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reward_model</span><span class="o">.</span><span class="n">reward_manager</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">dapo</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Clip-Higher æ›´é«˜è£å‰ª</strong>
<code class="docutils literal notranslate"><span class="pre">clip_ratio_low</span></code> å’Œ <code class="docutils literal notranslate"><span class="pre">clip_ratio_high</span></code> ç”¨äºæŒ‡å®š DAPO ç›®æ ‡å‡½æ•°ä¸­çš„ $\varepsilon_{\text {low }}$ å’Œ $\varepsilon_{\text {high }}$ã€‚</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">clip_ratio_low</span><span class="o">=</span><span class="mf">0.2</span>  <span class="c1"># è£å‰ªæ¯”ä¾‹ä¸‹é™ï¼Œé»˜è®¤å€¼ä¸º0.2</span>
<span class="n">clip_ratio_high</span><span class="o">=</span><span class="mf">0.28</span> <span class="c1"># è£å‰ªæ¯”ä¾‹ä¸Šé™ï¼Œé»˜è®¤å€¼ä¸º0.28</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>åŠ¨æ€é‡‡æ ·çš„ç›¸å…³é…ç½®</strong>
å°† <code class="docutils literal notranslate"><span class="pre">filter_groups.enable</span></code> è®¾ç½®ä¸º <code class="docutils literal notranslate"><span class="pre">True</span></code> ä¼šè¿‡æ»¤æ‰è¾“å‡º <code class="docutils literal notranslate"><span class="pre">metric</span></code> å®Œå…¨ç›¸åŒçš„ç»„ï¼Œä¾‹å¦‚å¯¹äº <code class="docutils literal notranslate"><span class="pre">acc</span></code> æŒ‡æ ‡ï¼Œè¿‡æ»¤æ‰è¾“å‡ºå‡†ç¡®ç‡å…¨éƒ¨ä¸º 1 æˆ– 0 çš„ç»„ã€‚
è®­ç»ƒå™¨ä¼šä½¿ç”¨ <code class="docutils literal notranslate"><span class="pre">gen_batch_size</span></code> è¿›è¡Œé‡å¤é‡‡æ ·ï¼Œç›´åˆ°ç”Ÿæˆè¶³å¤Ÿæ•°é‡çš„ç¬¦åˆæ¡ä»¶çš„ç»„ï¼Œæˆ–è€…è¾¾åˆ° <code class="docutils literal notranslate"><span class="pre">max_num_gen_batches</span></code> æ‰€æŒ‡å®šçš„ä¸Šé™ä¸ºæ­¢ã€‚</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>data.gen_batch_size=${gen_prompt_bsz}
algorithm.filter_groups.enable=${enable_filter_groups} # åŠ¨æ€é‡‡æ ·å¼€å…³
algorithm.filter_groups.metric=${filter_groups_metric} # ä½¿ç”¨å‡†ç¡®ç‡ä½œä¸ºè¿‡æ»¤æ ‡å‡†
algorithm.filter_groups.max_num_gen_batches=${max_num_gen_batches} # æœ€å¤§ç”Ÿæˆæ‰¹æ¬¡æ•°é‡,æœ€å¤šé‡å¤ç”Ÿæˆæ•°æ®çš„æ¬¡æ•°
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Token-level Loss</strong>
å°† <code class="docutils literal notranslate"><span class="pre">loss_agg_mode</span></code> è®¾ç½®ä¸º <code class="docutils literal notranslate"><span class="pre">token-mean</span></code> æ„å‘³ç€è®¡ç®—ä¸€ä¸ªæ‰¹æ¬¡ä¸­æ‰€æœ‰åºåˆ—å†…æ‰€æœ‰ token çš„ï¼ˆç­–ç•¥æ¢¯åº¦ï¼‰æŸå¤±çš„å¹³å‡å€¼ã€‚</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>actor_rollout_ref.actor.loss_agg_mode=${loss_agg_mode}
#æ³¨æ„ï¼šâ€œtoken-meanâ€æ˜¯é»˜è®¤è¡Œä¸ºã€‚
</pre></div>
</div>
<ul class="simple">
<li><p><strong>å¥–åŠ±æ¨¡å‹å¯¹è¶…é•¿å›ç­”çš„æƒ©ç½šé…ç½®</strong>
å°† <code class="docutils literal notranslate"><span class="pre">overlong_buffer.enable</span></code> è®¾ç½®ä¸º <code class="docutils literal notranslate"><span class="pre">True</span></code> å°†å¯¹è¾“å‡ºé•¿åº¦è¿‡é•¿ä½†ä»æœªè¶…è¿‡ç¡¬ä¸Šä¸‹æ–‡é™åˆ¶çš„è¾“å‡ºè¿›è¡Œæƒ©ç½šã€‚å…·ä½“æ¥è¯´ï¼Œå½“è¾“å‡ºçš„é•¿åº¦è¶…è¿‡ <code class="docutils literal notranslate"><span class="pre">max_response_length</span> <span class="pre">-</span> <span class="pre">overlong_buffer.len</span></code> ä¸”è¶…å‡º <code class="docutils literal notranslate"><span class="pre">0</span></code> åˆ° <code class="docutils literal notranslate"><span class="pre">overlong_buffer.len</span></code> ä¸ª token æ—¶ï¼Œæƒ©ç½šå€¼ä¼šä» <code class="docutils literal notranslate"><span class="pre">0</span></code> çº¿æ€§å¢åŠ åˆ° <code class="docutils literal notranslate"><span class="pre">overlong_buffer.penalty_factor</span></code>ã€‚</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>reward_model.overlong_buffer.enable=${enable_overlong_buffer} # å¯ç”¨è¶…é•¿ç¼“å†²åŒºæƒ©ç½š,å¼€å¯å¯¹è¶…é•¿è¾“å‡ºçš„æƒ©ç½šæœºåˆ¶
reward_model.overlong_buffer.len=${overlong_buffer_len}  # ç¼“å†²åŒºé•¿åº¦,å®šä¹‰ç¼“å†²åŒºçš„toke,æœ€å¤§æƒ©ç½šå¼ºåº¦
reward_model.overlong_buffer.penalty_factor=${overlong_penalty_factor}   #æƒ©ç½šå› å­,æœ€å¤§æƒ©ç½šå¼ºåº¦
</pre></div>
</div>
<p>ç›¸å…³å‚æ•°æ¶‰åŠçš„ä»£ç å¯ä»¥å‚è€ƒï¼š<a class="reference external" href="https://github.com/verl-project/verl-recipe/blob/main/dapo/README.md">Recipe: Decoupled Clip and Dynamic Sampling Policy Optimization (DAPO)</a></p>
</section>
<section id="id1">
<h2>ç¡¬ä»¶è¦æ±‚<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h2>
<p>å½“å‰æ”¯æŒAtlas 800T A3 ä¸ Atlas 900 A3 SuperPoDã€‚å®Œæˆè·‘å®Œæœ¬æ¬¡æœ€ä½³å®è·µéœ€è¦ 2å°Atlas 800T A3ã€‚å…³é”®è½¯ä»¶ç‰ˆæœ¬å¯ä»¥å‚è€ƒï¼š<a class="reference external" href="https://github.com/volcengine/verl/blob/main/docs/ascend_tutorial/ascend_quick_start.rst">Ascend Quickstart</a></p>
</section>
<section id="id2">
<h2>å®‰è£…åŸºç¡€ç¯å¢ƒ<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h2>
<table border="1" class="docutils">
<thead>
<tr>
<th>software</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Python</td>
<td>&gt;= 3.10, &lt;3.12</td>
</tr>
<tr>
<td>CANN</td>
<td>== 8.3.RC1</td>
</tr>
<tr>
<td>torch</td>
<td>== 2.7.1</td>
</tr>
<tr>
<td>torch_npu</td>
<td>== 2.7.1</td>
</tr>
<tr>
<td>verl</td>
<td>mainåˆ†æ”¯ commitId=252d76908b903ad8fb6969eb3a5e5f873c95ea2b</td>
</tr>
<tr>
<td>vllm</td>
<td>v0.11.0</td>
</tr>
<tr>
<td>vllm-ascend</td>
<td>v0.11.0-dev</td>
</tr>
<tr>
<td>transformers</td>
<td>4.57.3</td>
</tr>
</tbody>
</table><p>åœ¨æœ¬å®è·µä¸­, æˆ‘ä»¬é€šè¿‡æŒ‡å®š verl çš„commit id ä»¥é¿å…å¼•å…¥å…¶ä»–é—®é¢˜</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">verl</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="mi">252</span><span class="n">d76908b903ad8fb6969eb3a5e5f873c95ea2b</span>
<span class="c1"># æŒ‡å®šç›¸åº”çš„recipeç‰ˆæœ¬</span>
<span class="n">git</span> <span class="n">submodule</span> <span class="n">update</span> <span class="o">--</span><span class="n">init</span> <span class="o">--</span><span class="n">recursive</span> <span class="n">recipe</span>
</pre></div>
</div>
</section>
<section id="id3">
<h2>æ¨¡å‹è®­ç»ƒ<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h2>
<section id="id4">
<h3>æ•°æ®é›†å‡†å¤‡<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h3>
<p>Geometry3k æ•°æ®é›†æ˜¯ç”±åŠ åˆ©ç¦å°¼äºšå¤§å­¦æ´›æ‰çŸ¶åˆ†æ ¡ä¸æµ™æ±Ÿå¤§å­¦è”åˆç ”å‘çš„å‡ ä½•é¢†åŸŸä¸“ç”¨æ•°æ®é›†ï¼Œæ ¸å¿ƒé¢å‘è§†è§‰é—®ç­”ï¼ˆVQAï¼‰ä»»åŠ¡å±•å¼€ç ”ç©¶ä¸æ¨¡å‹è®­ç»ƒã€‚è¯¥æ•°æ®é›†æ€»è®¡åŒ…å« 3002 ä¸ªæ ·æœ¬ï¼Œé‡‡ç”¨å›¾åƒå’Œæ–‡æœ¬ä¸¤ç§æ¨¡æ€æ•°æ®å½¢å¼æ„å»ºï¼Œå…¶ä¸­æ–‡æœ¬æ¨¡æ€æ¶µç›–å„ç±»å‡ ä½•é—®é¢˜æè¿°ï¼Œå›¾åƒåˆ™ä»¥å¯è§†åŒ–å›¾è¡¨å‘ˆç°é—®é¢˜ä¸­çš„å‡ ä½•å›¾å½¢ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸‰è§’å½¢ã€åœ†å½¢ã€å››è¾¹å½¢ç­‰åŸºç¡€å‡ ä½•å½¢çŠ¶ï¼Œä»¥åŠä¸åŒå›¾å½¢é—´çš„ä½ç½®ã€åµŒå¥—ã€ç›¸äº¤ç­‰å…³è”å…³ç³»ã€‚å¯ä»¥ä»Hugging Faceåº“ä¸‹è½½å¯¹åº”çš„åŸå§‹æ•°æ®é›†ï¼š<a class="reference external" href="https://huggingface.co/datasets/hiyouga/geometry3k">Geometry3k </a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ä¸‹è½½åŸå§‹æ•°æ®å¹¶é¢„å¤„ç†</span>
<span class="n">python</span> <span class="o">./</span><span class="n">examples</span><span class="o">/</span><span class="n">data_preprocess</span><span class="o">/</span><span class="n">geo3k</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">local_dir</span><span class="o">=./</span><span class="n">data</span><span class="o">/</span><span class="n">geo3k</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>æƒé‡ä¸‹è½½<a class="headerlink" href="#id5" title="Link to this heading">ïƒ</a></h3>
<p>ä»Hugging Faceåº“ä¸‹è½½å¯¹åº”çš„æ¨¡å‹æƒé‡ï¼š<a class="reference external" href="https://huggingface.co/Qwen/Qwen3-VL-30B-A3B-Instruct/tree/main">Qwen3-VL-30B-A3B-Instruct</a></p>
</section>
<section id="id6">
<h3>å…¨å±€å˜é‡å¯¼å…¥<a class="headerlink" href="#id6" title="Link to this heading">ïƒ</a></h3>
<ul class="simple">
<li><p>ä¸ºäº†ç¡®ä¿ Ray è¿›ç¨‹èƒ½å¤Ÿæ­£å¸¸å›æ”¶å†…å­˜ï¼Œéœ€è¦å®‰è£…å¹¶ä½¿èƒ½ jemalloc åº“è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œç”¨äºæ›´å¥½ç®¡ç†å†…å­˜ï¼Œé¿å…é•¿è·‘è¿‡ç¨‹ä¸­å†…å­˜ OOMã€‚</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># æ ¹æ®å®é™…å®‰è£…è·¯å¾„è®¾ç½® jemalloc ç¯å¢ƒå˜é‡</span>
<span class="n">export</span> <span class="n">LD_PRELOAD</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libjemalloc</span><span class="o">.</span><span class="n">so</span><span class="mf">.2</span>
</pre></div>
</div>
<ul class="simple">
<li><p>æŸäº›æ¨¡å‹æ˜¯é€šè¿‡ vllm ascend è¿›è¡Œä¼˜åŒ–çš„ã€‚ä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¼˜åŒ–åçš„æ¨¡å‹å¯èƒ½å¹¶ä¸é€‚ç”¨ã€‚æ­¤æ—¶ï¼Œå°†æ­¤å€¼è®¾ç½®ä¸º 0 å³å¯ç¦ç”¨ä¼˜åŒ–åçš„æ¨¡å‹ã€‚</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">USE_OPTIMIZED_MODEL</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<ul class="simple">
<li><p>å¯ç”¨vLLM V1</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">VLLM_USE_V1</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<ul class="simple">
<li><p>æ˜‡è…¾å¤šå¡é€šä¿¡çš„å…œåº•é…ç½®ï¼Œå»¶é•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œé¿å…é›†ç¾¤ç¯å¢ƒä¸‹è®­ç»ƒå¯åŠ¨å› è¿æ¥æ…¢è€Œå¤±è´¥</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">HCCL_CONNECT_TIMEOUT</span><span class="o">=</span><span class="mi">5400</span>
</pre></div>
</div>
<ul class="simple">
<li><p>æ§åˆ¶ vLLM åœ¨æ˜‡è…¾èŠ¯ç‰‡ä¸Šæ˜¯å¦å¯ç”¨NZä¼˜åŒ–</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">VLLM_ASCEND_ENABLE_NZ</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="id7">
<h3>è®­ç»ƒ<a class="headerlink" href="#id7" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Model Weights Paths
MODEL_PATH=hf_weights/Qwen3-VL-30B-A3B-Instruct
RAY_DATA_HOME=${RAY_DATA_HOME:-&quot;${HOME}/verl&quot;}
CKPTS_DIR=${CKPTS_DIR:-&quot;${RAY_DATA_HOME}/ckpts/${project_name}/${exp_name}&quot;}

# File System Paths
TRAIN_FILE=$RAY_DATA_HOME/datasets/geo3k/train.parquet
TEST_FILE=$RAY_DATA_HOME/datasets/geo3k/test.parquet

#ä¿å­˜é¢‘ç‡ï¼Œ-1é»˜è®¤ä¸ä¿å­˜ï¼Œå¦‚éœ€è¯„æµ‹è¯·ä¿®æ”¹æ­¤å‚æ•°
trainer.save_freq=-1
</pre></div>
</div>
<p>å¯¹äºå•æœºä»»åŠ¡ Qwen3-VL-30B , ä¿®æ”¹è„šæœ¬ä¸­å‚æ•°<code class="docutils literal notranslate"><span class="pre">trainer.nnodes</span></code>ä¸º 1ï¼Œ <code class="docutils literal notranslate"><span class="pre">trainer.n_gpus_per_node</span></code> ä¸º16ï¼Œç„¶åç›´æ¥bashæ‰§è¡Œverlä»“ä¸Šç¤ºä¾‹è„šæœ¬</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">recipe</span><span class="o">/</span><span class="n">dapo</span><span class="o">/</span><span class="n">run</span> <span class="n">dapo_qwen3_vl_30b_fsdp2_npu</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>å¯¹äºå¤šèŠ‚ç‚¹ä»»åŠ¡ Qwen3-VL-30B ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ä»¥ä¸‹è„šæœ¬è¿›è¡Œå¤§è§„æ¨¡å¤šèŠ‚ç‚¹è®­ç»ƒæ‹‰èµ·</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pkill -9 python
ray stop --force
rm -rf /tmp/ray
export VLLM_USE_V1=1
export HCCL_CONNECT_TIMEOUT=5400
export VLLM_ASCEND_ENABLE_NZ=0
export LD_PRELOAD=/usr/local/lib/libjemalloc.so.2
# Some models are optimized by vllm ascend. While in some case, e.g. rlhf training, 
# the optimized model may not be suitable. In this case, set this value to 0 to disable the optimized model.
export USE_OPTIMIZED_MODEL=0

# ä¿®æ”¹ä¸ºå½“å‰éœ€è¦è·‘çš„ç”¨ä¾‹è·¯å¾„
DEFAULT_SH=&quot;./run_*.sh&quot;
echo &quot;Use $DEFAULT_SH&quot;

ulimit -n 32768
mkdir logs

NNODES=2
NPUS_PER_NODE=8
# ä¿®æ”¹ä¸ºå¯¹åº”ä¸»èŠ‚ç‚¹IP
MASTER_ADDR=&quot;IP FOR MASTER NODE&quot;
# ä¿®æ”¹ä¸ºå½“å‰èŠ‚ç‚¹çš„é€šä¿¡ç½‘å¡
SOCKET_IFNAME=&quot;Your SOCKET IFNAME&quot;
export HCCL_SOCKET_IFNAME=&quot;SOCKET IFNAME FOR CURRENT NODE&quot;
export GLOO_SOCKET_IFNAME=&quot;SOCKET IFNAME FOR CURRENT NODE&quot;
# è·å–å½“å‰IP
CURRENT_IP=$(ifconfig $SOCKET_IFNAME | grep -Eo &#39;inet (addr:)?([0-9]{1,3}\.){3}[0-9]{1,3}&#39; | awk &#39;{print $NF}&#39;)
if [ &quot;$MASTER_ADDR&quot; = &quot;$CURRENT_IP&quot; ]; then
  # ä¸»èŠ‚ç‚¹å¯åŠ¨
  ray start --head --port 6766 --dashboard-host=$MASTER_ADDR --node-ip-address=$CURRENT_IP --dashboard-port=8260 --resources=&#39;{&quot;NPU&quot;: &#39;$NPUS_PER_NODE&#39;}&#39;

  while true; do
      ray_status_output=$(ray status)
      npu_count=$(echo &quot;$ray_status_output&quot; | grep -oP &#39;(?&lt;=/)\d+\.\d+(?=\s*NPU)&#39; | head -n 1)
      npu_count_int=$(echo &quot;$npu_count&quot; | awk &#39;{print int($1)}&#39;)
      device_count=$((npu_count_int / $NPUS_PER_NODE))

      # åˆ¤æ–­device_count æ˜¯å¦ä¸ NNODES ç›¸ç­‰
      if [ &quot;$device_count&quot; -eq &quot;$NNODES&quot; ]; then
          echo &quot;Ray cluster is ready with $device_count devices (from $npu_count NPU resources), starting Python script.&quot;
          ray status
          bash $DEFAULT_SH
          break
      else
          echo &quot;Waiting for Ray to allocate $NNODES devices. Current device count: $device_count&quot;
          sleep 5
      fi
  done
else
  # å­èŠ‚ç‚¹å°è¯•å¾€ä¸»èŠ‚ç‚¹æ³¨å†Œ ray ç›´åˆ°æˆåŠŸ
  while true; do
      # å°è¯•è¿æ¥ ray é›†ç¾¤
      ray start --address=&quot;$MASTER_ADDR:6766&quot; --resources=&#39;{&quot;NPU&quot;: &#39;$NPUS_PER_NODE&#39;}&#39; --node-ip-address=$CURRENT_IP

      # æ£€æŸ¥è¿æ¥æ˜¯å¦æˆåŠŸ
      ray status
      if [ $? -eq 0 ]; then
          echo &quot;Successfully connected to the Ray cluster!&quot;
          break
      else
          echo &quot;Failed to connect to the Ray cluster. Retrying in 5 seconds...&quot;
          sleep 5
      fi
  done
fi

sleep 600
</pre></div>
</div>
<p>DEFAULT_SH:ä¿®æ”¹ä¸ºè®­ç»ƒæ‰€ç”¨é…ç½® sh æ–‡ä»¶è·¯å¾„ã€‚åœ¨æ­¤æ¡ˆä¾‹ä¸­ä¿®æ”¹ä¸º <a class="reference external" href="https://github.com/verl-project/verl-recipe/blob/main/dapo/run%20dapo_qwen3_vl_30b_fsdp2_npu.sh">Qwen3_VL_30B</a> è·¯å¾„ã€‚</p>
<p>NNODES å’Œ NPUS_PER_NODE:ä¿®æ”¹ä¸ºä½¿ç”¨èŠ‚ç‚¹æ•°é‡å’Œæ¯ä¸ªèŠ‚ç‚¹ NPU æ•°é‡ã€‚åœ¨æ­¤æ¡ˆä¾‹ä¸­åˆ†åˆ«ä¸º2å’Œ8ã€‚</p>
<p>MASTER_ADDR:ä¿®æ”¹ä¸ºå¯¹åº”ä¸»èŠ‚ç‚¹ IPã€‚å³æ‰€æœ‰èŠ‚ç‚¹çš„ MASTER_ADDR åº”è¯¥ç›¸åŒã€‚</p>
<p>SOCKET_IFNAME, HCCL_SOCKET_IFNAME, GLOO_SOCKET_IFNAME: ä¿®æ”¹ä¸ºå¯¹åº”é€šä¿¡ç½‘å¡ï¼Œé€šä¿¡ç½‘å¡å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è·å–ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span> <span class="o">|</span><span class="n">grep</span> <span class="s2">&quot;$(hostname -I |awk &#39;{print $1}&#39;|awk -F &#39;.&#39; &#39;{print $0}&#39;)&quot;</span> <span class="o">-</span><span class="n">B</span> <span class="mi">1</span><span class="o">|</span><span class="n">awk</span> <span class="o">-</span><span class="n">F</span> <span class="s1">&#39;:&#39;</span> <span class="s1">&#39;{print$1}&#39;</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span> <span class="o">|</span> <span class="n">tail</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
</section>
</section>
<section id="id8">
<h2>ä¼˜åŒ–å‚è€ƒ<a class="headerlink" href="#id8" title="Link to this heading">ïƒ</a></h2>
<ul class="simple">
<li><p><strong>å¯åŠ¨åŠ¨æ€æ‰¹æ¬¡å¤§å°</strong>
æ ¹æ®å• GPU çš„æœ€å¤§ Token æ€»æ•°ï¼ˆppo_max_token_len_per_gpuï¼‰åŠ¨æ€è°ƒæ•´æ‰¹æ¬¡å¤§å°</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>actor_rollout_ref.actor.use_dynamic_bsz=${use_dynamic_bsz}
actor_rollout_ref.ref.log_prob_use_dynamic_bsz=${use_dynamic_bsz}
actor_rollout_ref.rollout.log_prob_use_dynamic_bsz=${use_dynamic_bsz}
</pre></div>
</div>
<ul class="simple">
<li><p><strong>å•ä¸ª GPU èƒ½å¤„ç†çš„æœ€å¤§ Token æ€»æ•°</strong>
å½“<code class="docutils literal notranslate"><span class="pre">use_dynamic_bsz=True</span></code>æ—¶ï¼Œå• GPU åœ¨ä¸€ä¸ªå¾®æ‰¹æ¬¡ä¸­èƒ½å¤„ç†çš„æœ€å¤§ Token æ•°é‡</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>actor_rollout_ref.actor.ppo_max_token_len_per_gpu=${actor_ppo_max_token_len}  
actor_rollout_ref.ref.log_prob_max_token_len_per_gpu=${infer_ppo_max_token_len} 
actor_rollout_ref.rollout.log_prob_max_token_len_per_gpu=${infer_ppo_max_token_len}
</pre></div>
</div>
<ul class="simple">
<li><p><strong>å•ä¸ª GPU å¾®æ‰¹æ¬¡å¤§å°</strong>
å½“<code class="docutils literal notranslate"><span class="pre">use_dynamic_bsz=True</span></code>æ—¶ï¼Œæ¡†æ¶ä¼šä»¥è¯¥å€¼ä¸ºâ€‹åˆå§‹æ‰¹æ¬¡å¤§å°â€‹ï¼Œå†æ ¹æ®<code class="docutils literal notranslate"><span class="pre">ppo_max_token_len_per_gpu</span></code>å‘ä¸Š / å‘ä¸‹è°ƒæ•´</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ppo_micro_batch_size_per_gpu</span><span class="o">=</span><span class="mi">2</span> 
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">log_prob_micro_batch_size_per_gpu</span><span class="o">=</span><span class="mi">2</span> 
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">log_prob_micro_batch_size_per_gpu</span><span class="o">=</span><span class="mi">2</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>å¯ç”¨ FSDP2 æ¡†æ¶</strong>
â€œå°†æ¨¡å‹å‚æ•°ã€æ¢¯åº¦ã€ä¼˜åŒ–å™¨çŠ¶æ€åˆ†ç‰‡å­˜å‚¨åœ¨ä¸åŒ GPU ä¸Šâ€ï¼Œé¿å…å•å¡åŠ è½½å…¨é‡æ¨¡å‹å¯¼è‡´æ˜¾å­˜æº¢å‡ºã€‚</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># å¯ç”¨ FSDP2 æ¡†æ¶</span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">strategy</span><span class="o">=</span><span class="n">fsdp2</span> 
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">strategy</span><span class="o">=</span><span class="n">fsdp2</span> 
<span class="n">critic</span><span class="o">.</span><span class="n">strategy</span><span class="o">=</span><span class="n">fsdp2</span>

<span class="c1"># ä»…ç”¨äº FSDP2ï¼šå‰å‘ä¼ æ’­åé‡æ–°åˆ†ç‰‡ä»¥å‡å°‘å†…å­˜å ç”¨ã€‚</span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">fsdp_config</span><span class="o">.</span><span class="n">reshard_after_forward</span><span class="o">=</span><span class="kc">True</span>
<span class="c1"># ä»…ç”¨äº FSDP2ï¼šæ˜¯å¦åœ¨æ¨¡å‹å‰å‘ä¼ æ’­åé‡æ–°åˆ†ç‰‡ä»¥èŠ‚çœå†…å­˜ã€‚</span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">fsdp_config</span><span class="o">.</span><span class="n">reshard_after_forward</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>å¯ç”¨ä¸“å®¶å¹¶è¡Œé…ç½®</strong>
æŒ‡å®šæœ‰å¤šå°‘ä¸ª GPUç”¨äºå¹¶è¡Œè®¡ç®—ä¸åŒçš„ä¸“å®¶ç½‘ç»œ</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># MoE æ¶æ„ Actor æ¨¡å‹çš„ä¸“å®¶å¹¶è¡Œé…ç½®</span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">expert_parallel_size</span><span class="o">=</span><span class="mi">8</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>