

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NPU Qwen3-32B GSPO Optimization Practice &mdash; æ˜‡è…¾å¼€æº  æ–‡æ¡£</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom.css?v=f2aa3e58" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../../../_static/package_info.js?v=2b3ed588"></script>
      <script src="../../../../../_static/statistics.js?v=da671b53"></script>
      <script src="../../../../../_static/translations.js?v=beaddf03"></script>
      <script src="../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="ç´¢å¼•" href="../../../../../genindex.html" />
    <link rel="search" title="æœç´¢" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            æ˜‡è…¾å¼€æº
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="æœç´¢æ–‡æ¡£" aria-label="æœç´¢æ–‡æ¡£" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="å¯¼èˆªèœå•">
              <p class="caption" role="heading"><span class="caption-text">ğŸ å¼€å§‹ä½¿ç”¨</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../ascend/quick_install.html">å¿«é€Ÿå®‰è£…æ˜‡è…¾ç¯å¢ƒ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ—ï¸  åŸºç¡€è®¾æ–½ä¸æ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../accelerate/index.html">Accelerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../deepspeed/index.html">DeepSpeed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kernels/index.html">kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pytorch/index.html">PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../transformers/index.html">Transformers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ§  è®­ç»ƒä¸å¾®è°ƒæ¡†æ¶</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../LLaMA-Factory/index.html">LLaMA-Factory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ms-swift/index.html">ms-swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roll/index.html">ROLL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torchtitan/index.html">TorchTitan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../trl/index.html">Transformer Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../VeOmni/index.html">VeOmni</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../verl/index.html">verl</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸš€ æ¨ç†ä¸æœåŠ¡</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../llama_cpp/index.html">Llama.cpp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lm_deploy/index.html">LMDeploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../onnxruntime/index.html">ONNX Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sentence_transformers/index.html">Sentence Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sglang/index.html">SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torchchat/index.html">Torchchat</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ğŸ¨ å¤šæ¨¡æ€ã€åº”ç”¨ä¸è¯„æµ‹</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Diffusers/index.html">Diffusers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../lm_evaluation/index.html">LM-Evalution-Harness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../open_clip/index.html">open_clip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../opencompass/index.html">OpenCompass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../opencv/index.html">OpenCV</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sd_webui/index.html">Stable-Diffusion-WebUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../timm/index.html">timm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../wenet/index.html">WeNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../whisper_cpp/index.html">Whisper.cpp</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="ç§»åŠ¨ç‰ˆå¯¼èˆªèœå•" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">æ˜‡è…¾å¼€æº</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="é¡µé¢å¯¼èˆª">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">NPU Qwen3-32B GSPO Optimization Practice</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/sources/_generated/sources/verl/examples/gspo_optimization_practice.md.txt" rel="nofollow"> æŸ¥çœ‹é¡µé¢æºç </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="npu-qwen3-32b-gspo-optimization-practice">
<h1>NPU Qwen3-32B GSPO Optimization Practice<a class="headerlink" href="#npu-qwen3-32b-gspo-optimization-practice" title="Link to this heading">ïƒ</a></h1>
<p>Last updated: 02/26/2026.</p>
<p>æœ¬æ–‡ç« å¯¹åº”è„šæœ¬åœ°å€ï¼š<a class="reference external" href="https://github.com/volcengine/verl/blob/main/examples/gspo_trainer/run_qwen3_32b_gspo_npu.sh">qwen3_32b_gspo_npu</a></p>
<section id="id1">
<h2>ç®—æ³•é€‚é…<a class="headerlink" href="#id1" title="Link to this heading">ïƒ</a></h2>
<p>GSPOé€šè¿‡å°†ä¼˜åŒ–é¢—ç²’åº¦ä»<strong>tokençº§</strong>æå‡åˆ°<strong>sequenceçº§</strong>ï¼Œè§„é¿äº†GRPOä¼šé‡åˆ°çš„<strong>æ–¹å·®æ€¥å‰§å¢å¤§</strong>å¯¼è‡´è®­ç»ƒä¸ç¨³å®šçš„æƒ…å†µï¼Œå¢åŠ äº†è®­ç»ƒçš„ç¨³å®šæ€§ï¼ŒåŒæ—¶è¯¥ç®—æ³•ä¹Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šæå‡äº†ç®—æ³•çš„æ”¶æ•›é€Ÿåº¦ã€‚</p>
<p>æƒ³è¦æˆåŠŸåœ¨verlä»“åº“ä¸­æˆåŠŸè°ƒç”¨åˆ°GSPOç®—æ³•ï¼Œéœ€è¦è¿›è¡Œå¦‚ä¸‹çš„å¿…è¦é…ç½®</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># æ ¸å¿ƒç®—æ³•é…ç½®  </span>
<span class="n">algorithm</span><span class="o">.</span><span class="n">adv_estimator</span><span class="o">=</span><span class="n">grpo</span> \                    <span class="c1"># ä½¿ç”¨GRPOä¼˜åŠ¿ä¼°è®¡å™¨    </span>
<span class="n">algorithm</span><span class="o">.</span><span class="n">use_kl_in_reward</span><span class="o">=</span><span class="kc">False</span> \                <span class="c1"># ä¸åœ¨å¥–åŠ±ä¸­æ·»åŠ KLæƒ©ç½š    </span>
<span class="c1"># GSPOç­–ç•¥æŸå¤±æ¨¡å¼  </span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">policy_loss</span><span class="o">.</span><span class="n">loss_mode</span><span class="o">=</span><span class="n">gspo</span> \ <span class="c1"># å¯ç”¨GSPOç­–ç•¥æŸå¤±</span>
<span class="c1"># æå°è£å‰ªèŒƒå›´ï¼ˆGSPOç‰¹è‰²ï¼‰  </span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">clip_ratio_low</span><span class="o">=</span><span class="mf">0.0003</span> \   <span class="c1"># è£å‰ªä¸‹ç•Œï¼Œè®ºæ–‡æ¨èå€¼    </span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">clip_ratio_high</span><span class="o">=</span><span class="mf">0.0004</span> \  <span class="c1"># è£å‰ªä¸Šç•Œï¼Œè®ºæ–‡æ¨èå€¼    </span>
<span class="c1"># KLé…ç½®ï¼ˆGSPOä¸ä½¿ç”¨KL lossï¼‰  </span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">use_kl_loss</span><span class="o">=</span><span class="kc">False</span> \       <span class="c1"># ç¦ç”¨KLæŸå¤±    </span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">kl_loss_coef</span><span class="o">=</span><span class="mf">0.0</span> \        <span class="c1"># KLæŸå¤±ç³»æ•°è®¾ä¸º0    </span>
<span class="c1"># åºåˆ—çº§æŸå¤±èšåˆæ¨¡å¼ï¼ˆGSPOæ ¸å¿ƒï¼‰  </span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">loss_agg_mode</span><span class="o">=</span><span class="n">seq</span><span class="o">-</span><span class="n">mean</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">mean</span> \ <span class="c1"># åºåˆ—çº§å¹³å‡ï¼ŒGSPOè®ºæ–‡æ¨è    </span>
<span class="c1"># æ‰¹æ¬¡é…ç½®  </span>
<span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">n</span><span class="o">=</span><span class="mi">16</span> \                  <span class="c1"># æ¯ä¸ªpromptç”Ÿæˆ16ä¸ªå“åº”ï¼ˆç»„é‡‡æ ·ï¼‰</span>
</pre></div>
</div>
<p>ä¸€èˆ¬é€‰æ‹©å…¥å£å‡½æ•°ä¸º<code class="docutils literal notranslate"><span class="pre">verl.trainer.main_ppo</span></code></p>
</section>
<section id="id2">
<h2>åŸºç¡€ç¯å¢ƒ<a class="headerlink" href="#id2" title="Link to this heading">ïƒ</a></h2>
<p>å½“å‰æ”¯æŒAtlas 800T A3 ä¸ Atlas 900 A3 SuperPoDã€‚å®Œæˆè·‘å®Œæœ¬æ¬¡æœ€ä½³å®è·µéœ€è¦ 4å°Atlas 800T A3ã€‚å…³é”®è½¯ä»¶ç‰ˆæœ¬å¯ä»¥å‚è€ƒï¼š<a class="reference external" href="https://github.com/volcengine/verl/blob/main/docs/ascend_tutorial/ascend_quick_start.rst">Ascend Quickstart</a></p>
<section id="id3">
<h3>å®‰è£…åŸºç¡€ç¯å¢ƒ<a class="headerlink" href="#id3" title="Link to this heading">ïƒ</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th>software</th>
<th>version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Python</td>
<td>&gt;= 3.10, &lt;3.12</td>
</tr>
<tr>
<td>CANN</td>
<td>== 8.3.RC1</td>
</tr>
<tr>
<td>torch</td>
<td>== 2.7.1</td>
</tr>
<tr>
<td>torch_npu</td>
<td>== 2.7.1</td>
</tr>
<tr>
<td>verl</td>
<td>mainåˆ†æ”¯ commitId=252d76908b903ad8fb6969eb3a5e5f873c95ea2b</td>
</tr>
<tr>
<td>vllm</td>
<td>v0.11.0</td>
</tr>
<tr>
<td>vllm-ascend</td>
<td>v0.11.0-dev</td>
</tr>
<tr>
<td>transformers</td>
<td>4.57.3</td>
</tr>
</tbody>
</table><p>åœ¨æœ¬å®è·µä¸­, æˆ‘ä»¬é€šè¿‡æŒ‡å®š verl çš„commit id ä»¥é¿å…å¼•å…¥å…¶ä»–é—®é¢˜</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>verl
git<span class="w"> </span>checkout<span class="w"> </span>252d76908b903ad8fb6969eb3a5e5f873c95ea2b
<span class="c1"># æŒ‡å®šç›¸åº”çš„recipeç‰ˆæœ¬</span>
git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive<span class="w"> </span>recipe
</pre></div>
</div>
</section>
<section id="id4">
<h3>æƒé‡è·å–<a class="headerlink" href="#id4" title="Link to this heading">ïƒ</a></h3>
<p>ä»Hugging Faceåº“ä¸‹è½½å¯¹åº”çš„æ¨¡å‹æƒé‡ï¼š<a class="reference external" href="https://huggingface.co/Qwen/Qwen3-32B">Qwen/Qwen3-32B Â· Hugging Face</a></p>
</section>
<section id="id5">
<h3>æ•°æ®é›†å‡†å¤‡<a class="headerlink" href="#id5" title="Link to this heading">ïƒ</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ä¸‹è½½math-17kæ•°æ®é›†</span>
git<span class="w"> </span>clone<span class="w"> </span>https://huggingface.co/datasets/BytedTsinghua-SIA/DAPO-Math-17k

<span class="c1"># ä¸‹è½½AIME_2024æµ‹è¯•æ•°æ®é›†</span>
git<span class="w"> </span>clone<span class="w"> </span>https://huggingface.co/datasets/Maxwell-Jia/AIME_2024
</pre></div>
</div>
</section>
<section id="jemalloc">
<h3>jemallocå®‰è£…<a class="headerlink" href="#jemalloc" title="Link to this heading">ïƒ</a></h3>
<p>ä¸ºäº†ç¡®ä¿ Ray è¿›ç¨‹èƒ½å¤Ÿæ­£å¸¸å›æ”¶å†…å­˜ï¼Œéœ€è¦å®‰è£…å¹¶ä½¿èƒ½ jemalloc åº“è¿›è¡Œå†…å­˜ç®¡ç†ã€‚</p>
<section id="ubuntu">
<h4>Ubuntu æ“ä½œç³»ç»Ÿ<a class="headerlink" href="#ubuntu" title="Link to this heading">ïƒ</a></h4>
<p>é€šè¿‡æ“ä½œç³»ç»Ÿæºå®‰è£…jemallocï¼ˆæ³¨æ„ï¼š è¦æ±‚ubuntuç‰ˆæœ¬&gt;=20.04ï¼‰ï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>libjemalloc2
</pre></div>
</div>
<p>åœ¨å¯åŠ¨ä»»åŠ¡å‰æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤é€šè¿‡ç¯å¢ƒå˜é‡å¯¼å…¥jemallocï¼Œéœ€å…ˆé€šè¿‡ <strong>find /usr -name libjemalloc.so.2</strong> ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨ ï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># arm64æ¶æ„</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LD_PRELOAD</span><span class="o">=</span>/usr/lib/aarch64-linux-gnu/libjemalloc.so.2
<span class="c1"># x86_64æ¶æ„</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LD_PRELOAD</span><span class="o">=</span>/usr/lib/x86_64-linux-gnu/libjemalloc.so.2
</pre></div>
</div>
</section>
<section id="openeuler">
<h4>OpenEuler æ“ä½œç³»ç»Ÿ<a class="headerlink" href="#openeuler" title="Link to this heading">ïƒ</a></h4>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤é‡æ“ä½œç³»ç»Ÿæºå®‰è£…jemalloc</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>yum<span class="w"> </span>install<span class="w"> </span>jemalloc
</pre></div>
</div>
<p>å¦‚æœä¸Šè¿°æ–¹æ³•æ— æ³•æ­£å¸¸å®‰è£…ï¼Œå¯ä»¥é€šè¿‡æºç ç¼–è¯‘å®‰è£… å‰å¾€jemallocå®˜ç½‘ä¸‹è½½æœ€æ–°ç¨³å®šç‰ˆæœ¬ï¼Œå®˜ç½‘åœ°å€:https://github.com/jemalloc/jemalloc/releases/</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>tar<span class="w"> </span>-xvf<span class="w"> </span>jemalloc-<span class="o">{</span>version<span class="o">}</span>.tar.bz2
<span class="nb">cd</span><span class="w"> </span>jemalloc-<span class="o">{</span>version<span class="o">}</span>
./configure<span class="w"> </span>--prefix<span class="o">=</span>/usr/local
make
make<span class="w"> </span>install
</pre></div>
</div>
<p>åœ¨å¯åŠ¨ä»»åŠ¡å‰æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤é€šè¿‡ç¯å¢ƒå˜é‡å¯¼å…¥jemallocï¼š</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1">#æ ¹æ®å®é™…å®‰è£…è·¯å¾„è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚å®‰è£…è·¯å¾„ä¸º:/usr/local/lib/libjemalloc.so.2,å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥è®¾ç½®ç¯å¢ƒå˜é‡(å¯é€šè¿‡ find /usr -name libjemalloc.so.2 ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LD_PRELOAD</span><span class="o">=</span>/usr/lib/aarch64-linux-gnu/libjemalloc.so.2
</pre></div>
</div>
</section>
</section>
<section id="id6">
<h3>å¤šæœºä»»åŠ¡æ‹‰èµ·<a class="headerlink" href="#id6" title="Link to this heading">ïƒ</a></h3>
<p>é’ˆå¯¹æœ¬å®è·µæä¾›çš„å¤šæœºä»»åŠ¡ï¼Œå¯ç”¨ä¸‹é¢çš„è„šæœ¬æ‹‰èµ·</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pkill<span class="w"> </span>-9<span class="w"> </span>python
ray<span class="w"> </span>stop<span class="w"> </span>--force
rm<span class="w"> </span>-rf<span class="w"> </span>/tmp/ray

<span class="nb">export</span><span class="w"> </span><span class="nv">RAY_DEDUP_LOGS</span><span class="o">=</span><span class="m">0</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">HYDRA_FULL_ERROR</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">TASK_QUEUE_ENABLE</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">HCCL_EXEC_TIMEOUT</span><span class="o">=</span><span class="m">3600</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">HCCL_CONNECT_TIMEOUT</span><span class="o">=</span><span class="m">3600</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">HCCL_ASYNC_ERROR_HANDLING</span><span class="o">=</span><span class="m">0</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CPU_AFFINITY_CONF</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">VLLM_USE_V1</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">VLLM_ATTENTION_BACKEND</span><span class="o">=</span>XFORMERS
<span class="nb">export</span><span class="w"> </span><span class="nv">VLLM_ASCEND_ENABLE_FLASHCOMM</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">VLLM_ASCEND_ENABLE_PREFETCH_MLP</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">VLLM_ASCEND_ENABLE_DENSE_OPTIMIZE</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LD_PRELOAD</span><span class="o">=</span>/usr/local/lib/libjemalloc.so.2

<span class="c1"># ä¿®æ”¹ä¸ºå½“å‰éœ€è¦è·‘çš„ç”¨ä¾‹è·¯å¾„</span>
<span class="nv">DEFAULT_SH</span><span class="o">=</span><span class="s2">&quot;./run_*.sh&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Use </span><span class="nv">$DEFAULT_SH</span><span class="s2">&quot;</span>

<span class="nb">ulimit</span><span class="w"> </span>-n<span class="w"> </span><span class="m">32768</span>
mkdir<span class="w"> </span>logs

<span class="nv">NNODES</span><span class="o">=</span><span class="m">4</span>
<span class="nv">NPUS_PER_NODE</span><span class="o">=</span><span class="m">16</span>
<span class="c1"># ä¿®æ”¹ä¸ºå¯¹åº”ä¸»èŠ‚ç‚¹IP</span>
<span class="nv">MASTER_ADDR</span><span class="o">=</span><span class="s2">&quot;IP FOR MASTER NODE&quot;</span>
<span class="c1"># ä¿®æ”¹ä¸ºå½“å‰èŠ‚ç‚¹çš„é€šä¿¡ç½‘å¡</span>
<span class="nv">SOCKET_IFNAME</span><span class="o">=</span><span class="s2">&quot;Your SOCKET IFNAME&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">HCCL_SOCKET_IFNAME</span><span class="o">=</span><span class="s2">&quot;SOCKET IFNAME FOR CURRENT NODE&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">GLOO_SOCKET_IFNAME</span><span class="o">=</span><span class="s2">&quot;SOCKET IFNAME FOR CURRENT NODE&quot;</span>
<span class="c1"># è·å–å½“å‰IP</span>
<span class="nv">CURRENT_IP</span><span class="o">=</span><span class="k">$(</span>ifconfig<span class="w"> </span><span class="nv">$SOCKET_IFNAME</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-Eo<span class="w"> </span><span class="s1">&#39;inet (addr:)?([0-9]{1,3}\.){3}[0-9]{1,3}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $NF}&#39;</span><span class="k">)</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MASTER_ADDR</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENT_IP</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="c1"># ä¸»èŠ‚ç‚¹å¯åŠ¨</span>
<span class="w">  </span>ray<span class="w"> </span>start<span class="w"> </span>--head<span class="w"> </span>--port<span class="w"> </span><span class="m">6766</span><span class="w"> </span>--dashboard-host<span class="o">=</span><span class="nv">$MASTER_ADDR</span><span class="w"> </span>--node-ip-address<span class="o">=</span><span class="nv">$CURRENT_IP</span><span class="w"> </span>--dashboard-port<span class="o">=</span><span class="m">8260</span><span class="w"> </span>--resources<span class="o">=</span><span class="s1">&#39;{&quot;NPU&quot;: &#39;</span><span class="nv">$NPUS_PER_NODE</span><span class="s1">&#39;}&#39;</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="nv">ray_status_output</span><span class="o">=</span><span class="k">$(</span>ray<span class="w"> </span>status<span class="k">)</span>
<span class="w">      </span><span class="nv">npu_count</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ray_status_output</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">&#39;(?&lt;=/)\d+\.\d+(?=\s*NPU)&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="k">)</span>
<span class="w">      </span><span class="nv">npu_count_int</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$npu_count</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print int($1)}&#39;</span><span class="k">)</span>
<span class="w">      </span><span class="nv">device_count</span><span class="o">=</span><span class="k">$((</span><span class="nv">npu_count_int</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">$NPUS_PER_NODE</span><span class="k">))</span>

<span class="w">      </span><span class="c1"># åˆ¤æ–­device_count æ˜¯å¦ä¸ NNODES ç›¸ç­‰</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$device_count</span><span class="s2">&quot;</span><span class="w"> </span>-eq<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NNODES</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">          </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Ray cluster is ready with </span><span class="nv">$device_count</span><span class="s2"> devices (from </span><span class="nv">$npu_count</span><span class="s2"> NPU resources), starting Python script.&quot;</span>
<span class="w">          </span>ray<span class="w"> </span>status
<span class="w">          </span>bash<span class="w"> </span><span class="nv">$DEFAULT_SH</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">          </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Waiting for Ray to allocate </span><span class="nv">$NNODES</span><span class="s2"> devices. Current device count: </span><span class="nv">$device_count</span><span class="s2">&quot;</span>
<span class="w">          </span>sleep<span class="w"> </span><span class="m">5</span>
<span class="w">      </span><span class="k">fi</span>
<span class="w">  </span><span class="k">done</span>
<span class="k">else</span>
<span class="w">  </span><span class="c1"># å­èŠ‚ç‚¹å°è¯•å¾€ä¸»èŠ‚ç‚¹æ³¨å†Œ ray ç›´åˆ°æˆåŠŸ</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># å°è¯•è¿æ¥ ray é›†ç¾¤</span>
<span class="w">      </span>ray<span class="w"> </span>start<span class="w"> </span>--address<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$MASTER_ADDR</span><span class="s2">:6766&quot;</span><span class="w"> </span>--resources<span class="o">=</span><span class="s1">&#39;{&quot;NPU&quot;: &#39;</span><span class="nv">$NPUS_PER_NODE</span><span class="s1">&#39;}&#39;</span><span class="w"> </span>--node-ip-address<span class="o">=</span><span class="nv">$CURRENT_IP</span>

<span class="w">      </span><span class="c1"># æ£€æŸ¥è¿æ¥æ˜¯å¦æˆåŠŸ</span>
<span class="w">      </span>ray<span class="w"> </span>status
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">          </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Successfully connected to the Ray cluster!&quot;</span>
<span class="w">          </span><span class="k">break</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">          </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Failed to connect to the Ray cluster. Retrying in 5 seconds...&quot;</span>
<span class="w">          </span>sleep<span class="w"> </span><span class="m">5</span>
<span class="w">      </span><span class="k">fi</span>
<span class="w">  </span><span class="k">done</span>
<span class="k">fi</span>

sleep<span class="w"> </span><span class="m">600</span>
</pre></div>
</div>
<p>DEFAULT_SH:ä¿®æ”¹ä¸ºè®­ç»ƒæ‰€ç”¨é…ç½® sh æ–‡ä»¶è·¯å¾„ã€‚åœ¨æ­¤æ¡ˆä¾‹ä¸­ä¿®æ”¹ä¸º <a class="reference external" href="https://github.com/volcengine/verl/blob/main/examples/gspo_trainer/run_qwen3_32b_gspo_npu.sh">Qwen2.5-32B</a> è·¯å¾„ã€‚</p>
<p>NNODES å’Œ NPUS_PER_NODE:ä¿®æ”¹ä¸ºä½¿ç”¨èŠ‚ç‚¹æ•°é‡å’Œæ¯ä¸ªèŠ‚ç‚¹ NPU æ•°é‡ã€‚åœ¨æ­¤æ¡ˆä¾‹ä¸­åˆ†åˆ«ä¸º4å’Œ16ã€‚</p>
<p>MASTER_ADDR:ä¿®æ”¹ä¸ºå¯¹åº”ä¸»èŠ‚ç‚¹ IPã€‚å³æ‰€æœ‰èŠ‚ç‚¹çš„ MASTER_ADDR åº”è¯¥ç›¸åŒã€‚</p>
<p>SOCKET_IFNAME, HCCL_SOCKET_IFNAME, GLOO_SOCKET_IFNAME: ä¿®æ”¹ä¸ºå¯¹åº”é€šä¿¡ç½‘å¡ï¼Œé€šä¿¡ç½‘å¡å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è·å–ï¼š</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span> <span class="o">|</span><span class="n">grep</span> <span class="s2">&quot;$(hostname -I |awk &#39;{print $1}&#39;|awk -F &#39;.&#39; &#39;{print $0}&#39;)&quot;</span> <span class="o">-</span><span class="n">B</span> <span class="mi">1</span><span class="o">|</span><span class="n">awk</span> <span class="o">-</span><span class="n">F</span> <span class="s1">&#39;:&#39;</span> <span class="s1">&#39;{print$1}&#39;</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span> <span class="o">|</span> <span class="n">tail</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h2>æ€§èƒ½è°ƒä¼˜<a class="headerlink" href="#id7" title="Link to this heading">ïƒ</a></h2>
<p>ä¼˜åŒ–ä»è®­ç»ƒã€æ¨ç†ã€è°ƒåº¦å’Œå…¶ä»–å››ä¸ªæ–¹é¢å…¥æ‰‹ã€‚</p>
<section id="id8">
<h3>è®­ç»ƒ<a class="headerlink" href="#id8" title="Link to this heading">ïƒ</a></h3>
<section id="bsz">
<h4>åŠ¨æ€bsz<a class="headerlink" href="#bsz" title="Link to this heading">ïƒ</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">actor_ppo_max_token_len</span><span class="o">=</span><span class="k">$((</span><span class="o">(</span><span class="nv">max_prompt_length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">max_response_length</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">sp_size</span><span class="k">))</span>
<span class="nv">infer_ppo_max_token_len</span><span class="o">=</span><span class="k">$((</span><span class="o">(</span><span class="nv">max_prompt_length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">max_response_length</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">sp_size</span><span class="k">))</span>
</pre></div>
</div>
<p><strong>è¿™ä¸ªä¼˜åŒ–ç‚¹ä¸»è¦è°ƒæ•´ä¸Šé¢è¿™ä¸¤ä¸ªå‚æ•°ï¼Œä¸è¿‡éœ€è¦æ³¨æ„è¿™ä¸¤ä¸ªå‚æ•°è°ƒæ•´çš„å¤ªå¤§ä¼šå¯¼è‡´OOM</strong></p>
<p><strong>ä¸»è¦è°ƒæ•´</strong><code class="docutils literal notranslate"><span class="pre">actor_ppo_max_token_len</span></code>,è°ƒå¤§äº†ä¼šé™ä½è®­ç»ƒçš„è€—æ—¶ï¼Œè°ƒæ•´<code class="docutils literal notranslate"><span class="pre">infer_ppo_max_token_len</span></code>æ²¡æœ‰æ˜æ˜¾çš„æ”¶ç›Šï¼Œå¯ä»¥ä¸åŠ¨</p>
<p><strong>è¿™ä¸¤ä¸ªå‚æ•°çš„ä½œç”¨ä»‹ç»å¦‚ä¸‹ï¼š</strong></p>
<p><strong>è¿™ä¸¤ä¸ªå‚æ•°ç”¨äºæ§åˆ¶åŠ¨æ€æ‰¹å¤„ç†(dynamic batch size)æ¨¡å¼ä¸‹æ¯ä¸ªGPUå¤„ç†çš„æœ€å¤§tokenæ•°é‡</strong></p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">actor_ppo_max_token_len</span></code></strong>: Actoræ¨¡å‹åœ¨PPOæ›´æ–°(å‰å‘+åå‘ä¼ æ’­)æ—¶æ¯ä¸ªGPUèƒ½å¤„ç†çš„æœ€å¤§tokenæ•°</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">infer_ppo_max_token_len</span></code></strong>: æ¨ç†é˜¶æ®µ(Reference policyå’ŒRollout)è®¡ç®—logæ¦‚ç‡æ—¶æ¯ä¸ªGPUèƒ½å¤„ç†çš„æœ€å¤§tokenæ•°</p></li>
</ul>
</section>
</section>
<section id="id9">
<h3>æ¨ç†<a class="headerlink" href="#id9" title="Link to this heading">ïƒ</a></h3>
<section id="aclgraph-full-decode-only">
<h4>ACLgraph+FULL_DECODE_ONLY<a class="headerlink" href="#aclgraph-full-decode-only" title="Link to this heading">ïƒ</a></h4>
<p>æ¨ç†ç®—å­ä¸‹å‘æ–¹é¢çš„ä¼˜åŒ–ï¼Œå¹³å‡èƒ½æœ‰<code class="docutils literal notranslate"><span class="pre">15%~20%</span></code>å·¦å³çš„æ€§èƒ½æ”¶ç›Šã€‚</p>
<p>å…ˆçœ‹å•å¼€<strong>ACLgraph</strong>ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># å¼€å¯ACLgraph+FULL_DECODE_ONLYï¼ˆæ³¨æ„ï¼šå½“è®¾ç½®æ­¤å‚æ•°ä¸ºFalseæ—¶ï¼ŒTASK_QUEUE_ENABLEå¿…é¡»è®¾ç½®ä¸º1ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼‰</span>
actor_rollout_ref.rollout.enforce_eager<span class="o">=</span>False
actor_rollout_ref.rollout.engine_kwargs.vllm.compilation_config.cudagraph_capture_sizes<span class="o">=</span><span class="s1">&#39;[8,16,32,64,128]&#39;</span><span class="w"> </span><span class="se">\ </span>
actor_rollout_ref.rollout.engine_kwargs.vllm.compilation_config.cudagraph_mode<span class="o">=</span><span class="s1">&#39;FULL_DECODE_ONLY&#39;</span><span class="w"> </span><span class="se">\</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">FULL_DECODE_ONLY</span></code>å¼€å¯æˆåŠŸåæœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>
<p><img alt="FULL_DECODE_ONLY result" src="https://github.com/wucong25/verl-data/blob/main/ascend_acl_graph.png" /></p>
<p><strong><code class="docutils literal notranslate"><span class="pre">cudagraph_capture_sizes</span></code>å‚æ•°è®¾ç½®æŒ‡å—</strong></p>
<p>cudagraph_capture_sizesè®¾ç½®çš„å€¼å¯¹åº”çš„æ˜¯æ‰¹å¤§å°ï¼Œè¿™é‡Œçš„æ‰¹å¤§å°ä¸æ˜¯é…ç½®é‡Œçš„DPåŸŸå¯¹åº”çš„é‚£ä¸ªæ‰¹æ¬¡å¤§å°ï¼Œè¿™é‡Œæ˜¯ç›¸è¾ƒäºvllmæ¥è¯´çš„æ‰¹å¤§å°ï¼Œå•ä½ä¸º<strong>token</strong></p>
<p>é»˜è®¤ç”Ÿæˆçš„ç®—æ³•å¦‚ä¸‹ï¼Œå¯åšå‚è€ƒ</p>
<p><img alt="cudagraph_capture_sizes" src="https://github.com/wucong25/verl-data/blob/main/ascend_set_cudagraph_sizes.png" /></p>
<section id="id10">
<h5>æ¨ç†åç«¯åˆ‡æ¢<a class="headerlink" href="#id10" title="Link to this heading">ïƒ</a></h5>
<p>ä½¿ç”¨æ–¹å¼ï¼š<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">VLLM_ATTENTION_BACKEND=XFORMERS</span></code></p>
<p><img alt="VLLM_ATTENTION_BACKEND" src="https://github.com/wucong25/verl-data/blob/main/ascend_vllm_attn_backend.png" /></p>
<p>æ³¨ï¼šéœ€è¦æ³¨æ„æŸäº›åç«¯åœ¨ä¸€äº›æ¯”è¾ƒè€çš„vllm-ascendç‰ˆæœ¬å†…å¹¶ä¸æ”¯æŒ</p>
</section>
<section id="vllm-v1">
<h5>ä½¿èƒ½vllm v1ç‰ˆæœ¬<a class="headerlink" href="#vllm-v1" title="Link to this heading">ïƒ</a></h5>
<p>ä½¿ç”¨æ–¹å¼ï¼š<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">VLLM_USE_V1=1</span></code></p>
<p>å¯ä»¥å¸¸å¼€ï¼Œä¸€èˆ¬éƒ½æ˜¯æ­£æ”¶ç›Šã€‚</p>
</section>
</section>
</section>
<section id="id11">
<h3>è°ƒåº¦<a class="headerlink" href="#id11" title="Link to this heading">ïƒ</a></h3>
<section id="aiv">
<h4>AIV<a class="headerlink" href="#aiv" title="Link to this heading">ïƒ</a></h4>
<p>æ‰“å¼€æ–¹å¼ï¼šè®¾ç½®<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">HCCL_OP_EXPANSION_MODE=&quot;AIV&quot;</span></code></p>
<p>HCCL_OP_EXPANSION_MODEç¯å¢ƒå˜é‡ç”¨äºé…ç½®é€šä¿¡ç®—æ³•çš„ç¼–æ’å±•å¼€ä½ç½®ï¼Œæ”¯æŒå¦‚ä¸‹å–å€¼ï¼š</p>
<ul class="simple">
<li><p>AI_CPUï¼šä»£è¡¨é€šä¿¡ç®—æ³•çš„ç¼–æ’å±•å¼€ä½ç½®åœ¨Deviceä¾§çš„AI CPUè®¡ç®—å•å…ƒã€‚</p></li>
<li><p>AIVï¼šä»£è¡¨é€šä¿¡ç®—æ³•çš„ç¼–æ’å±•å¼€ä½ç½®åœ¨Deviceä¾§çš„Vector Coreè®¡ç®—å•å…ƒã€‚</p></li>
<li><p>HOSTï¼šä»£è¡¨é€šä¿¡ç®—æ³•çš„ç¼–æ’å±•å¼€ä½ç½®ä¸ºHostä¾§CPUï¼ŒDeviceä¾§æ ¹æ®ç¡¬ä»¶å‹å·è‡ªåŠ¨é€‰æ‹©ç›¸åº”çš„è°ƒåº¦å™¨ã€‚</p></li>
<li><p>HOST_TSï¼šä»£è¡¨é€šä¿¡ç®—æ³•çš„ç¼–æ’å±•å¼€ä½ç½®ä¸ºHostä¾§CPUï¼ŒHostå‘Deviceçš„Task Schedulerä¸‹å‘ä»»åŠ¡ï¼ŒDeviceçš„Task Schedulerè¿›è¡Œä»»åŠ¡è°ƒåº¦æ‰§è¡Œã€‚</p></li>
</ul>
<p>ä¸‹é¢ä»‹ç»ä¸¤ç§å±•å¼€æœºåˆ¶</p>
<section id="host">
<h5>HOSTå±•å¼€<a class="headerlink" href="#host" title="Link to this heading">ïƒ</a></h5>
<img src="https://github.com/wucong25/verl-data/blob/main/ascend_task_queue1.png" alt="image-20260113194257095" style="zoom:50%;" /><ul class="simple">
<li><p>è½¯ä»¶æ ˆå·¥ä½œåœ¨hostcpuï¼Œé€šä¿¡ç®—æ³•å±•å¼€ä¸€ä¸ªä¸ªtask</p></li>
<li><p>æ¯ä¸ªtaskè°ƒç”¨runtimeæ¥å£ï¼Œä¸‹å‘åˆ°deviceçš„rtsqueue</p></li>
<li><p>STARSä»rstqueueä¸Šé¡ºåºæ‹¿å–task</p></li>
<li><p>æ ¹æ®taskç±»å‹åˆ†åˆ«è°ƒç”¨æ‰SDMAå’ŒRDMAå¼•æ“ã€‚
<strong>å•ç®—å­ç“¶é¢ˆ</strong>ï¼šhostbound æ¯ä¸ªtaskæäº¤æ˜¯2~5usï¼Œä¸€ä¸ªé€šä¿¡ç®—å­æœ‰å‡ ç™¾ä¸ªtaskï¼Œå•ç®—å­åœºæ™¯ä¸ä¼šåœ¨deviceä¸Šç¼“å­˜ï¼Œä¸‹å‘ä¸€ä¸ªæ‰§è¡Œä¸€ä¸ª</p></li>
</ul>
</section>
<section id="aicpu">
<h5>AICpuæœºåˆ¶å±•å¼€<a class="headerlink" href="#aicpu" title="Link to this heading">ïƒ</a></h5>
<img src="https://github.com/wucong25/verl-data/blob/main/ascend_task_queue3.png" alt="image-20260113194333218" style="zoom:50%;" /><ul class="simple">
<li><p>hostä¾§ä¸ä¸‹å‘ä¸€ä¸ªä¸ªtaskï¼ŒæŠŠé€šä¿¡ç®—å­ä½œä¸ºä¸€ä¸ªä¸ªkernelï¼Œæ”¾åœ¨é€šä¿¡ç®—å­kernelçš„é˜Ÿåˆ—ä¸Šå»ã€‚</p></li>
<li><p>STARSè°ƒåº¦kernelé˜Ÿåˆ—æµä¸Šçš„kernelï¼ŒæŠŠkernelæ”¾åˆ°AiCPUä¸Šå»æ‰§è¡Œã€‚</p></li>
<li><p>AICPUè°ƒç”¨å‡½æ•°ï¼ˆkernelï¼‰ï¼Œç”¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œkernel å‡½æ•°ï¼Œåœ¨å‡½æ•°å†…æŠŠé€šä¿¡taskå±•å¼€ï¼ŒæŠŠtaskæ”¾åˆ°rstqueueä¸Šï¼ŒSTARSè°ƒç”¨ã€‚</p></li>
<li><p>é™ä½hostå’Œaicpuäº¤äº’ï¼Œç”±å‡ ç™¾æ¬¡é™ä½ä¸ºä¸€æ¬¡ã€‚</p></li>
<li><p>taskçš„æäº¤åœ¨AICPUä¸Šæäº¤ï¼Œåšäº†æäº¤çš„éƒ¨åˆ†åˆå¹¶ã€‚</p></li>
</ul>
</section>
</section>
<section id="task-queue-enable">
<h4>TASK_QUEUE_ENABLE<a class="headerlink" href="#task-queue-enable" title="Link to this heading">ïƒ</a></h4>
<p><strong>ä½¿ç”¨æ–¹å¼ï¼š</strong><code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">TASK_QUEUE_ENABLE=2</span></code></p>
<p>TASK_QUEUE_ENABLEï¼Œä¸‹å‘ä¼˜åŒ–ï¼Œå›¾æ¨¡å¼è®¾ç½®ä¸º1ï¼ˆå³å¼€å¯å›¾æ¨¡å¼çš„æ—¶å€™è¿™ä¸ªè¦è®¾ç½®ä¸º1ï¼‰ï¼Œéå›¾æ¨¡å¼è®¾ç½®ä¸º2</p>
<p>ç¤ºæ„å›¾ï¼š</p>
<p><img alt="ascend task queue" src="https://github.com/wucong25/verl-data/blob/main/ascend_task_queue2.png" /></p>
<section id="id12">
<h5>ç»‘æ ¸ä¼˜åŒ–<a class="headerlink" href="#id12" title="Link to this heading">ïƒ</a></h5>
<p><strong>ä½¿ç”¨æ–¹å¼ï¼š</strong><code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">CPU_AFFINITY_CONF=1</span></code></p>
<p>è¯¦ç»†è®¾ç½®åŸç†å¯çœ‹ï¼šhttps://www.hiascend.com/document/detail/zh/Pytorch/600/ptmoddevg/trainingmigrguide/performance_tuning_0059.html</p>
</section>
</section>
</section>
<section id="id13">
<h3>å…¶ä»–<a class="headerlink" href="#id13" title="Link to this heading">ïƒ</a></h3>
<p>ä»¥ä¸‹å†…å®¹æ±‡æ€»äº†è‹¥å¹²å…¨å±€ç¯å¢ƒå˜é‡çš„è°ƒä¼˜é…ç½®ã€‚ç”±äºè¿™äº›å‚æ•°åœ¨è®­ç»ƒé˜¶æ®µä¸æ¨ç†é˜¶æ®µå¾€å¾€éƒ½èƒ½å¸¦æ¥æ­£å‘æ”¶ç›Šï¼Œä¸”ç›®å‰å°šç¼ºä¹è¶³å¤Ÿç²¾ç»†çš„æ¶ˆèå®éªŒæ¥ä¸¥æ ¼åŒºåˆ†å®ƒä»¬å„è‡ªå¯¹è®­ç»ƒæˆ–æ¨ç†çš„è´¡çŒ®å æ¯”ï¼Œæ•…ç»Ÿä¸€å½’æ‹¢åœ¨æ­¤ï¼Œä¾›åç»­æŒç»­ç›‘æ§ä¸è¿›ä¸€æ­¥æ‹†è§£åˆ†æã€‚</p>
<section id="id14">
<h4>ä½¿èƒ½jemalloc<a class="headerlink" href="#id14" title="Link to this heading">ïƒ</a></h4>
<p>ä½¿ç”¨æ–¹å¼ï¼ˆæ³¨æ„éœ€è¦å…ˆå®‰è£…jemallocåº“ï¼‰ï¼š<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">LD_PRELOAD=/usr/local/lib/libjemalloc.so.2</span></code></p>
<p><strong>å®‰è£…ä½¿ç”¨æ•™ç¨‹ï¼š</strong><a class="reference external" href="https://gitcode.com/Ascend/MindSpeed-RL/blob/master/docs/install_guide.md#%E9%AB%98%E6%80%A7%E8%83%BD%E5%86%85%E5%AD%98%E5%BA%93-jemalloc-%E5%AE%89%E8%A3%85">MindSpeed-RL/docs/install_guide.md Â· Ascend/MindSpeed-RL - AtomGit | GitCode</a></p>
</section>
<section id="id15">
<h4>å¤šæµå¤ç”¨<a class="headerlink" href="#id15" title="Link to this heading">ïƒ</a></h4>
<p>å†…å­˜æ–¹é¢æœ‰ä¼˜åŒ–</p>
<p>ä½¿èƒ½æ–¹å¼ï¼š<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">MULTI_STREAM_MEMORY_REUSE=1</span></code></p>
<p>åŸç†ä»‹ç»ï¼šhttps://www.hiascend.com/document/detail/zh/Pytorch/600/ptmoddevg/trainingmigrguide/performance_tuning_0040.html</p>
</section>
<section id="vllm-ascend-enable-flashcomm">
<h4>VLLM_ASCEND_ENABLE_FLASHCOMM<a class="headerlink" href="#vllm-ascend-enable-flashcomm" title="Link to this heading">ïƒ</a></h4>
<p>ä½¿ç”¨æ–¹å¼ï¼š<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">VLLM_ASCEND_ENABLE_FLASHCOMM=1</span></code></p>
<p>å¯ç”¨æ˜‡è…¾ NPU ç‰¹æœ‰çš„FLASHCOMMé«˜é€Ÿé€šä¿¡ä¼˜åŒ–æŠ€æœ¯</p>
<p>åœ°å€ï¼šhttps://vllm-ascend.readthedocs.io/zh-cn/latest/user_guide/release_notes.html</p>
</section>
<section id="vllm-ascend-enable-dense-optimize">
<h4>VLLM_ASCEND_ENABLE_DENSE_OPTIMIZE<a class="headerlink" href="#vllm-ascend-enable-dense-optimize" title="Link to this heading">ïƒ</a></h4>
<p>ä½¿ç”¨æ–¹å¼ï¼š<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">VLLM_ASCEND_ENABLE_DENSE_OPTIMIZE=1</span></code></p>
<p>å¯ç”¨æ˜‡è…¾ NPUé’ˆå¯¹å¤§æ¨¡å‹æ¨ç†çš„ç¨ å¯†è®¡ç®—ä¼˜åŒ–</p>
<p>åœ°å€ï¼šhttps://vllm-ascend.readthedocs.io/zh-cn/latest/user_guide/release_notes.html</p>
</section>
<section id="vllm-ascend-enable-prefetch-mlp">
<h4>VLLM_ASCEND_ENABLE_PREFETCH_MLP<a class="headerlink" href="#vllm-ascend-enable-prefetch-mlp" title="Link to this heading">ïƒ</a></h4>
<p>ä½¿ç”¨æ–¹å¼ï¼š<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">VLLM_ASCEND_ENABLE_PREFETCH_MLP=1</span></code></p>
<p>å¯ç”¨ MLP å±‚çš„æƒé‡é¢„å–æœºåˆ¶</p>
<img src="https://github.com/wucong25/verl-data/blob/main/ascend_prefetch.png" alt="image-20251124173132677" style="zoom:50%;" /></section>
</section>
<section id="verl">
<h3>verlæ¡†æ¶å‚æ•°è®¾ç½®<a class="headerlink" href="#verl" title="Link to this heading">ïƒ</a></h3>
<p>ä¸»è¦æ˜¯å†…å­˜æ–¹é¢çš„ä¸€äº›è®¾ç½®å¼€å…³ï¼ˆæ³¨æ„ï¼Œè¿™ä¸ªé‡Œé¢çš„ä¼˜åŒ–éƒ½æˆ–å¤šæˆ–å°‘ä¼šå¯¼è‡´ååé‡æœ‰ä¸€å®šç¨‹åº¦çš„åŠ£åŒ–ï¼‰</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># æ¢¯åº¦æ£€æŸ¥ç‚¹ (Gradient Checkpointing)</span>
<span class="c1"># ä½œç”¨: é€šè¿‡é‡æ–°è®¡ç®—æ¿€æ´»å€¼æ¥èŠ‚çœæ˜¾å­˜,ä»¥è®¡ç®—æ¢å†…å­˜ã€‚åœ¨å‰å‘ä¼ æ’­æ—¶ä¸ä¿å­˜ä¸­é—´æ¿€æ´»å€¼,åå‘ä¼ æ’­æ—¶é‡æ–°è®¡ç®—,å¯ä»¥æ˜¾è‘—é™ä½æ˜¾å­˜å ç”¨,å…è®¸ä½¿ç”¨æ›´å¤§çš„batch sizeã€‚</span>
actor_rollout_ref.model.enable_gradient_checkpointing<span class="o">=</span>True

<span class="c1"># å‚æ•°å¸è½½ (Parameter Offload)</span>
<span class="c1"># ä½œç”¨: å°†æ¨¡å‹å‚æ•°å¸è½½åˆ°CPUå†…å­˜,è®­ç»ƒæ—¶å†åŠ è½½å›GPUã€‚</span>
actor_rollout_ref.actor.fsdp_config.param_offload<span class="o">=</span><span class="si">${</span><span class="nv">offload</span><span class="si">}</span><span class="w">  </span><span class="c1"># True  </span>
actor_rollout_ref.ref.fsdp_config.param_offload<span class="o">=</span><span class="si">${</span><span class="nv">offload</span><span class="si">}</span><span class="w">    </span><span class="c1"># True</span>

<span class="c1"># ä¼˜åŒ–å™¨çŠ¶æ€å¸è½½ (Optimizer Offload)</span>
<span class="c1"># ä½œç”¨: å°†ä¼˜åŒ–å™¨çŠ¶æ€(å¦‚Adamçš„åŠ¨é‡)å¸è½½åˆ°CPUã€‚ä¼˜åŒ–å™¨çŠ¶æ€é€šå¸¸å ç”¨å¤§é‡æ˜¾å­˜(å¯¹äºAdam,æ¯ä¸ªå‚æ•°éœ€è¦é¢å¤–8å­—èŠ‚),å¸è½½å¯ä»¥èŠ‚çœæ˜¾å­˜ã€‚</span>
actor_rollout_ref.actor.fsdp_config.optimizer_offload<span class="o">=</span><span class="si">${</span><span class="nv">offload</span><span class="si">}</span><span class="w">  </span><span class="c1"># True</span>

<span class="c1"># é‡Šæ”¾æ¨ç†å¼•æ“ç¼“å­˜ (Free Cache Engine)</span>
<span class="c1"># ä½œç”¨: åœ¨è®­ç»ƒé˜¶æ®µé‡Šæ”¾æ¨ç†å¼•æ“çš„KV cacheå’Œæƒé‡ã€‚è¿™æ˜¯3D-HybridEngineçš„æ ¸å¿ƒä¼˜åŒ–,å…è®¸åœ¨åŒä¸€GPUä¸Šäº¤æ›¿è¿›è¡Œæ¨ç†å’Œè®­ç»ƒ,æ˜¾è‘—é™ä½æ˜¾å­˜éœ€æ±‚ã€‚</span>
actor_rollout_ref.rollout.free_cache_engine<span class="o">=</span>True

<span class="c1">#  ç†µè®¡ç®—ä¼˜åŒ–</span>
<span class="c1"># entropy_checkpointing: åœ¨è®­ç»ƒæ—¶å¯¹ç†µè®¡ç®—å¯ç”¨é‡è®¡ç®—,é™ä½æ˜¾å­˜å³°å€¼</span>
<span class="c1"># entropy_from_logits_with_chunking: åˆ†å—å¤„ç†logitså¼ é‡(å¦‚2048 tokensä¸€ç»„),é¿å…ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ª[bsz*seq_len, vocab]å¼ é‡</span>
actor_rollout_ref.actor.entropy_checkpointing<span class="o">=</span>True<span class="w">  </span>
actor_rollout_ref.ref.entropy_checkpointing<span class="o">=</span>True<span class="w">  </span>
actor_rollout_ref.actor.entropy_from_logits_with_chunking<span class="o">=</span>True<span class="w">  </span>
actor_rollout_ref.ref.entropy_from_logits_with_chunking<span class="o">=</span>True

<span class="c1"># æ¨ç†å¼•æ“æ˜¾å­˜é…ç½®</span>
<span class="c1"># gpu_memory_utilization: æ§åˆ¶vLLMä½¿ç”¨çš„GPUæ˜¾å­˜æ¯”ä¾‹(0.90 = 90%)</span>
<span class="c1"># enforce_eager=False: å¯ç”¨CUDA graphsåŠ é€Ÿæ¨ç†,ä½†ä¼šå ç”¨é¢å¤–æ˜¾å­˜</span>
actor_rollout_ref.rollout.gpu_memory_utilization<span class="o">=</span><span class="m">0</span>.90<span class="w">  </span>
actor_rollout_ref.rollout.enforce_eager<span class="o">=</span>False
</pre></div>
</div>
</section>
</section>
<section id="npu">
<h2>NPUè°ƒä¼˜å‚è€ƒæ–‡ç« <a class="headerlink" href="#npu" title="Link to this heading">ïƒ</a></h2>
<p>ç¯å¢ƒå˜é‡ç›¸å…³ï¼š<a class="reference external" href="https://www.hiascend.com/document/detail/zh/Pytorch/600/apiref/Envvariables/Envir_001.html">ç¯å¢ƒå˜é‡åˆ—è¡¨-Ascend Extension for PyTorch6.0.0-æ˜‡è…¾ç¤¾åŒº</a></p>
<p>ç¤¾åŒºæ€§èƒ½è°ƒä¼˜æ•™ç¨‹ï¼š<a class="reference external" href="https://www.hiascend.com/document/detail/zh/Pytorch/600/ptmoddevg/trainingmigrguide/performance_tuning_0001.html">æ€§èƒ½è°ƒä¼˜æµç¨‹-Ascend Extension for PyTorch6.0.0-æ˜‡è…¾ç¤¾åŒº</a></p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; ç‰ˆæƒæ‰€æœ‰ 2024, Ascendã€‚</p>
  </div>

  åˆ©ç”¨ <a href="https://www.sphinx-doc.org/">Sphinx</a> æ„å»ºï¼Œä½¿ç”¨çš„ 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">ä¸»é¢˜</a>
    ç”± <a href="https://readthedocs.org">Read the Docs</a> å¼€å‘.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>